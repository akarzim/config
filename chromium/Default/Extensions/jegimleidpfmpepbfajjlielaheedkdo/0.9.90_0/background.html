<!DOCTYPE html> 
<html>
<head>
<script type="text/javascript">
var ctx = document.createElement('canvas'), img = new Image();
ctx.width = '101'; ctx.height = '101'; ctx = ctx.getContext('2d');

// open and initialize the colorPicker and avoid opening it twice...
var toggle = {}, cPOff = {}, cTab, range = 1, cPRange = 11, cPMode = 1, cPSize = 4;

chrome.extension.onRequest.addListener(function(request, sender, sendResponse){
	if (request.cPSize != undefined) {cPSize = request.cPSize;}
	if (request.toggle === false) toggle['tab_'+cTab] = false;
	if (request.cPOff != undefined) cPOff['tab_'+cTab] = request.cPOff;
	if (request.x) captureImage(request);
	if (request.doCapture) captureImage(request.doCapture);
});

chrome.tabs.onUpdated.addListener(function(tab,changeInfo) {
	if (changeInfo.status == 'loading') { // chrome.tabs.onUpdated fires if opening the 'Developer Tools'
		// if (changeInfo.url.indexOf('chrome') != 0 && changeInfo.url.indexOf('https://chrome.google.com/') != 0 && changeInfo.url.indexOf('file') != 0)
			chrome.tabs.executeScript(null, {code: 'cPMode='+cPMode+';cPSize='+cPSize});
		if (changeInfo.url && changeInfo.url.indexOf('chrome://') == 0 && toggle['tab_'+tab] != true) {
			toggle['tab_'+tab] = false; 
		} else toggle['tab_'+tab] = true;
	}
});

chrome.tabs.onSelectionChanged.addListener(function(tab) {
	/*chrome.tabs.get(tabId, function(tab) {
		if (toggle['tab_'+tabId] === false && tab.url.indexOf('chrome') != 0 && tab.url.indexOf('https://chrome.google.com/') != 0 && tab.url.indexOf('file') != 0)
			chrome.tabs.executeScript(null, {code: 'cPMode='+cPMode+';cPRange='+cPRange+';doCapture=true;'+'cPSize='+cPSize+';preventCursor=false;chListener ("'+cPMode+'")'});
	});*/
	if (toggle['tab_'+tab] === false)
			chrome.tabs.executeScript(null, {code: 'cPMode='+cPMode+';cPRange='+cPRange+';doCapture=true;'+'cPSize='+cPSize+';preventCursor=false;chListener ("'+cPMode+'")'});
});

function pickColor (request) {
	var pixels, x = request.x, y = request.y, xS1, yS1, xS2, yS2, r=(cPRange-1)/2, pixel = [0,0,0];
	
	xS1 = x - (x-r<0 ? x : r); yS1 = y - (y-r<0 ? y : r);
	xS2 = cPRange - (x<=r ? r-x : 0) - (x+r>request.win[0] ? r-request.win[0]+x+1 : 0);
	yS2 = cPRange - (y<=r ? r-y : 0) - (y+r>request.win[1] ? r-request.win[1]+y+1 : 0);
	ctx.drawImage(img, xS1, yS1, xS2, yS2, 0, 0, xS2, yS2);
	pixels = ctx.getImageData(0, 0, xS2, yS2).data;
	for(n=0, m=pixels.length; n<m; n+=4) {pixel[0]+=pixels[n]; pixel[1]+=pixels[n+1]; pixel[2]+=pixels[n+2]}
	pixel[0]=Math.round(pixel[0]/m*4); pixel[1]=Math.round(pixel[1]/m*4); pixel[2]=Math.round(pixel[2]/m*4);
	chrome.tabs.executeScript(null, {code: 'cP.cP.style.display=\'\';preventCursor=false;doCapture=false;cPRanger.childNodes[1].style.cursor=\'\';cP.importColor(\'rgb('+pixel[0]+','+pixel[1]+','+pixel[2]+')\')'});
}

function toggleCP (tab) {
	cTab = tab.id;
	// avoids colorPicker to be created twice
	if (toggle['tab_'+cTab]) chrome.tabs.executeScript(null, {file: "colorPicker.js"});
	else if (cPOff['tab_'+cTab]) chrome.tabs.executeScript(null, {code: 'cP(event)'});
}

function captureImage(request) {
	if (request.capture) {
		chrome.tabs.captureVisibleTab(null, {format: 'png'}, function(dataUrl) {
			img.onload = function() {pickColor(request)};
			img.src = dataUrl; dataUrl=null;
		});
	} else pickColor(request);
}

chrome.browserAction.setBadgeBackgroundColor({color:[0, 0, 0, 1]});
chrome.browserAction.setBadgeText({text:'0.9'});

/*var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-16695391-2']);
_gaq.push(['_trackPageview']);

(function() {
	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	ga.src = 'https://ssl.google-analytics.com/ga.js';
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();*/

</script>
</head>
</html>