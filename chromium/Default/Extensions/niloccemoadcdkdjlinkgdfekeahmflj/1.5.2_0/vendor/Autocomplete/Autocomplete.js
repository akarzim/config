////////////////////////////////////
//
// Autocomplete
// MIT-style license. Copyright 2012 Matt V. Murphy
//
////////////////////////////////////
(function(e,t,n){"use strict";var r,i=function(t,r){(this.element=typeof t=="string"?h(t):t)&&(this.element.tagName||"").toLowerCase()==="input"&&(this.boundCheckValue=l(this.checkValue,this),this.cache={},this.container=null,this.elementHasFocus=!1,this.highlightIdx=-1,this.lastValue="",this.shownValues=[],this.throttle=-1,this.usesTouch=e.ontouchstart!==n,this.values=[],this.setOptions(r),this.init())};(r=i.prototype).nothing=function(){},r.setOptions=function(e){var t=Object.prototype.hasOwnProperty,r;this.options={useNativeInterface:!0,offsetTop:0,offsetLeft:0,highlightColor:"#ffffff",highlightBgColor:"#3399ff",srcType:"",srcData:"",srcCleanData:[],onInput:this.nothing,valueSelectedCallback:n};if(e)for(r in this.options)t.call(this.options,r)&&e[r]!==n&&(this.options[r]=e[r])},r.init=function(){var e=this.options.srcType,n,r,i;this.values=e==="array"?(this.options.srcData||[]).concat():e==="dom"?this.getDomValues():e==="xml"?this.getXmlValues():[],this.valuesShownWithNoEntry=this.options.srcCleanData;if(p&&this.options.useNativeInterface)return this.options.onInput!==this.nothing&&u(this.element,"input",this.boundCheckValue),this.setDatalist();p&&(r=this.element.getAttribute("list"))&&((n=h(r))&&n.parentNode.removeChild(n),this.element.removeAttribute("list")),i=l(this.setElementFocus,this),u(this.element,"focus",i),u(this.element,"blur",i),t.activeElement===this.element&&i({type:"focus"})},r.getDomValues=function(){var e=this.element.getAttribute("list"),t=e?(h(e)||{}).parentNode:null,r=t?t.getElementsByTagName("option"):[],i,s,o,u=[];for(s=0,o=0;i=r[s];s++)(i=i.value)!==n&&(u[o++]=i);return u},r.getXmlValues=function(){var e=o(this.options.srcData),t,n,r,i,s,u=[];if(t=(e.getElementsByTagName("datalist")[0]||{}).childNodes)for(r=0,s=0;n=t[r];r++)n.nodeName==="option"&&(i=n.getAttribute("value"))!==null&&(u[s++]=i);return u},r.setDatalist=function(){var e=this.element.getAttribute("list"),n=this.container=e&&h(e);n?this.options.srcType!=="dom"&&(n.innerHTML=this.generateDatalistOptionsHtml()):(n=this.container=t.createElement("datalist"),n.id="list"+Math.ceil(Math.random()*5e4),n.innerHTML=this.generateDatalistOptionsHtml(),this.element.parentNode.appendChild(n),this.element.setAttribute("list",n.id))},r.generateDatalistOptionsHtml=function(){return this.values.length?'<option value="'+this.values.join('"><option value="')+'">':""},r.setElementFocus=function(t){var n=((t||e.event).type||"").toLowerCase()==="focus";(this.elementHasFocus=n)?(this.container||(this.lastValue=this.element.value,this.generateContainer(),this.addInputListeners(t)),this.lastValue=-1,this.checkValue(t)):this.shownValues.length&&this.clearValues()},r.generateContainer=function(){var r=t.createElement("div"),i=this.container=t.createElement("div"),s,o,f;if((o=e.getComputedStyle)&&(o=o(this.element,null)))f=o.getPropertyValue("display");else if(o=this.element.currentStyle)f=o.display;i.className="aCon",this.usesTouch?(u(i,"touchstart",l(this.highlightValue,this)),u(i,"touchend",l(this.selectValue,this))):(u(i,"mousemove",l(this.highlightValue,this)),v===n||v>=9?(u(i,"mousedown",a),u(i,"mouseup",l(this.selectValue,this))):u(i,"mousedown",l(this.selectValue,this))),(s=i.style).minWidth=this.element.offsetWidth+"px",s.marginLeft=this.options.offsetLeft+"px",s.marginTop=this.element.offsetHeight+this.options.offsetTop+"px",r.className="aWrapper",r.style.display=f||"block",r.appendChild(i),this.element.parentNode.insertBefore(r,this.element.nextSibling)},r.insertAfter=function(e,t){e.parentNode.insertBefore(t,e.nextSibling)},r.addInputListeners=function(e){var t;v===n||v>=9?(u(this.element,"input",this.boundCheckValue),v===9&&(t=l(this.toggleSelectionChangeEvent,this),u(this.element,"focus",t),u(this.element,"blur",t),t(e))):u(this.element,"propertychange",l(this.checkForValuePropertyChange,this)),u(this.element,"keydown",l(this.performKeyAction,this))},r.toggleSelectionChangeEvent=function(e){e.type==="focus"?u(t,"selectionchange",this.boundCheckValue):f(t,"selectionchange",this.boundCheckValue)},r.checkForValuePropertyChange=function(){this.elementHasFocus&&e.event.propertyName==="value"&&this.checkValue(e.event)},r.checkValue=function(e){var t=this.element.value,n=this.lastValue;t!==n&&(this.matchValue(t),this.options.onInput.apply(this,[t,n]),this.lastValue=t)},r.matchValue=function(e){var t=e.split(",");e=t[t.length-1].replace(/(^\s+|\s+$)/g,"");var n,r,i,s,o,u=[],a=0;if(!p||!this.options.useNativeInterface){if(e){if(!(o=this.cache["r-"+e])){n=this.cache.escapeRgx||(this.cache.escapeRgx=/([-.*+?^${}()|[\]\/\\])/g),i=new RegExp("^("+e.replace(n,"\\$1")+".*)$","igm"),s=this.cache.values||(this.cache.values=this.values.sort().join("\n"));while(r=(i.exec(s)||[])[0])if(e!==r){u[a++]=r;if(a===6)break}o=this.cache["r-"+e]=u}}else o=this.valuesShownWithNoEntry.slice(0,10);o&&o.length?this.showValues(o):this.clearValues()}},r.performKeyAction=function(t){var n=(t=t||e.event).which||t.keyCode,r={9:1,13:1,27:1,38:1,40:1},i,s;r[n]&&(n===9||n===13?this.highlightIdx>-1?this.selectValue(t):n===13&&e.opera?e.setTimeout(l(this.clearValues,this),0):this.clearValues():n===27?this.clearValues():((s=this.shownValues.length)?n===40&&this.highlightIdx===s-1?this.setHighlightedIndex(0):n===38&&this.highlightIdx===0?this.setHighlightedIndex(s-1):this.setHighlightedIndex(this.highlightIdx+(n===38?-1:1)):this.checkValue(t),a(t)))},r.showValues=function(e){var t=[],n=0,r=/</g,i="&lt;",s,o;t[n++]="<ul class='aList'>";for(o=0,s=e.length;o<s;o++)t[n++]="<li data-idx='"+o+"' class='aLim'>"+e[o].replace(r,i)+"</li>";t[n++]="</ul>",this.highlightIdx=-1,this.shownValues=e.concat(),this.container.innerHTML=t.join(""),this.setHighlightedIndex(0)},r.highlightValue=function(t){var n,r,i,s;if(this.usesTouch||this.throttle++&1){n=(t=t||e.event).target||t.srcElement,r=n.className||"";while(r.indexOf("aLim")===-1&&r!=="aCon")r=(n=n.parentNode).className||"";r.indexOf("aLim")>-1&&(s=parseInt(n.getAttribute("data-idx")||-1,10))>-1&&this.setHighlightedIndex(s)}},r.setHighlightedIndex=function(e){var t,n;if((e=Math.max(-1,e))!==this.highlightIdx&&e<this.shownValues.length){if(e>-1||this.highlightIdx>-1)t=this.container.firstChild.children;e>-1&&((n=t[e].style).color=this.options.highlightColor,n.backgroundColor=this.options.highlightBgColor),this.highlightIdx>-1&&((n=t[this.highlightIdx].style).color="",n.backgroundColor=""),this.highlightIdx=e}},r.selectValue=function(t){var r=(t=t||e.event).type.toLowerCase(),i=r!=="keydown"||(t.which||t.keyCode)!==9,s,o;(r.indexOf("mouse")>-1||r.indexOf("touch")>-1)&&((s=t.target||t.srcElement).className||"").indexOf("aLim")>-1&&(o=parseInt(s.getAttribute("data-idx")||-1,10))>-1&&(this.highlightIdx=o);if(this.highlightIdx>-1){var u=this.shownValues[this.highlightIdx],f=this.element.value.split(","),l=f.length;for(var c=0;c<l;c++)f[c]=f[c].replace(/(^\s+|\s+$)/g,"");f.length>1?(f[f.length-1]=u,this.element.value=f.join(", ")+", "):this.element.value=u+", ",this.clearValues(),this.checkValue(t),this.options.valueSelectedCallback!==n&&this.options.valueSelectedCallback()}if(i)return this.element.focus(),a(t)},r.clearValues=function(){this.highlightIdx=-1,this.lastValue="",this.shownValues=[],this.container.innerHTML=""},r.addValues=function(e){var t,r,i;if(e&&e.length){r=i=(t=this.values).length;for(var s=0,o;(o=e[s])!==n;s++)o&&c(t,o)===-1&&(t[i++]=o);i>r&&this.refresh()}},r.removeValues=function(e){var t,r,i,s;if(e&&e.length){r=i=(t=this.values).length;for(var o=0,u;(u=e[o])!==n;o++)u&&(s=c(t,u))>-1&&t.splice(s,1);t.length<r&&this.refresh()}},r.refresh=function(){this.cache={},p&&this.options.useNativeInterface?this.container.innerHTML=this.generateDatalistOptionsHtml():this.highlightIdx===-1&&this.matchValue(this.lastValue)};var s=function(){var e,t;return(e=navigator).appName==="Microsoft Internet Explorer"&&(new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})")).exec(e.userAgent)&&(t=parseFloat(RegExp.$1)),t>5?t:n},o=function(t){var n,r,i;return(n=typeof t)==="string"?e.DOMParser?i=(new DOMParser).parseFromString(t,"text/xml"):e.ActiveXObject&&(i=new ActiveXObject("Microsoft.XMLDOM"),i.async=!1,i.loadXML(t)):n==="object"&&(r=(t.ownerDocument||t).documentElement||{},r.nodeName&&r.nodeName.toUpperCase()!=="HTML"&&(i=t)),i||null},u=t.addEventListener?function(e,t,n){e.addEventListener(t,n,!1)}:function(e,t,n){e.attachEvent("on"+t,n)},a=function(e){return e.stopPropagation?(e.stopPropagation(),e.preventDefault()):(e.returnValue=!1,e.cancelBubble=!0),!1},f=t.addEventListener?function(e,t,n){e.removeEventListener(t,n,!1)}:function(e,t,n){e.detachEvent("on"+t,n)},l=function(e,t){var n=d.call(arguments,2);return function(){return e.apply(t,n.concat(d.call(arguments)))}},c=[].indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},h=function(e){return t.getElementById(e)},p=!!("list"in t.createElement("input")&&t.createElement("datalist")&&e.HTMLDataListElement),d=Array.prototype.slice,v=s();e.Autocomplete=i})(this,this.document);