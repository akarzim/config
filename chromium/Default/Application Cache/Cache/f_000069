/*
 * Copyright (c) 2012 Amazon.com, Inc. All rights reserved.
 */
function KindleBookDownloaderFactory(b){var f=5E3,e=0,l=1E3,a={};b.downloader=a;a.type=b.type;a.asin=b.asin;a.cache=b.cache;a.readAheadActive=!1;a.readAheadPauseCount=0;a.dbPutter=b.dbPutter;a.dbGetIdList=b.dbGetIdList;a.dbOosHandler=b.dbOosHandler;a.dbCheckCache=b.dbCheckCache;a.dbIsCached=b.dbIsCached;a.dbIsOos=b.dbIsOos;a.netGetter=b.netGetter;a.urlGetter=b.urlGetter;a.fileGetter=b.fileGetter;a.fileProgress=b.fileProgress;a.downloadError=b.downloadError;a.isIdRequired=b.isIdRequired||function(){return!0};
a.pauseReadAhead=function(){this.readAheadPauseCount++};a.resumeReadAhead=function(a){this.readAheadPauseCount=Math.max(0,--this.readAheadPauseCount);if(this.readAheadPauseCount===0)this.nextReadAheadId=a};a.removeIdFromReadAhead=function(a){if(this.readAheadActive){var b;for(b=0;b<this.readAheadIds.length;b++)if(this.readAheadIds[b]===a){this.readAheadIds.splice(b,1);break}for(b=0;b<this.readAheadUrls.length;b++)if(this.readAheadUrls[b].id===a){this.readAheadUrls.splice(b,1);break}}};a.readAheadOne=
function(a){function b(){n.readAheadActive&&(n.numReadAheadNetRequests--,n.readAheadUrls.length===0?n.numReadAheadNetRequests===0&&setTimeout(function(){n.getReadAheadUrls(a)},n.interReadWait):setTimeout(function(){n.readAheadOne(a)},n.interReadWait))}function d(){b()}function c(a){function c(){n.readAheadRemaining--;n.fileProgress(n.readAheadRemaining);b()}var k;k=a.fragmentMetadata!==void 0?a.fragmentMetadata.id:a.skeletonMetadata!==void 0?a.skeletonMetadata.id:a.glyphFragmentMetadata!==void 0?
a.glyphFragmentMetadata.id:void 0;var h=[];h[k]=a;n.dbPutter(h,c,function(a){function k(){n.dbPutter(h,c,d)}function d(){n.readAheadActive=!1;n.dbIsOos()}!(a.code===Kindle.DB.CONSTRAINT_ERR||a.message==="constraint failed")&&a.code===Kindle.DB.QUOTA_ERR?(n.dbCheckCache(),n.dbOosHandler(k,d)):b()})}var n=this;if(a===this.readAheadGeneration)if(n.readAheadStillAlive++,this.readAheadPauseCount>0)setTimeout(function(){n.readAheadOne(a)},n.startReadWait);else if(n.readAheadUrls.length===0&&n.numReadAheadNetRequests===
0)n.getReadAheadUrls(a);else for(;n.numReadAheadNetRequests<n.numReadAhead&&n.readAheadUrls.length>0;){n.numReadAheadNetRequests++;var k=n.readAheadUrls.shift();n.fileGetter(k,c,d)}};a.getReadAheadUrls=function(a){function b(k){c.readAheadUrls=k;setTimeout(function(){c.readAheadOne(a)},c.interReadWait)}function d(){}var c=this;if(a===this.readAheadGeneration&&this.readAheadActive)if(c.dbCheckCache()){c.readAheadStillAlive++;for(var n=[],k=0;k<c.readAheadIds.length&&c.readAheadIds[k]<c.nextReadAheadId;)k++;
k===c.readAheadIds.length&&(k=0);n=c.readAheadIds.splice(k,c.numReadAheadUrls);n.length===0?c.refreshReadAheadList(a):(c.nextReadAheadId=k<c.readAheadIds.length?c.readAheadIds[k]:0,c.urlGetter(n,b,d))}else c.readAheadActive=!1};a.refreshReadAheadList=function(b){function e(k){function d(){c.getReadAheadUrls(b)}var j=n.createSubTimer("success");c.readAheadStillAlive++;var o,s=[];for(o in k)s[k[o]]=!0;c.readAheadIds=[];for(o=0;o<=c.maxReadAheadId;o++)!s[o]&&a.isIdRequired(o)&&c.readAheadIds.push(o);
j.addCount("needed",c.readAheadIds.length);j.addCount("total",c.maxReadAheadId+1);j.endTimer();n.endTimer();n.log();if(c.readAheadIds.length>0){if(c.readAheadRemaining=c.readAheadIds.length,c.readAheadRemaining!==c.readAheadRemainingPrev)c.readAheadRemainingPrev=c.readAheadRemaining,setTimeout(d,c.startReadWait)}else c.readAheadActive=!1,c.dbIsCached()}function d(){n.endTimer();c.downloadError(Kindle.ERROR.UNKNOWN_DB_ERROR)}var c=this;if(b===this.readAheadGeneration){var n;this.readAheadActive&&(n=
KindleMetricsProfiler("bookDownloader.getIdList"),this.dbGetIdList(e,d))}};a.readAheadWatchdog=function(){var a=this;if(this.readAheadActive){if(this.readAheadStillAlive===0)this.readAheadGeneration++,this.readAheadRemaining<this.generationReadAheadRemaining?(this.numReadAheadNetRequests=0,this.generationReadAheadRemaining=this.readAheadRemaining,this.readAheadRemainingPrev=this.readAheadRemaining+1,this.watchDogTimeout=15E3,this.refreshReadAheadList(this.readAheadGeneration)):this.timeoutRetry?(this.generationReadAheadRemaining=
this.readAheadRemaining+1,this.watchDogTimeout=12E4):this.downloadError(Kindle.ERROR.TIMEOUT);setTimeout(function(){a.readAheadWatchdog()},this.watchDogTimeout)}this.readAheadStillAlive=0};a.startReadAhead=function(b,m){var d=this,c=f;if(this.cache){this.readAheadUrls=[];this.readAheadIds=[];this.numReadAheadNetRequests=this.nextReadAheadId=0;this.maxReadAheadId=b;this.readAheadActive=!0;this.readAheadGeneration=this.readAheadStillAlive=0;this.readAheadRemaining=b+1;this.readAheadRemainingPrev=this.readAheadRemaining+
1;this.generationReadAheadRemaining=b+2;this.watchDogTimeout=15E3;for(var n=this.numIds=0;n<=b;n++)a.isIdRequired(n)&&this.numIds++;m?(this.startReadWait=this.interReadWait=c=0,this.numReadAhead=8,this.numReadAheadUrls=200):(this.startReadAheadWait=f,this.interReadWait=e,this.startReadWait=l,this.numReadAhead=4,this.numReadAheadUrls=20,this.timeoutRetry=!0);this.debugCounter=15;setTimeout(function(){d.readAheadWatchdog()},c)}else this.readAheadActive=!1};a.cancelReadAhead=function(){this.readAheadActive=
!1;this.readAheadGeneration=-1;this.readAheadIds=this.readAheadUrls=null};a.setReadAheadTimersForTestMode=function(){l=e=f=0};return a}
function KindleReaderBookInfoProviderFactory(){var b=3E4,f="fragment",e="glyph",l="skeleton",a="resource",h="locationMap",m=f+"Ids",d=e+"Ids",c=l+"Ids",n=a+"Ids",k=h+"Ids",q=[f,e,l,a,h],j="book_context",o="book_metaData",s="book_manifest",g="book_key",r="book_fragmap",H="book_ok_to_download",u="book_skeleton_builder",x="book_resource_urls";return{BookInfo:function(t,M){function G(){var a=new jQuery.Deferred;KindleLibraryBookCover.getOfflineCover(y).then(function(c){p.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb().getTable("covers").insertRecord({asin:y,
coverData:c}).then(a.resolve,a.reject)},a.reject);return a.promise()}function z(a){function c(){var g=p.getModuleSync(j);v.savePinningFinishState(a,g).then(k.resolve,k.reject);b&&(w.endMetrics(P),P=null)}function g(){b&&(w.endMetrics(P),P=null);k.reject(Kindle.ERROR.NETWORK)}var b,k=new jQuery.Deferred;P||(P=w.startMetrics("SetOfflineState"),b=!0);V().done(function(){var b;p.isModuleInitialized(j)?(b=p.getModuleSync(j),b.isSample?c():(b={asin:y,kindleSessionId:b.kindleSessionId,isOffline:a===Kindle.BookInfo.CachedState.PINNED},
p.getModuleSync(p.SERVICE_CLIENT).setOfflineStatus(b).then(c,g))):k.reject()});return k.promise()}function B(){ma&&(ma.endTimer(),ma.log(),ma=null);var a=F!==na&&F!==Kindle.BookInfo.CachedState.PINNED?z(na):!0;$.when(a).then(function(){G().then(fa.resolve,fa.resolve)},function(a){a===Kindle.ERROR.NETWORK?fa.reject(a):fa.reject(Kindle.ERROR.UNKNOWN_DB_ERROR)});v.getBookStatistics().then(function(a){I.metricId&&(a.fragments!==void 0&&(w.increaseSubCounter(I.metricId,"fragmentCount",a.fragments.count),
w.increaseSubCounter(I.metricId,"fragmentsSize",a.fragments.size)),a.glyphs!==void 0&&(w.increaseSubCounter(I.metricId,"glyphCount",a.glyphs.count),w.increaseSubCounter(I.metricId,"glyphsSize",a.glyphs.size)),w.endMetrics(I.metricId))},function(){I.metricId&&w.endMetrics(I.metricId)})}function A(a,c,b){function k(a,j,o){function n(a){if(a.skeletonMetadata!==void 0&&a.skeletonMetadata.encryption===1){var b=KindleO_Aaa.o_aad(a.skeletonData,r);a.skeletonData=b;delete a.skeletonMetadata.encryption}c(a)}
function d(a,c){b(null,c,null,o)}var r;p.getModule(g).then(function(c){r=c;D(a,n,d,j)},b)}function n(a,j,k){function o(a){if(a.fragmentMetadata!==void 0&&a.fragmentMetadata.encryption===1){var b=KindleO_Aaa.o_aad(a.fragmentData,r);a.fragmentData=b;delete a.fragmentMetadata.encryption}c(a)}function d(a,c){b(null,c,null,k)}var r;p.getModule(g).then(function(c){r=c;D(a,o,d,j)},b)}function d(a,g,j){D(a,function(a){if(a.glyphFragmentMetadata!==void 0)a.glyphFragmentMetadata.id=j;c(a)},function(a,c){b(null,
c,null,j)},g)}function r(a,g,j){D(a,function(a){c(a)},function(a,c){b(null,c,null,j)},g)}function h(a,g,j){D(a,function(a){c(a)},function(a,c){b(null,c,null,j)},g)}var j;if(a.skeletonUrls){var o=a.skeletonUrls;for(j=0;j<o.length;j++)k(o[j].signedUrl,"loadSkeleton"+o[j].id,o[j].id)}if(a.fragmentUrls){o=a.fragmentUrls;for(j=0;j<o.length;j++)n(o[j].signedUrl,"loadFragment"+o[j].id,o[j].id)}if(a.glyphUrls){o=a.glyphUrls;for(j=0;j<o.length;j++)d(o[j].signedUrl,"loadGlyphFragment"+o[j].id,o[j].id)}if(a.resourceUrls){o=
a.resourceUrls;for(j=0;j<o.length;j++)r(o[j].signedUrl,"loadResource"+o[j].id,o[j].id)}if(a.locationMapUrls){a=a.locationMapUrls;for(j=0;j<a.length;j++)h(a[j].signedUrl,"loadMobiLocationMap"+a[j].id,a[j].id)}}function K(a,c){var b=new jQuery.Deferred;p.getModule(j).done(function(g){var j={asin:y,contentVersion:g.contentVersion,formatVersion:g.formatVersion,isSample:Y};if(g.kindleSessionId)j.kindleSessionId=g.kindleSessionId;if(g.basePath)j.basePath=g.basePath;if(g.useNewPath)j.useNewPath=g.useNewPath;
if(g.useProdBucket)j.useProdBucket=g.useProdBucket;j[a]=c;p.getModuleSync(p.SERVICE_CLIENT).getFileUrl(j).then(b.resolve,b.reject)});return b.promise()}function T(){var c=p.getModuleSync(o),b=p.getModuleSync(r),g=p.getModuleSync(u);Q?F===Kindle.BookInfo.CachedState.CACHED||F===Kindle.BookInfo.CachedState.PINNED?B():v.computeCacheQuota().then(function(){ma=KindleMetricsProfiler("readAhead");N[l].startReadAhead((b.fragmentMetadata.numberOfSkeletons||1)-1,oa);I.starting(l);N[f].startReadAhead(b.fragmentMetadata.numberOfFragments-
1,oa);I.starting(f);c.numOfGlyphFragments&&(N[e].startReadAhead(c.numOfGlyphFragments-1),I.starting(e));if(g.manifest.resourceManifest){var j=Math.max.apply(Math,Object.keys(g.manifest.resourceManifest));N[a].startReadAhead(j,oa);I.starting(a)}c.locationsInfo&&c.locationsInfo.numOfLocations&&(N[h].startReadAhead(Math.floor((c.locationsInfo.numOfLocations-1)/c.locationsInfo.mapSize),oa),I.starting(h))},fa.reject):fa.reject()}function L(a){for(var c=0;c<q.length;c++)N[q[c]]&&(N[q[c]].cancelReadAhead(),
N[q[c]]=null);fa.reject(a)}function J(){function a(c){w.startSubTimer(P,"getFragMap");var b=p.getModuleSync(j);D(b.fragmentMapUrl,function(a){c.resolve(a);w.endSubTimer(P,"getFragMap")},function(a,b){c.reject(b)},"loadFragmap")}p.isModuleRegistered(r)||p.registerModuleWithInitializer(r,a);return p.getModule(r)}function C(a){var c;a.cpr!==void 0&&(c={},KindleCompression.lzAddStringsToDictionary(a.cpr,c),KindleCompression.lzAddNumbersToDictionary(c),E=KindleCompression.lzGetDecompressionDictionary(c));
a.cprJson!==void 0&&(c={},KindleCompression.lzAddStringsToDictionary(a.cprJson,c,256),KindleCompression.lzAddNumbersToDictionary(c,256),ha=KindleCompression.lzGetDecompressionDictionary(c))}function U(){function a(c){w.startSubTimer(P,"getMetaData");var b=p.getModuleSync(j);D(b.metadataUrl,function(a){C(a);w.endSubTimer(P,"getMetaData");c.resolve(a)},function(a,b){c.reject(b)},"loadMetadata")}p.isModuleRegistered(o)||p.registerModuleWithInitializer(o,a);return p.getModule(o)}function ca(){function a(c){function b(a){w.endSubTimer(P,
"initManifest");c.resolve(a)}function g(){c.resolve({})}w.startSubTimer(P,"initManifest");var k=p.getModuleSync(j);k.manifestUrl?D(k.manifestUrl,b,g,"loadManifest"):c.resolve({})}p.isModuleRegistered(s)||p.registerModuleWithInitializer(s,a);return p.getModule(s)}function D(a,c,g,j){var k=new jQuery.Deferred;$.jsonp({url:a,callback:j,cache:!0,timeout:b,error:function(a,c){g&&g(a,c);k.reject(c)},success:function(a){c&&c(a);k.resolve(a)}});return k.promise()}function O(){var b={asin:y,type:f,cache:R,
netGetter:function(a,c,b){la(m,a,c,b)},dbGetter:function(a,c,b){v.getFragments(a).then(c,b)},dbGetIdList:function(a,c){v.getFragmentIds().then(a,c)},dbPutter:function(a,c,b){v.putFragments(a).then(c,b)},dbCheckCache:function(){var a=v.getCacheQuota();return a.cachedSize>a.cacheQuota?(L(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,c){p.getModuleSync(p.DB_CLIENT).getBookDb().deleteOldestBookData(y).then(a,c)},dbIsCached:function(){I.ended(this.type)},dbIsOos:function(){L(Kindle.ERROR.OUT_OF_SPACE)},
urlGetter:function(a,c,b){$.when(K(m,a)).then(function(a){c(a.fragmentUrls)},b)},fileGetter:function(a,c,b){A({fragmentUrls:[a]},c,b)},fileProgress:function(a){I.reportProgress(this.type,a)},downloadError:function(a){L(a)}};N[f]=KindleBookDownloaderFactory(b);Z[f]=KindleBookPieceManagerFactory(b);b={asin:y,type:l,cache:R,netGetter:function(a,b,g){la(c,a,b,g)},dbGetter:function(a,c,b){v.getSkeleton(a).then(c,b)},dbGetIdList:function(a,c){v.getSkeletonIds().then(a,c)},dbPutter:function(a,c,b){v.putSkeletons(a).then(c,
b)},dbCheckCache:function(){var a=v.getCacheQuota();return a.cachedSize>a.cacheQuota?(L(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,c){p.getModuleSync(p.DB_CLIENT).getBookDb().deleteOldestBookData(y).then(a,c)},dbIsCached:function(){I.ended(this.type)},dbIsOos:function(){L(Kindle.ERROR.OUT_OF_SPACE)},urlGetter:function(a,b,g){$.when(K(c,a)).then(function(a){b(a.skeletonUrls)},g)},fileGetter:function(a,c,b){A({skeletonUrls:[a]},c,b)},fileProgress:function(a){I.reportProgress(this.type,
a)},downloadError:function(a){L(a)}};N[l]=KindleBookDownloaderFactory(b);Z[l]=KindleBookPieceManagerFactory(b);b={asin:y,type:e,cache:R,netGetter:function(a,c,b){la(d,a,c,b)},dbGetter:function(a,c,b){v.getGlyphs(a).then(c,b)},dbGetIdList:function(a,c){v.getGlyphIds().then(a,c)},dbPutter:function(a,c,b){v.putGlyphs(a).then(c,b)},dbCheckCache:function(){return!0},dbOosHandler:function(a,c){v.deleteOldestBookData(y).then(a,c)},dbIsCached:function(){I.ended(this.type)},dbIsOos:function(){L(Kindle.ERROR.OUT_OF_SPACE)},
urlGetter:function(a,c,b){$.when(K(d,a)).then(function(a){c(a.glyphUrls)},b)},fileGetter:function(a,c,b){A({glyphUrls:[a]},c,b)},fileProgress:function(a){I.reportProgress(this.type,a)},downloadError:function(a){L(a)}};N[e]=KindleBookDownloaderFactory(b);Z[e]=KindleBookPieceManagerFactory(b);b={asin:y,type:a,cache:R,netGetter:function(a,c,b){la(n,a,c,b)},dbGetter:function(a,c,b){v.getResources(a).then(c,b)},dbGetIdList:function(a,c){v.getResourceIds().then(a,c)},dbPutter:function(a,c,b){v.putResources(a).then(c,
b)},dbCheckCache:function(){var a=v.getCacheQuota();return a.cachedSize>a.cacheQuota?(L(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,c){p.getModuleSync(p.DB_CLIENT).getBookDb().deleteOldestBookData(y).then(a,c)},dbIsCached:function(){I.ended(this.type)},dbIsOos:function(){L(Kindle.ERROR.OUT_OF_SPACE)},urlGetter:function(a,c,b){$.when(K(n,a)).then(function(a){c(a.resourceUrls)},b)},fileGetter:function(a,c,b){A({resourceUrls:[a]},c,b)},fileProgress:function(a){I.reportProgress(this.type,
a)},downloadError:function(a){L(a)},isIdRequired:function(a){var c=p.getModuleSync(u);return a in c.manifest.resourceManifest}};N[a]=KindleBookDownloaderFactory(b);Z[a]=KindleBookPieceManagerFactory(b);b={asin:y,type:h,cache:R,netGetter:function(a,c,b){la(k,a,c,b)},dbGetter:function(a,c,b){v.getLocations(a).then(c,b)},dbGetIdList:function(a,c){v.getLocationMapIds().then(a,c)},dbPutter:function(a,c,b){v.putLocations(a).then(c,b)},dbCheckCache:function(){var a=v.getCacheQuota();return a.cachedSize>
a.cacheQuota?(L(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,c){p.getModuleSync(p.DB_CLIENT).getBookDb().deleteOldestBookData(y).then(a,c)},dbIsCached:function(){I.ended(this.type)},dbIsOos:function(){L(Kindle.ERROR.OUT_OF_SPACE)},urlGetter:function(a,c,b){$.when(K(k,a)).then(function(a){c(a.locationMapUrls)},b)},fileGetter:function(a,c,b){A({locationMapUrls:[a]},c,b)},fileProgress:function(a){I.reportProgress(this.type,a)},downloadError:function(a){L(a)}};N[h]=KindleBookDownloaderFactory(b);
Z[h]=KindleBookPieceManagerFactory(b)}function W(){function c(b){p.getModuleList([o,s]).done(function(c){c=KindleBookSkeletonBuilderFactory(Z[l],Z[a],c[s],E);w.endSubTimer(P,"getSkeletonBuilder");b.resolve(c)}).fail(b.fail)}p.isModuleRegistered(u)||(w.startSubTimer(P,"getSkeletonBuilder"),p.registerModuleWithInitializer(u,c))}function aa(){function c(b){p.getModule(s).done(function(c){c=KindleBookResourceUrlTranslator(Z[a],c);w.endSubTimer(P,"getResourceUrlTranslator");b.resolve(c)}).fail(b.fail)}
p.isModuleRegistered(x)||(w.startSubTimer(P,"getResourceUrlTranslator"),p.registerModuleWithInitializer(x,c))}function V(){function a(c){var b=c.context&&c.metadata&&c.fragmap?c:null;if(c.cacheState){F=c.cacheState;if(F===Kindle.BookInfo.CachedState.PINNING)na=Kindle.BookInfo.CachedState.PINNED;Kindle.BookInfo.CachedState.isFullyDownloaded(F)&&p.registerModule(g,!0)}c.context!==void 0&&p.registerModule(j,c.context);c.metadata!==void 0&&(C(c.metadata),p.registerModule(o,c.metadata));c.manifest!==void 0?
p.registerModule(s,c.manifest):p.registerModule(s,{});c.fragmap!==void 0&&p.registerModule(r,c.fragmap);w.endSubTimer(P,"checkDB");X.resolve(b)}function c(a){function b(){window.location.reload(!0)}w.endSubTimer(P,"checkDB");a&&a.code===Kindle.DB.DATABASE_ERR&&a.message.indexOf("no such table")>=0&&w.emit("App::DatabaseGoneOnGetBookInfo",{breakdown:["Browser"]}).then(b,b);X.resolve()}if(!X){X=new jQuery.Deferred;w.startSubTimer(P,"checkDB");var b=p.getModuleSync(p.DB_CLIENT);b.getBookDb()?(v=b.getBookDb().BookInfoDB(y),
v.getBookInfo().then(a,c)):(R=Q=!1,c())}return X.promise()}function ia(){I.metricId=w.startMetrics("BookDownload::Reading");p.getModuleList([j,o,s,r,H]).done(function(a){var c=$.extend({},a[j]);delete c.kindleSessionId;a={metadata:a[o],manifest:a[s],fragmap:a[r],context:c,cacheState:qa};v&&R&&v.insertBookInfo(a)})}function ka(a,c){function b(a){var c,k=new jQuery.Deferred,n=w.createTimer();if(a)F=Kindle.BookInfo.CachedState.PARTIAL,c=Kindle.ERROR.FORCE_DELETE;else if(F===Kindle.BookInfo.CachedState.PINNED)qa=
F=Kindle.BookInfo.CachedState.PINNING,na=Kindle.BookInfo.CachedState.PINNED,c=Kindle.ERROR.PINNED_CONTENT_UPGRADE;else if(F===Kindle.BookInfo.CachedState.CACHED)F=Kindle.BookInfo.CachedState.PARTIAL,c=Kindle.ERROR.CONTENT_UPGRADE;p.getModuleSync(p.DB_CLIENT).getBookDb().deleteBooksData([y]).fail(k.reject).done(function(){p.detachModule(g);p.detachModule(r);p.detachModule(o);p.detachModule(s);p.detachModule(j);p.detachModule(u);p.detachModule(x);h=null;n.emit(a?"BookDownload::ForceDelete":"BookDownload::ContentUpgrade");
k.resolve(c)});return k.promise()}function k(a){function n(){var b;if(a.downloadRestrictionReason)m.reject(a.downloadRestrictionReason.reasonCode);else{b=q.createSubTimer("finishStartReading");if(p.isModuleInitialized(j)){var k=p.getModuleSync(j);if(k.contentVersion===a.contentVersion&&k.lastPageReadData&&a.lastPageReadData&&k.lastPageReadData.position!==a.lastPageReadData.position)k.lastPageReadData=a.lastPageReadData,v.updateBookContext(k);k.kindleSessionId=a.kindleSessionId}else p.registerModule(j,
a);if(a.isSample)Y=!0,da||(Q=R=!1),p.isModuleInitialized(g)||p.registerModule(g,!0);else if(t.isSample===!0){b.endTimer();q.endTimer();q.log();m.reject(Kindle.ERROR.UNKNOWN_ERR);return}a.contentChecksum&&!p.isModuleInitialized(g)&&p.registerModule(g,a.contentChecksum);h||(O(),W(),aa(),U(),ca(),ia());Z.setNetworkReady();b.endTimer();b=q.createSubTimer("resolve");m.resolve(!0);b.endTimer();q.endTimer();q.log();$.when(U(),ca(),J()).fail(function(){c("LoadFailure")});p.getModuleList([j,o,s,r,H]).done(T).fail(fa.reject)}}
l.endTimer();var d=h&&a.contentVersion&&a.contentVersion!==h.context.contentVersion,e=h&&a.formatVersion&&a.formatVersion!==h.context.formatVersion,f=a.downloadRestrictionReason&&a.downloadRestrictionReason.reasonCode,f=f===Kindle.ERROR.CONTENT_LOAN_ENDED||f===Kindle.ERROR.CONTENT_RENTAL_EXPIRED;S=d||e;d||e||f?b(f).then(n,m.reject):n()}function n(a){h?m.resolve(!1):m.reject(a);F===Kindle.BookInfo.CachedState.PINNED?fa.resolve():fa.reject(Kindle.ERROR.NETWORK)}function d(a){e.endTimer();h=a;w.startMetrics("Reader::StartReading");
l=q.createSubTimer("startReading");a=$.extend({asin:y},t);if(h&&h.context&&F===Kindle.BookInfo.CachedState.PINNED)a.kindleSessionId=h.context.kindleSessionId;f=ra(a);h&&(O(),W(),aa(),Z.setNetworkReady());f.then(k,n)}var h,q,e,l,f,m=new jQuery.Deferred;fa=new jQuery.Deferred;P=a;q=KindleMetricsProfiler("bookInfo.startReading");e=q.createSubTimer("getInfoFromDB");t.isSample===!0&&!da?d(null):V().done(d);ea=new jQuery.Deferred;p.registerModuleWithDeferred(p.BOOKINFO,ea);p.getModuleList([j,o,r]).done(function(){setTimeout(function(){ea.resolve(ja)},
15)}).fail(ea.reject);return m.promise()}function ga(){var a=t.bucket+"/"+t.asin+"/"+t.version;a+=t.sample===void 0?"/book":"/sample";var b={baseUrl:a,fragmentMapUrl:a+"/frags/gz_fragmap.jsonp",imageBaseUrl:a,locationMapUrl:a+"/locations.jsonp",metadataUrl:a+"/metadata.jsonp",mobiToHtmlUrl:a+"/mobiToHtml.jsonp",htmlToMobiUrl:a+"/htmlToMobi.jsonp",version:t.version,auth:t.auth?t.auth:"",contentKey:t.key?t.key:"",lastPageReadData:{deviceName:null,position:-1,syncTime:0}},g=b.contentKey;t.key&&(_deferredKey=
new jQuery.Deferred,_deferredKey.resolve());ra=function(){return(new jQuery.Deferred(function(a){a.resolve(g)})).promise()};la=function(a,g,j,k){var o=[],h=[],r=[],q=[];switch(a){case c:for(a=0;a<g.length;a++)r.push({id:g[a],signedUrl:b.baseUrl+"/frags/gz_skeleton"+g[a]+".jsonp"+b.auth});break;case m:for(a=0;a<g.length;a++)o.push({id:g[a],signedUrl:b.baseUrl+"/frags/gz_frag"+g[a]+".jsonp"+b.auth});break;case d:for(a=0;a<g.length;a++)h.push({id:g[a],signedUrl:b.baseUrl+"/glyphs/glyphFragment"+g[a]+
".jsonp"+b.auth});break;case n:for(a=0;a<g.length;a++)q.push({id:g[a],signedUrl:b.baseUrl+"/resources/resource"+g[a]+b.auth})}g={};if(r.length)g.skeletonUrls=r;if(o.length)g.fragmentUrls=o;if(h.length)g.glyphUrls=h;if(q.length)g.resourceUrls=q;A(g,j,k)}}var ea=null,ja,y=t.asin,Y,da=t.cacheSample,p=M||KindleModuleManager,w=p.getModuleSync(p.METRICS_MANAGER),S,ba=null,X=null,v=null,F=null,E=null,ha=null,Q=!0,R=!0,N={},I={totalChunks:0,starting:function(a){var c=N[a].numIds;this.totalChunks+=c;this[a]=
{downloading:!0,remaining:c}},ended:function(a){if(this[a])this[a].downloading=!1;this.isDownloading()||B()},isDownloading:function(){for(var a=0;a<q.length;a++)if(this[q[a]]&&this[q[a]].downloading)return!0;return!1},reportProgress:function(a,c){if(this[a]&&c!==this[a].remaining){this[a].remaining=c;for(var b=0,g=0;g<q.length;g++)this[q[g]]&&(b+=this[q[g]].remaining);g=this.totalChunks;pa&&pa(g-b,g)}}},Z={setNetworkReady:function(){for(var a=0;a<q.length;a++)this[q[a]]&&this[q[a]].setNetworkReady()}},
fa=null,pa=null,na=Kindle.BookInfo.CachedState.CACHED,oa=!1,qa=Kindle.BookInfo.CachedState.PARTIAL,ma=null,P=null,la=function(a,c,b,g){$.when(K(a,c)).then(function(a){A(a,b,g)},function(a,b,j){g(a,b,j,c)})},ra=function(a){var c=new jQuery.Deferred;p.getModuleSync(p.SERVICE_CLIENT).startReading(a).then(function(a){if(t.basePath)a.basePath=t.basePath;if(t.useNewPath)a.useNewPath=t.useNewPath;if(t.useProdBucket)a.useProdBucket=t.useProdBucket;c.resolve(a)},function(){c.reject("timeout")});return c.promise()};
t.bucket!==void 0&&ga();return ja={getBookInfoDfd:function(){return ea.promise()},getAsin:function(){return y},getRefEmId:function(){var a=p.getModuleSync(o);return a.refEmId||a.referenceEmbeddedId||a.guid},startReading:function(a,c){p.registerModule(H,!0);return ka(a,c)},doneReading:function(){for(var a=0;a<q.length;a++)N[q[a]]&&(N[q[a]].cancelReadAhead(),N[q[a]]=null)},getImageBaseUrl:function(){return p.getModuleSync(j).imageBaseUrl+"/"},getKindleSessionId:function(){return p.getModuleSync(j).kindleSessionId},
getFragmentMap:function(a,c){setTimeout(function(){p.getModule(r).then(a,c)},15)},getBookType:function(){return p.getModuleSync(r).fragmentMetadata.bookType},isBookSample:function(){return Y},getBookSkeleton:function(a,c,b){p.getModule(u).then(function(g){g.buildSkeleton(b).then(a,c)},c)},getBookFragments:function(a,c,b){Z[f].getPieces(b,function(c){if(c.fragmentMetadata.compression===1||c.fragmentMetadata.compression===2){c.fragmentData=KindleCompression.lzExpandWithStaticDictionary(c.fragmentData,
E);if(c.paraData!==void 0&&typeof c.paraData==="string"){var b=KindleCompression.lzExpandWithStaticDictionary(c.paraData,ha,256);c.paraData=JSON.parse(b)}delete c.fragmentMetadata.compression}a(c)},c)},getGlyphFragments:function(a,c,b){Z[e].getPieces(b,function(c){if(c.glyphFragmentMetadata.compression===1||typeof c.glyphData==="string"){var b=KindleCompression.lzExpandWithStaticDictionary(c.glyphData,ha,256);c.glyphData=JSON.parse(b);delete c.glyphFragmentMetadata.compression}a(c)},c)},getMetadata:function(a,
c){return p.getModule(o).then(a,c)},getResourceUrls:function(a,c,b){p.getModule(x).then(function(g){g.getResourceUrls(b,a,c)},c)},UNKNOWN_FPR:-1,getFurthestPositionReadData:function(){return p.getModuleSync(j).lastPageReadData||{}},getLocationConverter:function(){function a(c){var b=jQuery.Deferred();Z[h].getPieces([c],b.resolve,b.reject);return b}if(ba===null){var c={},b=p.getModuleSync(r),g=p.getModuleSync(o);c.locationsInfo=g.locationsInfo;c.minPosition=b.fragmentArray[0].cPos;c.maxPosition=b.fragmentArray[b.fragmentArray.length-
1].ePos;c.mapGetter=a;ba=KindleUserLocationConverter.getLocationConverter(b.fragmentMetadata.bookType,c)}return ba},hasCover:function(a,c){var b=$.Deferred();p.getModuleSync(j).manifestUrl?p.getModule(s).then(function(a){a=a.coverResource;b.resolve(a!==void 0&&a!==null)},b.reject):b.resolve(!1);return b.promise().then(a,c)},getCoverUrl:function(c,b){var g=$.Deferred();p.getModuleSync(j).manifestUrl?p.getModule(s).then(function(c){c=c.coverResource;c!==void 0&&c!==null&&Z[a].getPieces(c,function(a){g.resolve(a.data)},
g.reject)},g.reject):g.resolve(null);return g.promise().then(c,b)},getBookPositions:function(){var a=new jQuery.Deferred;p.getModule(o).then(function(c){var b=KindleModuleManager.getModuleSync(j);a.resolve({toc:c.positions.toc,srl:b.srl||c.positions.srl,cover:c.positions.cover})},a.reject);return a.promise()},startDownloading:function(a,c,b){na=Kindle.BookInfo.CachedState.PINNED;oa=!0;p.registerModuleWithDeferred(H,b);p.registerModuleWithDeferred(p.JOURNAL_MANAGER,KindlJournalManager.initialize());
KindleReaderAnnotationManager.deferredInitialize(y,p);return ka(a,c)},cancelDownloading:function(){L(Kindle.ERROR.CANCELLED)},getDownloadComplete:function(a){pa=a;return fa.promise()},isBookDownloaded:function(){return F===Kindle.BookInfo.CachedState.CACHED||F===Kindle.BookInfo.CachedState.PINNED},setCachedState:z,getSizeInfo:function(){var a=new jQuery.Deferred;$.when(p.getModule(o),v.computeCacheQuota()).then(function(c,b){a.resolve({bookSize:c.bookSize,quota:b})},a.reject);return a.promise()},
isUpdated:function(){return!!S}}}}}var KindleReaderBookInfoProvider=KindleReaderBookInfoProviderFactory();
function KindleBookPieceManagerFactory(b){function f(a){if(a.fragmentMetadata!==void 0)return a.fragmentMetadata.id;else if(a.skeletonMetadata!==void 0)return a.skeletonMetadata.id;else if(a.glyphFragmentMetadata!==void 0)return a.glyphFragmentMetadata.id;else if(a.metadata!==void 0)return a.metadata.id}var e={},l;e.type=b.type;e.asin=b.asin;e.cache=b.cache;e.dbGetter=b.dbGetter;e.dbPutter=b.dbPutter;e.downloader=b.downloader;e.netGetter=b.netGetter;e.getPieces=function(a,b,e){function d(a){for(var c in a)b(a[c]);
var k=[],n;for(n=0;n<j.length;n++)c=j[n],a[c]===void 0&&k.push(c);j=k;k.length>0?q(k):o.downloader.resumeReadAhead(g)}function c(){l||(l=new jQuery.Deferred);l.done(function(){q(j)})}function n(a){function c(){b(a)}var k=f(a);if(o.cache){var j=[];j[k]=a;o.dbPutter(j,c,c);o.downloader.removeIdFromReadAhead(k);--s===0&&o.downloader.resumeReadAhead(g)}else b(a)}function k(a,c,b,j){var d;Object.prototype.toString.call(j)==="[object Array]"?(d=j,j="list"):d=[j];r[j]=r[j]+1||1;r[j]<=2?o.netGetter(d,n,k):
(e(a,c,b),--s===0&&o.downloader.resumeReadAhead(g))}function q(a){s=a.length;o.netGetter(a,n,k)}Object.prototype.toString.call(a)!=="[object Array]"&&(a=[a]);var j=a.slice(0),o=this,s=0,g=Math.max.apply(Math,j)+1,r=[];this.cache?(this.downloader.pauseReadAhead(),this.dbGetter(a,d,c)):q(a)};e.setNetworkReady=function(){l||(l=new jQuery.Deferred);l.resolve()};return e}
function KindleBookSkeletonBuilderFactory(b,f,e,l){function a(a,b){b&&(a=a.replace(/\burl\s*\(\s*(?:'([^']*)'|"([^"]*)")\s*\)/gi,function(a,c,j){return(c=b[c||j])?'url("'+c+'")':c===null?"none":a}));return a}function h(a,b,k,d){a=a.includes;if(a!==void 0){for(var j,o=0;o<a.length;o++){var h=d[a[o]],g=b[h.metadata.id];if(g.type==="text/css")j=j||{},j[g.name]=h.data}if(j)k.skeletonData=k.skeletonData.replace(/<link\s(?:[^\/>'"]|'[^']*'|"[^"]*")*href\s*=\s*(?:'([^']*)'|"([^"]*)")(?:[^\/>'"]|'[^']*'|"[^"]*")*(?:\/>|>\s*<\/link>)/gi,
function(a,c,b){return(c=j[c||b])?'<style type="text/css">'+c+"</style>":a})}}function m(c,b,k,d){if(k!==null){var j=c.resourceManifest,c=c.skeletonManifest[b.skeletonMetadata.id],o;for(o in k){var e=k[o],g=j[e.metadata.id].includes;if(g!==void 0){for(var r={},f=0;f<g.length;f++){var l=k[g[f]];r[j[g[f]].name]=l===void 0?null:l.data}e.data=a(e.data,r)}}h(c,j,b,k);k=c.depends;if(k!==void 0){o=[];for(c=0;c<k.length;c++)e=j[k[c]],e.resInfo!==void 0&&o.push(e.resInfo);b.resourceInfo=o}}d.resolve(b)}var d=
{};d.skeletonManager=b;d.resourceManger=f;d.manifest=e;d.dictionary=l;d.buildSkeleton=function(c){function b(c){c.data=a(c.data,c.resList);r[c.metadata.id]=c;o++;g!==null&&o>=j&&m(e,g,r,k)}var k=new jQuery.Deferred,d=this.dictionary,j=0,o=0,h=[];if(this.manifest.skeletonManifest!==void 0&&this.manifest.skeletonManifest[c]!==void 0&&this.manifest.skeletonManifest[c].depends!==null)h=this.manifest.skeletonManifest[c].depends.slice(),j=h.length;var g=null,r=null,e=this.manifest;this.skeletonManager.getPieces([c],
function(a){if(a.skeletonMetadata.compression===1)a.skeletonData=KindleCompression.lzExpandWithStaticDictionary(a.skeletonData,d),delete a.skeletonMetadata.compression;o>=j?m(e,a,r,k):g=a},k.reject);j>0&&(r={},this.resourceManger.getPieces(h,b,k.reject));return k.promise()};return d}
var KindleCompression=function(){function b(a,c,b){var j,b=b>0?b:h;for(j in c)c[j]>=b&&(b=c[j]+1);j=b;for(var d in a)for(var b=a[d],e=2;e<=b.length;e++){var g=b.substr(0,e);c.hasOwnProperty(g)||(c[g]=j++)}return c}function f(a,b){var e,j=h;e="";for(var o=0;o<b.length;){var f=b.charAt(o);o++;f.charCodeAt(0)<=l?a.hasOwnProperty(e+f)?e+=f:(e.length>0&&j<m&&(a[e+f]=j,j++,j===d&&(j=c)),e=f):e=""}return a}function e(){if(defaultDictionary===void 0||defaultDictionary==={})defaultDictionary=f({},defaultDictionaryString);
return defaultDictionary}var l=9983,a=l+1,h=a+100+1,m=65533,d=55295,c=57344;return{lzCompress:function(b){var k={},e=[],j,o=h,f,g,r;f=j="";for(var H=0;H<b.length;){var u=b.charAt(H);H++;if(u.charCodeAt(0)<=l){for(;f.length>0;){g=Math.min(100,f.length);r=f.substr(0,g);f=f.substr(g);e.push(a+g);for(g=0;g<r.length;g++)e.push(r.charCodeAt(g))}k.hasOwnProperty(j+u)?j+=u:(j.length>0&&(e.push(j.length===1?j.charCodeAt(0):k[j]),o<m&&(k[j+u]=o,o++,o===d&&(o=c))),j=u)}else j.length>0&&(e.push(j.length===1?
j.charCodeAt(0):k[j]),j=""),f+=u}for(j.length>0&&e.push(j.length===1?j.charCodeAt(0):k[j]);f.length>0;){g=Math.min(100,f.length);r=f.substr(0,g);f=f.substr(g);e.push(a+g);for(g=0;g<r.length;g++)e.push(r.charCodeAt(g))}for(i=0;i<e.length;i++)e[i]=String.fromCharCode(e[i]);return e.join("")},lzExpand:function(b){for(var k={},e=[],j,o=h,f="",g,r=0;r<b.length;){j=b.charCodeAt(r);r++;if(j<=l)j=String.fromCharCode(j);else if(j>=h)(j=k[j])||(j=f+g);else{f=j-a;e.push(b.substr(r,f));r+=f;f="";continue}e.push(j);
g=j.charAt(0);o<m&&f.length>0&&(k[o]=f+g,o++,o===d&&(o=c));f=j}return e.join("")},lzBuildDictionary:f,lzGetDecompressionDictionary:function(a){var c=[],b;for(b in a)c[a[b]]=b;return c},lzAddStringsToDictionary:b,lzAddNumbersToDictionary:function(a,c){for(var d=[],j=100;j<1E3;j++)d.push(""+j);return b(d,a,c)},lzCompressWithStaticDictionary:function(c,b){if(b===void 0||b==={})b=e();var d=[],j,o,h,g;o=j="";for(var r=0;r<c.length;){var f=c.charAt(r);r++;if(f.charCodeAt(0)<=l){for(;o.length>0;){h=Math.min(100,
o.length);g=o.substr(0,h);o=o.substr(h);d.push(a+h);for(h=0;h<g.length;h++)d.push(g.charCodeAt(h))}b.hasOwnProperty(j+f)?j+=f:(j.length>0&&d.push(j.length===1?j.charCodeAt(0):b[j]),j=f)}else j.length>0&&(d.push(j.length===1?j.charCodeAt(0):b[j]),j=""),o+=f}for(j.length>0&&d.push(j.length===1?j.charCodeAt(0):b[j]);o.length>0;){h=Math.min(100,o.length);g=o.substr(0,h);o=o.substr(h);d.push(a+h);for(h=0;h<g.length;h++)d.push(g.charCodeAt(h))}for(i=0;i<d.length;i++)d[i]=String.fromCharCode(d[i]);return d.join("")},
lzExpandWithStaticDictionary:function(c,b,d){if(b===void 0||b===[]){if(defaultDeDictionary===void 0||defaultDeDictionary===[]){e();defaultDeDictionary=[];for(var j in defaultDictionary)defaultDeDictionary[defaultDictionary[j]]=j}b=defaultDeDictionary}j=l;var o=h;d!==void 0&&(j=d-1,o=d);for(var d=[],f=0;f<c.length;){var g=c.charCodeAt(f);f++;g<=j?d.push(String.fromCharCode(g)):g>=o?d.push(b[g]):(g-=a,d.push(c.substr(f,g)),f+=g)}return d.join("")}}}(),KindleO_Aaa=function(){function b(a){for(var c=
[],b,g,d,h,k,f,e=0;e<a.length;)b=a.charCodeAt(e++)&255,g=a.charCodeAt(e++)&255,d=a.charCodeAt(e++)&255,h=b>>2,b=(b&3)<<4|g>>4,k=(g&15)<<2|d>>6,f=d&63,isNaN(g)?k=f=64:isNaN(d)&&(f=64),c.push(l.charAt(h)+l.charAt(b)+l.charAt(k)+l.charAt(f));return c.join("")}function f(a,c){var b=[];b.length=256;for(var g=0;g<256;g++)b[g]=g;for(var d=0,h,g=0;g<256;g++)d=d+b[g]+c[g%c.length]&255,h=b[g],b[g]=b[d],b[d]=h;for(var d=g=0,k=[],f=0;f<a.length;f++)g=g+1&255,d=d+b[g]&255,h=b[g],b[g]=b[d],b[d]=h,k.push(String.fromCharCode(a.charCodeAt(f)^
b[b[g]+b[d]&255]));return k.join("")}function e(a,c){for(var b="",g=c?d:m,h=g.length,k=0;k<a;k++)b+=g.charAt(Math.floor(Math.random()*h));return b}for(var l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=[],h=0;h<l.length;h+=1)a[l.charCodeAt(h)]=h;for(var m="eeeeeeeeeeeeeeeeettttttttaaaaaaaaaaaaaaaaooooooiiiiiiinnnnssssrrrrhhhhllldddcccuuummmfffpoggwwyybbvkxjqz",d=m+"                                             ",c=[],n=0;n<10;n++)c[n]=e(15,!1);var k=["p","span","div","em",
"i","strong","b","a","big","small"],q=!1;return{iToStr:function(a,c,b){var g=new Image;g.onload=function(){var a=KindleHostDeviceDetector.isIE(),b=g.height,d=g.width,j=document.createElement("canvas").getContext("2d");j.drawImage(g,0,0);for(var h,k,f,e,n,l="",m=0,q,s=0;s<b;){h=j.getImageData(0,s,d,1);m=0;for(q=h.data.length-4;m<q;){k=h.data[m++]&7;f=h.data[m++]&3;e=h.data[m++]&7;m++;n=k*32+f*8+e;if(a){var J=void 0,J=0;n>=65&&n<=90||n>=50&&n<=55||n===0?J=n:(J=k>=2?-1:1,J=(k+J+8)%8*32+(f+J+4)%4*8+(e+
J+8)%8);J>=65&&J<=90||J>=50&&J<=55||(J=0);n=J}if(n===0)break;l+=String.fromCharCode(n)}if(n===0)break;s++}c(l)};g.onerror=function(){b()};g.src=a},o_aaa:b,o_aac:function(a,c){var d;d=a.replace(/\x0d\x0a/g,"\n");for(var g=[],k=0;k<d.length;k++){var e=d.charCodeAt(k);e<128?g.push(String.fromCharCode(e)):(e>127&&e<2048?g.push(String.fromCharCode(e>>6|192)):(g.push(String.fromCharCode(e>>12|224)),g.push(String.fromCharCode(e>>6&63|128))),g.push(String.fromCharCode(e&63|128)))}d=g.join("");g=c;g+="00000000000000000000000000000000".substring(0,
32-g.length);k=[];for(h=0;h<g.length;h+=2)k.push(parseInt(g.substring(h,h+2),16));return b(f(d,k))},o_aad:function(c,b){var d;d=[];for(var g,h,k,e,n,l=0;l<c.length;)g=a[c.charCodeAt(l++)],h=a[c.charCodeAt(l++)],e=a[c.charCodeAt(l++)],n=a[c.charCodeAt(l++)],g=g<<2|h>>4,h=(h&15)<<4|e>>2,k=(e&3)<<6|n,d.push(String.fromCharCode(g)),e!==64&&d.push(String.fromCharCode(h)),n!==64&&d.push(String.fromCharCode(k));d=d.join("");e=[];for(n=0;n<b.length;n++)e.push(b.charCodeAt(n));d=f(d,e);e=[];for(n=0;n<d.length;)l=
d.charCodeAt(n),l<128?(e.push(String.fromCharCode(l)),n++):l>191&&l<224?(g=d.charCodeAt(n+1),e.push(String.fromCharCode((l&31)<<6|g&63)),n+=2):(g=d.charCodeAt(n+1),h=d.charCodeAt(n+2),e.push(String.fromCharCode((l&15)<<12|(g&63)<<6|h&63)),n+=3);return e.join("")},o_aae:function(a){var b;if(!q){for(b=0;b<10;b++)$(c[b]).addClass("noDisplay");q=!0}var d=$(a).html(),g=!1,h="",f=0;for(b=0;b<d.length;b++)if(d[b]===">")g=!1;else if(d[b]==="<")g=!0;else if(b%60===7&&!g){h+=d.substring(f,b);var f=b,n=k[Math.floor(Math.random()*
k.length)];h+="<"+n+' class="'+c[Math.floor(Math.random()*c.length)]+'">'+e(30,!0)+"</"+n+">"}h+=d.substring(f,d.length);$(a).html(h)},o_aaf:function(a){a:{for(var b=0;b<c.length;b++)if(c[b]===a){a=!0;break a}a=!1}return a}}}(),KindleReaderAnnotationManager=function(){function b(a,c){return a.start-c.start}function f(a){for(var c=0;c<a.length;c++)if(a[c].guid&&!a[c].refEmId)a[c].refEmId=a[c].guid}function e(a){function c(){l(a).then(g.resolve,g.reject)}function b(){k(a).then(c,g.reject)}var g=new jQuery.Deferred;
g.then(function(){for(var c=0;c<a.length;c++)O.emit(m(a[c]))},function(){for(var c=0;c<a.length;c++)O.emit(m(a[c],"Fail"))});n(a);for(var d=0;d<a.length;d++){if(a[d].asin===void 0||a[d].refEmId===void 0||a[d].start===void 0||a[d].type===void 0)return O.emit(m(a[d],"Invalid")),KindleDebug.error("Tried to delete an invalid annotation."),g.reject().promise();if(a[d].note)a[d].note=j(a[d].note)}W.acquire().done(function(){D.saveToJournal(a).then(b,g.reject);g.then(W.release,W.release)});return g.promise()}
function l(c){function d(){for(var k,e=!1,j,f=0;f<c.length;f++)j=c[f],k=a(j.type,j.start),j.action===M?k===-1&&(C.push(j),e=!0):j.action===G?k!==-1&&(C.splice(k,1),C.push(j),e=!0):j.action===z&&k!==-1&&C.splice(k,1);e&&C.sort(b);h.resolve();g()}var h=new jQuery.Deferred;s().then(d,d);return h.promise()}function a(a,c){for(var b in C){var g=C[b];if(g.type===a&&g.start===c)return b}return-1}function h(c,b){return C[a(c,Number(b))]||null}function m(a,c){var b="Reader::"+K[a.action]+K[a.type];c&&(b+=
c);return b}function d(a){for(var c=(new Date).getTime(),b=0;b<a.length;b++)a[b].asin=T,a[b].refEmId=L,a[b].action=M,a[b].modifiedTimestamp=c;return a}function c(a){for(var c=(new Date).getTime(),b=0;b<a.length;b++)a[b].action=z,a[b].modifiedTimestamp=c;return a}function n(a){for(var c=0;c<a.length;c++)a[c].positionType=J;return a}function k(a){function c(){function d(a){e.context=a;c()}for(var h,k,e;g<a.length&&!(a[g].action===M&&(a[g].type===u||a[g].type===t));)++g;if(g<a.length){e=a[g++];switch(e.type){case u:h=
e.position;k=e.position+A;break;case t:h=e.start,k=e.end}q(h,k).then(d,c)}else b.resolve()}var b=new jQuery.Deferred,g=0;c();return b.promise()}function q(a,c){aa===null&&(aa=KindleRenderer.createWordIterator());return aa.getText(a,c)}function j(a){a.length>Kindle.opt.maxNoteChars&&(O.emit("Reader::NoteLengthLimitExceeded",{submetrics:[{name:"ResultSize",value:a.length}]}),a=a.substr(0,Kindle.opt.maxNoteChars));return a}function o(a,b,g,h){var k=KindleReaderAnnotationManager.getAnnotationsInRange(a,
b,t),j=k.length,f={type:t,start:a,position:g,end:b},n=[];h&&n.push.apply(n,d([{type:x,start:b,position:g,end:b,note:h}]));if(k.length===1&&a>=k[0].start&&b<=k[0].end){if(n.length===0)return(new jQuery.Deferred).resolve([k[0]])}else{if(j>0)f.start=Math.min(a,k[0].start),f.end=Math.max(b,k[j-1].end),n.push.apply(n,c(k));n.push.apply(n,d([f]))}return e(n)}function s(){function a(b){if(b[0])C=b[0].annotationsData,f(C);c.resolve()}var c=new jQuery.Deferred;U?U.getRecord(B,{asin:T},{annotationsData:!0}).then(a,
c.reject):c.reject();return c.promise()}function g(){var a=new jQuery.Deferred;U?U.insertRecord(B,{asin:T,annotationsData:C}).then(a.resolve,a.reject):a.reject();return a.promise()}function r(){function a(){b.resolve()}function c(){b.resolve()}var b=new jQuery.Deferred;ca.getAnnotations(T,L).then(function(b){C=b.annotations;f(C);g().then(a,c)},b.reject);return b.promise()}function H(){function a(){s().then(b.reject,b.reject)}function c(){r().then(b.resolve,a)}var b=new jQuery.Deferred;D.uploadJournal().then(c,
c);return b.promise()}var u="kindle.bookmark",x="kindle.note",t="kindle.highlight",M="create",G="modify",z="delete",B="annotationsCache",A=100,K={};K[u]="Bookmark";K[x]="Note";K[t]="Highlight";K[M]="Create";K[G]="Modify";K[z]="Delete";var T=null,L=null,J=null,C=null,U=null,ca=null,D=null,O,W=Lock(),aa=null;return{BOOKMARK:u,NOTE:x,HIGHLIGHT:t,POPULAR_HIGHLIGHT:"kindle.popular",SELECTION:"kindle.selection",deferredInitialize:function(a,c){function b(){d.resolve(h);KindleReaderMetrics.notifyAnnotationsReady()}
var g=c||KindleModuleManager,d=new jQuery.Deferred,h=this;C=[];T=a;g.getModuleList([g.BOOKINFO,g.SERVICE_CLIENT,g.DB_CLIENT,g.JOURNAL_MANAGER,g.METRICS_MANAGER]).then(function(a){L=a[g.BOOKINFO].getRefEmId();J=a[g.BOOKINFO].getBookType();ca=a[g.SERVICE_CLIENT];U=a[g.DB_CLIENT].getBookDb();D=a[g.JOURNAL_MANAGER];O=a[g.METRICS_MANAGER];H().then(b,b)},d.reject);return d.promise()},clear:function(){},getAnnotation:h,getAllAnnotations:function(){return C.slice()},getAnnotationsInRange:function(a,c,b){var g=
[],d;for(d in C){var h=C[d];(h.start<=c&&h.end>=a||h.start>=a&&h.start<=c)&&(!b||b===h.type)&&g.push(h)}return g},createBookmark:function(a){a=[{type:u,start:a,position:a,end:a,context:""}];d(a);return e(a)},createNote:o,modifyNote:function(a,c,b){var g=new jQuery.Deferred;if(a=h(x,a)){a.note=b;a.position=c;c=[a];b=(new Date).getTime();for(a=0;a<c.length;a++)c[a].action=G,c[a].modifiedTimestamp=b;e(c).then(g.resolve,g.reject)}else g.reject();return g.promise()},createHighlight:function(a,c,b){return o(a,
c,b,null)},deleteAnnotations:function(a){c(a);return e(a)},getContext:q}}();
function KindleBookResourceUrlTranslator(b,f){var e={};e.resourceManger=b;e.resourceManifest=f.resourceManifest;e.reverseLookup={};for(var l in e.resourceManifest)e.reverseLookup[e.resourceManifest[l].name]=l;e.getResourceUrls=function(a,b,e){function d(a){var c={};c[l[a.metadata.id].name]=a.data;b(c)}for(var c=[],f=0;f<a.length;f++){var k=this.reverseLookup[a[f]];k!==void 0&&c.push(k)}var l=this.resourceManifest;c.length!==a.length&&e();c.length>0?this.resourceManger.getPieces(c,d,e):b({})};return e}
function AssertionError(b){Error.call(this,b)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){return{multiColumnMode:function(){return!KindleHostDeviceDetector.isMetroArm()}}}(),KindleHostDeviceDetector=function(){function b(){return navigator.platform.indexOf("iPad")!==-1}function f(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function e(){return b()||f()||n()||l()}function l(){return navigator.userAgent.indexOf("Cloud9")!==
-1}function a(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function h(){return a()&&/arm/i.test(navigator.cpuClass)}function m(){return navigator.onLine}function d(){return"standalone"in navigator&&navigator.standalone}function c(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function n(){return navigator.userAgent.indexOf("PlayBook")!==-1}function k(){return!!window.navigator.msPointerEnabled}return{isiOS:e,isiPad:b,isiPhone:f,isiOS_4x:function(){return(b()||
f())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){var a;if(a=b()||f()){a=navigator.userAgent.indexOf("OS ");var c=0;if(a===-1)a=0;else{for(a+=3;/^\d$/.test(navigator.userAgent.charAt(a));)c=c*10+parseInt(navigator.userAgent.charAt(a),10),a++;a=c}a=a>=5}return a},isFirefox:function(){return navigator.userAgent.indexOf("Firefox")!==-1},isSafari:function(){return navigator.userAgent.indexOf("Safari")!==-1},isMetro:a,isMetroArm:h,isMetroSnappedView:function(){return a()&&$(window).width()===
320},isIE:function(){return navigator.userAgent.indexOf("MSIE")!==-1},isPlayBook:n,isCloud9:l,isTablet:function(){return b()||a()},isOnline:m,isNetworkAvailable:function(){if(!m())return(new jQuery.Deferred).reject().promise();var a=$.ajax({url:"/ping",error:function(){a.reject()},timeout:5E3});return a.promise()},isNetworkAvailableSync:function(){if(!m())return!1;var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome},isiOSAppMode:d,
isChromeApp:c,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return d()||c()},isCookieEnabled:function(){return navigator.cookieEnabled},isLocalStorageEnabled:function(){if(KindleLocalStorage.localStorageObject===null)return!1;try{KindleLocalStorage.localStorageObject.setItem("testLocalStorage","1"),KindleLocalStorage.localStorageObject.removeItem("testLocalStorage")}catch(a){return!1}return!0},isWebSQLSupported:function(){return!!window.openDatabase},
isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.webkitIndexedDB||!!window.msIndexedDB||!!window.indexedDB},isMSPointerEnabled:k,isTouchDevice:function(){return e()||k()||n()},getDevicePlatform:function(){return b()?"iPad":f()?"iPhone":n()?"playBook":l()?"otter":h()?"metroArm":a()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return b()&&KindleHostPadDetector.isPad1(d())||h()},getDeviceType:function(){return a()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return a()?
Kindle.ClientName.Metro:Kindle.ClientName.KCR},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(b){if(KindleLocalStorage.localStorageObject.getItem("definitelyNotPad1"))return!1;var f=0,e=1E3,l=0,a;for(i=0;i<3;i++)a=SunSpiderBenchmark.get3DSpeed(),a>f?f=a:a<e&&(e=a),l+=a;f=l/3;if(f>=200&&b)return!0;if(f>=100&&!b)return!0;KindleLocalStorage.localStorageObject.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function b(b,e){for(var l in e)if(e.hasOwnProperty(l)&&typeof b[l]!==typeof e[l])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},onBookExtrasOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},
removeBook:function(){}},IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openBookExtras:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},hideAppBar:function(){}},checkImplements:b,assertImplements:function(f,e){b(f,e)||
KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function b(a){var c=[],b;for(b in a){var h=a[b].entry;h.guid=h.guid||h.refEmId;delete h.refEmId;h&&c.push(h)}return c}function f(b){var c=[],e;for(e in b)c.push({entry:b[e]});return h.getAppDb().getTable(a).insertList(c)}function e(a){function c(){var j;k<a.length?(f=Math.min(k+100,a.length),j=Array.prototype.slice.call(a,k,f),k=f,m.updateAnnotations(b(j),KindleLocale.getLocalTimeOffset()).then(function(){h.getAppDb().deleteJournalEntries(j).then(c,
e.reject)},e.reject)):e.resolve()}var e=new jQuery.Deferred,k=0,f;c();return e.promise()}function l(){var b=new jQuery.Deferred;h.getAppDb().getTable(a).getRecord().then(function(a){a.length>0?e(a).then(b.resolve,b.reject):b.resolve()},b.reject);return b.promise()}var a="journal",h=null,m=null;return{initialize:function(){var a=new jQuery.Deferred,c=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT]).then(function(b){m=b[KindleModuleManager.SERVICE_CLIENT];
h=b[KindleModuleManager.DB_CLIENT];a.resolve(c)},a.reject);return a.promise()},saveToJournal:function(a){var c=new jQuery.Deferred;f(a).then(function(){l().then(c.resolve,c.resolve)},c.reject);return c.promise()},uploadJournal:l}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")},
setDeviceToken:function(b){KindleLocalStorage.localStorageObject.setItem("kindleDeviceToken",b)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.localStorageObject.removeItem("kindleDeviceToken")}}}(),KindleLocalStorage=function(){function b(){var b={getItem:function(a){return!a||!this.hasOwnProperty(a)?null:unescape(document.cookie.replace(RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"))},key:function(a){return unescape(document.cookie.replace(/\s*\=(?:.(?!;))*$/,
"").split(/\s*\=(?:[^;](?!;))*[^;]?;\s*/)[a])},setItem:function(a,b){if(a)document.cookie=escape(a)+"="+escape(b)+"; path=/",this.length=document.cookie.match(/\=/g).length},length:0,removeItem:function(a){if(a&&this.hasOwnProperty(a)){var b=new Date;b.setDate(b.getDate()-1);document.cookie=escape(a)+"=; expires="+b.toGMTString()+"; path=/";this.length--}},hasOwnProperty:function(a){return RegExp("(?:^|;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}};b.length=(document.cookie.match(/\=/g)||
b).length;return b}var f=null;try{if("localStorage"in window&&window.localStorage!==null&&window.localStorage)f=window.localStorage}catch(e){KindleDebug.error("Exception: Detecting local storage threw an exception."),KindleHostDeviceDetector.isIE()&&(KindleDebug.log("Using a 'localStorage' polyfill"),f=b())}return{localStorageObject:f}}(),KindleLocale=function(){var b=-(new Date).getTimezoneOffset();return{getLocalTimeOffset:function(){return b},getCountryCode:function(){return"US"}}}(),KindleMetricsProfiler=
function(b){function f(b){for(var a=0,h=0;h<b.length;h+=1)a+=b[h].end-b[h].start;return a}var e={};e.name=b;e.counters=null;e.subTimers=null;e.runs=[{start:(new Date).getTime(),end:null}];e.endTimer=function(){var b=this.runs[this.runs.length-1];if(b.end===null)b.end=(new Date).getTime()};e.addCount=function(b,a){if(this.counters===null)this.counters={};this.counters[b]===void 0?this.counters[b]=a:this.counters[b]+=a};e.createSubTimer=function(b){if(this.subTimers===null)this.subTimers={};this.subTimers[b]===
void 0?this.subTimers[b]=KindleMetricsProfiler(b):this.subTimers[b].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[b]};e.log=function(){this.logAsPercentageOfTime("",f(this.runs))};e.logAsPercentageOfTime=function(b,a){var h=b+":"+this.name,e;f(this.runs);for(e in this.counters);for(e in this.subTimers)this.subTimers[e].logAsPercentageOfTime(h,a)};return e};
function KindleModuleManagerFactory(){function b(a,b){if(o[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;o[a]=b;s[a].resolve(b)}function f(a){if(o.hasOwnProperty(a))throw"Duplicate registration of module "+a;o[a]=void 0}function e(a,c){s[a]||(s[a]=new jQuery.Deferred);b(a,c)}function l(a,c){f(a);s[a]||(s[a]=new jQuery.Deferred);c(s[a]);s[a].done(function(c){b(a,c)})}function a(a,b){l(a,function(a){b.done(a.resolve).fail(a.reject)})}function h(a){s[a]||
(s[a]=new jQuery.Deferred);return s[a].promise()}function m(a){if(!o[a])throw"Trying to get uninitialized module "+a;return o[a]}function d(a){return o.hasOwnProperty(a)}function c(a,b){o[a]=b}function n(a){var b=o[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function k(a){for(var b={},c=0;c<a.length;c++)b[name]=o[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function q(){o={}}var j={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",BOOKINFO:"bookinfo",NETWORK:"network"},o={},s={};return{CONSTANTS:j.CONSTANTS,DB_CLIENT:j.DB_CLIENT,RESOURCE_BUNDLE:j.RESOURCE_BUNDLE,METRICS_MANAGER:j.METRICS_MANAGER,SERVICE_CLIENT:j.SERVICE_CLIENT,APP_REGISTRATION:j.APP_REGISTRATION,JOURNAL_MANAGER:j.JOURNAL_MANAGER,BOOK_METADATA:j.BOOK_METADATA,BOOK_FRAGMAP:j.BOOK_FRAGMAP,
BOOKINFO:j.BOOKINFO,NETWORK:j.NETWORK,ERROR_CODE_CANCEL:"canceled",registerModule:e,registerModuleList:function(a){for(var b in a)e(b,a[b])},registerModuleWithInitializer:l,registerModuleWithDeferred:a,detachModule:function(a){var b=o[a],c=s[a];c&&!c.isResolved()&&c.reject("canceled");delete o[a];delete s[a];return b},getModule:h,getModuleList:function(a){var b=new jQuery.Deferred,c,d=[];for(c=0;c<a.length;c++)d.push(h(a[c]));$.when.apply($,d).done(function(){var c,d={};for(c=0;c<a.length;c++)d[a[c]]=
arguments[c];b.resolve(d)}).fail(b.reject);return b.promise()},getModuleSync:m,isModuleInitialized:function(a){return o[a]!==void 0},isModuleRegistered:d,switchToTestMode:function(){this.registerModuleTest=c;this.getModule=n;this.getModuleSync=m;this.getModuleList=k;this.clear=q;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},define:function(b,c,e){if(!d(b)){var k=[],f=$.Deferred();a(b,f);c&&c.length&&c.forEach(function(a){k.push(a&&$.isFunction(a.promise)?a:h(a))});
$.when.apply($,k).then(function(){var a;typeof e==="function"?(a=$.makeArray(arguments),a=e.apply(e,a)):a=e;a&&$.isFunction(a.promise)?a.then(f.resolve,function(){f.reject()}):f.resolve(a)},function(){f.reject()})}},require:function(a,b){$.isArray(a)||(a=[a]);var c,d,e=[];a.forEach(function(a){e.push(a&&$.isFunction(a.promise)?a:h(a))});b||(d=$.Deferred(),c=d.promise());$.when.apply($,e).done(function(){var a=$.makeArray(arguments);b?b.apply(b,a):d.resolve.apply(d,a)},function(){b&&d.reject()});return c}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{getStoreURL:function(){var b=new jQuery.Deferred;$.get("/remote/store").then(function(f){(f=f.url)?b.resolve(f):b.reject()},b.reject);return b.promise()},uploadFeedback:function(b){if(!b)return(new $.Deferred.reject).promise();var f={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth},f={version:KindleVersion.getVersionString(),
message:b.text,info:f};if(KindleHostDeviceDetector.isMetro()&&b.eid&&b.deviceType)f.eid=b.eid,f.deviceType=b.deviceType;b={url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(f)};return $.ajax(b)}}}(),KindleUserAgentMetricsInfo=function(){function b(a){if(a){var b=/^0*([0-9]+)/.exec(a);if(b&&b.length>=2)return parseInt(b[1],10);else KindleDebug.error("Bad regex on versionString: "+a)}}function f(){l=GoogleUserAgent.browserName.toLowerCase();a=GoogleUserAgent.browserVersionString.toLowerCase();
(function(){var b;["ipad","iphone"].indexOf(l)!==-1&&((b=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&b.length>=2&&(a=b[1]),osName=l="ios")})();(function(){var b=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);b&&(a=b[1]);osName="metro"})();h=b(a);c="undefined"===typeof h?d:n[l]?[l,h].join(m):d;e=!0}var e,l,a,h,m="@",d="other",c,n={chrome:14,firefox:7,safari:5,metro:1,ie:9,ios:4};return{browserWithVersionString:function(){e||f();return c}}}(),KindleVersion=function(){var b=null,f=null;return{getMetricsVersion:function(){f||
(f=parseInt("010405021".slice(0,2),10),f+=".",f+=parseInt("010405021".slice(2,4),10),f+=".",f+=parseInt("010405021".slice(4,6),10));return f},getVersionString:function(){b||(b=parseInt("010405021".slice(0,2),10),b+=".",b+=parseInt("010405021".slice(2,4),10),b+=".",b+=parseInt("010405021".slice(4,6),10),b+=".",b+=parseInt("010405021".slice(6),10));return b},getVersion:function(){return Number("010405021")}}}(),KindleChromeInstaller=function(){function b(){function b(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,
function(){KindleDebug.log("install success");setTimeout(b,250)},function(b){KindleDebug.error(b)})}function f(){return window.chrome&&Kindle.top.chrome.webstore&&Kindle.top.chrome.webstore.install}return{install:function(){f()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},initialize:function(){if(KindleHostDeviceDetector.isChrome()&&f()){var e=document.createElement("button");e.id="inlineInstallProxy";e.style.display=
"none";$(e).click(b);$("body").append(e)}}}}(),KindleFirefoxInstaller=function(){function b(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();var b=$.Deferred(),e=navigator.mozApps.getSelf();e.onsuccess=function(){b.resolve(e.result)};e.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);b.reject()};return b.promise()}return{install:function(){var f=$.Deferred();b().done(function(b){b?f.reject():(navigator.mozApps.install(Kindle.URL.getHostURL()+
"/offline/kcr_ff.webapp").onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");f.resolve()},request.onerror=function(){KindleDebug.error("Firefox App failed to install.");f.reject()})}).fail(f.reject);return f.promise()}}}(),KindleLibrary=function(){function b(){KindleLibraryHomeScreenPopup.show();KindleLibraryControlBar.setCacheDone()}function f(a){KindleSpinner.hide();a===Kindle.STORE.OFFLINE_ERROR?V(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED):a===Kindle.STORE.GENERIC_ERROR&&
V(Kindle.ERROR.STORE_OPEN_FAILED)}function e(){da||(KindleHostDeviceDetector.isiOS()?KindleLibraryHeaderBar.dismissKeyboard():KindleLibraryHeaderBar.deactivateSearch());return!1}function l(){KindleLocalStorage.localStorageObject.getItem(Kindle.App.LIBRARY_FAIL_FLAG)?E.emit("Library::OpenLibraryFail"):KindleLocalStorage.localStorageObject.setItem(Kindle.App.LIBRARY_FAIL_FLAG,"true");w=E.startMetrics("Library::OpenLibrary");KindleSpinner.show();KindleLibrarySetting.initialize();p=KindleHostDeviceDetector.isiPad()||
KindleHostDeviceDetector.isPlayBook();D().getBookDataLastSyncTime(q);a();z();B();r();H();KindleLibrarySetting.getLastLibraryView()==="downloaded"&&(KindleLibraryScrollPane.setView("downloaded"),KindleLibrarySetting.setLibraryView("downloaded"));p||A();KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",Kindle.top.document).bind("orientationchange.library",d):$(window).resize(d);$(window).keydown(c);$(window).keyup(n);KindleHostDeviceDetector.isiOS()?$("#page_body").bind("touchstart",e):$("#page_body").bind("click",
e);KindleHostDeviceDetector.isiOS()||$(window).focus(function(){ha.checkTokenConsistency()});KindleOffline.isEnabled()?D().getCachedAsins(void 0).then(function(a){var b,c,d={};d[Kindle.BookInfo.CachedState.CACHED]=0;d[Kindle.BookInfo.CachedState.PINNED]=0;for(b in a)c=a[b],d[c.cacheState]++;d[Kindle.BookInfo.CachedState.CACHED]&&E.increaseSubCounter(w,"booksCached",d[Kindle.BookInfo.CachedState.CACHED]);d[Kindle.BookInfo.CachedState.PINNED]&&E.increaseSubCounter(w,"booksPinned",d[Kindle.BookInfo.CachedState.PINNED])}):
E.increaseSubCounter(w,"noOffline",1)}function a(){KindleLibrarySearch.initialize(function(){var a=new jQuery.Deferred;KindleHostDeviceDetector.isOnline()?a.resolve(y):D().getCachedAsins("pinned").done(function(b){var c=[],d;for(d in y)b.indexOf(y[d].asin)<0&&c.push(y[d]);a.resolve(c)});return a.promise()},function(a,b){var c=KindleLibraryScrollPane.displayBooks(a,b);c===0?KindleLibraryMessagePane.showEmptySearchMessage(!KindleHostDeviceDetector.isOnline()):c>0&&KindleLibraryMessagePane.hideEmptySearchMessage()})}
function h(){KindleLibraryHeaderBar.setSyncButtonDisabled(!0);KindleSpinner.overlay();D().getBookDataLastSyncTime(q)}function m(){Q=!0;h()}function d(){Y?ba=!0:(KindleLibraryContextMenu&&KindleLibraryContextMenu.hide(),KindleLibraryScrollPane.resizeScrollPane())}function c(a){if(!Y)switch(a.which){case 38:KindleLibraryScrollBar.moveStart(!0);break;case 40:KindleLibraryScrollBar.moveStart(!1)}}function n(a){if(!Y)switch(a.which){case 33:KindleLibraryScrollBar.movePage(!0);break;case 34:KindleLibraryScrollBar.movePage(!1);
break;case 27:KindleLibraryHeaderBar.deactivateSearch(!0);break;default:KindleLibraryScrollBar.moveEnd()}}function k(a){Q?(g(),KindleHostDeviceDetector.isOnline()?V(Kindle.ERROR.SYNC_FAILED):V(Kindle.ERROR.SYNC_FAILED_OFFLINE)):a?D().getAllBooks(s):KindleMessageDialog.showError(Kindle.ERROR.LIBRARY_LOAD_FAILED,function(){q(Kindle.DB.NEVER)},ResourceBundle.getLocalizedString("k_dialog_message_retryButton_text"))}function q(a){var b=a===Kindle.DB.NEVER?null:a;KindleHostDeviceDetector.isOnline()?(w&&
b!==null&&E.modifyMetricsMethod(w,"Library::OpenLibraryCached"),ha.getOwnedContent(b).then(function(a){Q=!1;D().updateBookData(a.asinsToRemove,a.asinsToAdd,a.syncTime,o,j)},function(){k(b!==null)})):(w&&E.modifyMetricsMethod(w,"Library::OpenLibraryOffline"),k(b!==null))}function j(){KindleLibraryHeaderBar.setSyncButtonDisabled(!1)}function o(a){Q&&a===0?g():D().getAllBooks(function(b){s(b,a===0)})}function s(a,b){var c=y[0];y=a;for(var d in y)if(y[d].lastTimeRead===void 0)y[d].lastTimeRead=-1;d=KindleLibrarySetting.getLastSortParam();
KindleLibrarySort.sortBookList(y,d);KindleLibrarySetting.setSortParam(d);d=y[0];b&&c&&d&&c.asin===d.asin?da&&J(da):(KindleLibraryScrollPane.setLayout(KindleLibrarySetting.getLastLayoutView()),C());g();w&&(E.increaseSubCounter(w,KindleLibrarySetting.getLastLayoutView(),1),E.increaseSubCounter(w,KindleLibrarySetting.getLastLibraryView(),1),E.increaseSubCounter(w,"bookCount",y.length),E.endMetrics(w),w=void 0)}function g(){Q=!1;da=void 0;KindleSpinner.hide();KindleLibraryHeaderBar.setSyncButtonDisabled(!1);
F.onLibraryLoaded();KindleLocalStorage.localStorageObject.removeItem(Kindle.App.LIBRARY_FAIL_FLAG)}function r(){var a=KindleLibrarySetting.getSettings();KindleLibraryScrollPane.initialize(a,ca,u,x,t)}function H(){KindleLibraryMessagePane.initialize(function(a){$("#message_container").append(a)},function(){KindleSpinner.show();F.openStore({isSourceEmptyLibBtn:!0})})}function u(a,b){function c(a){var b={asin:a,basePath:R.basePath,useNewPath:R.useNewPath,useProdBucket:R.useProdBucket},d=E.startMetrics("Library::SaveBook");
KindleOffline.pinBook(b,V).then(function(){E.endMetrics(d);J(a)},function(){E.cancelMetrics(d)})}function d(a){KindleOffline.unpinBook({asin:a},V).done(function(){J(a)})}da||D().getBookCachedState(a.asin).done(function(g){var h=KindleOffline.isEnabled()?KindlePopupMenu.ITEM_ENABLED:KindlePopupMenu.ITEM_DISABLED,e=KindlePopupMenu.ITEM_ENABLED,k=KindlePopupMenu.ITEM_HIDDEN,h=KindleHostDeviceDetector.isOnline()?h:KindlePopupMenu.ITEM_DISABLED,f=KindleLibrarySetting.getLastLibraryView()==="downloaded"?
h:k,j="unknown";if(g&&g.length>0)j=g[0].cacheState;switch(j){case Kindle.BookInfo.CachedState.PINNED:g=[k,f,k,e];break;case Kindle.BookInfo.CachedState.CACHED:g=[h,f,k,e];break;default:g=[k,k,h,e]}KindleLibraryContextMenu.show(a.asin,g,b,[c,d,c,ca])})}function x(a,b,c){p||(c>=a?$("#slide_container").removeClass("scrollbar_shown"):($("#slide_container").addClass("scrollbar_shown"),KindleLibraryScrollBar.updateValueRange(a,b,c)))}function t(a){KindleLibraryScrollBar.updateValue(a)}function M(a){var b=
document.createElement("a");b.href=a;b.target="_blank";a=document.createEvent("MouseEvents");a.initEvent("click",!0,!0);b.dispatchEvent(a)}function G(){KindleLibrarySettingsMenu.show(M)}function z(){var a=KindleLibraryHeaderBar,b={},c={},d=KindleLibrarySearch;b[a.EVENT_SYNC_CLICKED]=m;b[a.EVENT_MANAGE_CLICKED]=G;b[a.EVENT_STORE_CLICKED]=function(){KindleSpinner.show();F.openStore({})};c[a.SEARCH_CALLBACK.ENABLE]=function(){var a=!KindleHostDeviceDetector.isOnline()?"downloaded":"cloud";KindleLibraryControlBar.hideViewTabs();
KindleLibraryScrollPane.setView(a)};c[a.SEARCH_CALLBACK.SEARCH]=KindleUtils.debounce(function(a){d.search(a)},200);c[a.SEARCH_CALLBACK.DISABLE]=function(){KindleLibraryScrollPane.setView(KindleLibrarySetting.getLastLibraryView());KindleLibraryControlBar.showViewTabs()};a.initialize(function(a){$("body").append(a);I.resolve()},b,c)}function B(){var a=KindleLibraryControlBar;a.setRetryCallback(ea);a.setAppCacheStatusGetter(v.getSharedModuleSync(Kindle.MODULE.APPCACHE_EVENTHANDLER).getCacheStatus);var b=
{};b[a.EVENT_LIBRARY_SORT_CLICKED]=ka;b[a.EVENT_LIBRARY_LAYOUT_CLICKED]=ga;b[a.EVENT_LIBRARY_IMAGE_CHANGING]=T;b[a.EVENT_LIBRARY_IMAGE_CHANGED]=L;b[a.EVENT_LIBRARY_VIEW_CLICKED]=U;a.initialize(function(a){$("#page_body_content_containers").prepend(a)},KindleLibrarySetting.getSettings(),b)}function A(){KindleLibraryScrollBar.initialize(function(a){$("#slide_container").append(a)},K)}function K(a,b){KindleLibraryScrollPane.setScrollValue(a,b)}function T(a,b){KindleLibraryScrollPane.updateCoverSize(b.value,
!1)}function L(a,b){var c=b.value;KindleLibrarySetting.setCoverSize(c);KindleLibraryScrollPane.updateCoverSize(c,!0)}function J(a){D().getBookCachedState(a).done(function(b){KindleLibraryScrollPane.updateBookCacheState(a,b.length>0?b[0].cacheState:"");D().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(function(a){$.isEmptyObject(a)?KindleLibraryNoDownloadedMessage.show():KindleLibraryNoDownloadedMessage.hide()})})}function C(){D().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(function(a){KindleLibraryScrollPane.setBookData(y,
a);y.length===0?KindleLibraryMessagePane.showEmptyLibraryMessage():(KindleLibraryMessagePane.hideEmptyLibraryMessage(),$.isEmptyObject(a)?KindleLibraryNoDownloadedMessage.show():KindleLibraryNoDownloadedMessage.hide())})}function U(a){function b(){KindleLibraryScrollPane.setView(a);KindleLibrarySetting.setLibraryView(a);KindleLibraryControlBar.setViewState(a)}a!==KindleLibrarySetting.getLastLibraryView()&&(!KindleHostDeviceDetector.isOnline()&&a==="cloud"?V("BookNotAvailable"):a==="downloaded"&&!KindleOffline.isEnabled()?
KindleHostDeviceDetector.isFirefox()?KindleOffline.enableOfflineMessage().done(b):KindleOffline.firstRunMessage().done(b):b())}function ca(a,b){a!==null&&!Y&&(da=a,S=b,KindleHostDeviceDetector.isOnline()?O(a):D().getBookCachedState(a).done(function(b){b.length>0&&Kindle.BookInfo.CachedState.isMaybeDownloaded(b[0].cacheState)?O(a):(E.emit("Library::OpenBookNotAvailable"),V("BookNotAvailable"),S&&S())}))}function D(){return X.getAppDb()}function O(a){F.openBook({asin:a,isSample:!1})}function W(){KindleLibraryHeaderBar.deactivateSearch(!0);
S&&S()}function aa(){KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.allowTouchEvents();ba&&(KindleLibraryScrollPane.resizeScrollPane(),ba=!1);h();Y=!1}function V(a){a===Kindle.ERROR.CONTENT_RENTAL_EXPIRED?ja():KindleMessageDialog.showError(a)}function ia(a,b){a?(Y=!0,KindleSpinner.hide(),KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents(),setTimeout(W,500)):(V(b),S&&S(),aa())}function ka(){var a;a=KindleHostDeviceDetector.isiOS()?"up":"down";KindleLibrarySortMenu.show(a,
function(a){if(a!==KindleLibrarySetting.getLastSortParam())document.getElementById("kindleLibrary_button_sort_label").innerHTML=ResourceBundle.getLocalizedString(KindleLibrarySort.getLabel(a)),y.length>0?(KindleLibrarySort.sortBookList(y,a),KindleLibrarySetting.setSortParam(a),C()):KindleLibrarySetting.setSortParam(a)})}function ga(a){KindleLibraryScrollPane.setLayout(a);KindleLibrarySetting.setLayoutView(a)}function ea(){E.emit("KindleApp:AppCacheError:RetryClicked",{breakdown:["Browser"]});KindleLibraryAppCacheFailDialog.hasBeenShownThisSession()?
(KindleLibraryAppCacheFailDialog.open(),E.emit("KindleApp:AppCacheError:RetryClickedAfterRebootDialogShown",{breakdown:["Browser"]})):Kindle.top.location.reload(!1)}function ja(){var a=!0;E.emit("Library::Rentals:ExpiredDialogShown");var b=function(){var b=da;return function(){a&&(a=!1,E.emit("Library::Rentals:BuyOrRentAgainClicked"));KindleMessageDialog.close();if(b!==void 0){var c="https://www.amazon.com/dp/"+b+"/ref=kcr_store_expired";KindleHostDeviceDetector.isiPad()?(c+="_ipad",M(c)):(c+="_desktop",
Kindle.top.location=c)}else KindleDebug.error("no asin selected for BuyOrRentAgainClicked")}}();KindleMessageDialog.showError(Kindle.ERROR.CONTENT_RENTAL_EXPIRED,function(){a&&(a=!1,E.emit("Library::Rentals:DismissClicked"))},ResourceBundle.getLocalizedString("k_dialog_rental_expired_dismiss_button_text"),[{buttonText:ResourceBundle.getLocalizedString("k_dialog_rental_expired_extend_button_text"),callback:b}])}var y=[],Y=!1,da,p,w,S,ba=!1,X=null,v,F,E,ha,Q=!1,R,N,I;return{initialize:function(){N||
(N=jQuery.Deferred());I||(I=jQuery.Deferred());v=window.parent.KindleApp;KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.initialize();v&&($("body").bind("touchmove.elastic",KindleIOSScrollStopper.stopScroll),F=v.getAppInterfaceForLibrary(),Kindle=v.getSharedModuleSync(KindleModuleManager.CONSTANTS),ResourceBundle=v.getSharedModuleSync(KindleModuleManager.RESOURCE_BUNDLE),v.setLibraryInterface({onReaderOpenStatus:ia,onReaderClose:aa,onStoreOpenStatus:f,libraryUpdateNeeded:h}),v.registerEventCallback(Kindle.APP_CACHE.CACHE_PROGRESS,
function(a){KindleLibraryControlBar.setCacheProgress(a.progressRatio)}),v.registerEventCallback(Kindle.APP_CACHE.CACHE_CACHED,b),v.registerEventCallback(Kindle.APP_CACHE.CACHE_DONE,b),v.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_RETRY,function(){KindleLibraryControlBar.setCacheNeedsRetry()}),v.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART,function(){KindleLibraryControlBar.setCacheNeedsRetry()}),v.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART,function(){KindleLibraryAppCacheFailDialog.open()}),
v.getSharedModules().done(function(a){KindleModuleManager.registerModuleList(a);KindleOffline.isFirstTime()&&!v.getQueryParams().asin?KindleOffline.firstRunMessage().done(N.resolve):N.resolve();!KindleOffline.isFirstTime()&&!KindleLocalStorage.localStorageObject.getItem("haveDB")&&KindleHostDeviceDetector.isFirefox()&&KindleOffline.enableOfflineMessage();E=a[KindleModuleManager.METRICS_MANAGER];X=a[KindleModuleManager.DB_CLIENT];ha=a[KindleModuleManager.SERVICE_CLIENT];l()}),$("body").bind("contextmenu",
function(a){a.preventDefault()}),F&&(R=F.getQueryParameters()))},registerControlHotkey:function(a,b,c){$(document).keydown(function(d){if(d.keyCode===a.charCodeAt(0)&&(d.ctrlKey||d.metaKey)&&!d.shiftKey)return d.preventDefault(),b.apply(this,c),!1})},register:function(a,b){return F.register(a,b)},deregister:function(a,b){return F.deregister(a,b)},onStoreLinkClicked:function(a){var b={};b[a]=!0;KindleSpinner.show();F.openStore(b);KindleNotificationDialog.hide();return!1}}}(),KindleX=KindleLibrary,
KindleLibraryAuthor=function(){var b=["phd","md","sir"];return{getDisplayableString:function(f){for(var e="",l=f.length,a=0;a<l;a++){for(var h=f[a].split(","),m=[],d=[],c=0;c<h.length;c++){var n=$.trim(h[c]);b.indexOf(n.toLowerCase())>-1?m.push(n):d.unshift(n)}if(d.length===2){e+=d[0]+" "+d[1];for(h=0;h<m.length;h++)e+=", ",e+=m[h]}else e+=f[a];l>1&&(a===l-2?e+=" and ":a<l-2&&(e+=", "))}return e},getLegacyDisplayableString:function(b){for(var e="",l=b.length,a=0;a<l;a++)e+=b[a],a<l-1&&(e+="; ");return e}}}(),
KindleLibraryBookCover=function(){function b(){d||(d=KindleHostDeviceDetector.isiPad()?a:l);return d}function f(a){m||(m=e,m=m.replace("{width}",b().width),m=m.replace("{height}",b().height));var d=m;return d=d.replace("{asin}",a)}var e="/cover/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",l={width:255,height:255},a={width:255,height:255},h=null,m=null,d=null;return{getBookCoverUrl:function(a){h||(h="https://images-na.ssl-images-amazon.com/images/P/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",
h=h.replace("{width}",b().width),h=h.replace("{height}",b().height));var d=h;return d=d.replace("{asin}",a)},getOfflineCover:function(a){var b=new jQuery.Deferred,a=f(a);$.ajax({url:a,beforeSend:function(a){a.overrideMimeType("text/plain; charset=x-user-defined")},success:function(a){a="data:image/jpeg;base64,"+KindleO_Aaa.o_aaa(a);b.resolve(a)},error:b.reject});return b.promise()}}}(),KindleLibraryScrollPane=function(){function b(){T=!0;U&&c()}function f(){for(var b=0;b<E;b++){var c=X[b],d=ba[v+
b],g=S[d].find(".book_image");c.height!==1&&c.width!==1?(g.attr("src",c.src),c.width>c.height&&g.removeClass("book_image").addClass("book_image_wide")):D&&(g.attr("src",t),c=S[d].find(".book_title").text(),d=S[d].find(".alt_title"),d.text(c),d.show())}v+=E;v>=ba.length-1?(X=[],ba=[],v=0):a()}function e(a){return function(){var b=v+E-1;a>=v&&a<=b&&(F++,F===E&&(clearTimeout(ha),f()))}}function l(){f()}function a(){F=0;ha=setTimeout(l,K);E=Math.min(z,ba.length-v);for(var a=0;a<E;a++){var b=v+a,c=ba[b];
X[a]||(X[a]=new Image);b=e(b);X[a].onload=b;X[a].onerror=b;X[a].src=w[c]||KindleLibraryBookCover.getBookCoverUrl(c)}}function h(a,b){var c=a.find(".book_click_area");c.tap(function(){var c=a.find(".book_image, .book_image_wide");!ja&&!KindleLibraryContextMenu.isVisible()&&(ja=!0,c.addClass("opening"),y(b.asin,function(){c.removeClass("opening");ja=!1}));return!1});var d=a.find(".book_image, .book_image_wide");D?(a.tapHold(function(a){Y(b,[a.x,a.y-100]);O._unbind("touchmove");O._unbind("touchend");
O._unbind("touchcancel")}),c.activate(function(){d.addClass("opening");setTimeout(function(){d.removeClass("opening")},A)})):(c.bind("contextmenu",function(a){Q&&clearTimeout(Q);Y(b,[a.pageX,a.pageY]);a.preventDefault()}),c.mousedown(function(a){d.addClass("held");if(!Q)R.x=a.pageX,R.y=a.pageY,Q=setTimeout(function(){Y(b,[R.x,R.y]);clearTimeout(Q);Q=null},B)}),c.mouseup(function(){clearTimeout(Q);d.removeClass("held");Q=null;return!0}),c.mouseout(function(){clearTimeout(Q);d.removeClass("held");Q=
null;return!1}),c.mousemove(function(a){R.x=a.pageX;R.y=a.pageY}));return a}function m(a,b){var c=S[a];if(c)switch(c.removeClass("book_is_pinned book_is_cached"),b){case Kindle.BookInfo.CachedState.PINNED:c.addClass("book_is_pinned");break;case Kindle.BookInfo.CachedState.CACHED:c.addClass("book_is_cached")}}function d(){O&&(O.destroy(),O=null);var b=$("<div>").attr("id",G),c,d,g;for(g in U){c=U[g].asin;if(S[U[g].asin])d=S[U[g].asin];else{d=U[g];var e=KindleUXComponentManager.renderTemplate(u,{asin:d.asin,
title:d.title,author:KindleLibraryAuthor.getDisplayableString(d.authors),src:x}),e=h(e,d);S[d.asin]=e;ba.push(d.asin);d=e}m(c,ca[c]);b.append(d)}a();$("#"+G).replaceWith(b);ka=0;q()}function c(){w?d():KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getCachedCovers().done(function(a){w=a;d()})}function n(){W=o*J;C.grid_style_container.style.height=W+s+"px";C.grid_style_bookCover.style.width=W+"px";C.grid_style_bookCover.style.height=W+"px";C.grid_style_pinned.style.backgroundPosition=
"center "+(W+3)+"px"}function k(a,b){var c=-b*H;aa&&(c=ga.scrollTop()+c,c=Math.min(c,aa-ga.height()),c=Math.max(c,0),j(c,!0),p(c))}function q(){D?O?O.refresh():O=KindleLibraryScroller.createScrollerObject("titles_container",{hScroll:!1,lockDirection:!1,hScrollbar:!1,vScrollbar:!1}):(L==="grid"?(V=W+s,ia=Math.floor(ga.width()/(W+g)),C.grid_style_container.style.width=100/ia+"%"):(V=r,ia=1),j(Math.floor(ka/ia)*V,!1),aa=ga[0].scrollHeight,da(aa,ga.scrollTop(),ga.height()))}function j(a,b){ga.scrollTop(a);
b&&(ka=Math.round(a/V)*ia)}var o=21.25,s=100,g=20,r=86,H=75,u="KindleLibraryBookContainer",x="./images/override/library/img_alt_cover.png",t="./images/override/library/blank_cover.png",M="book_highlightsearch",G="titles_inner_wrapper",z=30,B=1E3,A=500,K=6E4,T,L,J,C,U,ca,D,O,W,aa,V,ia,ka=0,ga,ea,ja,y,Y,da,p,w,S={},ba=[],X=[],v=0,F=0,E=0,ha,Q=null,R={x:0,y:0};return{initialize:function(a,c,d,g,h){L=a.layoutState;J=a.coverSize;D=KindleHostDeviceDetector.isiOS();ja=!1;y=c;Y=d;da=g;p=h;ga=$("#titles_container");
ea=$("#slide_container");a=document.styleSheets[2].cssRules;if(a===void 0)a=document.styleSheets[2].rules;C={};for(c=0;c<a.length;c++){d=a[c];if(d.selectorText===".grid_container .book_container")C.grid_style_container=d;if(d.selectorText===".grid_container .book_cover")C.grid_style_bookCover=d;if(d.selectorText===".grid_container .book_is_pinned")C.grid_style_pinned=d}ea.mousewheel(k);D||n();KindleUXComponentManager.initializeTemplate(u,b)},setBookData:function(a,b){U=a;ca={};for(var d in b)ca[b[d].asin]=
b[d].cacheState;T&&c()},updateCoverSize:function(a,b){!D&&!b&&(J=a,n(),q())},setLayout:function(a){L=a;ea.removeClass("grid_container list_container").addClass(a+"_container");q()},setView:function(a){a==="downloaded"?ea.addClass("download_view"):ea.removeClass("download_view");q()},setScrollValue:j,updateBookCacheState:m,resizeScrollPane:function(){q()},displayBooks:function(a,b){function c(a,b){var d=[],g=[],e={};if(d=b.match(a)){for(var h=d.length,k=0;k<h;k++)e[d[k]]=d[k];for(k in e)g.push(RegExp(e[k],
"g"));return g.sort().reverse()}else return g}function d(a,b){for(var c=a,g=b.length,e=0;e<g;e++)c=c.replace(b[e],'<span class="'+M+'">'+b[e].source+"</span>");return c}var g=a.length,e=0;if(g===0)return e;for(var k=KindleHostDeviceDetector.isOnline(),f=$("#"+G)[0],j=b.source==="(?:)"||!b.source,n=document.createDocumentFragment(),o=0;o<g;o++){var l,m,r,t=a[o];(k||ca[t.asin])&&e++;j?l=S[t.asin]:(l=S[t.asin].clone(),m=c(b,t.title),m=d(t.title,m),r=c(b,t.displayableAuthorsString),r=d(t.displayableAuthorsString,
r),l.find(".book_title").html(m),l.find(".book_author").html(r),l=h(l,t));n.appendChild(l[0])}f.innerHTML="";f.appendChild(n);q();return e}}}(),KindleLibraryScroller=function(){function b(b,e){var l=new iScroll(b,e),a=l._momentum;l._momentum=function(b,e,d,c,f){b=b===0?0:Math.max(25,Math.abs(b))*(b<0?-1:1);return a(b,e,d,c,f)};return l}return{createScrollerObject:function(f,e){return new b(f,e)}}}(),KindleLibrarySearch=function(){var b,f,e,l=-1;return{search:function(a){function h(){var a=d,e=m,h=
[],q=l,j=l,o,s=0,g;for(g in e){o=e[g];if(!o.displayableAuthorsString)o.displayableAuthorsString=KindleLibraryAuthor.getDisplayableString(o.authors);a.source?(q=o.title.search(a),j=o.displayableAuthorsString.search(a)):q=0;q!==l||j!==l?(o.hidden=!1,h[s]=o,s++):o.hidden=!0}m={set:h,queryPattern:a};_displayBooksCallback(m.set,m.queryPattern);b=m.set;f=d}var m,a=a.replace(RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g"),"\\$&"),a=$.trim(a),d=RegExp(a,"gi");if(!f||!(f.source&&a===f.source))b&&f&&f.source&&
a.search(f)===0?(m=b,h()):e().done(function(a){m=a;h()})},initialize:function(a,b){e=a;_displayBooksCallback=b}}}(),KindleLibrarySetting=function(){function b(a){a in s||(s[a]=KindleLocalStorage.localStorageObject.getItem(a));return s[a]}function f(a,b){s[a]=b;return KindleLocalStorage.localStorageObject.setItem(a,b)}function e(){return b(k)}function l(a){f(k,a)}function a(){return b(j)}function h(a){f(j,a)}function m(){return b(o)}function d(a){f(o,a)}function c(){return b(q)}function n(a){f(q,a)}
var k="last_layout_view",q="last_opened_view",j="last_sort_param",o="last_cover_size",s={};return{initialize:function(){var b=e(),k=a(),f=m(),j=c();b||l("grid");k||h("recent");f||d(9);KindleHostDeviceDetector.isOnline()?j||n("cloud"):n("downloaded")},getLastLayoutView:e,setLayoutView:l,getLastSortParam:a,setSortParam:h,getLastCoverSize:m,setCoverSize:d,getLastLibraryView:c,setLibraryView:n,getSettings:function(){var b={};b.layoutState=e();b.viewState=c();b.coverSize=m();b.sortParam=a();return b}}}(),
KindleLibrarySort=function(){function b(a){if(!a.sortTitle){var b=KindleStringUtilities.stripNonAlphaNumericChars(a.title),b=b.toLowerCase();a:{var e=ResourceBundle.getLocalizedArticles(),d;for(i=0;i<e.length;i++)if(d=e[i],b.indexOf(d)===0){b=b.substring(d.length);break a}}b=KindleStringUtilities.replaceAccentedChars(b);a.sortTitle=b}}function f(a,b){return a.sortTitle<b.sortTitle?-1:a.sortTitle>b.sortTitle?1:0}function e(a,b){var e=(b.lastTimeRead>0?b.lastTimeRead:b.purchaseDate)-(a.lastTimeRead>
0?a.lastTimeRead:a.purchaseDate);return e===0?f(a,b):e}function l(a,b){for(var e=0,d=0;d<a.authors.length&&d<b.authors.length&&e===0;d++){var c=a.authors[d].toLowerCase(),n=b.authors[d].toLowerCase();c<n?e=-1:c>n&&(e=1)}e===0&&(e=a.authors.length-b.authors.length);return e===0?f(a,b):e}return{SORT_BY_AUTHOR:"author",SORT_BY_TITLE:"title",SORT_BY_RECENT:"recent",SORT_BY_AUTHOR_LABEL:"k_L_sort_author_label",SORT_BY_TITLE_LABEL:"k_L_sort_title_label",SORT_BY_RECENT_LABEL:"k_L_sort_recent_label",sortBookList:function(a,
h){for(var m in a)b(a[m]);switch(h){case "title":a.sort(f);break;case "author":a.sort(l);break;case "recent":a.sort(e);break;default:KindleDebug.error("Trying to sort by invalid type "+h)}},compareBooks:function(a,h,m){b(a);b(h);var d;switch(m){case "recent":d=e(a,h);break;case "title":d=f(a,h);break;case "author":d=l(a,h);break;default:KindleDebug.error("Trying to compare by invalid type "+m)}return d},getLabel:function(a){switch(a){case "title":return"k_L_sort_title_label";case "author":return"k_L_sort_author_label";
case "recent":return"k_L_sort_recent_label";default:return"Invalid Sort Type"}}}}(),KindleDialogOverlay=function(){return{showOverlay:function(b){$("body").append("<div class='ui-widget-overlay ui-widget-overlay-kcr-ios-hack'></div>");$(".ui-widget-overlay-kcr-ios-hack").attr("style","z-index: 1000;").width(window.outerWidth).height(window.outerHeight);(function(){var f=b.component.dialog("option","position");$("body",Kindle.top.document).bind("orientationchange.dialog",function(){b.dialogSettings.k4w_transparent_modal_overlay&&
$(".ui-widget-overlay-kcr-ios-hack").css({width:0,height:0});$(".ui-widget-overlay-kcr-ios-hack").css({width:window.outerWidth+"px",height:window.outerHeight+"px"});b.component.dialog("option","position",f)})})();(function(){b.callbacks.onOverlayClicked&&$(".ui-widget-overlay-kcr-ios-hack").tap(function(b){b.preventDefault()})})()},removeOverlay:function(){$(".ui-widget-overlay-kcr-ios-hack").remove();$("body",Kindle.top.document).unbind("orientationchange.dialog")}}}(),KindleEnableOfflineDialog=
function(){function b(){KindleUXComponentManager.closeDialog(f)}var f="KindleEnableOfflineDialog",e={BUTTON_TEXT:"k_dialog_enableOffline_button_text",OFFLINE_TITLE:"k_dialog_enable_offline_title",FIREFOX_MSG:"k_dialog_enable_offline_firefox_msg"},l={DIALOG:"kindle_dialog_enableOffline",CONTENT:"kindle_dialog_enableOffline_content",BUTTON:"kindle_dialog_enableOffline_button"},a={TITLE:"enable_offline_title",TOP_MSG:"enable_offline_top_msg"},h,m={getDialogSettings:function(){return{autoOpen:!1,width:626,
modal:!0,draggable:!1,resizable:!1,dialogClass:"enableOfflineDialog"}},beforeDialogOpen:function(d){h=d;var c,f;KindleHostDeviceDetector.isFirefox()&&(c=ResourceBundle.getLocalizedString(e.OFFLINE_TITLE),f=ResourceBundle.getLocalizedString(e.FIREFOX_MSG,{linkStart:"<a href='http://www.amazon.com/gp/help/customer/display.html/ref=kcr_help_menu?nodeId=200732370#fxoffline' target='_blank'>",linkEnd:"</a>"}));d={title:c,topInstruction:f,topInstructionClass:void 0};h.find("#"+a.TITLE).html(d.title);h.find("#"+
a.TOP_MSG).html(d.topInstruction);d.topInstructionClass&&h.find("#"+a.TOP_MSG).addClass(d.topInstructionClass);d=h.find("#"+l.BUTTON);d.html(ResourceBundle.getLocalizedString(e.BUTTON_TEXT));d.one("click",b)},onDialogOpen:function(){var a=$("#"+l.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")}};return{open:function(){KindleUXComponentManager.openDialog(f,m)},close:function(){KindleUXComponentManager.closeDialog(f)}}}(),
KindleFirstRunDialog=function(){function b(){KindleUXComponentManager.closeDialog(l);d()}function f(){var b,c,d,e,h;KindleHostDeviceDetector.isChromeApp()?(c=ResourceBundle.getLocalizedString(a.CHROME_APP_TITLE),d=ResourceBundle.getLocalizedString(a.CHROME_APP_MSG)):KindleHostDeviceDetector.isChrome()?(e="continue",c=ResourceBundle.getLocalizedString(a.OFFLINE_TITLE),d=ResourceBundle.getLocalizedString(a.CHROME_MSG)):KindleHostDeviceDetector.isiOS()?(b="ipad_prompt",c=ResourceBundle.getLocalizedString(a.OFFLINE_TITLE),
d=ResourceBundle.getLocalizedString(a.IOS_PROMPT_MSG)):KindleHostDeviceDetector.isFirefox()?(b="ff_prompt",c=ResourceBundle.getLocalizedString(a.OFFLINE_TITLE),d=ResourceBundle.getLocalizedString(a.FIREFOX_MSG),h="ff-db-msg"):(b="safari_prompt",c=ResourceBundle.getLocalizedString(a.OFFLINE_TITLE),d=ResourceBundle.getLocalizedString(a.SAFARI_PROMPT_MSG));return{topImgClass:b,title:c,topInstruction:d,bottomImgClass:e,topInstructionClass:h}}function e(){KindleUXComponentManager.closeDialog(l)}var l=
"KindleFirstRunDialog",a={BUTTON_TEXT:"k_dialog_firstRun_button_text",BUTTON_TEXT_CHROME:"k_dialog_firstRun_button_text_chrome",CRX_BUTTON_TEXT:"k_dialog_firstRun_button_crx_text",INSTALLING_BUTTON_TEXT:"k_dialog_firstRun_button_installing_text",INSTALLED_BUTTON_TEXT:"k_dialog_firstRun_button_installed_text",CONTINUE_BUTTON_TEXT:"k_dialog_firstRun_button_text_chrome_done",OFFLINE_TITLE:"k_dialog_firstRun_offline_title",CHROME_APP_TITLE:"k_dialog_firstRun_chrome_app_title",CHROME_APP_MSG:"k_dialog_firstRun_chrome_app_msg",
CHROME_MSG:"k_dialog_firstRun_chrome_msg",FIREFOX_MSG:"k_dialog_firstRun_firefox_msg",IOS_PROMPT_MSG:"k_dialog_firstRun_ios_prompt_msg",SAFARI_PROMPT_MSG:"k_dialog_firstRun_safari_prompt_msg"},h={DIALOG:"kindle_dialog_firstRun",CONTENT:"kindle_dialog_firstRun_content",BUTTON:"kindle_dialog_firstRun_button",CRX_BUTTON:"kindle_dialog_firstRun_button_crx"},m={TITLE:"first_run_title",TOP_MSG:"first_run_top_msg",TOP_IMG:"first_run_top_img",BOTTOM_IMG:"first_run_bottom_img"},d,c,n={getDialogSettings:function(){return{autoOpen:!1,
width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"firstRunDialog"}},beforeDialogOpen:function(d){function n(){KindleChromeInstaller.install();e()}c=d;d=f();c.find("#"+m.TITLE).html(d.title);c.find("#"+m.TOP_MSG).html(d.topInstruction);d.topImgClass&&c.find("#"+m.TOP_IMG).addClass(d.topImgClass);d.bottomImgClass&&c.find("#"+m.BOTTOM_IMG).addClass(d.bottomImgClass);d.topInstructionClass&&c.find("#"+m.TOP_MSG).addClass(d.topInstructionClass);d=c.find("#"+h.BUTTON);d.html(ResourceBundle.getLocalizedString(a.BUTTON_TEXT));
d.one("click",b);KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()&&(d.removeClass("primary_btn").addClass("chrome_btn").html(ResourceBundle.getLocalizedString(a.BUTTON_TEXT_CHROME)),d=c.find("#"+h.CRX_BUTTON),d.removeClass("disabled").html(ResourceBundle.getLocalizedString(a.CRX_BUTTON_TEXT)),d.unbind("click"),d.one("click",n),d.show())},onDialogOpen:function(){var a=$("#"+h.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");
a.removeClass("ui-dialog-content ui-widget-content")},onDialogClose:function(){}};return{open:function(a){d=a;KindleUXComponentManager.openDialog(l,n)},close:e}}(),KindleMessageDialog=function(){var b={TITLE_ID:"kindle_dialog_message_title_text",TEXT_ID:"kindle_dialog_message_text"},f={dismiss:"k_dialog_message_dismissButton_text"},e,l,a,h,m=function(){KindleUXComponentManager.closeDialog("KindleMessageDialog")},d={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,
k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(c){var d={};h?d[h]=m:d[ResourceBundle.getLocalizedString(f.dismiss)]=m;if(_additionalButtons)for(var e=0;e<_additionalButtons.length;e++){var j=_additionalButtons[e];d[j.buttonText]=j.callback}c.dialog("option","buttons",d);c.find("#"+b.TITLE_ID).empty().append(a);c.find("#"+b.TEXT_ID).empty().append(l)},onDialogClose:function(){e&&e()}},c=function(b,c,m,j,o){e=m;a=b;l=c;_additionalButtons=o;h=j?j:ResourceBundle.getLocalizedString(f.dismiss);
KindleUXComponentManager.openDialog("KindleMessageDialog",d)};return{open:c,close:m,showError:function(a,b,d,e){a=KindleErrorMap.getErrorText(a);c(a.title,a.text,b,d,e)}}}(),KindleNotificationDialog=function(){function b(a){$(window).unbind("touchstart.notification mousedown.notification");KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).unbind("orientationchange.notification"):$(window).unbind("resize.notification");a.removeClass(n.SHOWN);setTimeout(function(){a.remove()},s)}function f(a){function b(c){var e,
g,h,f;if(e=d[c.optionProperty])if(typeof e==="string"?g=e:(g=e.id,h=e.localizationParams,f=e.htmlClass),e=ResourceBundle.getLocalizedString(g,h))c=$(c.tag).addClass(c.htmlClass).html(e),f&&c.addClass(f),a.find("."+n.CONTAINER).append(c)}a.find("."+n.CONTAINER).empty();b(n.PRETITLE);b(n.TITLE);b(n.BODY);b(n.LEGAL)}function e(a,b){var c=$("#kindleNotificationArrow"),d=$("#"+b.targetElementId),e=0,g=0;b.targetAlignment==="right"?(e=d.offset().left+d.outerWidth(),e-=a.outerWidth()):(e=d.offset().left+
d.outerWidth()/2,e-=a.outerWidth()/2);(function(){var b=$("body").outerWidth();e+a.outerWidth()>b&&(e=b-a.outerWidth());e<0&&(e=0)})();(function(){var a=b.targetBeakOffset||0;g=d.offset().left-e+d.outerWidth()/2+a})();a.css("left",e+"px");c.css("left",g+"px")}function l(a){function c(){e(a,d);KindleHostDeviceDetector.isiOS()&&a.show();k=null}function h(){k?clearTimeout(k):KindleHostDeviceDetector.isiOS()&&a.hide();k=setTimeout(c,g)}function f(){u=!0;H&&x.increment();b(a)}var k;$(window).bind("touchstart.notification mousedown.notification",
function(a){(!a.srcElement||!a.srcElement.id||!d.clickIdsToIgnore||!d.clickIdsToIgnore[a.srcElement.id])&&setTimeout(f,o)});KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).bind("orientationchange.notification",h):$(window).bind("resize.notification",h);setTimeout(f,j)}function a(a){l(a);$("body").append(a);e(a,d);setTimeout(function(){u||(a.addClass(n.SHOWN),setTimeout(function(){H=!0},q))},k)}function h(b){f(b);a(b)}function m(a){var b=$("<canvas id='kindleNotificationArrow' width='32' height='32'></canvas>"),
c=b[0].getContext("2d");c.beginPath();c.moveTo(0,24);c.lineTo(0,25);c.lineTo(32,25);c.lineTo(32,24);c.lineTo(16,0);c.closePath();c.fillStyle="#eee";c.fill();c.beginPath();c.moveTo(0,24);c.lineTo(16,0);c.lineTo(32,24);c.strokeStyle="rgba(32,32,32,0.8)";c.stroke();b.css("top","-24px");b.css("left","50%");b.css("margin-left","-16px");b.css("position","absolute");a.prepend(b);r.resolve(a)}var d={},c={},n={BODY:{htmlClass:"notificationBodyText",tag:"<div></div>",optionProperty:"bodyId"},LEGAL:{htmlClass:"notificationLegalText",
tag:"<div></div>",optionProperty:"legalId"},TITLE:{htmlClass:"notificationTitleText",tag:"<span></span>",optionProperty:"titleId"},PRETITLE:{htmlClass:"notificationPreTitleText",tag:"<span></span>",optionProperty:"preTitleId"},CONTAINER:"notificationContainer",SHOWN:"shown"},k=2E3,q=1E3,j=2E4,o=250,s=3E3,g=100,r=null,H=!1,u=!1,x;return{show:function(a){d=$.extend({},c,a);x=LocalStorageCounter("kcrNotifications."+d.notificationId);a=d.notificationCount|1;x.getValue()<a&&(r||(r=new jQuery.Deferred,
KindleUXComponentManager.initializeComponent("KindleNotificationDialog",m)),r.done(h))},hide:function(){var a=$("#kindleNotification");b(a)}}}(),KindlePopupMenu=function(){function b(a){var b=KindleUXComponentManager.renderTemplate(l),g=b.find("#kindle_menu_border"),h=q[a].menuItems,j=!0,m,x;for(x in h)m=$(document.createElement("div")).addClass(d).addClass(c).text(h[x].content).attr("id",h[x].elementId),j&&(m.addClass(n),j=!1),m.tap(f(m,h[x].clickHandler)),g.append(m);m.addClass(k);KindleHostDeviceDetector.isiOS()&&
"onorientationchange"in window&&$("body",Kindle.top.document).bind("orientationchange",function(){KindleUXComponentManager.hideMenu(a)});q[a].doneCallback(b,e(a))}function f(a,b){return function(){a.hasClass(c)&&b()}}function e(b){return{getDialogSettings:function(){var c=a,d=q[b];d.buttonID&&(c+=" "+(d.position==="down"?h:m));return{autoOpen:!1,draggable:!1,resizable:!1,modal:!0,minHeight:0,width:"auto",dialogClass:c,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var c=q[b].buttonID,
d=q[b].position,e=[];c?(c=$("#"+c),d==="down"?(d=c.offset().top+c.outerHeight(),e[0]=KindleHostDeviceDetector.isMetro()?c.offset().left+23:c.offset().left,e[1]=KindleHostDeviceDetector.isMetro()?d+10:d):(e[0]="right",e[1]="bottom")):e=d;a.dialog("option","position",e)},onDialogOpen:function(){j=!0},onDialogClose:function(){j=!1},onOverlayClicked:function(){j&&KindleUXComponentManager.hideMenu(b)}}}var l="KindlePopupMenu",a="kindle_menu",h="down_menu",m="up_menu",d="kindle_menu_button",c="button_enabled",
n="ui-corner-top",k="ui-corner-bottom",q={},j=!1;return{ITEM_ENABLED:0,ITEM_DISABLED:1,ITEM_HIDDEN:2,initialize:function(a,c,d,e,h){q[a]={menuItems:d,doneCallback:h,buttonID:c,position:e};KindleUXComponentManager.hasTemplate(l)?b(a):KindleUXComponentManager.initializeTemplate(l,function(){b(a)})},updateMenu:function(a,b){for(var e,h,f=0;f<b.length;f++)b[f]!==2&&(e===void 0&&(e=f),h=f);a.find("."+d).each(function(a){$(this).removeClass().addClass(d);switch(b[a]){case 0:$(this).addClass(c);break;case 1:$(this).addClass("button_disabled");
break;case 2:$(this).addClass("button_hidden")}a===e&&$(this).addClass(n);a===h&&$(this).addClass(k)})},updatePosition:function(a,b){q[a].position=b}}}(),KindlePromptDialog=function(){var b={OK_BUTTON_STRING_ID:"k_common_confirm_button",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button"},f={TEXT_LABEL_ID:"kindle_dialog_prompt_label"},e,l,a,h=function(){a="ok";KindleUXComponentManager.closeDialog("KindlePromptDialog")},m=function(){a="cancel";KindleUXComponentManager.closeDialog("KindlePromptDialog")},
d={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(b.CANCEL_BUTTON_STRING_ID)]=m;a[ResourceBundle.getLocalizedString(b.OK_BUTTON_STRING_ID)]=h;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(l);a.find("#"+f.TEXT_LABEL_ID).empty().append(b)},onDialogClose:function(){e(a)}};return{open:function(b,h){e=h;a=!1;l=b;KindleUXComponentManager.openDialog("KindlePromptDialog",
d)}}}(),KindleSigningOutDialog=function(){var b={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,width:"450px"}}};return{show:function(){KindleUXComponentManager.openDialog("KindleSigningOutDialog",b)},hide:function(){KindleUXComponentManager.closeDialog("KindleSigningOutDialog")}}}(),KindleSpinner=function(){function b(){h||(h=new jQuery.Deferred,KindleUXComponentManager.initializeComponent(l,f));return h.promise()}function f(b){a=b;h.resolve()}function e(){$("body").append(a);
var b=window.innerWidth>1?window.innerWidth:window.outerWidth,d=parseInt(a.css("width"),10),c=window.innerHeight>1?window.innerHeight:window.outerHeight,e=parseInt(a.css("height"),10);a.css("top",(c-e)/2+"px").css("left",(b-d)/2+"px")}var l="KindleSpinner",a,h;return{overlay:function(){var a=b();$.when(a).then(function(){e()})},show:function(){var a=b();$.when(a).then(function(){e()})},hide:function(){var a=b();$.when(a).then(function(){$("#loading_spinner").detach()})}}}(),KindleUnoptimizedFormatDialog=
function(){var b={TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_message",METRO_TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_metro_message",CLOSE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_close",STOP_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_stopSave",CONTINUE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_continue"},f={TEXT_LABEL_ID:"kindleReader_dialog_unoptimizedFormat_message_id"},e,l,a,h=function(){KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},m=function(){l=
!0;KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},d={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(b.CLOSE_BUTTON_STRING_ID)]=h;a[ResourceBundle.getLocalizedString(b.CONTINUE_BUTTON_STRING_ID)]=m;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(c){var d=KindleHostDeviceDetector.isIE()?b.METRO_TEXT_LABEL_STRING_ID:b.TEXT_LABEL_STRING_ID,d=ResourceBundle.getLocalizedString(d,
{linkStart:"<a href='http://itunes.apple.com/us/app/kindle/id302584613?mt=8'>",linkEnd:"</a>"});c.find("#"+f.TEXT_LABEL_ID).empty().append(d);$(c[0].parentNode).find(".ui-button-text").first().text(a)},onDialogClose:function(){e(l)}};return{open:function(c){a=ResourceBundle.getLocalizedString(b.CLOSE_BUTTON_STRING_ID);e=c;l=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",d)},openPinning:function(c){a=ResourceBundle.getLocalizedString(b.STOP_BUTTON_STRING_ID);e=c;l=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",
d)}}}(),KindleLibraryAppCacheFailDialog=function(){function b(){KindleUXComponentManager.closeDialog(f)}var f="KindleLibraryAppCacheFailDialog",e={DIALOG:"kindle_dialog_appCacheFail",IMG_ARROW_ID:"appCacheDialogFail_arrow",CONTENT_TEXT_ID:"appCacheDialogFail_content",TOGGLER_ID:"appCacheDialogFail_toggler",BUTTON:"kindle_appCacheDialog_button"},l=!1,a=!1,h,m={onDialogOpen:function(a){var b=$("#"+e.DIALOG);b.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");b.removeClass("ui-dialog-content ui-widget-content");
l=!0;a.dialog("option","position","center")},getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,width:626,position:"center",k4w_transparent_modal_overlay:!0}},onInitializationDone:function(d){h=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);d.find("#"+e.BUTTON).bind("click",b);var c=d.find("#"+e.TOGGLER_ID),f=d.find("#"+e.IMG_ARROW_ID),k=d.find("#"+e.CONTENT_TEXT_ID);c.tap(function(){k.slideToggle("fast",function(){d.dialog("option","position",
"center")});f.hasClass("kindleLibrary_arrowClosed")?f.switchClass("kindleLibrary_arrowClosed","kindleLibrary_arrowOpen",0):f.switchClass("kindleLibrary_arrowOpen","kindleLibrary_arrowClosed",0);a||h.emit("KindleApp:AppCacheError:BrowserRebootPrompt:ExpandClicked",{breakdown:["Browser"]});a=!0})}};return{hasBeenShownThisSession:function(){return l},open:function(){KindleUXComponentManager.openDialog(f,m)},close:b}}(),KindleLibraryContextMenu=function(){function b(b){return function(){e();b(a)}}function f(a){function e(a,
b,c){return{elementId:a,content:b,clickHandler:c}}h={};var f=0,l;for(l in d)h[d[l]]=e(d[l],ResourceBundle.getLocalizedString(m[l]),b(a[f])),f++}function e(){KindleUXComponentManager.hideMenu(l)}var l="KindleLibraryContextMenu",a,h,m={ITEM_PIN:"k_L_context_pin",ITEM_REMOVE:"k_L_context_remove",ITEM_DOWNLOAD_PIN:"k_L_context_download_pin",ITEM_OPEN_BOOK:"k_L_context_read"},d={ITEM_PIN:"kindleLibrary_contextMenuItem_pin",ITEM_REMOVE:"kindleLibrary_contextMenuItem_remove",ITEM_DOWNLOAD_PIN:"kindleLibrary_contextMenuItem_download_pin",
ITEM_OPEN_BOOK:"kindleLibrary_contextMenuItem_open_book"};return{isVisible:function(){return KindleUXComponentManager.isVisible(l)},show:function(b,d,e,m){a=b;f(m);KindleUXComponentManager.showMenu(l,null,h,e,d)},hide:e}}(),KindleLibraryControlBar=function(){function b(a,b){var c=B.find("#"+a).children(),d,e;for(d=0;d<c.length;d++)e=c[d].id,e===b?$(c[d]).addClass(G.ACTIVE):$(c[d]).removeClass(G.ACTIVE)}function f(a,b,c){var d=a.find("#"+b);d.tap(function(){if(c)return c(d[0]),!1})}function e(e){B=
e;B.find("#view_"+n).addClass(G.ACTIVE);B.find("#view_"+k).addClass(G.ACTIVE);var j=d[o],q=d[H],u=d[s];f(e,t.VIEW_GRID_ID,function(a){b(t.LAYOUT_BUTTONS_ID,t.VIEW_GRID_ID);A&&A.show();j(a.getAttribute("value"))});f(e,t.VIEW_LIST_ID,function(a){b(t.LAYOUT_BUTTONS_ID,t.VIEW_LIST_ID);A&&A.hide();j(a.getAttribute("value"))});f(e,t.SORT_BUTTON_ID,function(){u()});$.each(t.VIEW,function(a,c){f(e,c,function(a){!KindleHostDeviceDetector.isOnline()&&a.id===t.VIEW.CLOUD_ID||!KindleOffline.isEnabled()&&a.id===
t.VIEW.DOWNLOAD_ID||b(t.VIEW_BUTTONS_ID,a.id);q(a.getAttribute("value"))})});switch(x()){case Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART:a();break;case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:a();break;case Kindle.APP_CACHE.CACHE_PROGRESS:l(K);break;case Kindle.APP_CACHE.CACHE_CACHED:h();break;case Kindle.APP_CACHE.CACHE_DONE:h()}if(KindleHostDeviceDetector.isiOS())m(e);else{A=KindleLibraryImageSlider;var z={};z[A.EVENT_LIBRARY_IMAGE_CHANGING]=d[g];z[A.EVENT_LIBRARY_IMAGE_CHANGED]=d[r];A.initialize(function(a){a.insertAfter(B.find("#"+
t.VIEW_TOGGLE_ID));m(e)},c,n,z)}}function l(a){K=a;B&&B.addClass(G.CACHING)}function a(){if(B){B.removeClass(G.CACHE_SUCCESS).addClass(G.CACHE_ERROR);var a=KindleHostDeviceDetector.isiPad()?M.CACHE_ERROR_MESSAGE_PAD:M.CACHE_ERROR_MESSAGE;B.find("#"+t.MESSAGE_ID).empty().append(ResourceBundle.getLocalizedString(a)).tap(u)}}function h(){B&&(B.find("#"+t.MESSAGE_ID).empty().append(ResourceBundle.getLocalizedString(M.CACHE_DONE_MESSAGE)),B.removeClass(G.CACHE_ERROR).addClass(G.CACHE_SUCCESS),setTimeout(function(){B.removeClass(G.CACHING)},
z))}var m,d,c,n,k,q,j=0,o=j++,s=j++,g=j++,r=j++,H=j++,u,x,t={VIEW_GRID_ID:"view_grid",VIEW_LIST_ID:"view_list",SORT_BUTTON_ID:"kindleLibrary_button_sort",VIEW:{DOWNLOAD_ID:"view_downloaded",CLOUD_ID:"view_cloud"},VIEW_BUTTONS_ID:"view_state_buttons",CONTAINER_ID:"view_sort_size_controls",LAYOUT_BUTTONS_ID:"view_buttons",SORT_BUTTONS_ID:"view_sort",VIEW_TOGGLE_ID:"view_toggle",MESSAGE_ID:"cache_message"},M={CACHE_MESSAGE:"k_L_caching",CACHE_DONE_MESSAGE:"k_L_cached",CACHE_ERROR_MESSAGE:"k_L_cacheError",
CACHE_ERROR_MESSAGE_PAD:"k_L_cacheError_pad"},G={ACTIVE:"btn_set_active",CACHING:"caching",CACHE_ERROR:"cacheError",CACHE_SUCCESS:"cacheSuccess"},z=3E3,B,A,K=1;return{EVENT_LIBRARY_LAYOUT_CLICKED:o,EVENT_LIBRARY_SORT_CLICKED:s,EVENT_LIBRARY_IMAGE_CHANGING:g,EVENT_LIBRARY_IMAGE_CHANGED:r,EVENT_LIBRARY_VIEW_CLICKED:H,CONTAINER_HEIGHT:45,initialize:function(a,b,h){m=a;d=h;c=b.coverSize;n=b.layoutState;k=b.viewState;q=b.sortParam;KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);
a=ResourceBundle.getLocalizedString(KindleLibrarySort.getLabel(q));KindleUXComponentManager.initializeComponent("KindleLibraryControlBar",e,{sortParam:a})},setViewState:function(a){k=a;b(t.VIEW_BUTTONS_ID,"view_"+a)},setCacheProgress:l,setCacheNeedsRetry:a,setCacheDone:h,setRetryCallback:function(a){u=a},setAppCacheStatusGetter:function(a){x=a},hideViewTabs:function(){$("#page_body").addClass("search_mode",200)},showViewTabs:function(){$("#page_body").removeClass("search_mode",200)}}}(),KindleLibraryFeedbackDialog=
function(){function b(){KindleUXComponentManager.closeDialog(e)}function f(){var b=m.find("#"+a).val();if(b){m.find("#"+a);var c=m.find("#"+h);c.addClass("sending").removeClass("success error");c.html(ResourceBundle.getLocalizedString("k_provide_feedback_sending"));KindleRemoteClient.uploadFeedback({text:b}).then(function(){c.removeClass("sending error").addClass("success");c.html(ResourceBundle.getLocalizedString("k_provide_feedback_success"));setTimeout(function(){KindleUXComponentManager.closeDialog(e)},
1500)},function(){c.removeClass("success sending").addClass("error");c.html(ResourceBundle.getLocalizedString("k_provide_feedback_error"))})}else KindleUXComponentManager.closeDialog(e)}var e="KindleLibraryFeedbackDialog",l={DIALOG_SEND_FEEDBACK_BTN_ID:"k_send_feedback_button",DIALOG_CANCEL_BTN_ID:"k_common_cancel_button"},a="kindleLibrary_feedback_area",h="kindleLibrary_feedback_status",m,d=function(a){a.which===27&&b()},c={onInitializationDone:function(b){m=b;b.click(function(a){a.stopPropagation()});
KindleTouchEventsToggler.isRequired()&&(m.find("#"+a).focus(function(){KindleTouchEventsToggler.off()}),m.find("#"+a).blur(function(){KindleTouchEventsToggler.on()}))},getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(l.DIALOG_CANCEL_BTN_ID)]=b;a[ResourceBundle.getLocalizedString(l.DIALOG_SEND_FEEDBACK_BTN_ID)]=f;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(){m.find("#"+h).html("");m.find("#"+a).val("");
KindleHostDeviceDetector.isiOS()&&m.find("#"+a).attr("tabindex","-1");m.find("#"+a).off("keydown",d);m.find("#"+a).on("keydown",d)}};return{show:function(){KindleUXComponentManager.openDialog(e,c)}}}(),KindleLibraryHeaderBar=function(){function b(a,b){a.find("#"+g[b]).tap(function(){var a=z[r[b]];a&&a();return!1})}function f(a){B=a;A=$(a.find("#"+g.SYNC_BUTTON_ID)[0]);var c=z[r.SYNC_BUTTON_ID];z[r.SYNC_BUTTON_ID]=function(){K||c()};a.find(":not(.search)").click(function(){t&&h(!0)});var d=a.find("#"+
g.SEARCH_BAR_ID),f=a.find("#"+g.CLEAR_BUTTON_ID);d.keydown(function(a){a.keyCode===13&&a.preventDefault()});KindleLibrary.registerControlHotkey("F",e);d.keyup(function(){var a=d.attr("value");if(x[u.SEARCH])x[u.SEARCH](a);a&&!M?f.fadeIn(200):!a&&M&&f.fadeOut(420);M=a});z[r.CLEAR_BUTTON_ID]=m;a.find("#"+g.SEARCH_BUTTON_ID).click(e);a.find("#"+g.CLEAR_BUTTON_ID).click(m);for(var j in g)g[j]===g.SEARCH_BUTTON_ID||g[j]===g.SEARCH_BAR_ID||g[j]===g.CLEAR_BUTTON_ID||b(a,j);KindleTouchEventsToggler.isRequired()&&
(d.focus(function(){KindleTouchEventsToggler.off(function(a){return a&&a.tagName==="BODY"?!1:!0})}),d.blur(function(){KindleTouchEventsToggler.on()}));G(a)}function e(){t?h(!0):l()}function l(){if(!T){T=!0;var a=$("#"+g.SEARCH_BAR_ID),b=$("#"+g.SEARCH_BUTTON_ID);t=!0;if(x[u.ENABLE])x[u.ENABLE]();a.attr("value","");a.show();a.prop("disabled",!1);a.focus();a.css("opacity",100);a.hide();b.fadeOut(150,function(){b.removeClass("header_bar_icon large");b.addClass("small");b.fadeIn(100);a.fadeIn(420,function(){if(x[u.SEARCH])x[u.SEARCH]("");
T=!1})})}}function a(){if(KindleHostDeviceDetector.isiOS()){var a=$("#"+g.SEARCH_BUTTON_ID),b=$("#"+g.SEARCH_BAR_ID);b.detach();a.after(b)}}function h(b){if(t&&!T){var c=$("#"+g.SEARCH_BAR_ID);if(!c.val().trim()||b){var d=$("#"+g.SEARCH_BUTTON_ID);T=!0;a();c.blur();t=!1;m();if(x[u.DISABLE])x[u.DISABLE]();c.fadeOut(333,function(){c.attr("disabled","disabled");c.css("opacity",0);d.hide();d.removeClass("small");d.addClass("header_bar_icon large");d.fadeIn(150,function(){T=!1})})}}}function m(){$("#"+
g.SEARCH_BAR_ID).attr("value","");M="";$("#"+g.CLEAR_BUTTON_ID).fadeOut(420);t&&$("#"+g.SEARCH_BAR_ID).focus();if(x[u.SEARCH])x[u.SEARCH]("")}var d=0,c=d++,n=d++,k=d++,q=d++,j=d++,o=d++,s=d++,g={KINDLE_LOGO_ID:"kindleLibrary_kindleLogo",SEARCH_BUTTON_ID:"kindleLibrary_button_search",SYNC_BUTTON_ID:"kindleLibrary_button_sync",MANAGE_BUTTON_ID:"kindleLibrary_button_manage",STORE_BUTTON_ID:"kindleLibrary_button_store",SEARCH_BAR_ID:"kindleLibrary_bar_search",CLEAR_BUTTON_ID:"kindleLibrary_clear_search"},
r={KINDLE_LOGO_ID:c,SEARCH_BUTTON_ID:n,SEARCH_BAR_ID:k,CLEAR_BUTTON_ID:q,SYNC_BUTTON_ID:j,MANAGE_BUTTON_ID:o,STORE_BUTTON_ID:s},d=0,q=d++,H=d++,d=d++,u={ENABLE:q,SEARCH:H,DISABLE:d},x,t=!1,M="",G,z,B,A,K=!1,T=!1;return{EVENT_LOGO_CLICKED:c,EVENT_SEARCH_CLICKED:n,EVENT_BAR_CLICKED:k,EVENT_SYNC_CLICKED:j,EVENT_MANAGE_CLICKED:o,EVENT_STORE_CLICKED:s,SEARCH_CALLBACK:u,initialize:function(a,b,c){G=a;z=b;x=c;KindleUXComponentManager.initializeComponent("KindleLibraryHeaderBar",f)},setSyncButtonDisabled:function(a){B&&
(a?A.addClass("disabled"):A.removeClass("disabled"),K=a)},activateSearch:l,deactivateSearch:h,dismissKeyboard:function(){t&&($("#"+g.SEARCH_BAR_ID).attr("value")===""?h():a())},clearSearch:m}}(),KindleLibraryImageSlider=function(){function b(){n&&n.hide()}function f(f){n=f;var j=a[d],o=a[c],m=n.find("#"+k.IMAGE_SLIDER_ID);m.slider({range:"min",value:e,max:12,min:6,step:1,animate:!0,slide:j,change:o});m.find(".ui-slider-handle").removeAttr("href");m.find(".ui-slider-handle").attr("id",k.IMAGE_SLIDER_HANDLE_ID);
l==="list"&&b();h(f)}var e,l,a,h,m=0,d=m++,c=m++,n,k={IMAGE_SLIDER_ID:"kindleLibrary_coverImage_slider",IMAGE_SLIDER_HANDLE_ID:"kindleLibrary_coverImage_slider_handle"};return{EVENT_LIBRARY_IMAGE_CHANGING:d,EVENT_LIBRARY_IMAGE_CHANGED:c,initialize:function(b,c,d,k){h=b;l=d;a=k;e=c;KindleUXComponentManager.initializeComponent("KindleLibraryImageSlider",f)},show:function(){n&&n.show()},hide:b}}(),KindleLibraryMessagePane=function(){function b(b){m=!1;b.find(f.EMPTY_LIBRARY_MESSAGE).tap(function(){h();
return!0});var c=ResourceBundle.getLocalizedString(l.EMPTY_SEARCH_MSG);b.find("#"+f.EMPTY_SEARCH_TEXT).text(c);c=ResourceBundle.getLocalizedString(l.EMPTY_SEARCH_OFFLINE);b.find("#"+f.EMPTY_SEARCH_DETAIL).text(c);c=$(document.createElement("span")).addClass(e.EMPTY_LIBRARY_STORENAME).text(ResourceBundle.getLocalizedString(l.EMPTY_LIBRARY_storeName)).wrap("<div>").parent().html();c=ResourceBundle.getLocalizedString(l.EMPTY_LIBRARY_MSG,{storeName:c});b.find(f.EMPTY_LIBRARY_MAIN).html(c);a(b)}var f=
{EMPTY_LIBRARY_MESSAGE:"#empty-lib-box",EMPTY_LIBRARY_MAIN:"#empty-lib-box p.main",EMPTY_SEARCH_BOX:"#empty_search_box",EMPTY_SEARCH_TEXT:"#empty_search_text",EMPTY_SEARCH_DETAIL:"#empty_search_detail"},e={EMPTY_LIBRARY_STORENAME:"store-name"},l={EMPTY_SEARCH_MSG:"k_empty_search_msg",EMPTY_SEARCH_OFFLINE:"k_empty_search_offline",EMPTY_LIBRARY_MSG:"k_empty_library_main",EMPTY_LIBRARY_storeName:"k_empty_library_store_name"},a,h,m;return{initialize:function(d,c){a=d;h=c;KindleUXComponentManager.initializeComponent("KindleLibraryMessagePane",
b)},showEmptyLibraryMessage:function(){m||($("#page_body_content_containers").hide(),$(f.EMPTY_LIBRARY_MESSAGE).show(),m=!0)},hideEmptyLibraryMessage:function(){m&&($("#page_body_content_containers").show(),$(f.EMPTY_LIBRARY_MESSAGE).hide(),m=!1)},showEmptySearchMessage:function(a){m||($("#page_body_content_containers").hide(),$(f.EMPTY_SEARCH_BOX).show(),$(f.EMPTY_SEARCH_TEXT).show(),a?$(f.EMPTY_SEARCH_DETAIL).show():$(f.EMPTY_SEARCH_DETAIL).hide(),m=!0)},hideEmptySearchMessage:function(){m&&($("#page_body_content_containers").show(),
$(f.EMPTY_SEARCH_BOX).hide(),$(f.EMPTY_SEARCH_TEXT).hide(),$(f.EMPTY_SEARCH_DETAIL).hide(),m=!1)}}}(),KindleLibraryNoDownloadedMessage=function(){function b(b){a=b;var b=a.find("."+l.TOGGLER_CLASS),d=a.find("."+l.IMG_ARROW_CLASS),c=a.find("."+l.CONTENT_TEXT_CLASS);b.tap(function(){c.slideToggle("fast");d.hasClass(f)?d.switchClass(f,e,0):d.switchClass(e,f,0)});h.resolve()}var f="kindleLibrary_arrowClosed",e="kindleLibrary_arrowOpen",l={TOGGLER_CLASS:"kindleLibrary_noDownloadedToggle",CONTENT_TEXT_CLASS:"kindleLibrary_noDownloadedContent",
IMG_ARROW_CLASS:"kindleLibrary_noDownloadedArrow"},a,h;return{show:function(){h||(h=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleLibraryNoDownloadedMessage",b));h.promise().then(function(){$("#kindleLibrary_noDownloadsMsg").length<=0&&$("#titles_container").append(a)})},hide:function(){h&&a.detach()}}}(),KindleLibraryProgressDialog=function(){function b(){KindleUXComponentManager.closeDialog(e);h()}function f(b){m&&b>=0&&b<=100&&m.find("#"+a.PROGRESS_DIV_ID).slider("option",
"value",b)}var e="KindleLibraryProgressDialog",l={DIALOG_CANCEL_BTN_ID:"k_common_cancel_button"},a={PROGRESS_DIV_ID:"kindleLibrary_progressbar_div"},h,m,d={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(l.DIALOG_CANCEL_BTN_ID)]=b;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(){f(0)},onInitializationDone:function(b){m=b;m.find("#"+a.PROGRESS_DIV_ID).slider({range:"min",value:0,disabled:!0,max:100,
min:0,step:1,animate:!0});m.find(".ui-slider-range").addClass("ui-corner-all")}};return{open:function(a){h=a;KindleUXComponentManager.openDialog(e,d)},close:function(){KindleUXComponentManager.closeDialog(e)},updateValue:f}}(),KindleLibraryScrollBar=function(){function b(a){u=a;m(u.find("#"+k.UP_ARROW_ID),!0);m(u.find("#"+k.DOWN_ARROW_ID),!1);G&&n();r(u)}function f(a,b){z=A-b.value;H(z,!1)}function e(a,b){z=A-b.value;H(z,!0)}function l(a){z=a;u.find("#"+k.PROGRESS_ID).slider("option","value",A-a)}
function a(a){a=z+a;a=Math.min(a,A);a=Math.max(a,0);l(a);H(a,!0)}function h(){u.find("#"+k.PROGRESS_ID).slider({orientation:"vertical",animate:!0,slide:f,stop:e});u.find("."+q).removeAttr("href");u.find("."+q).attr("id",k.SLIDER_HANDLE_ID);u.find("#"+k.SLIDER_CONTAINER_ID).tap(function(a){z=a.clientY<a.currentTarget.offsetHeight/2?0:A;l(z);H(z,!0)});x=!0}function m(a,b){a.bind({mousedown:function(){d(b)},mouseup:c,mouseleave:c})}function d(b){c();var d=b?-j:j;a(d);M=0;t=setInterval(function(){M++;
M>=s&&a(d)},o)}function c(){clearInterval(t)}function n(){x||h();var a=u.find("#"+k.SLIDER_CONTAINER_ID).height(),a=Math.max(a*B/G,g);u.find("#"+k.SLIDER_DIV_ID).css({top:a/2+"px",bottom:a/2+"px"});A=G-B;u.find("#"+k.PROGRESS_ID).slider("option","min",0).slider("option","max",A);l(z);u.find("."+q).css({"margin-bottom":-a/2+"px",height:a+"px"})}var k={SLIDER_CONTAINER_ID:"KindleLibrarySliderContainer",SLIDER_DIV_ID:"KindleLibrarySliderDiv",SLIDER_HANDLE_ID:"kindleLibrarySliderHandle",PROGRESS_ID:"KindleLibraryProgress",
UP_ARROW_ID:"kindleLibrarySliderUpArrow",DOWN_ARROW_ID:"kindleLibrarySliderDownArrow"},q="ui-slider-handle",j=80,o=100,s=5,g=20,r,H,u,x,t,M,G,z,B,A;return{initialize:function(a,c){r=a;H=c;KindleUXComponentManager.initializeComponent("KindleLibraryScrollBar",b)},updateValueRange:function(a,b,c){G=a;z=b;B=c;u&&n()},updateValue:function(a){z=a;u&&l(a)},moveStart:d,moveEnd:c,movePage:function(b){a(b?-B:B)}}}(),KindleLibrarySettingsMenu=function(){function b(){a();KindleSigningOutDialog.show();KindleX.deregister(null,
!0).fail(function(){KindleSigningOutDialog.hide();KindleMessageDialog.open(ResourceBundle.getLocalizedString(m.OFFLINE_LOGOUT_TITLE),ResourceBundle.getLocalizedString(m.OFFLINE_LOGOUT_TEXT))})}function f(){a();KindleLibraryFeedbackDialog.show()}function e(){function a(b,c,d){return{elementId:b,content:c,clickHandler:d}}var e={};e.ITEM_HELP=a(d.ITEM_HELP,ResourceBundle.getLocalizedString(m.HELP_ID),l(c.HELP_LINK));e.ITEM_TERMS=a(d.ITEM_TERMS,ResourceBundle.getLocalizedString(m.TERM_OF_USE_ID),l(c.TERM_OF_USE_LINK));
e.ITEM_LEGAL=a(d.ITEM_LEGAL,ResourceBundle.getLocalizedString(m.LEGAL_NOTICE_ID),l(c.LEGAL_NOTICE_LINK));e.ITEM_PRIVACY=a(d.ITEM_PRIVACY,ResourceBundle.getLocalizedString(m.PRIVACY_ID),l(c.PRIVACY_LINK));e.ITEM_CONTACT_US=a(d.ITEM_CONTACT_US,ResourceBundle.getLocalizedString(m.CONTACT_US_ID),f);e.ITEM_DEREGISTER=a(d.ITEM_DEREGISTER,ResourceBundle.getLocalizedString(m.DEREGISTER_ID),b);return e}function l(b){return function(){a();n(b)}}function a(){KindleUXComponentManager.hideMenu(h)}var h="KindleLibrarySettingsMenu",
m={HELP_ID:"k_L_help",TERM_OF_USE_ID:"k_L_terms_of_use",LEGAL_NOTICE_ID:"k_L_legal_notices",PRIVACY_ID:"k_L_privacy",DEREGISTER_ID:"k_L_deregister_title",CONTACT_US_ID:"k_L_contact_us",OFFLINE_LOGOUT_TITLE:"k_dialog_offlineLogout_Title",OFFLINE_LOGOUT_TEXT:"k_dialog_offlineLogout_Text"},d={ITEM_HELP:"kindleLibrary_settingsMenu_item_help",ITEM_TERMS:"kindleLibrary_settingsMenu_item_terms",ITEM_LEGAL:"kindleLibrary_settingsMenu_item_legal",ITEM_PRIVACY:"kindleLibrary_settingsMenu_item_privacy",ITEM_CONTACT_US:"kindleLibrary_settingsMenu_item_contactUs",
ITEM_DEREGISTER:"kindleLibrary_settingsMenu_item_signOut"},c={HELP_LINK:"http://www.amazon.com/gp/help/customer/display.html/ref=kcr_help_menu?nodeId=200701430",TERM_OF_USE_LINK:"http://www.amazon.com/kindleterms",LEGAL_NOTICE_LINK:"http://www.amazon.com/gp/help/customer/display.html/ref=kcr_legalnotices_menu?nodeId=200701450",PRIVACY_LINK:"http://www.amazon.com/privacy"},n;return{show:function(a){n=a;KindleUXComponentManager.showMenu(h,"kindleLibrary_button_manage",e(),"down")},hide:a}}(),KindleLibrarySortMenu=
function(){function b(b){function a(a,b,c){return{elementId:a,content:b,clickHandler:c}}var h={};h.ITEM_SORT_RECENT=a(e.ITEM_SORT_RECENT,ResourceBundle.getLocalizedString(f.SORT_RECENT),function(){KindleLibrarySortMenu.hide();b("recent")});h.ITEM_SORT_AUTHOR=a(e.ITEM_SORT_AUTHOR,ResourceBundle.getLocalizedString(f.SORT_AUTHOR),function(){KindleLibrarySortMenu.hide();b("author")});h.ITEM_SORT_TITLE=a(e.ITEM_SORT_TITLE,ResourceBundle.getLocalizedString(f.SORT_TITLE),function(){KindleLibrarySortMenu.hide();
b("title")});return h}var f={SORT_RECENT:"k_L_sort_recent",SORT_AUTHOR:"k_L_sort_author",SORT_TITLE:"k_L_sort_title"},e={ITEM_SORT_RECENT:"kindleLibrary_sortMenuItem_sortByRecent",ITEM_SORT_AUTHOR:"kindleLibrary_sortMenuItem_sortByAuthor",ITEM_SORT_TITLE:"kindleLibrary_sortMenuItem_sortByTitle"};return{show:function(e,a){KindleUXComponentManager.showMenu("KindleLibrarySortMenu","kindleLibrary_button_sort",b(a),e)},hide:function(){KindleUXComponentManager.hideMenu("KindleLibrarySortMenu")}}}(),KindleLibraryHomeScreenPopup=
function(){function b(b){var d=$(document.createElement("span")).addClass(e.IMAGE_CLASS).context.outerHTML,k=$(document.createElement("span")).addClass(e.STRONG_TEXT_CLASS).text(ResourceBundle.getLocalizedString(l.STRONG_TEXT_ID)).context.outerHTML;b.find("."+e.TEXT_CLASS).append(ResourceBundle.getLocalizedString(l.TEXT_ID,{browserActionIcon:d,addToHomeText:k}));$("body").append(b);setTimeout(function(){b.addClass(f);b.tap(function(){KindleHostDeviceDetector.isiOS_5xOrGreater()&&KindleLibraryHeaderBar.deactivateSearch();
b.removeClass(f)});setTimeout(function(){b.removeClass(f)},h);setTimeout(function(){b.remove()},m)},a)}var f="shown",e={IMAGE_CLASS:"addToHomeActionIcon",TEXT_CLASS:"addToHomeText",STRONG_TEXT_CLASS:"addToHomeStrongText"},l={TEXT_ID:"k_addToHomeScreen_text",STRONG_TEXT_ID:"k_addToHomeScreen_strong_text"},a=5E3,h=14E3,m=17E3,d;return{show:function(){!d&&KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isInAppMode()&&(d=!0,KindleUXComponentManager.initializeComponent("KindleLibraryHomeScreenPopup",
b))}}}(),KindleErrorMap=function(){var b,f;return{getErrorText:function(e){if(!b)b={},b[Kindle.ERROR.OUT_OF_SPACE]={title:"k_L_saveBookOutOfSpace_Title",text:"k_L_saveBookOutOfSpace_Text",textParams:{linkStart:"<a href='http://www.amazon.com/gp/help/customer/display.html/ref=kcr_help_menu?nodeId=200732370#fxoffline' target='_blank'>",linkEnd:"</a>"}},b[Kindle.ERROR.TIMEOUT]={title:"k_L_openBookTimeoutError_Title",text:"k_L_openBookTimeoutError_Text"},b[Kindle.ERROR.LOAD_FAILURE]={title:"k_L_openBookLoadFailure_Title",
text:"k_L_openBookLoadFailure_Text"},b[Kindle.ERROR.REMOVE_FAILURE]={title:"k_L_removeBookError_Title",text:"k_L_removeBookError_Text"},b[Kindle.ERROR.REMOVE_NETWORK_FAILURE]={title:"k_L_removeBookNetworkError_Title",text:"k_L_removeBookNetworkError_Text"},b[Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED]={title:"k_bookextras_open_failed_Error_Title",text:"k_bookextras_open_failed_Error_Text"},b[Kindle.ERROR.BOOKEXTRAS_NO_CACHE_ERROR]={title:"k_bookextras_offline_cache_failed_Error_Title",text:"k_bookextras_offline_cache_failed_Error_Text"},
b[Kindle.ERROR.CONTENT_LOANED]={title:"k_L_openBookContentLoanedError_Title",text:"k_L_openBookContentLoanedError_Text"},b[Kindle.ERROR.CONTENT_LOAN_ENDED]={title:"k_L_openBookContentLoanEndedError_Title",text:"k_L_openBookContentLoanEndedError_Text"},b[Kindle.ERROR.CONTENT_LICENSE_EXCEEDED]={title:"k_L_openBookContentLicenseExceededError_Title",text:"k_L_openBookContentLicenseExceededError_Text"},b[Kindle.ERROR.CONTENT_UNSUPPORTED]={title:"k_L_openBookContentUnsupportedError_Title",text:"k_L_openBookContentUnsupportedError_Text"},
b[Kindle.ERROR.CONTENT_UNSUPPORTED_METRO]={title:"k_L_openBookContentUnsupportedErrorMetro_Title",text:"k_L_openBookContentUnsupportedErrorMetro_Text"},b[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]={title:"k_L_openBookContentRentalExpiredError_Title",text:"k_L_openBookContentRentalExpiredError_Text"},b[Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO]={title:"k_L_openBookContentRentalExpiredErrorMetro_Title",text:"k_L_openBookContentRentalExpiredErrorMetro_Text",textParams:{link:"<a href='http://kindle.amazon.com/' target='_blank'>http://kindle.amazon.com/</a>"}},
b[Kindle.ERROR.CONTENT_UPGRADE]={title:"k_L_openBookContentUpgrade_Title",text:"k_L_openBookContentUpgrade_Text"},b[Kindle.ERROR.SESSION_LIMIT_EXCEEDED]={title:"k_L_openBookSessionLimitExceededError_Title",text:"k_L_openBookSessionLimitExceededError_Text"},b[Kindle.ERROR.BOOK_NOT_AVAILABLE]={title:"k_L_bookNotAvailable_Title",text:"k_L_bookNotAvailable_Text"},b[Kindle.ERROR.STORE_NOT_AVAILABLE]={title:"k_L_storeNotAvailable_Title",text:"k_L_storeNotAvailable_Text"},b[Kindle.ERROR.STORE_OPEN_FAILED]=
{title:"k_store_open_failed_Error_Title",text:"k_store_open_failed_Error_Text"},b[Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED]={title:"k_store_open_failed_offline_Error_Title",text:"k_store_open_failed_offline_Error_Text"},b[Kindle.ERROR.SYNC_FAILED]={title:"k_L_syncFailedError_Title",text:"k_L_syncFailedError_Text"},b[Kindle.ERROR.SYNC_FAILED_OFFLINE]={title:"k_L_syncFailedOfflineError_Title",text:"k_L_syncFailedOfflineError_Text"},b[Kindle.ERROR.NOT_IMPLEMENTED]={title:"k_lib_unimplementedFeature_Error_Title",
text:"k_lib_unimplementedFeature_Error_Text"},b[Kindle.ERROR.LIBRARY_LOAD_FAILED]={title:"k_L_loadFailedError_Title",text:"k_L_loadFailedError_Text"},b[Kindle.ERROR.NETWORK]={title:"k_L_openBookNetworkError_Title",text:"k_L_openBookNetworkError_Text"},b[Kindle.ERROR.UNKNOWN_ERR]={title:"k_L_unknownError_Title",text:"k_L_unknownError_Text"},b[Kindle.ERROR.OUTDATED_CHROME]={title:"k_L_outdatedChrome_Title",text:"k_L_outdatedChrome_Text",textParams:{linkStart:"<a href='https://www.google.com/chrome/' target='_blank'>",
linkEnd:"</a>"}},f={},f[Kindle.ERROR.CONTENT_UNSUPPORTED]=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO,f[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]=Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO;KindleHostDeviceDetector.isMetro()&&(e=f[e]||e);(e=b[e])||(e=b[Kindle.ERROR.UNKNOWN_ERR]);return{title:ResourceBundle.getLocalizedString(e.title,e.titleParams),text:ResourceBundle.getLocalizedString(e.text,e.textParams)}}}}(),KindleIOSScrollStopper={stopScroll:function(b){b.preventDefault()}},KindleListUtilities=function(){return{binarySearch:function(b,
f,e){if(!b.length)return 0;for(var l=b.length-1,a=0,h=0,m=null,d=0;a<=l;)if(h=Math.floor((a+l)/2),m=b[h],d=0,e===void 0?m>f?d=1:m<f&&(d=-1):d=e(f,m),d>0)l=h-1;else if(d<0)a=h+1;else return h;return h===0||d<0?h:h-1},first:function(b){return b[0]},last:function(b){return b[b.length-1]}}}(),KindleOffline=function(){function b(a){var b=new jQuery.Deferred;setTimeout(b.resolve,a);return b.promise()}function f(a,b,f){if(a.indexOf(e)>=0&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()){var d=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),
c=d.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.openPinning(function(a){a?(d.increaseSubCounter(c,"Continue",1),d.endMetrics(c),d=null,b()):(d.increaseSubCounter(c,"Cancel",1),d.endMetrics(c),d=null,f())})}else b()}var e="topaz",l=null;return{isFirstTime:function(){return KindleLocalStorage.localStorageObject.getItem("haveRun")?!1:!0},isEnabled:function(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled()},firstRunMessage:function(){var a=
new jQuery.Deferred;KindleFirstRunDialog.open(function(){KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(a.resolve,a.reject);KindleLocalStorage.localStorageObject.setItem(Kindle.App.HAVE_RUN,"true")});return a.promise()},enableOfflineMessage:function(){var a=new jQuery.Deferred;KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(a.resolve,a.reject);setTimeout(function(){a.isRejected()&&KindleEnableOfflineDialog.open()},500);return a.promise()},
pinBook:function(a,e){function l(){o.cancelDownloading();KindleLibraryProgressDialog.close();k.reject()}function d(){KindleLibraryProgressDialog.updateValue(100);$.when(q,b(200)).then(function(){KindleLibraryProgressDialog.close();k.resolve()})}function c(a){KindleLibraryProgressDialog.close();a!==Kindle.ERROR.CANCELLED&&e(a);k.reject(a)}function n(){function a(b,c){KindleLibraryProgressDialog.updateValue(Math.round(100*Math.min(b,c)/Math.max(1,c)))}o.getSizeInfo().then(function(b){b.bookSize*1.53>
b.quota?c(Kindle.ERROR.OUT_OF_SPACE):o.getBookInfoDfd().then(function(){var b=o.getBookType();f(b,function(){g.resolve(!0);o.getDownloadComplete(a).then(d,c)},function(){g.reject();l()})})})}var k,q,j,o,s,g;k=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return k.reject(),k.promise();j=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(d){j.registerModuleList(d);s=j.getModuleSync(j.METRICS_MANAGER).startMetrics("Pin");
a.isSample=!1;o=KindleReaderBookInfoProvider.BookInfo(a,j);q=b(1500);g=new jQuery.Deferred;KindleLibraryProgressDialog.open(l);o.startDownloading(s,c,g).then(n,c)});return k.promise()},unpinBook:function(a,b){function e(a){KindleSpinner.hide();l.endMetrics(j);b(a===Kindle.ERROR.NETWORK?Kindle.ERROR.REMOVE_NETWORK_FAILURE:Kindle.ERROR.REMOVE_FAILURE);f.reject(a)}function d(){KindleSpinner.hide();l.endMetrics(j);f.resolve()}function c(b){b.cacheState!==Kindle.BookInfo.CachedState.PINNED?b=!0:KindleHostDeviceDetector.isOnline()?
(b={asin:a.asin,kindleSessionId:b.context.kindleSessionId,isOffline:!1},b=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(b)):b=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return b}var f,k,l,j;KindleSpinner.show();f=new jQuery.Deferred;l=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);j=l.startMetrics("Unpin");k=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();k.getRecord("bookinfo",{asin:a.asin},
{cacheState:!0,context:!0}).then(function(b){b&&b.length>0?$.when(c(b[0])).fail(e).done(function(){k.deleteBooksData([a.asin]).then(d,e)}):d()},e);return f.promise()},downloadBook:function(a,e,f,d){function c(){$.when(j,b(200)).then(function(){q.resolve();f()})}function n(a){if(a!==Kindle.ERROR.CANCELLED){if(a===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())a=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;var b=KindleErrorMap.getErrorText(a);b.code=a;d(b)}q.reject(a)}function k(){function a(b,
c){e(Math.round(100*Math.min(b,c)/Math.max(1,c)))}l.getSizeInfo().then(function(b){b.bookSize*1.53>b.quota?n(Kindle.ERROR.OUT_OF_SPACE):(g.resolve(!0),l.getDownloadComplete(a).then(c,n))})}var q,j,o,s,g;q=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return q.reject(),q.promise();o=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(c){o.registerModuleList(c);s=o.getModuleSync(o.METRICS_MANAGER).startMetrics("Pin");
l=KindleReaderBookInfoProvider.BookInfo(a,o);j=b(1500);g=new jQuery.Deferred;l.startDownloading(s,n,g).then(k,n)});return q.promise()},removeBook:function(a,b,e){function d(a){l.endMetrics(j);e(a)}function c(){l.endMetrics(j);b()}function f(b){b.cacheState!==Kindle.BookInfo.CachedState.PINNED||b.context.isSample?b=!0:KindleHostDeviceDetector.isOnline()?(b={asin:a.asin,kindleSessionId:b.context.kindleSessionId,isOffline:!1},b=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(b)):
b=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return b}var k,l,j;l=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);j=l.startMetrics("Unpin");k=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();k.getRecord("bookinfo",{asin:a.asin},{cacheState:!0,context:!0}).then(function(b){b&&b.length>0?$.when(f(b[0])).fail(d).done(function(){k.deleteBooksData([a.asin]).then(c,d)}):c()},d)},cancelBookDownload:function(){l.cancelDownloading()}}}(),KindleStringUtilities=
function(){var b={"\u2019":"'","\uff07":"'","\u00e0":"a","\u00e1":"a","\u00e2":"a","\u00e3":"a","\u00e4":"a","\u00e5":"a","\u00c0":"a","\u00c1":"a","\u00c2":"a","\u00c3":"a","\u00c4":"a","\u00c5":"a","\u00e8":"e","\u00e9":"e","\u00ea":"e","\u00eb":"e","\u00c8":"e","\u00c9":"e","\u00ca":"e","\u00cb":"e","\u00ec":"i","\u00ed":"i","\u00ee":"i","\u00ef":"i","\u00cc":"i","\u00cd":"i","\u00ce":"i","\u00cf":"i","\u00f2":"o","\u00f3":"o","\u00f4":"o","\u00f5":"o","\u00f6":"o","\u00f8":"o","\u00d2":"o","\u00d3":"o",
"\u00d4":"o","\u00d5":"o","\u00d6":"o","\u00d8":"o","\u00f9":"u","\u00fa":"u","\u00fb":"u","\u00fc":"u","\u00d9":"u","\u00da":"u","\u00db":"u","\u00dc":"u","\u00fd":"y","\u00ff":"y","\u00dd":"y","\u0178":"y","\u00e7":"c","\u00c7":"c","\u00f1":"n","\u00d1":"n","\u00df":"s","\u00e6":"ae","\u00c6":"ae","\u0153":"oe"};return{replaceAccentedChars:function(f){return f=f.replace(/[^A-Za-z0-9 ]+/g,function(e){return b[e]?b[e]:e})},stripNonAlphaNumericChars:function(f){return f=f.replace(/^[^A-Za-z0-9 ]+/g,
function(e){return b[e]?e:""})}}}(),KindleTouchEventsToggler=function(){function b(a){if(m)for(var b=$(":hasTouchEvent"),e=0;e<b.length;e++){var f=b[e];if((!a||!a(f))&&f._listeners)for(var l=f._listeners.slice(0),j=0;j<l.length;j++){var o=l[j][0];if(o==="touchstart"||o==="touchmove"||o==="touchend")o={element:f,type:o,func:l[j][1],useCapture:l[j][2]},h.push(o),f.removeEventListener(o.type,o.func,o.useCapture)}}}function f(){if(m){for(var a=0;a<h.length;a++){var b=h[a];b.element.addEventListener(b.type,
b.func,b.useCapture)}h=[]}}var e=null,l=null,a=!1,h=[],m=!1;return{initialize:function(){if(!a)e=HTMLElement.prototype.addEventListener,HTMLElement.prototype.addEventListener=function(){if(!this._listeners)this._listeners=[];this._listeners.push(arguments);e.apply(this,arguments)},l=HTMLElement.prototype.removeEventListener,HTMLElement.prototype.removeEventListener=function(){function a(b,c){try{return typeof b==="function"&&typeof c==="function"?b===c:b.handleEvent===c.handleEvent}catch(d){}return!1}
if(this._listeners)for(var b=0;b<this._listeners.length;++b)if(this._listeners[b][0]===arguments[0]&&a(this._listeners[b][1],arguments[1])){this._listeners.splice(b,1);break}l.apply(this,arguments)},m=a=!0,$.expr[":"].hasTouchEvent=function(a){if(a._listeners)for(var b=0;b<a._listeners.length;b++){var e=a._listeners[b][0];if(e==="touchstart"||e==="touchmove"||e==="touchend")return!0}return!1},$.expr[":"].hasListeners=function(a){return a._listeners!==void 0}},deInitialize:function(){if(a){var b=0;
$(":hasListeners").each(function(a,e){for(var f=e._listeners.slice(0),h=0;h<f.length;h++)e.removeEventListener(f[h][0],f[h][1]),b++});HTMLElement.prototype.addEventListener=e;HTMLElement.prototype.removeEventListener=l;h=[];a=!1}},on:f,off:b,disallowTouchEvents:function(){m=!0;b();m=!1},allowTouchEvents:function(){m=!0;f()},isRequired:function(){return KindleHostDeviceDetector.isiOS()}}}();
(function(b){var f=["tap","tapHold","swipeLeft","swipeRight","activate","pinch","zoom","doubletap"];b.each(f,function(e,f){b.fn[f]=function(a,e){e=e||{};return f==="tap"?KindleHostDeviceDetector.isTouchDevice()?a?gt(this).on(f,a,b.extend(e,{expire:700,moveThreshold:10})):this.trigger(f):a?this.click(a):this.trigger("click"):a?gt(this).on(f,a,e):this.trigger(f)};b.attrFn[f]=!0});b.each(f,function(e,f){var a="unbind"+f.slice(0,1).toUpperCase()+f.slice(1);b.fn[a]=function(a){return f==="tap"&&!KindleHostDeviceDetector.isiOS()&&
!KindleHostDeviceDetector.isMSPointerEnabled()?a?this.unbind("click",a):this.unbind("click"):gt(this).off(f,a)};b.attrFn[a]=!0})})(jQuery);
var KindleUXComponentManager=function(){function b(a,b){var c=$.extend({},b,{s:ResourceBundle.getLocalizedString});return $.tmpl(a,{},c)}function f(a){if(a.callbacks.onDialogOpen)a.callbacks.onDialogOpen(a.component);a.callbacks.onOverlayClicked&&$(".ui-widget-overlay").tap(a.callbacks.onOverlayClicked).bind("contextmenu",function(b){a.callbacks.onOverlayClicked();b.preventDefault()})}function e(a,c,e){d(a,function(){var d;d=b(a,e);k[a]={component:d};c(d)})}function l(a){a.stopPropagation()}function a(a,
b,c,d){var e=k[a];e.callbacks=c;if(c.onInitializationDone)c.onInitializationDone(b);if(c.getDialogSettings)e.dialogSettings=c.getDialogSettings();if(e.dialogSettings.width===void 0){if(KindleHostDeviceDetector.isiPad())a=j;else if(KindleHostDeviceDetector.isMetro()){if(a=s,e.dialogSettings.dialogClass="wide-dialog",!d)e.dialogSettings.k4w_transparent_modal_overlay=!1}else a=o;e.dialogSettings.width=a}e.dialogSettings.modal&&b.keydown(l).keyup(l);if(KindleHostDeviceDetector.isiOS_5xOrGreater()){a=
e.dialogSettings;if(a.modal)a.modal=!1,a.k4w_modal=!0;b=b.dialog(a)}else b=b.dialog(e.dialogSettings);e.component=b;if(!d&&!KindleHostDeviceDetector.isiOS_5xOrGreater()){var m=b.dialog("option","position");$(window).resize(function(){b.dialog("option","position",m)})}b.bind("dialogopen",function(){f(e)});b.bind("dialogclose",function(){if(e.callbacks.onDialogClose)e.callbacks.onDialogClose(e.component);e.dialogSettings.k4w_modal&&KindleDialogOverlay.removeOverlay()});b.bind("dialogbeforeclose",function(){$(".ui-widget-overlay").unbindTap();
e.dialogSettings.modal&&g&&g(!0);e.callbacks.beforeDialogClose&&e.callbacks.beforeDialogClose(e.component)});h(e)}function h(a){a.component.dialog("isOpen")||(a.dialogSettings.k4w_transparent_modal_overlay?$("body").addClass(q):$("body").removeClass(q),a.callbacks.beforeDialogOpen&&a.callbacks.beforeDialogOpen(a.component),a.dialogSettings.modal&&g&&g(!1),a.dialogSettings.k4w_modal&&KindleDialogOverlay.showOverlay(a),a.component.dialog("open"))}function m(a){k[a]&&k[a].component.dialog("isOpen")&&
k[a].component.dialog("close")}function d(a,b){c(a).then(function(c){n[a]||($.template(a,c),b())},function(){KindleDebug.error("Template "+a+" is missing")})}function c(a){var b=$.Deferred(),a=$("#"+a);a.length!==1?b.reject():b.resolve(a);return b.promise()}function n(a){return $.template[a]}var k=[],q="transparent_overlay",j=475,o=400,s="100%",g;return{initializeTemplate:d,hasTemplate:n,renderTemplate:function(a,c){if(!$.template[a])throw{name:"initializationError",message:"Please call KindleUXComponentManager.initializeTemplate function first"};
return b(a,c)},initializeComponent:e,openDialog:function(b,c,d){var f=k[b];f?h(f):f!==null&&(k[b]=null,e(b,function(d){a(b,d,c)},d))},closeDialog:m,isVisible:function(a){return k[a]&&k[a].component.dialog("isOpen")?!0:!1},showMenu:function(b,c,d,e,f){var g=k[b];g?(c||KindlePopupMenu.updatePosition(b,e),f&&KindlePopupMenu.updateMenu(g.component,f),h(g)):KindlePopupMenu.initialize(b,c,d,e,function(c,d){f&&KindlePopupMenu.updateMenu(c,f);k[b]={component:c};a(b,c,d,!0)})},updateMenu:function(a,b){var c=
k[a];c&&KindlePopupMenu.updateMenu(c.component,b)},hideMenu:m,registerKeyEventsEnabledCallback:function(a){g=a}}}();
