/*
 * Copyright (c) 2012 Amazon.com, Inc. All rights reserved.
 */
function KindleBookDownloaderFactory(b){var l=5E3,e=0,k=1E3,a={};b.downloader=a;a.type=b.type;a.asin=b.asin;a.cache=b.cache;a.readAheadActive=!1;a.readAheadPauseCount=0;a.dbPutter=b.dbPutter;a.dbGetIdList=b.dbGetIdList;a.dbOosHandler=b.dbOosHandler;a.dbCheckCache=b.dbCheckCache;a.dbIsCached=b.dbIsCached;a.dbIsOos=b.dbIsOos;a.netGetter=b.netGetter;a.urlGetter=b.urlGetter;a.fileGetter=b.fileGetter;a.fileProgress=b.fileProgress;a.downloadError=b.downloadError;a.isIdRequired=b.isIdRequired||function(){return!0};
a.pauseReadAhead=function(){this.readAheadPauseCount++};a.resumeReadAhead=function(a){this.readAheadPauseCount=Math.max(0,--this.readAheadPauseCount);if(this.readAheadPauseCount===0)this.nextReadAheadId=a};a.removeIdFromReadAhead=function(a){if(this.readAheadActive){var b;for(b=0;b<this.readAheadIds.length;b++)if(this.readAheadIds[b]===a){this.readAheadIds.splice(b,1);break}for(b=0;b<this.readAheadUrls.length;b++)if(this.readAheadUrls[b].id===a){this.readAheadUrls.splice(b,1);break}}};a.readAheadOne=
function(a){function b(){g.readAheadActive&&(g.numReadAheadNetRequests--,g.readAheadUrls.length===0?g.numReadAheadNetRequests===0&&setTimeout(function(){g.getReadAheadUrls(a)},g.interReadWait):setTimeout(function(){g.readAheadOne(a)},g.interReadWait))}function e(){b()}function h(a){function c(){g.readAheadRemaining--;g.fileProgress(g.readAheadRemaining);b()}var d;d=a.fragmentMetadata!==void 0?a.fragmentMetadata.id:a.skeletonMetadata!==void 0?a.skeletonMetadata.id:a.glyphFragmentMetadata!==void 0?
a.glyphFragmentMetadata.id:void 0;var h=[];h[d]=a;g.dbPutter(h,c,function(a){function f(){g.dbPutter(h,c,d)}function d(){g.readAheadActive=!1;g.dbIsOos()}!(a.code===Kindle.DB.CONSTRAINT_ERR||a.message==="constraint failed")&&a.code===Kindle.DB.QUOTA_ERR?(g.dbCheckCache(),g.dbOosHandler(f,d)):b()})}var g=this;if(a===this.readAheadGeneration)if(g.readAheadStillAlive++,this.readAheadPauseCount>0)setTimeout(function(){g.readAheadOne(a)},g.startReadWait);else if(g.readAheadUrls.length===0&&g.numReadAheadNetRequests===
0)g.getReadAheadUrls(a);else for(;g.numReadAheadNetRequests<g.numReadAhead&&g.readAheadUrls.length>0;){g.numReadAheadNetRequests++;var d=g.readAheadUrls.shift();g.fileGetter(d,h,e)}};a.getReadAheadUrls=function(a){function b(f){h.readAheadUrls=f;setTimeout(function(){h.readAheadOne(a)},h.interReadWait)}function e(){}var h=this;if(a===this.readAheadGeneration&&this.readAheadActive)if(h.dbCheckCache()){h.readAheadStillAlive++;for(var g=[],d=0;d<h.readAheadIds.length&&h.readAheadIds[d]<h.nextReadAheadId;)d++;
d===h.readAheadIds.length&&(d=0);g=h.readAheadIds.splice(d,h.numReadAheadUrls);g.length===0?h.refreshReadAheadList(a):(h.nextReadAheadId=d<h.readAheadIds.length?h.readAheadIds[d]:0,h.urlGetter(g,b,e))}else h.readAheadActive=!1};a.refreshReadAheadList=function(b){function e(d){function f(){h.getReadAheadUrls(b)}var c=g.createSubTimer("success");h.readAheadStillAlive++;var s,o=[];for(s in d)o[d[s]]=!0;h.readAheadIds=[];for(s=0;s<=h.maxReadAheadId;s++)!o[s]&&a.isIdRequired(s)&&h.readAheadIds.push(s);
c.addCount("needed",h.readAheadIds.length);c.addCount("total",h.maxReadAheadId+1);c.endTimer();g.endTimer();g.log();if(h.readAheadIds.length>0){if(h.readAheadRemaining=h.readAheadIds.length,h.readAheadRemaining!==h.readAheadRemainingPrev)h.readAheadRemainingPrev=h.readAheadRemaining,setTimeout(f,h.startReadWait)}else h.readAheadActive=!1,h.dbIsCached()}function m(){g.endTimer();h.downloadError(Kindle.ERROR.UNKNOWN_DB_ERROR)}var h=this;if(b===this.readAheadGeneration){var g;this.readAheadActive&&(g=
KindleMetricsProfiler("bookDownloader.getIdList"),this.dbGetIdList(e,m))}};a.readAheadWatchdog=function(){var a=this;if(this.readAheadActive){if(this.readAheadStillAlive===0)this.readAheadGeneration++,this.readAheadRemaining<this.generationReadAheadRemaining?(this.numReadAheadNetRequests=0,this.generationReadAheadRemaining=this.readAheadRemaining,this.readAheadRemainingPrev=this.readAheadRemaining+1,this.watchDogTimeout=15E3,this.refreshReadAheadList(this.readAheadGeneration)):this.timeoutRetry?(this.generationReadAheadRemaining=
this.readAheadRemaining+1,this.watchDogTimeout=12E4):this.downloadError(Kindle.ERROR.TIMEOUT);setTimeout(function(){a.readAheadWatchdog()},this.watchDogTimeout)}this.readAheadStillAlive=0};a.startReadAhead=function(b,n){var m=this,h=l;if(this.cache){this.readAheadUrls=[];this.readAheadIds=[];this.numReadAheadNetRequests=this.nextReadAheadId=0;this.maxReadAheadId=b;this.readAheadActive=!0;this.readAheadGeneration=this.readAheadStillAlive=0;this.readAheadRemaining=b+1;this.readAheadRemainingPrev=this.readAheadRemaining+
1;this.generationReadAheadRemaining=b+2;this.watchDogTimeout=15E3;for(var g=this.numIds=0;g<=b;g++)a.isIdRequired(g)&&this.numIds++;n?(this.startReadWait=this.interReadWait=h=0,this.numReadAhead=8,this.numReadAheadUrls=200):(this.startReadAheadWait=l,this.interReadWait=e,this.startReadWait=k,this.numReadAhead=4,this.numReadAheadUrls=20,this.timeoutRetry=!0);this.debugCounter=15;setTimeout(function(){m.readAheadWatchdog()},h)}else this.readAheadActive=!1};a.cancelReadAhead=function(){this.readAheadActive=
!1;this.readAheadGeneration=-1;this.readAheadIds=this.readAheadUrls=null};a.setReadAheadTimersForTestMode=function(){k=e=l=0};return a}
function KindleReaderBookInfoProviderFactory(){var b=3E4,l="fragment",e="glyph",k="skeleton",a="resource",j="locationMap",n=l+"Ids",m=e+"Ids",h=k+"Ids",g=a+"Ids",d=j+"Ids",f=[l,e,k,a,j],c="book_context",s="book_metaData",o="book_manifest",r="book_key",q="book_fragmap",w="book_ok_to_download",v="book_skeleton_builder",x="book_resource_urls";return{BookInfo:function(t,G){function O(){var a=new jQuery.Deferred;KindleLibraryBookCover.getOfflineCover(U).then(function(c){u.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb().getTable("covers").insertRecord({asin:U,
coverData:c}).then(a.resolve,a.reject)},a.reject);return a.promise()}function y(a){function b(){var f=u.getModuleSync(c);A.savePinningFinishState(a,f).then(r.resolve,r.reject);d&&(F.endMetrics(S),S=null)}function f(){d&&(F.endMetrics(S),S=null);r.reject(Kindle.ERROR.NETWORK)}var d,r=new jQuery.Deferred;S||(S=F.startMetrics("SetOfflineState"),d=!0);ra().done(function(){var d;u.isModuleInitialized(c)?(d=u.getModuleSync(c),d.isSample?b():(d={asin:U,kindleSessionId:d.kindleSessionId,isOffline:a===Kindle.BookInfo.CachedState.PINNED},
u.getModuleSync(u.SERVICE_CLIENT).setOfflineStatus(d).then(b,f))):r.reject()});return r.promise()}function J(){sa&&(sa.endTimer(),sa.log(),sa=null);var a=Z!==ta&&Z!==Kindle.BookInfo.CachedState.PINNED?y(ta):!0;$.when(a).then(function(){O().then(fa.resolve,fa.resolve)},function(a){a===Kindle.ERROR.NETWORK?fa.reject(a):fa.reject(Kindle.ERROR.UNKNOWN_DB_ERROR)});A.getBookStatistics().then(function(a){L.metricId&&(a.fragments!==void 0&&(F.increaseSubCounter(L.metricId,"fragmentCount",a.fragments.count),
F.increaseSubCounter(L.metricId,"fragmentsSize",a.fragments.size)),a.glyphs!==void 0&&(F.increaseSubCounter(L.metricId,"glyphCount",a.glyphs.count),F.increaseSubCounter(L.metricId,"glyphsSize",a.glyphs.size)),F.endMetrics(L.metricId))},function(){L.metricId&&F.endMetrics(L.metricId)})}function K(a,c,b){function d(a,f,g){function q(a){if(a.skeletonMetadata!==void 0&&a.skeletonMetadata.encryption===1){var b=KindleO_Aaa.o_aad(a.skeletonData,h);a.skeletonData=b;delete a.skeletonMetadata.encryption}c(a)}
function o(a,c){b(null,c,null,g)}var h;u.getModule(r).then(function(c){h=c;Q(a,q,o,f)},b)}function f(a,d,g){function q(a){if(a.fragmentMetadata!==void 0&&a.fragmentMetadata.encryption===1){var b=KindleO_Aaa.o_aad(a.fragmentData,h);a.fragmentData=b;delete a.fragmentMetadata.encryption}c(a)}function o(a,c){b(null,c,null,g)}var h;u.getModule(r).then(function(c){h=c;Q(a,q,o,d)},b)}function q(a,d,f){Q(a,function(a){if(a.glyphFragmentMetadata!==void 0)a.glyphFragmentMetadata.id=f;c(a)},function(a,c){b(null,
c,null,f)},d)}function h(a,d,f){Q(a,function(a){c(a)},function(a,c){b(null,c,null,f)},d)}function s(a,d,f){Q(a,function(a){c(a)},function(a,c){b(null,c,null,f)},d)}var g;if(a.skeletonUrls){var o=a.skeletonUrls;for(g=0;g<o.length;g++)d(o[g].signedUrl,"loadSkeleton"+o[g].id,o[g].id)}if(a.fragmentUrls){o=a.fragmentUrls;for(g=0;g<o.length;g++)f(o[g].signedUrl,"loadFragment"+o[g].id,o[g].id)}if(a.glyphUrls){o=a.glyphUrls;for(g=0;g<o.length;g++)q(o[g].signedUrl,"loadGlyphFragment"+o[g].id,o[g].id)}if(a.resourceUrls){o=
a.resourceUrls;for(g=0;g<o.length;g++)h(o[g].signedUrl,"loadResource"+o[g].id,o[g].id)}if(a.locationMapUrls){a=a.locationMapUrls;for(g=0;g<a.length;g++)s(a[g].signedUrl,"loadMobiLocationMap"+a[g].id,a[g].id)}}function H(a,b){var d=new jQuery.Deferred;u.getModule(c).done(function(c){var f={asin:U,contentVersion:c.contentVersion,formatVersion:c.formatVersion,isSample:xa};if(c.kindleSessionId)f.kindleSessionId=c.kindleSessionId;if(c.basePath)f.basePath=c.basePath;if(c.useNewPath)f.useNewPath=c.useNewPath;
if(c.useProdBucket)f.useProdBucket=c.useProdBucket;f[a]=b;u.getModuleSync(u.SERVICE_CLIENT).getFileUrl(f).then(d.resolve,d.reject)});return d.promise()}function I(){var c=u.getModuleSync(s),b=u.getModuleSync(q),f=u.getModuleSync(v);ia?Z===Kindle.BookInfo.CachedState.CACHED||Z===Kindle.BookInfo.CachedState.PINNED?J():A.computeCacheQuota().then(function(){sa=KindleMetricsProfiler("readAhead");V[k].startReadAhead((b.fragmentMetadata.numberOfSkeletons||1)-1,ua);L.starting(k);V[l].startReadAhead(b.fragmentMetadata.numberOfFragments-
1,ua);L.starting(l);c.numOfGlyphFragments&&(V[e].startReadAhead(c.numOfGlyphFragments-1),L.starting(e));if(f.manifest.resourceManifest){var d=Math.max.apply(Math,Object.keys(f.manifest.resourceManifest));V[a].startReadAhead(d,ua);L.starting(a)}c.locationsInfo&&c.locationsInfo.numOfLocations&&(V[j].startReadAhead(Math.floor((c.locationsInfo.numOfLocations-1)/c.locationsInfo.mapSize),ua),L.starting(j))},fa.reject):fa.reject()}function z(a){for(var c=0;c<f.length;c++)V[f[c]]&&(V[f[c]].cancelReadAhead(),
V[f[c]]=null);fa.reject(a)}function C(){function a(b){F.startSubTimer(S,"getFragMap");var f=u.getModuleSync(c);Q(f.fragmentMapUrl,function(a){b.resolve(a);F.endSubTimer(S,"getFragMap")},function(a,c){b.reject(c)},"loadFragmap")}u.isModuleRegistered(q)||u.registerModuleWithInitializer(q,a);return u.getModule(q)}function D(a){var c;a.cpr!==void 0&&(c={},KindleCompression.lzAddStringsToDictionary(a.cpr,c),KindleCompression.lzAddNumbersToDictionary(c),Ha=KindleCompression.lzGetDecompressionDictionary(c));
a.cprJson!==void 0&&(c={},KindleCompression.lzAddStringsToDictionary(a.cprJson,c,256),KindleCompression.lzAddNumbersToDictionary(c,256),Ia=KindleCompression.lzGetDecompressionDictionary(c))}function R(){function a(b){F.startSubTimer(S,"getMetaData");var f=u.getModuleSync(c);Q(f.metadataUrl,function(a){D(a);F.endSubTimer(S,"getMetaData");b.resolve(a)},function(a,c){b.reject(c)},"loadMetadata")}u.isModuleRegistered(s)||u.registerModuleWithInitializer(s,a);return u.getModule(s)}function T(){function a(b){function f(a){F.endSubTimer(S,
"initManifest");b.resolve(a)}function d(){b.resolve({})}F.startSubTimer(S,"initManifest");var g=u.getModuleSync(c);g.manifestUrl?Q(g.manifestUrl,f,d,"loadManifest"):b.resolve({})}u.isModuleRegistered(o)||u.registerModuleWithInitializer(o,a);return u.getModule(o)}function Q(a,c,f,d){var g=new jQuery.Deferred;$.jsonp({url:a,callback:d,cache:!0,timeout:b,error:function(a,c){f&&f(a,c);g.reject(c)},success:function(a){c&&c(a);g.resolve(a)}});return g.promise()}function M(){var c={asin:U,type:l,cache:ma,
netGetter:function(a,c,b){pa(n,a,c,b)},dbGetter:function(a,c,b){A.getFragments(a).then(c,b)},dbGetIdList:function(a,c){A.getFragmentIds().then(a,c)},dbPutter:function(a,c,b){A.putFragments(a).then(c,b)},dbCheckCache:function(){var a=A.getCacheQuota();return a.cachedSize>a.cacheQuota?(z(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,c){u.getModuleSync(u.DB_CLIENT).getBookDb().deleteOldestBookData(U).then(a,c)},dbIsCached:function(){L.ended(this.type)},dbIsOos:function(){z(Kindle.ERROR.OUT_OF_SPACE)},
urlGetter:function(a,c,b){$.when(H(n,a)).then(function(a){c(a.fragmentUrls)},b)},fileGetter:function(a,c,b){K({fragmentUrls:[a]},c,b)},fileProgress:function(a){L.reportProgress(this.type,a)},downloadError:function(a){z(a)}};V[l]=KindleBookDownloaderFactory(c);ca[l]=KindleBookPieceManagerFactory(c);c={asin:U,type:k,cache:ma,netGetter:function(a,c,b){pa(h,a,c,b)},dbGetter:function(a,c,b){A.getSkeleton(a).then(c,b)},dbGetIdList:function(a,c){A.getSkeletonIds().then(a,c)},dbPutter:function(a,c,b){A.putSkeletons(a).then(c,
b)},dbCheckCache:function(){var a=A.getCacheQuota();return a.cachedSize>a.cacheQuota?(z(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,c){u.getModuleSync(u.DB_CLIENT).getBookDb().deleteOldestBookData(U).then(a,c)},dbIsCached:function(){L.ended(this.type)},dbIsOos:function(){z(Kindle.ERROR.OUT_OF_SPACE)},urlGetter:function(a,c,b){$.when(H(h,a)).then(function(a){c(a.skeletonUrls)},b)},fileGetter:function(a,c,b){K({skeletonUrls:[a]},c,b)},fileProgress:function(a){L.reportProgress(this.type,
a)},downloadError:function(a){z(a)}};V[k]=KindleBookDownloaderFactory(c);ca[k]=KindleBookPieceManagerFactory(c);c={asin:U,type:e,cache:ma,netGetter:function(a,c,b){pa(m,a,c,b)},dbGetter:function(a,c,b){A.getGlyphs(a).then(c,b)},dbGetIdList:function(a,c){A.getGlyphIds().then(a,c)},dbPutter:function(a,c,b){A.putGlyphs(a).then(c,b)},dbCheckCache:function(){return!0},dbOosHandler:function(a,c){A.deleteOldestBookData(U).then(a,c)},dbIsCached:function(){L.ended(this.type)},dbIsOos:function(){z(Kindle.ERROR.OUT_OF_SPACE)},
urlGetter:function(a,c,b){$.when(H(m,a)).then(function(a){c(a.glyphUrls)},b)},fileGetter:function(a,c,b){K({glyphUrls:[a]},c,b)},fileProgress:function(a){L.reportProgress(this.type,a)},downloadError:function(a){z(a)}};V[e]=KindleBookDownloaderFactory(c);ca[e]=KindleBookPieceManagerFactory(c);c={asin:U,type:a,cache:ma,netGetter:function(a,c,b){pa(g,a,c,b)},dbGetter:function(a,c,b){A.getResources(a).then(c,b)},dbGetIdList:function(a,c){A.getResourceIds().then(a,c)},dbPutter:function(a,c,b){A.putResources(a).then(c,
b)},dbCheckCache:function(){var a=A.getCacheQuota();return a.cachedSize>a.cacheQuota?(z(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,c){u.getModuleSync(u.DB_CLIENT).getBookDb().deleteOldestBookData(U).then(a,c)},dbIsCached:function(){L.ended(this.type)},dbIsOos:function(){z(Kindle.ERROR.OUT_OF_SPACE)},urlGetter:function(a,c,b){$.when(H(g,a)).then(function(a){c(a.resourceUrls)},b)},fileGetter:function(a,c,b){K({resourceUrls:[a]},c,b)},fileProgress:function(a){L.reportProgress(this.type,
a)},downloadError:function(a){z(a)},isIdRequired:function(a){var c=u.getModuleSync(v);return a in c.manifest.resourceManifest}};V[a]=KindleBookDownloaderFactory(c);ca[a]=KindleBookPieceManagerFactory(c);c={asin:U,type:j,cache:ma,netGetter:function(a,c,b){pa(d,a,c,b)},dbGetter:function(a,c,b){A.getLocations(a).then(c,b)},dbGetIdList:function(a,c){A.getLocationMapIds().then(a,c)},dbPutter:function(a,c,b){A.putLocations(a).then(c,b)},dbCheckCache:function(){var a=A.getCacheQuota();return a.cachedSize>
a.cacheQuota?(z(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,c){u.getModuleSync(u.DB_CLIENT).getBookDb().deleteOldestBookData(U).then(a,c)},dbIsCached:function(){L.ended(this.type)},dbIsOos:function(){z(Kindle.ERROR.OUT_OF_SPACE)},urlGetter:function(a,c,b){$.when(H(d,a)).then(function(a){c(a.locationMapUrls)},b)},fileGetter:function(a,c,b){K({locationMapUrls:[a]},c,b)},fileProgress:function(a){L.reportProgress(this.type,a)},downloadError:function(a){z(a)}};V[j]=KindleBookDownloaderFactory(c);
ca[j]=KindleBookPieceManagerFactory(c)}function aa(){function c(b){u.getModuleList([s,o]).done(function(c){c=KindleBookSkeletonBuilderFactory(ca[k],ca[a],c[o],Ha);F.endSubTimer(S,"getSkeletonBuilder");b.resolve(c)}).fail(b.fail)}u.isModuleRegistered(v)||(F.startSubTimer(S,"getSkeletonBuilder"),u.registerModuleWithInitializer(v,c))}function W(){function c(b){u.getModule(o).done(function(c){c=KindleBookResourceUrlTranslator(ca[a],c);F.endSubTimer(S,"getResourceUrlTranslator");b.resolve(c)}).fail(b.fail)}
u.isModuleRegistered(x)||(F.startSubTimer(S,"getResourceUrlTranslator"),u.registerModuleWithInitializer(x,c))}function ra(){function a(b){var f=b.context&&b.metadata&&b.fragmap?b:null;if(b.cacheState){Z=b.cacheState;if(Z===Kindle.BookInfo.CachedState.PINNING)ta=Kindle.BookInfo.CachedState.PINNED;Kindle.BookInfo.CachedState.isFullyDownloaded(Z)&&u.registerModule(r,!0)}b.context!==void 0&&u.registerModule(c,b.context);b.metadata!==void 0&&(D(b.metadata),u.registerModule(s,b.metadata));b.manifest!==
void 0?u.registerModule(o,b.manifest):u.registerModule(o,{});b.fragmap!==void 0&&u.registerModule(q,b.fragmap);F.endSubTimer(S,"checkDB");va.resolve(f)}function b(a){function c(){window.location.reload(!0)}F.endSubTimer(S,"checkDB");a&&a.code===Kindle.DB.DATABASE_ERR&&a.message.indexOf("no such table")>=0&&F.emit("App::DatabaseGoneOnGetBookInfo",{breakdown:["Browser"]}).then(c,c);va.resolve()}if(!va){va=new jQuery.Deferred;F.startSubTimer(S,"checkDB");var f=u.getModuleSync(u.DB_CLIENT);f.getBookDb()?
(A=f.getBookDb().BookInfoDB(U),A.getBookInfo().then(a,b)):(ma=ia=!1,b())}return va.promise()}function Wa(){L.metricId=F.startMetrics("BookDownload::Reading");u.getModuleList([c,s,o,q,w]).done(function(a){var b=$.extend({},a[c]);delete b.kindleSessionId;a={metadata:a[s],manifest:a[o],fragmap:a[q],context:b,cacheState:Oa};A&&ma&&A.insertBookInfo(a)})}function ya(a,b){function f(a){var b,d=new jQuery.Deferred,g=F.createTimer();if(a)Z=Kindle.BookInfo.CachedState.PARTIAL,b=Kindle.ERROR.FORCE_DELETE;else if(Z===
Kindle.BookInfo.CachedState.PINNED)Oa=Z=Kindle.BookInfo.CachedState.PINNING,ta=Kindle.BookInfo.CachedState.PINNED,b=Kindle.ERROR.PINNED_CONTENT_UPGRADE;else if(Z===Kindle.BookInfo.CachedState.CACHED)Z=Kindle.BookInfo.CachedState.PARTIAL,b=Kindle.ERROR.CONTENT_UPGRADE;u.getModuleSync(u.DB_CLIENT).getBookDb().deleteBooksData([U]).fail(d.reject).done(function(){u.detachModule(r);u.detachModule(q);u.detachModule(s);u.detachModule(o);u.detachModule(c);u.detachModule(v);u.detachModule(x);e=null;g.emit(a?
"BookDownload::ForceDelete":"BookDownload::ContentUpgrade");d.resolve(b)});return d.promise()}function d(a){function g(){var f;if(a.downloadRestrictionReason)l.reject(a.downloadRestrictionReason.reasonCode);else{f=j.createSubTimer("finishStartReading");if(u.isModuleInitialized(c)){var d=u.getModuleSync(c);if(d.contentVersion===a.contentVersion&&d.lastPageReadData&&a.lastPageReadData&&d.lastPageReadData.position!==a.lastPageReadData.position)d.lastPageReadData=a.lastPageReadData,A.updateBookContext(d);
d.kindleSessionId=a.kindleSessionId}else u.registerModule(c,a);if(a.isSample)xa=!0,Pa||(ia=ma=!1),u.isModuleInitialized(r)||u.registerModule(r,!0);else if(t.isSample===!0){f.endTimer();j.endTimer();j.log();l.reject(Kindle.ERROR.UNKNOWN_ERR);return}a.contentChecksum&&!u.isModuleInitialized(r)&&u.registerModule(r,a.contentChecksum);e||(M(),aa(),W(),R(),T(),Wa());ca.setNetworkReady();f.endTimer();f=j.createSubTimer("resolve");l.resolve(!0);f.endTimer();j.endTimer();j.log();$.when(R(),T(),C()).fail(function(){b("LoadFailure")});
u.getModuleList([c,s,o,q,w]).done(I).fail(fa.reject)}}k.endTimer();var h=e&&a.contentVersion&&a.contentVersion!==e.context.contentVersion,m=e&&a.formatVersion&&a.formatVersion!==e.context.formatVersion,n=a.downloadRestrictionReason&&a.downloadRestrictionReason.reasonCode,n=n===Kindle.ERROR.CONTENT_LOAN_ENDED||n===Kindle.ERROR.CONTENT_RENTAL_EXPIRED;Ja=h||m;h||m||n?f(n).then(g,l.reject):g()}function g(a){e?l.resolve(!1):l.reject(a);Z===Kindle.BookInfo.CachedState.PINNED?fa.resolve():fa.reject(Kindle.ERROR.NETWORK)}
function h(a){m.endTimer();e=a;F.startMetrics("Reader::StartReading");k=j.createSubTimer("startReading");a=$.extend({asin:U},t);if(e&&e.context&&Z===Kindle.BookInfo.CachedState.PINNED)a.kindleSessionId=e.context.kindleSessionId;n=Qa(a);e&&(M(),aa(),W(),ca.setNetworkReady());n.then(d,g)}var e,j,m,k,n,l=new jQuery.Deferred;fa=new jQuery.Deferred;S=a;j=KindleMetricsProfiler("bookInfo.startReading");m=j.createSubTimer("getInfoFromDB");t.isSample===!0&&!Pa?h(null):ra().done(h);qa=new jQuery.Deferred;u.registerModuleWithDeferred(u.BOOKINFO,
qa);u.getModuleList([c,s,q]).done(function(){setTimeout(function(){qa.resolve(Ra)},15)}).fail(qa.reject);return l.promise()}function Xa(){var a=t.bucket+"/"+t.asin+"/"+t.version;a+=t.sample===void 0?"/book":"/sample";var c={baseUrl:a,fragmentMapUrl:a+"/frags/gz_fragmap.jsonp",imageBaseUrl:a,locationMapUrl:a+"/locations.jsonp",metadataUrl:a+"/metadata.jsonp",mobiToHtmlUrl:a+"/mobiToHtml.jsonp",htmlToMobiUrl:a+"/htmlToMobi.jsonp",version:t.version,auth:t.auth?t.auth:"",contentKey:t.key?t.key:"",lastPageReadData:{deviceName:null,
position:-1,syncTime:0}},b=c.contentKey;t.key&&(_deferredKey=new jQuery.Deferred,_deferredKey.resolve());Qa=function(){return(new jQuery.Deferred(function(a){a.resolve(b)})).promise()};pa=function(a,b,f,d){var r=[],q=[],o=[],e=[];switch(a){case h:for(a=0;a<b.length;a++)o.push({id:b[a],signedUrl:c.baseUrl+"/frags/gz_skeleton"+b[a]+".jsonp"+c.auth});break;case n:for(a=0;a<b.length;a++)r.push({id:b[a],signedUrl:c.baseUrl+"/frags/gz_frag"+b[a]+".jsonp"+c.auth});break;case m:for(a=0;a<b.length;a++)q.push({id:b[a],
signedUrl:c.baseUrl+"/glyphs/glyphFragment"+b[a]+".jsonp"+c.auth});break;case g:for(a=0;a<b.length;a++)e.push({id:b[a],signedUrl:c.baseUrl+"/resources/resource"+b[a]+c.auth})}b={};if(o.length)b.skeletonUrls=o;if(r.length)b.fragmentUrls=r;if(q.length)b.glyphUrls=q;if(e.length)b.resourceUrls=e;K(b,f,d)}}var qa=null,Ra,U=t.asin,xa,Pa=t.cacheSample,u=G||KindleModuleManager,F=u.getModuleSync(u.METRICS_MANAGER),Ja,za=null,va=null,A=null,Z=null,Ha=null,Ia=null,ia=!0,ma=!0,V={},L={totalChunks:0,starting:function(a){var c=
V[a].numIds;this.totalChunks+=c;this[a]={downloading:!0,remaining:c}},ended:function(a){if(this[a])this[a].downloading=!1;this.isDownloading()||J()},isDownloading:function(){for(var a=0;a<f.length;a++)if(this[f[a]]&&this[f[a]].downloading)return!0;return!1},reportProgress:function(a,c){if(this[a]&&c!==this[a].remaining){this[a].remaining=c;for(var b=0,d=0;d<f.length;d++)this[f[d]]&&(b+=this[f[d]].remaining);d=this.totalChunks;Aa&&Aa(d-b,d)}}},ca={setNetworkReady:function(){for(var a=0;a<f.length;a++)this[f[a]]&&
this[f[a]].setNetworkReady()}},fa=null,Aa=null,ta=Kindle.BookInfo.CachedState.CACHED,ua=!1,Oa=Kindle.BookInfo.CachedState.PARTIAL,sa=null,S=null,pa=function(a,c,b,d){$.when(H(a,c)).then(function(a){K(a,b,d)},function(a,b,f){d(a,b,f,c)})},Qa=function(a){var c=new jQuery.Deferred;u.getModuleSync(u.SERVICE_CLIENT).startReading(a).then(function(a){if(t.basePath)a.basePath=t.basePath;if(t.useNewPath)a.useNewPath=t.useNewPath;if(t.useProdBucket)a.useProdBucket=t.useProdBucket;c.resolve(a)},function(){c.reject("timeout")});
return c.promise()};t.bucket!==void 0&&Xa();return Ra={getBookInfoDfd:function(){return qa.promise()},getAsin:function(){return U},getRefEmId:function(){var a=u.getModuleSync(s);return a.refEmId||a.referenceEmbeddedId||a.guid},startReading:function(a,c){u.registerModule(w,!0);return ya(a,c)},doneReading:function(){for(var a=0;a<f.length;a++)V[f[a]]&&(V[f[a]].cancelReadAhead(),V[f[a]]=null)},getImageBaseUrl:function(){return u.getModuleSync(c).imageBaseUrl+"/"},getKindleSessionId:function(){return u.getModuleSync(c).kindleSessionId},
getFragmentMap:function(a,c){setTimeout(function(){u.getModule(q).then(a,c)},15)},getBookType:function(){return u.getModuleSync(q).fragmentMetadata.bookType},isBookSample:function(){return xa},getBookSkeleton:function(a,c,b){u.getModule(v).then(function(d){d.buildSkeleton(b).then(a,c)},c)},getBookFragments:function(a,c,b){ca[l].getPieces(b,function(c){if(c.fragmentMetadata.compression===1||c.fragmentMetadata.compression===2){c.fragmentData=KindleCompression.lzExpandWithStaticDictionary(c.fragmentData,
Ha);if(c.paraData!==void 0&&typeof c.paraData==="string"){var b=KindleCompression.lzExpandWithStaticDictionary(c.paraData,Ia,256);c.paraData=JSON.parse(b)}delete c.fragmentMetadata.compression}a(c)},c)},getGlyphFragments:function(a,c,b){ca[e].getPieces(b,function(c){if(c.glyphFragmentMetadata.compression===1||typeof c.glyphData==="string"){var b=KindleCompression.lzExpandWithStaticDictionary(c.glyphData,Ia,256);c.glyphData=JSON.parse(b);delete c.glyphFragmentMetadata.compression}a(c)},c)},getMetadata:function(a,
c){return u.getModule(s).then(a,c)},getResourceUrls:function(a,c,b){u.getModule(x).then(function(d){d.getResourceUrls(b,a,c)},c)},UNKNOWN_FPR:-1,getFurthestPositionReadData:function(){return u.getModuleSync(c).lastPageReadData||{}},getLocationConverter:function(){function a(c){var b=jQuery.Deferred();ca[j].getPieces([c],b.resolve,b.reject);return b}if(za===null){var c={},b=u.getModuleSync(q),d=u.getModuleSync(s);c.locationsInfo=d.locationsInfo;c.minPosition=b.fragmentArray[0].cPos;c.maxPosition=b.fragmentArray[b.fragmentArray.length-
1].ePos;c.mapGetter=a;za=KindleUserLocationConverter.getLocationConverter(b.fragmentMetadata.bookType,c)}return za},hasCover:function(a,b){var d=$.Deferred();u.getModuleSync(c).manifestUrl?u.getModule(o).then(function(a){a=a.coverResource;d.resolve(a!==void 0&&a!==null)},d.reject):d.resolve(!1);return d.promise().then(a,b)},getCoverUrl:function(b,d){var f=$.Deferred();u.getModuleSync(c).manifestUrl?u.getModule(o).then(function(c){c=c.coverResource;c!==void 0&&c!==null&&ca[a].getPieces(c,function(a){f.resolve(a.data)},
f.reject)},f.reject):f.resolve(null);return f.promise().then(b,d)},getBookPositions:function(){var a=new jQuery.Deferred;u.getModule(s).then(function(b){var d=KindleModuleManager.getModuleSync(c);a.resolve({toc:b.positions.toc,srl:d.srl||b.positions.srl,cover:b.positions.cover})},a.reject);return a.promise()},startDownloading:function(a,c,b){ta=Kindle.BookInfo.CachedState.PINNED;ua=!0;u.registerModuleWithDeferred(w,b);u.registerModuleWithDeferred(u.JOURNAL_MANAGER,KindlJournalManager.initialize());
KindleReaderAnnotationManager.deferredInitialize(U,u);return ya(a,c)},cancelDownloading:function(){z(Kindle.ERROR.CANCELLED)},getDownloadComplete:function(a){Aa=a;return fa.promise()},isBookDownloaded:function(){return Z===Kindle.BookInfo.CachedState.CACHED||Z===Kindle.BookInfo.CachedState.PINNED},setCachedState:y,getSizeInfo:function(){var a=new jQuery.Deferred;$.when(u.getModule(s),A.computeCacheQuota()).then(function(c,b){a.resolve({bookSize:c.bookSize,quota:b})},a.reject);return a.promise()},
isUpdated:function(){return!!Ja}}}}}var KindleReaderBookInfoProvider=KindleReaderBookInfoProviderFactory();
function KindleBookPieceManagerFactory(b){function l(a){if(a.fragmentMetadata!==void 0)return a.fragmentMetadata.id;else if(a.skeletonMetadata!==void 0)return a.skeletonMetadata.id;else if(a.glyphFragmentMetadata!==void 0)return a.glyphFragmentMetadata.id;else if(a.metadata!==void 0)return a.metadata.id}var e={},k;e.type=b.type;e.asin=b.asin;e.cache=b.cache;e.dbGetter=b.dbGetter;e.dbPutter=b.dbPutter;e.downloader=b.downloader;e.netGetter=b.netGetter;e.getPieces=function(a,b,e){function m(a){for(var d in a)b(a[d]);
var g=[],h;for(h=0;h<c.length;h++)d=c[h],a[d]===void 0&&g.push(d);c=g;g.length>0?f(g):s.downloader.resumeReadAhead(r)}function h(){k||(k=new jQuery.Deferred);k.done(function(){f(c)})}function g(a){function c(){b(a)}var d=l(a);if(s.cache){var f=[];f[d]=a;s.dbPutter(f,c,c);s.downloader.removeIdFromReadAhead(d);--o===0&&s.downloader.resumeReadAhead(r)}else b(a)}function d(a,c,b,f){var h;Object.prototype.toString.call(f)==="[object Array]"?(h=f,f="list"):h=[f];q[f]=q[f]+1||1;q[f]<=2?s.netGetter(h,g,d):
(e(a,c,b),--o===0&&s.downloader.resumeReadAhead(r))}function f(a){o=a.length;s.netGetter(a,g,d)}Object.prototype.toString.call(a)!=="[object Array]"&&(a=[a]);var c=a.slice(0),s=this,o=0,r=Math.max.apply(Math,c)+1,q=[];this.cache?(this.downloader.pauseReadAhead(),this.dbGetter(a,m,h)):f(a)};e.setNetworkReady=function(){k||(k=new jQuery.Deferred);k.resolve()};return e}
function KindleBookSkeletonBuilderFactory(b,l,e,k){function a(a,b){b&&(a=a.replace(/\burl\s*\(\s*(?:'([^']*)'|"([^"]*)")\s*\)/gi,function(a,f,c){return(f=b[f||c])?'url("'+f+'")':f===null?"none":a}));return a}function j(a,b,d,f){a=a.includes;if(a!==void 0){for(var c,e=0;e<a.length;e++){var o=f[a[e]],r=b[o.metadata.id];if(r.type==="text/css")c=c||{},c[r.name]=o.data}if(c)d.skeletonData=d.skeletonData.replace(/<link\s(?:[^\/>'"]|'[^']*'|"[^"]*")*href\s*=\s*(?:'([^']*)'|"([^"]*)")(?:[^\/>'"]|'[^']*'|"[^"]*")*(?:\/>|>\s*<\/link>)/gi,
function(a,b,d){return(b=c[b||d])?'<style type="text/css">'+b+"</style>":a})}}function n(b,g,d,f){if(d!==null){var c=b.resourceManifest,b=b.skeletonManifest[g.skeletonMetadata.id],e;for(e in d){var o=d[e],r=c[o.metadata.id].includes;if(r!==void 0){for(var q={},m=0;m<r.length;m++){var k=d[r[m]];q[c[r[m]].name]=k===void 0?null:k.data}o.data=a(o.data,q)}}j(b,c,g,d);d=b.depends;if(d!==void 0){e=[];for(b=0;b<d.length;b++)o=c[d[b]],o.resInfo!==void 0&&e.push(o.resInfo);g.resourceInfo=e}}f.resolve(g)}var m=
{};m.skeletonManager=b;m.resourceManger=l;m.manifest=e;m.dictionary=k;m.buildSkeleton=function(b){function g(b){b.data=a(b.data,b.resList);q[b.metadata.id]=b;e++;r!==null&&e>=c&&n(j,r,q,d)}var d=new jQuery.Deferred,f=this.dictionary,c=0,e=0,o=[];if(this.manifest.skeletonManifest!==void 0&&this.manifest.skeletonManifest[b]!==void 0&&this.manifest.skeletonManifest[b].depends!==null)o=this.manifest.skeletonManifest[b].depends.slice(),c=o.length;var r=null,q=null,j=this.manifest;this.skeletonManager.getPieces([b],
function(a){if(a.skeletonMetadata.compression===1)a.skeletonData=KindleCompression.lzExpandWithStaticDictionary(a.skeletonData,f),delete a.skeletonMetadata.compression;e>=c?n(j,a,q,d):r=a},d.reject);c>0&&(q={},this.resourceManger.getPieces(o,g,d.reject));return d.promise()};return m}
var KindleCompression=function(){function b(a,b,f){var c,f=f>0?f:j;for(c in b)b[c]>=f&&(f=b[c]+1);c=f;for(var e in a)for(var f=a[e],o=2;o<=f.length;o++){var r=f.substr(0,o);b.hasOwnProperty(r)||(b[r]=c++)}return b}function l(a,b){var f,c=j;f="";for(var e=0;e<b.length;){var o=b.charAt(e);e++;o.charCodeAt(0)<=k?a.hasOwnProperty(f+o)?f+=o:(f.length>0&&c<n&&(a[f+o]=c,c++,c===m&&(c=h)),f=o):f=""}return a}function e(){if(defaultDictionary===void 0||defaultDictionary==={})defaultDictionary=l({},defaultDictionaryString);
return defaultDictionary}var k=9983,a=k+1,j=a+100+1,n=65533,m=55295,h=57344;return{lzCompress:function(b){var d={},f=[],c,e=j,o,r,q;o=c="";for(var l=0;l<b.length;){var v=b.charAt(l);l++;if(v.charCodeAt(0)<=k){for(;o.length>0;){r=Math.min(100,o.length);q=o.substr(0,r);o=o.substr(r);f.push(a+r);for(r=0;r<q.length;r++)f.push(q.charCodeAt(r))}d.hasOwnProperty(c+v)?c+=v:(c.length>0&&(f.push(c.length===1?c.charCodeAt(0):d[c]),e<n&&(d[c+v]=e,e++,e===m&&(e=h))),c=v)}else c.length>0&&(f.push(c.length===1?
c.charCodeAt(0):d[c]),c=""),o+=v}for(c.length>0&&f.push(c.length===1?c.charCodeAt(0):d[c]);o.length>0;){r=Math.min(100,o.length);q=o.substr(0,r);o=o.substr(r);f.push(a+r);for(r=0;r<q.length;r++)f.push(q.charCodeAt(r))}for(i=0;i<f.length;i++)f[i]=String.fromCharCode(f[i]);return f.join("")},lzExpand:function(b){for(var d={},f=[],c,e=j,o="",r,q=0;q<b.length;){c=b.charCodeAt(q);q++;if(c<=k)c=String.fromCharCode(c);else if(c>=j)(c=d[c])||(c=o+r);else{o=c-a;f.push(b.substr(q,o));q+=o;o="";continue}f.push(c);
r=c.charAt(0);e<n&&o.length>0&&(d[e]=o+r,e++,e===m&&(e=h));o=c}return f.join("")},lzBuildDictionary:l,lzGetDecompressionDictionary:function(a){var b=[],f;for(f in a)b[a[f]]=f;return b},lzAddStringsToDictionary:b,lzAddNumbersToDictionary:function(a,d){for(var f=[],c=100;c<1E3;c++)f.push(""+c);return b(f,a,d)},lzCompressWithStaticDictionary:function(b,d){if(d===void 0||d==={})d=e();var f=[],c,h,o,r;h=c="";for(var q=0;q<b.length;){var j=b.charAt(q);q++;if(j.charCodeAt(0)<=k){for(;h.length>0;){o=Math.min(100,
h.length);r=h.substr(0,o);h=h.substr(o);f.push(a+o);for(o=0;o<r.length;o++)f.push(r.charCodeAt(o))}d.hasOwnProperty(c+j)?c+=j:(c.length>0&&f.push(c.length===1?c.charCodeAt(0):d[c]),c=j)}else c.length>0&&(f.push(c.length===1?c.charCodeAt(0):d[c]),c=""),h+=j}for(c.length>0&&f.push(c.length===1?c.charCodeAt(0):d[c]);h.length>0;){o=Math.min(100,h.length);r=h.substr(0,o);h=h.substr(o);f.push(a+o);for(o=0;o<r.length;o++)f.push(r.charCodeAt(o))}for(i=0;i<f.length;i++)f[i]=String.fromCharCode(f[i]);return f.join("")},
lzExpandWithStaticDictionary:function(b,d,f){if(d===void 0||d===[]){if(defaultDeDictionary===void 0||defaultDeDictionary===[]){e();defaultDeDictionary=[];for(var c in defaultDictionary)defaultDeDictionary[defaultDictionary[c]]=c}d=defaultDeDictionary}c=k;var h=j;f!==void 0&&(c=f-1,h=f);for(var f=[],o=0;o<b.length;){var r=b.charCodeAt(o);o++;r<=c?f.push(String.fromCharCode(r)):r>=h?f.push(d[r]):(r-=a,f.push(b.substr(o,r)),o+=r)}return f.join("")}}}(),KindleO_Aaa=function(){function b(a){for(var b=
[],f,d,e,h,g,j,m=0;m<a.length;)f=a.charCodeAt(m++)&255,d=a.charCodeAt(m++)&255,e=a.charCodeAt(m++)&255,h=f>>2,f=(f&3)<<4|d>>4,g=(d&15)<<2|e>>6,j=e&63,isNaN(d)?g=j=64:isNaN(e)&&(j=64),b.push(k.charAt(h)+k.charAt(f)+k.charAt(g)+k.charAt(j));return b.join("")}function l(a,b){var f=[];f.length=256;for(var d=0;d<256;d++)f[d]=d;for(var e=0,h,d=0;d<256;d++)e=e+f[d]+b[d%b.length]&255,h=f[d],f[d]=f[e],f[e]=h;for(var e=d=0,g=[],j=0;j<a.length;j++)d=d+1&255,e=e+f[d]&255,h=f[d],f[d]=f[e],f[e]=h,g.push(String.fromCharCode(a.charCodeAt(j)^
f[f[d]+f[e]&255]));return g.join("")}function e(a,b){for(var f="",d=b?m:n,e=d.length,h=0;h<a;h++)f+=d.charAt(Math.floor(Math.random()*e));return f}for(var k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=[],j=0;j<k.length;j+=1)a[k.charCodeAt(j)]=j;for(var n="eeeeeeeeeeeeeeeeettttttttaaaaaaaaaaaaaaaaooooooiiiiiiinnnnssssrrrrhhhhllldddcccuuummmfffpoggwwyybbvkxjqz",m=n+"                                             ",h=[],g=0;g<10;g++)h[g]=e(15,!1);var d=["p","span","div","em",
"i","strong","b","a","big","small"],f=!1;return{iToStr:function(a,b,f){var d=new Image;d.onload=function(){var a=KindleHostDeviceDetector.isIE(),c=d.height,f=d.width,e=document.createElement("canvas").getContext("2d");e.drawImage(d,0,0);for(var h,g,j,o,m,k="",n=0,l,z=0;z<c;){h=e.getImageData(0,z,f,1);n=0;for(l=h.data.length-4;n<l;){g=h.data[n++]&7;j=h.data[n++]&3;o=h.data[n++]&7;n++;m=g*32+j*8+o;if(a){var C=void 0,C=0;m>=65&&m<=90||m>=50&&m<=55||m===0?C=m:(C=g>=2?-1:1,C=(g+C+8)%8*32+(j+C+4)%4*8+(o+
C+8)%8);C>=65&&C<=90||C>=50&&C<=55||(C=0);m=C}if(m===0)break;k+=String.fromCharCode(m)}if(m===0)break;z++}b(k)};d.onerror=function(){f()};d.src=a},o_aaa:b,o_aac:function(a,d){var f;f=a.replace(/\x0d\x0a/g,"\n");for(var e=[],h=0;h<f.length;h++){var g=f.charCodeAt(h);g<128?e.push(String.fromCharCode(g)):(g>127&&g<2048?e.push(String.fromCharCode(g>>6|192)):(e.push(String.fromCharCode(g>>12|224)),e.push(String.fromCharCode(g>>6&63|128))),e.push(String.fromCharCode(g&63|128)))}f=e.join("");e=d;e+="00000000000000000000000000000000".substring(0,
32-e.length);h=[];for(j=0;j<e.length;j+=2)h.push(parseInt(e.substring(j,j+2),16));return b(l(f,h))},o_aad:function(c,b){var f;f=[];for(var d,e,h,g,j,m=0;m<c.length;)d=a[c.charCodeAt(m++)],e=a[c.charCodeAt(m++)],g=a[c.charCodeAt(m++)],j=a[c.charCodeAt(m++)],d=d<<2|e>>4,e=(e&15)<<4|g>>2,h=(g&3)<<6|j,f.push(String.fromCharCode(d)),g!==64&&f.push(String.fromCharCode(e)),j!==64&&f.push(String.fromCharCode(h));f=f.join("");g=[];for(j=0;j<b.length;j++)g.push(b.charCodeAt(j));f=l(f,g);g=[];for(j=0;j<f.length;)m=
f.charCodeAt(j),m<128?(g.push(String.fromCharCode(m)),j++):m>191&&m<224?(d=f.charCodeAt(j+1),g.push(String.fromCharCode((m&31)<<6|d&63)),j+=2):(d=f.charCodeAt(j+1),e=f.charCodeAt(j+2),g.push(String.fromCharCode((m&15)<<12|(d&63)<<6|e&63)),j+=3);return g.join("")},o_aae:function(a){var b;if(!f){for(b=0;b<10;b++)$(h[b]).addClass("noDisplay");f=!0}var g=$(a).html(),j=!1,m="",k=0;for(b=0;b<g.length;b++)if(g[b]===">")j=!1;else if(g[b]==="<")j=!0;else if(b%60===7&&!j){m+=g.substring(k,b);var k=b,n=d[Math.floor(Math.random()*
d.length)];m+="<"+n+' class="'+h[Math.floor(Math.random()*h.length)]+'">'+e(30,!0)+"</"+n+">"}m+=g.substring(k,g.length);$(a).html(m)},o_aaf:function(a){a:{for(var b=0;b<h.length;b++)if(h[b]===a){a=!0;break a}a=!1}return a}}}(),KindleReaderAnnotationManager=function(){function b(a,b){return a.start-b.start}function l(a){for(var b=0;b<a.length;b++)if(a[b].guid&&!a[b].refEmId)a[b].refEmId=a[b].guid}function e(a){function b(){k(a).then(e.resolve,e.reject)}function f(){d(a).then(b,e.reject)}var e=new jQuery.Deferred;
e.then(function(){for(var b=0;b<a.length;b++)M.emit(n(a[b]))},function(){for(var b=0;b<a.length;b++)M.emit(n(a[b],"Fail"))});g(a);for(var h=0;h<a.length;h++){if(a[h].asin===void 0||a[h].refEmId===void 0||a[h].start===void 0||a[h].type===void 0)return M.emit(n(a[h],"Invalid")),KindleDebug.error("Tried to delete an invalid annotation."),e.reject().promise();if(a[h].note)a[h].note=c(a[h].note)}aa.acquire().done(function(){Q.saveToJournal(a).then(f,e.reject);e.then(aa.release,aa.release)});return e.promise()}
function k(c){function f(){for(var e,h=!1,g,j=0;j<c.length;j++)g=c[j],e=a(g.type,g.start),g.action===G?e===-1&&(D.push(g),h=!0):g.action===O?e!==-1&&(D.splice(e,1),D.push(g),h=!0):g.action===y&&e!==-1&&D.splice(e,1);h&&D.sort(b);d.resolve();r()}var d=new jQuery.Deferred;o().then(f,f);return d.promise()}function a(a,b){for(var c in D){var f=D[c];if(f.type===a&&f.start===b)return c}return-1}function j(b,c){return D[a(b,Number(c))]||null}function n(a,b){var c="Reader::"+H[a.action]+H[a.type];b&&(c+=
b);return c}function m(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].asin=I,a[c].refEmId=z,a[c].action=G,a[c].modifiedTimestamp=b;return a}function h(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=y,a[c].modifiedTimestamp=b;return a}function g(a){for(var b=0;b<a.length;b++)a[b].positionType=C;return a}function d(a){function b(){function e(a){j.context=a;b()}for(var g,h,j;d<a.length&&!(a[d].action===G&&(a[d].type===v||a[d].type===t));)++d;if(d<a.length){j=a[d++];switch(j.type){case v:g=
j.position;h=j.position+K;break;case t:g=j.start,h=j.end}f(g,h).then(e,b)}else c.resolve()}var c=new jQuery.Deferred,d=0;b();return c.promise()}function f(a,b){W===null&&(W=KindleRenderer.createWordIterator());return W.getText(a,b)}function c(a){a.length>Kindle.opt.maxNoteChars&&(M.emit("Reader::NoteLengthLimitExceeded",{submetrics:[{name:"ResultSize",value:a.length}]}),a=a.substr(0,Kindle.opt.maxNoteChars));return a}function s(a,b,c,f){var d=KindleReaderAnnotationManager.getAnnotationsInRange(a,
b,t),g=d.length,j={type:t,start:a,position:c,end:b},q=[];f&&q.push.apply(q,m([{type:x,start:b,position:c,end:b,note:f}]));if(d.length===1&&a>=d[0].start&&b<=d[0].end){if(q.length===0)return(new jQuery.Deferred).resolve([d[0]])}else{if(g>0)j.start=Math.min(a,d[0].start),j.end=Math.max(b,d[g-1].end),q.push.apply(q,h(d));q.push.apply(q,m([j]))}return e(q)}function o(){function a(c){if(c[0])D=c[0].annotationsData,l(D);b.resolve()}var b=new jQuery.Deferred;R?R.getRecord(J,{asin:I},{annotationsData:!0}).then(a,
b.reject):b.reject();return b.promise()}function r(){var a=new jQuery.Deferred;R?R.insertRecord(J,{asin:I,annotationsData:D}).then(a.resolve,a.reject):a.reject();return a.promise()}function q(){function a(){c.resolve()}function b(){c.resolve()}var c=new jQuery.Deferred;T.getAnnotations(I,z).then(function(c){D=c.annotations;l(D);r().then(a,b)},c.reject);return c.promise()}function w(){function a(){o().then(c.reject,c.reject)}function b(){q().then(c.resolve,a)}var c=new jQuery.Deferred;Q.uploadJournal().then(b,
b);return c.promise()}var v="kindle.bookmark",x="kindle.note",t="kindle.highlight",G="create",O="modify",y="delete",J="annotationsCache",K=100,H={};H[v]="Bookmark";H[x]="Note";H[t]="Highlight";H[G]="Create";H[O]="Modify";H[y]="Delete";var I=null,z=null,C=null,D=null,R=null,T=null,Q=null,M,aa=Lock(),W=null;return{BOOKMARK:v,NOTE:x,HIGHLIGHT:t,POPULAR_HIGHLIGHT:"kindle.popular",SELECTION:"kindle.selection",deferredInitialize:function(a,b){function c(){f.resolve(e);KindleReaderMetrics.notifyAnnotationsReady()}
var d=b||KindleModuleManager,f=new jQuery.Deferred,e=this;D=[];I=a;d.getModuleList([d.BOOKINFO,d.SERVICE_CLIENT,d.DB_CLIENT,d.JOURNAL_MANAGER,d.METRICS_MANAGER]).then(function(a){z=a[d.BOOKINFO].getRefEmId();C=a[d.BOOKINFO].getBookType();T=a[d.SERVICE_CLIENT];R=a[d.DB_CLIENT].getBookDb();Q=a[d.JOURNAL_MANAGER];M=a[d.METRICS_MANAGER];w().then(c,c)},f.reject);return f.promise()},clear:function(){},getAnnotation:j,getAllAnnotations:function(){return D.slice()},getAnnotationsInRange:function(a,b,c){var d=
[],f;for(f in D){var e=D[f];(e.start<=b&&e.end>=a||e.start>=a&&e.start<=b)&&(!c||c===e.type)&&d.push(e)}return d},createBookmark:function(a){a=[{type:v,start:a,position:a,end:a,context:""}];m(a);return e(a)},createNote:s,modifyNote:function(a,b,c){var d=new jQuery.Deferred;if(a=j(x,a)){a.note=c;a.position=b;b=[a];c=(new Date).getTime();for(a=0;a<b.length;a++)b[a].action=O,b[a].modifiedTimestamp=c;e(b).then(d.resolve,d.reject)}else d.reject();return d.promise()},createHighlight:function(a,b,c){return s(a,
b,c,null)},deleteAnnotations:function(a){h(a);return e(a)},getContext:f}}();
function KindleBookResourceUrlTranslator(b,l){var e={};e.resourceManger=b;e.resourceManifest=l.resourceManifest;e.reverseLookup={};for(var k in e.resourceManifest)e.reverseLookup[e.resourceManifest[k].name]=k;e.getResourceUrls=function(a,b,e){function m(a){var d={};d[f[a.metadata.id].name]=a.data;b(d)}for(var h=[],g=0;g<a.length;g++){var d=this.reverseLookup[a[g]];d!==void 0&&h.push(d)}var f=this.resourceManifest;h.length!==a.length&&e();h.length>0?this.resourceManger.getPieces(h,m,e):b({})};return e}
function AssertionError(b){Error.call(this,b)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){return{multiColumnMode:function(){return!KindleHostDeviceDetector.isMetroArm()}}}(),KindleHostDeviceDetector=function(){function b(){return navigator.platform.indexOf("iPad")!==-1}function l(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function e(){return b()||l()||g()||k()}function k(){return navigator.userAgent.indexOf("Cloud9")!==
-1}function a(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function j(){return a()&&/arm/i.test(navigator.cpuClass)}function n(){return navigator.onLine}function m(){return"standalone"in navigator&&navigator.standalone}function h(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function g(){return navigator.userAgent.indexOf("PlayBook")!==-1}function d(){return!!window.navigator.msPointerEnabled}return{isiOS:e,isiPad:b,isiPhone:l,isiOS_4x:function(){return(b()||
l())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){var a;if(a=b()||l()){a=navigator.userAgent.indexOf("OS ");var c=0;if(a===-1)a=0;else{for(a+=3;/^\d$/.test(navigator.userAgent.charAt(a));)c=c*10+parseInt(navigator.userAgent.charAt(a),10),a++;a=c}a=a>=5}return a},isFirefox:function(){return navigator.userAgent.indexOf("Firefox")!==-1},isSafari:function(){return navigator.userAgent.indexOf("Safari")!==-1},isMetro:a,isMetroArm:j,isMetroSnappedView:function(){return a()&&$(window).width()===
320},isIE:function(){return navigator.userAgent.indexOf("MSIE")!==-1},isPlayBook:g,isCloud9:k,isTablet:function(){return b()||a()},isOnline:n,isNetworkAvailable:function(){if(!n())return(new jQuery.Deferred).reject().promise();var a=$.ajax({url:"/ping",error:function(){a.reject()},timeout:5E3});return a.promise()},isNetworkAvailableSync:function(){if(!n())return!1;var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome},isiOSAppMode:m,
isChromeApp:h,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return m()||h()},isCookieEnabled:function(){return navigator.cookieEnabled},isLocalStorageEnabled:function(){if(KindleLocalStorage.localStorageObject===null)return!1;try{KindleLocalStorage.localStorageObject.setItem("testLocalStorage","1"),KindleLocalStorage.localStorageObject.removeItem("testLocalStorage")}catch(a){return!1}return!0},isWebSQLSupported:function(){return!!window.openDatabase},
isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.webkitIndexedDB||!!window.msIndexedDB||!!window.indexedDB},isMSPointerEnabled:d,isTouchDevice:function(){return e()||d()||g()},getDevicePlatform:function(){return b()?"iPad":l()?"iPhone":g()?"playBook":k()?"otter":j()?"metroArm":a()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return b()&&KindleHostPadDetector.isPad1(m())||j()},getDeviceType:function(){return a()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return a()?
Kindle.ClientName.Metro:Kindle.ClientName.KCR},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(b){if(KindleLocalStorage.localStorageObject.getItem("definitelyNotPad1"))return!1;var l=0,e=1E3,k=0,a;for(i=0;i<3;i++)a=SunSpiderBenchmark.get3DSpeed(),a>l?l=a:a<e&&(e=a),k+=a;l=k/3;if(l>=200&&b)return!0;if(l>=100&&!b)return!0;KindleLocalStorage.localStorageObject.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function b(b,e){for(var k in e)if(e.hasOwnProperty(k)&&typeof b[k]!==typeof e[k])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},onBookExtrasOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},
removeBook:function(){}},IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openBookExtras:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},hideAppBar:function(){}},checkImplements:b,assertImplements:function(l,e){b(l,e)||
KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function b(a){var b=[],e;for(e in a){var d=a[e].entry;d.guid=d.guid||d.refEmId;delete d.refEmId;d&&b.push(d)}return b}function l(b){var e=[],g;for(g in b)e.push({entry:b[g]});return j.getAppDb().getTable(a).insertList(e)}function e(a){function e(){var c;d<a.length?(f=Math.min(d+100,a.length),c=Array.prototype.slice.call(a,d,f),d=f,n.updateAnnotations(b(c),KindleLocale.getLocalTimeOffset()).then(function(){j.getAppDb().deleteJournalEntries(c).then(e,
g.reject)},g.reject)):g.resolve()}var g=new jQuery.Deferred,d=0,f;e();return g.promise()}function k(){var b=new jQuery.Deferred;j.getAppDb().getTable(a).getRecord().then(function(a){a.length>0?e(a).then(b.resolve,b.reject):b.resolve()},b.reject);return b.promise()}var a="journal",j=null,n=null;return{initialize:function(){var a=new jQuery.Deferred,b=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT]).then(function(e){n=e[KindleModuleManager.SERVICE_CLIENT];
j=e[KindleModuleManager.DB_CLIENT];a.resolve(b)},a.reject);return a.promise()},saveToJournal:function(a){var b=new jQuery.Deferred;l(a).then(function(){k().then(b.resolve,b.resolve)},b.reject);return b.promise()},uploadJournal:k}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")},
setDeviceToken:function(b){KindleLocalStorage.localStorageObject.setItem("kindleDeviceToken",b)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.localStorageObject.removeItem("kindleDeviceToken")}}}(),KindleLocalStorage=function(){function b(){var b={getItem:function(a){return!a||!this.hasOwnProperty(a)?null:unescape(document.cookie.replace(RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"))},key:function(a){return unescape(document.cookie.replace(/\s*\=(?:.(?!;))*$/,
"").split(/\s*\=(?:[^;](?!;))*[^;]?;\s*/)[a])},setItem:function(a,b){if(a)document.cookie=escape(a)+"="+escape(b)+"; path=/",this.length=document.cookie.match(/\=/g).length},length:0,removeItem:function(a){if(a&&this.hasOwnProperty(a)){var b=new Date;b.setDate(b.getDate()-1);document.cookie=escape(a)+"=; expires="+b.toGMTString()+"; path=/";this.length--}},hasOwnProperty:function(a){return RegExp("(?:^|;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}};b.length=(document.cookie.match(/\=/g)||
b).length;return b}var l=null;try{if("localStorage"in window&&window.localStorage!==null&&window.localStorage)l=window.localStorage}catch(e){KindleDebug.error("Exception: Detecting local storage threw an exception."),KindleHostDeviceDetector.isIE()&&(KindleDebug.log("Using a 'localStorage' polyfill"),l=b())}return{localStorageObject:l}}(),KindleLocale=function(){var b=-(new Date).getTimezoneOffset();return{getLocalTimeOffset:function(){return b},getCountryCode:function(){return"US"}}}(),KindleMetricsProfiler=
function(b){function l(b){for(var a=0,e=0;e<b.length;e+=1)a+=b[e].end-b[e].start;return a}var e={};e.name=b;e.counters=null;e.subTimers=null;e.runs=[{start:(new Date).getTime(),end:null}];e.endTimer=function(){var b=this.runs[this.runs.length-1];if(b.end===null)b.end=(new Date).getTime()};e.addCount=function(b,a){if(this.counters===null)this.counters={};this.counters[b]===void 0?this.counters[b]=a:this.counters[b]+=a};e.createSubTimer=function(b){if(this.subTimers===null)this.subTimers={};this.subTimers[b]===
void 0?this.subTimers[b]=KindleMetricsProfiler(b):this.subTimers[b].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[b]};e.log=function(){this.logAsPercentageOfTime("",l(this.runs))};e.logAsPercentageOfTime=function(b,a){var e=b+":"+this.name,n;l(this.runs);for(n in this.counters);for(n in this.subTimers)this.subTimers[n].logAsPercentageOfTime(e,a)};return e};
function KindleModuleManagerFactory(){function b(a,b){if(s[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;s[a]=b;o[a].resolve(b)}function l(a){if(s.hasOwnProperty(a))throw"Duplicate registration of module "+a;s[a]=void 0}function e(a,c){o[a]||(o[a]=new jQuery.Deferred);b(a,c)}function k(a,c){l(a);o[a]||(o[a]=new jQuery.Deferred);c(o[a]);o[a].done(function(c){b(a,c)})}function a(a,b){k(a,function(a){b.done(a.resolve).fail(a.reject)})}function j(a){o[a]||
(o[a]=new jQuery.Deferred);return o[a].promise()}function n(a){if(!s[a])throw"Trying to get uninitialized module "+a;return s[a]}function m(a){return s.hasOwnProperty(a)}function h(a,b){s[a]=b}function g(a){var b=s[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function d(a){for(var b={},c=0;c<a.length;c++)b[name]=s[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function f(){s={}}var c={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",BOOKINFO:"bookinfo",NETWORK:"network"},s={},o={};return{CONSTANTS:c.CONSTANTS,DB_CLIENT:c.DB_CLIENT,RESOURCE_BUNDLE:c.RESOURCE_BUNDLE,METRICS_MANAGER:c.METRICS_MANAGER,SERVICE_CLIENT:c.SERVICE_CLIENT,APP_REGISTRATION:c.APP_REGISTRATION,JOURNAL_MANAGER:c.JOURNAL_MANAGER,BOOK_METADATA:c.BOOK_METADATA,BOOK_FRAGMAP:c.BOOK_FRAGMAP,
BOOKINFO:c.BOOKINFO,NETWORK:c.NETWORK,ERROR_CODE_CANCEL:"canceled",registerModule:e,registerModuleList:function(a){for(var b in a)e(b,a[b])},registerModuleWithInitializer:k,registerModuleWithDeferred:a,detachModule:function(a){var b=s[a],c=o[a];c&&!c.isResolved()&&c.reject("canceled");delete s[a];delete o[a];return b},getModule:j,getModuleList:function(a){var b=new jQuery.Deferred,c,d=[];for(c=0;c<a.length;c++)d.push(j(a[c]));$.when.apply($,d).done(function(){var c,d={};for(c=0;c<a.length;c++)d[a[c]]=
arguments[c];b.resolve(d)}).fail(b.reject);return b.promise()},getModuleSync:n,isModuleInitialized:function(a){return s[a]!==void 0},isModuleRegistered:m,switchToTestMode:function(){this.registerModuleTest=h;this.getModule=g;this.getModuleSync=n;this.getModuleList=d;this.clear=f;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},define:function(b,c,d){if(!m(b)){var f=[],e=$.Deferred();a(b,e);c&&c.length&&c.forEach(function(a){f.push(a&&$.isFunction(a.promise)?a:j(a))});
$.when.apply($,f).then(function(){var a;typeof d==="function"?(a=$.makeArray(arguments),a=d.apply(d,a)):a=d;a&&$.isFunction(a.promise)?a.then(e.resolve,function(){e.reject()}):e.resolve(a)},function(){e.reject()})}},require:function(a,b){$.isArray(a)||(a=[a]);var c,d,f=[];a.forEach(function(a){f.push(a&&$.isFunction(a.promise)?a:j(a))});b||(d=$.Deferred(),c=d.promise());$.when.apply($,f).done(function(){var a=$.makeArray(arguments);b?b.apply(b,a):d.resolve.apply(d,a)},function(){b&&d.reject()});return c}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{getStoreURL:function(){var b=new jQuery.Deferred;$.get("/remote/store").then(function(l){(l=l.url)?b.resolve(l):b.reject()},b.reject);return b.promise()},uploadFeedback:function(b){if(!b)return(new $.Deferred.reject).promise();var l={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth},l={version:KindleVersion.getVersionString(),
message:b.text,info:l};if(KindleHostDeviceDetector.isMetro()&&b.eid&&b.deviceType)l.eid=b.eid,l.deviceType=b.deviceType;b={url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(l)};return $.ajax(b)}}}(),KindleUserAgentMetricsInfo=function(){function b(a){if(a){var b=/^0*([0-9]+)/.exec(a);if(b&&b.length>=2)return parseInt(b[1],10);else KindleDebug.error("Bad regex on versionString: "+a)}}function l(){k=GoogleUserAgent.browserName.toLowerCase();a=GoogleUserAgent.browserVersionString.toLowerCase();
(function(){var b;["ipad","iphone"].indexOf(k)!==-1&&((b=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&b.length>=2&&(a=b[1]),osName=k="ios")})();(function(){var b=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);b&&(a=b[1]);osName="metro"})();j=b(a);h="undefined"===typeof j?m:g[k]?[k,j].join(n):m;e=!0}var e,k,a,j,n="@",m="other",h,g={chrome:14,firefox:7,safari:5,metro:1,ie:9,ios:4};return{browserWithVersionString:function(){e||l();return h}}}(),KindleVersion=function(){var b=null,l=null;return{getMetricsVersion:function(){l||
(l=parseInt("010405021".slice(0,2),10),l+=".",l+=parseInt("010405021".slice(2,4),10),l+=".",l+=parseInt("010405021".slice(4,6),10));return l},getVersionString:function(){b||(b=parseInt("010405021".slice(0,2),10),b+=".",b+=parseInt("010405021".slice(2,4),10),b+=".",b+=parseInt("010405021".slice(4,6),10),b+=".",b+=parseInt("010405021".slice(6),10));return b},getVersion:function(){return Number("010405021")}}}();
function KindleReaderUIFactory(){function b(a){var b=c();KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(c){c.getAppDb().updateMaxPosition(B.getAsin(),b,a)})}function l(a){if(!P.selection)return!1;KindleReaderSelectionRenderer.clearSelection();KindleReaderContextMenu.hide();a.newValue!==null&&KindleReaderSelectionRenderer.setSelection(a.newValue)}function e(){Y.setSelection(null)}function k(){return Sa.bookType||Ta["book-type"]}function a(){return k()===Kindle.BookInfo.PublisherMetadata.COMIC}
function j(){return k()===Kindle.BookInfo.PublisherMetadata.CHILDREN}function n(){m();D()}function m(){e();KindleReaderPageArrow.setArrowEnabled(KindleRenderer.hasPreviousScreen(),KindleRenderer.hasNextScreen()||!ja);F();P.trackLpr&&(KindleReaderLPRManager.onPageChange(t()),Ya&&Ya())}function h(){clearTimeout(da);if(Ba.length>0){var a=t(),b=Ba.pop();f(a,b);KindleReaderMetrics.reportBackButtonUsage()}Ba.length===0&&KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_BACK,!1)}function g(a){clearTimeout(da);
ga.positionFromLocation(a).done(d)}function d(a){if(!ja&&a>=c())r();else{var b=t();Ba.push(b);Ba=Ba.slice(-8);KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_BACK,!0);f(b,a)}}function f(a,b){KindleReaderMetrics.startGoToMetrics();KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat();try{KindleReaderZoomableManager.deactivateZoomable(),KindleRenderer.gotoPosition(b)}catch(c){}m()}function c(){var a=0;try{a=KindleRenderer.getMaximumPosition()}catch(b){a=-1}return a}function s(){KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getBookExtras(B.getAsin(),
o)}function o(a){a=a[0];a===void 0?KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED):KindleHostDeviceDetector.isOnline()?a.isAvailable&&(a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED||a.isAvailable===Kindle.BOOKEXTRAS.BEX_ISAVAILABLE)&&X.openBookExtras(a.asin):a.isAvailable&&a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED?X.openBookExtras(a.asin):KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_NO_CACHE_ERROR)}function r(){KindleReaderSampleEnd.open(function(a){a==="buy"&&Za()})}
function q(a){KindleHostDeviceDetector.isiOS()||ia();KindleReaderZoomableManager.isZoomed()?KindleReaderZoomableManager.gotoNextZoomable():v(a)}function w(a){KindleHostDeviceDetector.isiOS()||ia();KindleReaderZoomableManager.isZoomed()?KindleReaderZoomableManager.gotoPreviousZoomable():x(a)}function v(a){KindleHostDeviceDetector.isiOS()&&A(!0);KindleHostDeviceDetector.isMetro()&&!na&&(X.hideAppBar(),A(!0));if(!Ca)if(KindleReaderMetrics.startPageTurnTimer(KindleReaderMetrics.NEXT_PAGE,a),ka&&($("#kindleReader_content").addClass("turnStart"),
$("#kindleReader_content").removeClass("turnEnd")),KindleRenderer.hasNextScreen()?KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat():ja||r(),KindleRenderer.nextScreen())return ka&&($("#kindleReader_content").addClass("turnEnd"),$("#kindleReader_content").removeClass("turnStart")),setTimeout(KindleReaderMetrics.endPageTurnTimer,0),m(),D(),KindleReaderZoomableManager.clearZoomables(),!0;else ka&&($("#kindleReader_content").css({visibility:"hidden"}),$("#kindleReader_content").addClass("turnEnd"),
$("#kindleReader_content").removeClass("turnStart"));return!1}function x(a){KindleHostDeviceDetector.isiOS()&&A(!0);KindleHostDeviceDetector.isMetro()&&!na&&(X.hideAppBar(),A(!0));if(!Ca)if(KindleReaderMetrics.startPageTurnTimer(KindleReaderMetrics.PREV_PAGE,a),ka&&($("#kindleReader_content").addClass("turnStart"),$("#kindleReader_content").removeClass("turnEnd")),KindleRenderer.hasPreviousScreen()&&KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat(),KindleRenderer.previousScreen())return ka&&
($("#kindleReader_content").addClass("turnEnd"),$("#kindleReader_content").removeClass("turnStart")),setTimeout(KindleReaderMetrics.endPageTurnTimer,0),m(),D(),KindleReaderZoomableManager.clearZoomables(),!0;else ka&&($("#kindleReader_content").css({visibility:"hidden"}),$("#kindleReader_content").addClass("turnEnd"),$("#kindleReader_content").removeClass("turnStart"));return!1}function t(){return KindleRenderer.getPagePositionRange().currentTopOfPage}function G(){function a(){b.resolve(0)}var b=
new jQuery.Deferred;KindleModuleManager.getModuleList([N.BOOK_CONTEXT,N.BOOK_METADATA]).then(function(c){var d=c[N.BOOK_CONTEXT].srl||c[N.BOOK_METADATA].positions.srl;ea.location>=0?ga.positionFromLocation(ea.location).done(b.resolve):P.trackLpr?KindleModuleManager.getModule(N.LPR_MANAGER).then(function(a){a=a.getStartReadingPosition();a.lastTimeRead!==KindleReaderLPRManager.NEVER?(d=a.lastPositionRead,b.resolve(d)):Da.done(function(){if(B.getFurthestPositionReadData().position!==B.UNKNOWN_FPR)d=
B.getFurthestPositionReadData().position;b.resolve(d)})},a):b.resolve(d)},a);return b.promise()}function O(){KindleSpinner.hide();m();D();Ca=!1;KindleReaderZoomableManager.clearZoomables();KindleReaderZoomableManager.isZoomed()&&KindleReaderZoomableManager.activateZoomableOnPageTurn()}function y(a){a=a[0];if(a===void 0||!a.isAvailable){var b=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb();$.ajax({url:Kindle.BOOKEXTRAS.BEX_URL+B.getAsin()+"/Check",type:"GET",dataType:"json",
success:function(a){a.isAvailable===!0&&(KindleReaderGoToMenu.updateGoToMenu({4:KindlePopupMenu.ITEM_ENABLED}),b.updateBookExtras(B.getAsin(),Kindle.BOOKEXTRAS.BEX_ISAVAILABLE,function(){}))}})}else(a.isAvailable===Kindle.BOOKEXTRAS.BEX_ISAVAILABLE||a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED)&&KindleReaderGoToMenu.updateGoToMenu({4:KindlePopupMenu.ITEM_ENABLED})}function J(a){function c(a){KindleReaderGoToMenu.bookIsReady({gotoUserLocation:g,gotoPosition:d,getMaxUserLocation:function(){return a},
openBookExtras:s},B)}var f=KindleModuleManager.getModuleSync(N.BOOK_METADATA);ga=B.getLocationConverter();KindleModuleManager.registerModule(N.LOCATION_CONVERTER,ga);KindleReaderMetrics.setBookType(a);f.locationsInfo&&f.locationsInfo.numOfLocations?(KindleReaderLocationBar.setMinMaxLocation(1,f.locationsInfo.numOfLocations),c(f.locationsInfo.numOfLocations),ga.locationFromPosition(KindleRenderer.getMinimumPosition()).done(function(a){KindleReaderLocationBar.setMinMaxLocation(a,f.locationsInfo.numOfLocations)})):
$.when(ga.locationFromPosition(KindleRenderer.getMinimumPosition()),ga.locationFromPosition(KindleRenderer.getMaximumPosition())).done(function(a,b){KindleReaderLocationBar.setMinMaxLocation(a,b);c(b)});KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getBookExtras(B.getAsin(),y);KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_GOTO,!0);KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_CONTROL_PANEL,P.viewSettings);ja&&(KindleModuleManager.getModule(N.ANNOTATION_MANAGER).done(Eb),
KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_SYNC,!0));KindleHostDeviceDetector.isMetro()&&KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_PIN_TO_START_METRO,!0);if(P.trackLpr){b(function(){});var e=KindleModuleManager.getModuleSync(N.LPR_MANAGER);Da.done(function(){e.onReadingStart(B.getFurthestPositionReadData(),t(),ga,xa);Ya=KindleReaderArrhythmicHeartBeatHandler.onReadingStart(B.getAsin(),B.getRefEmId(),B.getKindleSessionId(),e.getLastPositionRead,ja,
B.getBookType())})}F();O();X.onRendererLoaded(a,!ja,k())}function K(){try{ga=B.getLocationConverter();var a={version:"2.0",containerId:"kindleReader_content",bookInfo:B,startingPositionDfd:G()},b=M();$.extend(b,aa());$.extend(b,W());$.extend(b,ra());$.extend(b,Wa());$.extend(b,ya());$.extend(b,{});KindleRenderer.initialize(a,b,{statusCallback:I,pageChangeCallback:n,annotationEventCallback:Cb},KindleReaderOverlayManager(Y))}catch(c){}}function H(){function a(){if($a)ab=!0;else{ab=!1;var b=lb,c=ya();
if(c.columns&&c.columns.num===b.columns.num&&c.columns.gap===b.columns.gap)KindleRenderer.onWindowResize();else KindleRenderer.updateSettings(c);F()}}(Ua.state()!=="pending"||!KindleHostDeviceDetector.isMetro())&&Ua.done(a)}function I(a){a.status===KindleRenderer.STATUS_LOADING||a.status===KindleRenderer.STATUS_PAGINATING?(Ca=!0,e(),KindleSpinner.show(),KindleReaderMetrics.startSpinnerTimer()):a.status===KindleRenderer.STATUS_DONE?la?(KindleReaderMetrics.endGoToMetrics(),KindleReaderMetrics.endSpinnerTimer(),
ka&&$("#kindleReader_content").css("visibility","visible"),setTimeout(KindleReaderMetrics.endPageTurnTimer,0),O()):($.when(B.getBookInfoDfd()).done(function(){J(B.getBookType())}),la=!0,Ua.resolve(),F()):a.status===KindleRenderer.STATUS_ERROR&&(a.errorCode===KindleRenderer.ERROR_LOAD_FAILURE?bb(Kindle.ERROR.LOAD_FAILURE):(KindleSpinner.hide(),Ca=!1,KindleReaderMetrics.endGoToMetrics(),KindleReaderMetrics.endSpinnerTimer(),ka&&$("#kindleReader_content").css("visibility","visible"),setTimeout(KindleReaderMetrics.endPageTurnTimer,
0),D(),KindleHostDeviceDetector.isMetro()?KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_R_pageLoadError_Title"),ResourceBundle.getLocalizedString("k_R_pageLoadError_Text"),Na):KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_R_pageLoadError_Title"),ResourceBundle.getLocalizedString("k_R_pageLoadError_Text")),a.errorCode===KindleRenderer.ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT?KindleReaderMetrics.reportTimeOutMetrics():KindleReaderMetrics.reportContentNotAvailableMetrics()))}
function z(){if(!KindleHostDeviceDetector.isiOS()){var a=Fb-E.getMargin();$(".kindleReader_pageTurnArea").css("width",a+"%");$("#kindleReader_pageTurnAreaRight").css("left",100-a+"%");$("#kindleReader_center").css("left",a+"%");$("#kindleReader_center").css("right",a+"%");KindleHostDeviceDetector.isMetro()&&$("#kindleReader_center").css("width",100-2*a+"%")}}function C(){$("#kindleReader_pageTurnAreaLeft").css("backgroundColor",E.getBodyColor());$("#kindleReader_pageTurnAreaRight").css("backgroundColor",
E.getBodyColor());$("#kindleReader_center").css("backgroundColor",E.getBGColor());$("#kindleReader_title").css("color",E.getTitleColor());$("#kindleReader_book_container").css("backgroundColor",E.getBGColor());$("#kindleReader_book_container").css("color",E.getFGColor());var a=E.getColorMode()===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK;KindleReaderLocationBar.setLocationBarBlack(a);KindleReaderPageArrow.setArrowColor(E.getColorMode())}function D(){if(!(c()<0)){var b=KindleRenderer.getPagePositionRange().currentTopOfPage;
b<0&&(b=0);ga.locationFromPosition(b).done(function(b){(a()||j())&&b++;KindleReaderLocationBar.updateLocation(b)})}}function R(a){if(mb){switch((a.detail?a.detail:a).which){case 13:var b=document.activeElement;b&&b.id&&!na&&KindleReaderHeaderBar.clickElementWithID(b.id);break;case 32:a.shiftKey?w(ha.KEY):q(ha.KEY);break;case 37:case 38:case 33:w(ha.KEY);break;case 39:case 40:case 34:q(ha.KEY);break;case 27:KindleReaderZoomableManager.deactivateZoomable()}a.stopPropagation();KindleReaderLocationBar.hidePopup()}}
function T(a){function b(){q(ha.WHEEL)}function c(){w(ha.WHEEL)}a=a.originalEvent.wheelDelta||-1*a.originalEvent.detail;cb&&clearTimeout(cb);cb=a<0?setTimeout(b,100):setTimeout(c,100)}function Q(){var a=KindleHostDeviceDetector.isMetro();KindleReaderPageArrow.initialize(function(a){$("#kindleReader_touchLayer").append(a);z()},function(){a||w(ha.ARROW)},function(){a||q(ha.ARROW)})}function M(){var a={},b=E.getFontSize();a.fontSizes=[b*0.5,b*0.75,b,b*1.2,b*1.4,b*1.6,b*1.8];a.fontSizeUnits="px";a.glyphScale=
E.getGlyphScale();a.lineHeight=E.getLineHeight();return a}function aa(){var a={};a.margin=E.getMargin();return a}function W(){var a={};a.backgroundColor=E.getBGColor();a.fontColor=E.getFGColor();a.highlightColor=E.getHighlightColor();a.selectionColor=E.getSelectionColor();a.insertBgColor=E.getInsertBGColor();return a}function ra(){var a={};a[KindleReaderAnnotationManager.NOTE]={className:"amazon-note",style:"position: absolute; width: 10px; height: 10px; background-image: url('"+Gb+"'); cursor: pointer; margin-top: 0px; margin-left:-2px;",
drawingType:KindleRendererAnnotationRenderer.DRAW_AFTER};var b=E.getHighlightColor();a[KindleReaderAnnotationManager.HIGHLIGHT]={className:"amazon-highlight",style:"position: absolute; z-index: -10; background-color: "+b,drawingType:KindleRendererAnnotationRenderer.DRAW_OVER};b=E.getSelectionColor();a[KindleReaderAnnotationManager.SELECTION]={className:"amazon-selection",style:"position: absolute; z-index: -9; background-color: "+b,drawingType:KindleRendererAnnotationRenderer.DRAW_OVER};return{annotationStyles:a}}
function Wa(){var a={};a[KindleReaderAnnotationManager.NOTE]={clickable:!0};a[KindleReaderAnnotationManager.HIGHLIGHT]={clickable:!1};a[KindleReaderAnnotationManager.SELECTION]={clickable:!1};a[KindleReaderAnnotationManager.POPULAR_HIGHLIGHT]={clickable:!0};return{annotationClick:a}}function ya(){var a={};if(P.columns>1){var b=1,c=0;E.getShowColumns()==="true"?(KindleHostDeviceDetector.isTablet()?window.outerWidth>window.outerHeight&&(b=2):$("#kindleReader_content").width()>950&&(b=2),b=Math.min(b,
P.columns),b=Math.max(b,1)):E.getShowColumns()==="on"&&(b=Math.min(2,P.columns));b>1?(c=(22-E.getMargin())*0.666667+2,c=Math.round($("#kindleReader_content").width()*c/100),ka=KindleHostDeviceDetector.isMetro()):ka=!1;a.columns={num:b,gap:c};KindleReaderMetrics.setColumnCount(b)}else ka=!1,a.columns={num:1,gap:0};return lb=a}function Xa(a){qa(a);E.save(KindleLocalStorage.localStorageObject)}function qa(a){var b={},c=E.getFontSize()!==a.getFontSize(),d=E.getMargin()!==a.getMargin(),f=E.getColorMode()!==
a.getColorMode(),e=E.getShowColumns()!==a.getShowColumns();E.copy(a);c&&$.extend(b,M());d&&($.extend(b,aa()),z());f&&($.extend(b,W()),$.extend(b,ra()),C());e&&(a=E.getShowColumns()==="true",ba.emit(a?"Reader::ColumnModeChanged::Auto":"Reader::ColumnModeChanged::One"));(e||d)&&$.extend(b,ya());KindleRenderer.updateSettings(b)}function Ra(){var a=ba.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.open(function(b){b?(ba.increaseSubCounter(a,"Continue",1),ba.endMetrics(a),Ka.resolve(!0)):
(ba.increaseSubCounter(a,"Cancel",1),ba.endMetrics(a),Ka.resolve(!1),KindleRenderer.shutdown(),hb())})}function U(a){a.indexOf(nb)>=0&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()?Ra(a):Ka.resolve(!0)}function xa(a){function b(){KindleMessageDialog.showError(Kindle.ERROR.SYNC_FAILED)}KindleReaderSyncPositionDialog.open(a,function(c){switch(c){case KindleReaderSyncPositionDialog.USER_RESPONSES.SYNC:d(a.fprPosition);ba.emit("Reader::SyncLPR");break;case KindleReaderSyncPositionDialog.USER_RESPONSES.RESET:Ea.resetLPR({asin:B.getAsin(),
kindleSessionId:B.getKindleSessionId(),position:a.currentPosition,positionType:B.getBookType(),localTimeOffset:KindleLocale.getLocalTimeOffset(),refEmId:B.getRefEmId()}).fail(b);ba.emit("Reader::ResetLPR");break;case KindleReaderSyncPositionDialog.USER_RESPONSES.CANCEL:ba.emit("Reader::SyncLPRCancel")}})}function Pa(){function a(b){var c=b.lastPageReadData,d=t();$.when(ga.locationFromPosition(d),ga.locationFromPosition(c.position)).done(function(a,b){b>a?(xa({currentLocation:a,currentPosition:d,fprPosition:c.position,
fprLocation:b,fprDevice:c.deviceName,fprDateTime:c.syncTime}),KindleReaderLPRManager.updateFprSyncTime(c)):KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_R_syncPosition_title"),ResourceBundle.getLocalizedString("k_R_syncPosition_alreadyFurthest_Text"))})}function b(){KindleMessageDialog.showError(Kindle.ERROR.SYNC_FAILED)}clearTimeout(da);la&&Ea&&(KindleModuleManager.getModuleSync(N.BOOK_METADATA),Ea.getLPR(B.getAsin(),B.getRefEmId()).then(a,b))}function u(){KindleReaderBookmarkOverlay.initialize(function(a){$("#kindleReader_book_container").append(a)},
Ja)}function F(){if(la&&KindleModuleManager.isModuleInitialized(N.ANNOTATION_MANAGER)){var a=KindleModuleManager.getModuleSync(N.ANNOTATION_MANAGER);wa=!1;for(var b=KindleRenderer.getPagePositionRange(),b=a.getAnnotationsInRange(b.currentTopOfPage,b.currentBottomOfPage),c=0;c<b.length;c+=1)if(b[c].type===a.BOOKMARK){wa=!0;break}za()}}function Ja(){function a(){}clearTimeout(da);if(P.bookmarks&&la&&KindleModuleManager.isModuleInitialized(N.ANNOTATION_MANAGER)){var b=KindleModuleManager.getModuleSync(N.ANNOTATION_MANAGER),
c=KindleRenderer.getPagePositionRange();if(wa)for(var c=b.getAnnotationsInRange(c.currentTopOfPage,c.currentBottomOfPage),d=0;d<c.length;d+=1)c[d].type===KindleReaderAnnotationManager.BOOKMARK&&b.deleteAnnotations([c[d]]).done(a);else b.createBookmark(c.currentTopOfPage).done(a);wa=!wa;za()}}function za(){wa?$("#kindleReader_bookmark").addClass("hasBookmark"):$("#kindleReader_bookmark").removeClass("hasBookmark");KindleReaderBookmarkOverlay.setIsBookmarked(wa)}function va(){la&&KindleModuleManager.isModuleInitialized(N.ANNOTATION_MANAGER)&&
(A(!1),clearTimeout(da),KindleReaderAnnotationsPane.open(),Bb(),KindleReaderAnnotationsPane.scrollToPosition(t()))}function A(a){KindleHostDeviceDetector.isiOS()&&na!==a&&((na=a)?($("#kindleReader_book_container").addClass("immersive_mode"),KindleReaderBookmarkOverlay.setImmersiveMode(!0),KindleReaderLocationBar.setImmersiveMode(!0)):($("#kindleReader_book_container").removeClass("immersive_mode"),KindleReaderBookmarkOverlay.setImmersiveMode(!1),KindleReaderLocationBar.setImmersiveMode(!1)))}function Z(){Ca||
(A(!1),clearTimeout(da),KindleReaderSettingsDialog.open(E,P,Xa))}function Ha(){var a=$("#kindleReader_content");return function(b,c,d){return La.getBookPositionAt(b-a.offset().left,c-a.offset().top,d)}}function Ia(){var a,b={};a=document.createElement("div");a.id="kindleReader_touchLayer";var c=$(a);$("#kindleReader_book_container").append(a);b.getBookPositionAt=Ha();b.selectionStateManager=Y;if(!KindleHostDeviceDetector.isiOS())c.click(Oa),c.keyup(R),c.dblclick(sa),c.bind("mousewheel",T),b.mouseDownEventSource=
a,b.mouseEventSource=a,b.mouseClickOutsideEventSource=document.getElementById("kindleReader_book_container");if(KindleHostDeviceDetector.isTouchDevice())c.swipeLeft(ta,{touchOnly:!0,distance:25}),c.swipeRight(ua,{touchOnly:!0,distance:25}),c.tap(Qa),KindleHostDeviceDetector.isiOS()&&(c.doubletap(pa),c.bind("touchstart",S)),b.touchEventSource=a,b.selectionHandleLeft=KindleReaderSelectionRenderer.getGrabHandleBegin(),b.selectionHandleRight=KindleReaderSelectionRenderer.getGrabHandleEnd();KindleSelectionEvents.initialize(b)}
function ia(){na=!0;$("#bookmark_overlay_div").addClass("immersive_mode");$("#kindleReader_header").addClass("immersive_mode");$("#kindleReader_footer").addClass("immersive_mode");$("#kindleReader_pageTurnAreaLeft").addClass("immersive_mode");$("#kindleReader_pageTurnAreaRight").addClass("immersive_mode");da&&(clearTimeout(da),da=null)}function ma(){KindleReaderImmersiveModeExit.initialize(function(a){$("#kindleReader_book_container").append(a);$(".immersive_exit").hover(V)},V)}function V(){na=!1;
$("#kindleReader_header").toggle(!0);$("#bookmark_overlay_div").removeClass("immersive_mode");$("#kindleReader_header").removeClass("immersive_mode");$("#kindleReader_footer").removeClass("immersive_mode");$("#kindleReader_pageTurnAreaLeft").removeClass("immersive_mode");$("#kindleReader_pageTurnAreaRight").removeClass("immersive_mode");da&&(clearTimeout(da),da=null)}function L(a){a?ia():V()}function ca(a){function b(){e();KindleRenderer.reloadAnnotations()}function c(){KindleReaderAnnotationManager.deleteAnnotations(j).done(b)}
function d(){KindleReaderAnnotationManager.createHighlight(h.start,h.end,t()).done(b)}function f(){KindleReaderEditNoteDialog.open(null,function(a){a&&KindleReaderAnnotationManager.createNote(h.start,h.end,t(),a).done(b)},null,function(){e()})}function g(){Aa(m[0].start)}var h=Y.getSelection(),j=h?KindleReaderAnnotationManager.getAnnotationsInRange(h.start,h.end,KindleReaderAnnotationManager.HIGHLIGHT):[],m=h?KindleReaderAnnotationManager.getAnnotationsInRange(h.start,h.end,KindleReaderAnnotationManager.NOTE):
[];(function(){var b=KindlePopupMenu,e=j.length===1&&j[0].start<=h.start&&j[0].end>=h.end,o=h&&!e?b.ITEM_ENABLED:b.ITEM_HIDDEN,e=e?b.ITEM_ENABLED:b.ITEM_HIDDEN,k=h&&m.length===0?b.ITEM_ENABLED:b.ITEM_HIDDEN,n=h&&m.length>0?b.ITEM_ENABLED:b.ITEM_HIDDEN,b=h.start===h.end?b.ITEM_ENABLED:b.ITEM_HIDDEN,q=[],l=[];l[KindleReaderContextMenu.CREATE_HIGHLIGHT]=d;l[KindleReaderContextMenu.CREATE_NOTE]=f;l[KindleReaderContextMenu.EDIT_NOTE]=g;l[KindleReaderContextMenu.DELETE_HIGHLIGHT]=c;q[KindleReaderContextMenu.CREATE_HIGHLIGHT]=
o;q[KindleReaderContextMenu.CREATE_NOTE]=k;q[KindleReaderContextMenu.EDIT_NOTE]=n;q[KindleReaderContextMenu.DELETE_HIGHLIGHT]=e;q[KindleReaderContextMenu.DEFINITION]=function(){var a=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLanguage();return dictionary.isLanguageSupported(a)}()&&b;position=fa(a);KindleReaderContextMenu.show(q,position,l,h)})();KindleHostDeviceDetector.isiOS()?$("#kindleReader_book_container").bind("touchstart.contextMenu",function(){KindleReaderContextMenu.hide();
$("#kindleReader_book_container").unbind("touchstart.contextMenu")}):$("#kindleReader_book_container").bind("mousedown.contextMenu",function(){KindleReaderContextMenu.hide();$("#kindleReader_book_container").unbind("mousedown.contextMenu")})}function fa(a){var b=KindleListUtilities.first(La.getBounds(a.selection.end)),a=KindleListUtilities.last(La.getBounds(a.selection.start)),c=$("#kindleReader_content").offset(),d=KindleHostDeviceDetector.isiOS()?80:0,f=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()?
25:0,e=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()?35:0,g;g=b.left+c.left;b=b.bottom+c.top+f;if($(window).height()-b>d)return[g,b];g=a.left+c.left-e;b=a.top+c.top-d-e;return b>0?[g,b]:"center"}function Aa(a){function b(){e();KindleReaderAnnotationManager.deleteAnnotations([c]).done(KindleRenderer.reloadAnnotations);d.resolve("Delete")}var c=KindleReaderAnnotationManager.getAnnotation(KindleReaderAnnotationManager.NOTE,a),d=new jQuery.Deferred;KindleReaderEditNoteDialog.open(c.note,
function(a){a?(KindleReaderAnnotationManager.modifyNote(c.start,t(),a),d.resolve("Save")):b()},b,function(){e();d.resolve("Cancel")});return d.promise()}function ta(){Y.getSelection()||q(ha.SWIPE)}function ua(){Y.getSelection()||w(ha.SWIPE)}function Oa(a){var b=a.pageX-$("#kindleReader_content").offset().left,a=a.pageY-$("#kindleReader_content").offset().top;la&&b>0&&a>0&&!Y.getSelection()&&(ia(),Va(b,a))}function sa(a){oa&&(clearTimeout(oa),oa=null);var b=a.pageX-$("#kindleReader_content").offset().left,
a=a.pageY-$("#kindleReader_content").offset().top;la&&b>0&&a>0&&!Y.getSelection()&&KindleReaderZoomableManager.activateZoomableAtPosition(b,a)}function S(a){var b=a.originalEvent.touches[0].pageX-$("#kindleReader_content").offset().left,a=a.originalEvent.touches[0].pageY-$("#kindleReader_content").offset().top;la&&b>0&&a>0&&!Y.getSelection()&&Va(b,a)}function pa(){var a=this.x-$("#kindleReader_content").offset().left,b=this.y-$("#kindleReader_content").offset().top;la&&a>0&&b>0&&!Y.getSelection()&&
KindleReaderZoomableManager.activateZoomableAtPosition(a,b);oa&&(clearTimeout(oa),oa=null)}function Qa(){function a(){if(c<=0)return w(e),!0;else if(c>=f)return q(e),!0;return!1}function b(){oa=null;if((!la||!(c>0&&d>0)||!Va(c,d))&&!Y.getSelection())if(KindleHostDeviceDetector.isMetro()&&!KindleHostDeviceDetector.isMetroSnappedView())!a()&&!KindleReaderContextMenu.wasVisible()&&(A(!na),X.onReaderTapped());else if(c<f/4)w(e),KindleHostDeviceDetector.isMetro()&&X.hideAppBar();else if(c>f-f/4)q(e),KindleHostDeviceDetector.isMetro()&&
X.hideAppBar();else if(!KindleReaderContextMenu.wasVisible()&&(A(!na),KindleHostDeviceDetector.isMetro()))X.onReaderTapped()}var c=this.x-$("#kindleReader_content").offset().left,d=this.y-$("#kindleReader_content").offset().top,f=$("#kindleReader_content").width(),e=this.isTouchEvent?ha.TAP:ha.ARROW;!oa&&(KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetroSnappedView())?oa=setTimeout(b,Hb):this.isTouchEvent?b():a()}function Va(a,b){var c=!1;if(KindleHostDeviceDetector.isIE()){var d=
$("#kindleReader_touchLayer");try{d.hide(),c=KindleRenderer.handleClick(a,b)}finally{d.show()}}else c=KindleRenderer.handleClick(a,b);return c}function rb(){A(!1);clearTimeout(da);KindleReaderGoToMenu.show()}function hb(){!ja&&!db?(Za(),eb=!0):jb()}function ub(){clearTimeout(da);X.pinBookToStart(B.getAsin())}function tb(){function a(b){return function(){e();b.apply(this,arguments)}}var b=KindleReaderHeaderBar,c={};c[b.BUTTON_CLOSE]=hb;c[b.BUTTON_GOTO]=a(rb);c[b.BUTTON_CONTROL_PANEL]=a(Z);c[b.BUTTON_BOOKMARK]=
a(Ja);c[b.BUTTON_SYNC]=a(Pa);c[b.BUTTON_NOTE]=a(va);c[b.BUTTON_IMMERSIVE]=ia;c[b.BUTTON_BACK]=h;c[b.BUTTON_PIN_TO_START_METRO]=a(ub);b.initialize(function(a){$("#kindleReader_book_container").append(a)},c)}function sb(){KindleReaderLocationBar.initialize(function(a){a.find("#kindleReader_progressbar_handle").mousedown(function(){clearTimeout(da)});$("#kindleReader_book_container").append(a)},g)}function zb(){$(document).keyup(R);KindleUXComponentManager.registerKeyEventsEnabledCallback(function(a){mb=
a})}function Ab(){function a(c){clearTimeout(b);b=setTimeout(H,c||0);$("#kindleReader_annotations_pane").height($("body",Kindle.top.document).height()-212);$("#kindleReader_annotations_pane_scrollWrapper").height($("body",Kindle.top.document).height()-212)}var b;KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window?$("body",Kindle.top.document).bind("orientationchange",function(){a(0)}):window.onresize=function(){a(200)}}function Bb(){function a(b){d(b.start)}function b(a){KindleReaderAnnotationManager.deleteAnnotations([a]).done(function(){F();
KindleRenderer.reloadAnnotations()})}function c(a,b){a?KindleReaderAnnotationManager.modifyNote(b.start,b.position,a):KindleReaderAnnotationManager.deleteAnnotations([b]).done(function(){KindleRenderer.reloadAnnotations()})}KindleModuleManager.isModuleInitialized(N.ANNOTATION_MANAGER)&&KindleModuleManager.getModuleList([N.ANNOTATION_MANAGER,N.LOCATION_CONVERTER]).done(function(d){var f=d[N.LOCATION_CONVERTER],d=d[N.ANNOTATION_MANAGER].getAllAnnotations();KindleReaderAnnotationsPane.loadAnnotations(d,
f,a,b,c)})}function Cb(a,b){function c(){fb=!1;Y.enable()}KindleHostDeviceDetector.isiOS()&&A(!1);a===KindleReaderAnnotationManager.NOTE&&!fb&&(fb=!0,Y.disable(),Aa(b).then(function(a){c();ba.emit("Reader::Icon::"+a)},c))}function ib(){jb()}function Na(){X.closeReader(ob)}function jb(){KindleRenderer.shutdown();ba&&(ob=ba.startMetrics("App::CloseReader"),ba.uploadMetrics());if(P.trackLpr){KindleReaderArrhythmicHeartBeatHandler.onReadingEnd();if(KindleModuleManager.isModuleInitialized(N.LPR_MANAGER)&&
KindleModuleManager.isModuleInitialized(KindleModuleManager.SERVICE_CLIENT)){var a=KindleModuleManager.getModuleSync(N.LPR_MANAGER).getLastPositionRead();Ea.doneReading({asin:B.getAsin(),kindleSessionId:B.getKindleSessionId(),position:a,positionType:B.getBookType(),localTimeOffset:KindleLocale.getLocalTimeOffset(),countryCode:KindleLocale.getCountryCode(),refEmId:B.getRefEmId()})}B.doneReading()}Na()}function vb(){z();u();ma();tb();sb();Ia();KindleHostDeviceDetector.isiOS()||Q();C();zb();Ab();if(!KindleHostDeviceDetector.isMetro())window.oncontextmenu=
function(){return!1};KindleHostDeviceDetector.isiOS()||$(window).focus(function(){Ea.checkTokenConsistency()})}function yb(){B.getDownloadComplete(function(a,b){KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_IN_PROGRESS,Math.round(100*Math.min(a,b)/Math.max(1,b)))}).then(function(){KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_COMPLETED);if(KindleHostDeviceDetector.isMetro())X.onBookDownloadComplete({asin:B.getAsin()})},function(a){if(a)switch(a){case Kindle.ERROR.OUT_OF_SPACE:case Kindle.ERROR.UNKNOWN_DB_ERROR:KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_DISK_ERROR);
break;case Kindle.ERROR.NETWORK:case Kindle.ERROR.TIMEOUT:KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_NETWORK_ERROR)}})}function kb(a){Da.done(function(){if(B.isUpdated()){var b=ResourceBundle.getLocalizedString("k_L_openBookContentUpgrade_ButtonText");KindleMessageDialog.showError(Kindle.ERROR.CONTENT_UPGRADE,a,b)}else a()})}function wb(b){ea=b||{};ea.readerClass&&$("body").addClass(ea.readerClass);ea.readerAppBar&&ea.readerAppBar==="hide"&&ia();if(ea.asin)Ma=
ea.metricsId,pb=ea.standAlone,ea.isSample&&KindleHostDeviceDetector.isiOS()&&KindleReaderHeaderBar.setCloseButtonEnabled(ResourceBundle.getLocalizedString("k_R_toolbar_iOS_sample_close_button")),Fa&&KindleSpinner.show(),B=KindleReaderBookInfoProvider.BookInfo(ea,KindleModuleManager),Ma?ba.endSubTimer(Ma,"initialize"):Ma=ba.startMetrics("Reader:Open"),Da=B.startReading(Ma,bb),Da.done(function(){B.isBookDownloaded()||yb()}),Db(ea.asin,ea.returnToLibrary),xb().done(function(){Ga||(Ga=new KindleReaderSettings,
Ga.reset());a()||j()?Ga.reset():Ga.load(KindleLocalStorage.localStorageObject);P.showTitle||($("#kindleReader_title").hide(),$("#kindleReader_content").addClass("no_title"));KindleHostDeviceDetector.isiOS()||(da=setTimeout(ia,5E3));KindleHostDeviceDetector.hasCanvasPerformanceProblem()?(U(B.getBookType()),Ka.then(function(a){a&&kb(K)})):kb(K);(a()||j())&&setTimeout(function(){KindleReaderTutorial(k())},3E3);qa(Ga)}),Da.done(Ib).fail(bb),KindleModuleManager.getModule(N.BOOK_METADATA).done(Jb),setTimeout(window.focus,
0),KindleTouchEventsToggler.isRequired()&&gb.done(function(){KindleTouchEventsToggler.allowTouchEvents()})}function xb(){var b=new $.Deferred;Ta={};Sa={};P=new ReaderOptions;$.when(KindleModuleManager.getModule(N.BOOK_CONTEXT),KindleModuleManager.getModule(N.BOOK_METADATA),B.getBookInfoDfd()).done(function(c,d){var f=B.getBookType(),e=["RegionMagnification","book-type","cover","fixed-layout","orientation-lock","original-resolution","zero-gutter","zero-margin"],g={},h,m,o;if(d.publisherMetadata&&d.publisherMetadata.length>=
3&&d.publisherMetadata[0]==="metadata"&&(h=d.publisherMetadata[2])&&h.length>0)for(o=0;o<h.length;o++)if(h[o].length>=2&&h[o][0]==="meta"&&(m=h[o][1],m.name&&$.inArray(m.name,e)>=0))g[m.name]=m.content;Ta=g;d.headerMetadata&&$.extend(Sa,d.headerMetadata);if(c.isSample)P.selection=!1,P.bookmarks=!1,P.annotations=!1;if(c.isSample&&!ea.cacheSample)P.trackLpr=!1;if(f.indexOf(nb)>=0||Sa.fixedLayout||Ta["fixed-layout"]||!KindleDeviceCapabilities.multiColumnMode())P.columns=1;if(a()||j())P.selection=!1,
P.annotations=!1,P.bookmarks=!1,P.viewSettings=!1,P.showTitle=!1;P.bookmarks||KindleReaderBookmarkOverlay.setVisible(!1);b.resolve()});return b.promise()}function Db(a,b){KindleModuleManager.getModule(N.BOOK_CONTEXT).done(function(c){ja=!c.isSample;db=b;c=ja||db?ResourceBundle.getLocalizedString("k_R_toolbar_library_button"):ResourceBundle.getLocalizedString("k_R_toolbar_iOS_sample_close_button");KindleReaderHeaderBar.setCloseButtonEnabled(c);ja&&(KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.JOURNAL_MANAGER,
KindlJournalManager.initialize()),KindleModuleManager.registerModuleWithDeferred(N.ANNOTATION_MANAGER,KindleReaderAnnotationManager.deferredInitialize(a,KindleModuleManager)));(ja||ea.cacheSample)&&KindleModuleManager.registerModuleWithDeferred(N.LPR_MANAGER,KindleReaderLPRManager.initialize(a))})}function Ib(a){X.onStartReadingStatus(!0,null,a)}function bb(a){if(!qb&&a!==KindleModuleManager.ERROR_CODE_CANCEL){qb=!0;var b=Kb(a);if(pb){if(a===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())a=
Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;KindleHostDeviceDetector.isMetro()?KindleMessageDialog.showError(a,Na):KindleMessageDialog.showError(a,b)}else b()}}function Kb(a){return function(){X.onStartReadingStatus(!1,a)}}function Jb(a){a.title&&$("#kindleReader_title").text(a.title)}function Eb(){P.bookmarks&&(KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_BOOKMARK,!0),F());P.annotations&&KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_NOTE,!0);KindleRenderer.reloadAnnotations()}
function Lb(){KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.deInitialize()}function Mb(){$a=!0}function Nb(){$a=!1;ab&&H()}function Ob(a,b,c,d){return KindleOffline.downloadBook(a,b,c,d)}function Pb(){KindleOffline.cancelBookDownload()}function Qb(a,b,c){KindleOffline.removeBook(a,b,c)}function Rb(){Fa.setReaderInterface({openBook:wb,unloadReader:Lb,onStoreOpenStatus:Sb,onBookExtrasOpenStatus:Tb,pauseReader:Mb,resumeReader:Nb,setToolbarVisible:function(a){(KindleHostDeviceDetector.isiOS()?
A:L)(!a)},setFocus:function(){setTimeout(window.focus,0)},downloadBook:Ob,cancelBookDownload:Pb,removeBook:Qb,getSelectedText:function(a){return KindleReaderClippingManager.getSelectedText(a)},hideContextMenu:function(){KindleReaderContextMenu.hide()}})}function Sb(a){KindleSpinner.hide();a===Kindle.STORE.GENERIC_ERROR?eb?KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_FAILED,ib):KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_FAILED):a===Kindle.STORE.OFFLINE_ERROR&&(eb?KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED,
ib):KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED))}function Tb(a){KindleSpinner.hide();a===Kindle.BOOKEXTRAS.GENERIC_ERROR&&KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED)}function Za(){KindleSpinner.show();X.openStore(B.getAsin())}var Fb=30,nb="topaz",Ka,Hb=300,Gb="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAASklEQVQYGWMUSd/dwMDAUA/E2EAjULDh9QwXBkagwv/YVCCJgRWzwARAupCBaMYeGBdsGzEmgjXgNBFmHMzkYWUiE9B3oAAlBBoBvxIeobfDoeQAAAAASUVORK5CYII=",
ea={},E,Ga,lb,gb,B,Da,ja,P,Ta,Sa,wa=null,ga,la=!1,Ua,na=!1,da=null,mb=!0,cb,Ma,ob,Fa,X,ba,Ea,Ca=!0,eb=!1,db=!1,pb=!1,qb=!1,$a=!1,ab=!1,Ba=[],Y=null,La=null,Ya,oa=null,N={ANNOTATION_MANAGER:"annotation_manager",LPR_MANAGER:"lpr_manager",BOOK_METADATA:"book_metaData",BOOK_CONTEXT:"book_context",LOCATION_CONVERTER:"locationConverter"},ha={KEY:"keyboard",ARROW:"arrow",TAP:"tap",SWIPE:"swipe",WHEEL:"wheel"},ka,fb=!1;return{initialize:function(){gb=new jQuery.Deferred;Ka=new jQuery.Deferred;Fa=window.parent.KindleApp;
Ua=new jQuery.Deferred;KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.initialize();Fa&&(E=new KindleReaderSettings,E.reset(),E.load(KindleLocalStorage.localStorageObject),Y=KindleSelectionStateManagerFactory(),Y.addEventListener(Y.SELECTION_CHANGED_EVENT,l),Y.addEventListener(Y.PROCESS_SELECTION_EVENT,ca),La=KindleSelectionHelper(KindleRenderer.getPageSelectableItemBoundaries),KindleReaderSelectionRenderer.initialize(La),$("body").bind("touchmove.elastic",KindleIOSScrollStopper.stopScroll),
X=Fa.getAppInterfaceForReader(),KindleInterfaces.assertImplements(X,KindleInterfaces.IKindleAppForReader),Fa.getSharedModules().done(function(a){Kindle=a[KindleModuleManager.CONSTANTS];ResourceBundle=a[KindleModuleManager.RESOURCE_BUNDLE];vb();KindleModuleManager.registerModuleList(a);ba=a[KindleModuleManager.METRICS_MANAGER];Ea=a[KindleModuleManager.SERVICE_CLIENT];Rb();X.onReaderReady();a=KindleRenderer.PAGE_LOAD_INCOMPLETE_FLAG_NAME;KindleLocalStorage.localStorageObject.getItem(a)&&(ba.emit("Reader::PageLoadIncomplete"),
KindleLocalStorage.localStorageObject.removeItem(a))}),KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents());gb.resolve()},gotoPosition:d,openStoreDP:Za,setDesktopImmersiveMode:L,leaveDesktopImmersiveMode:function(){L(!1)},nextPage:v,prevPage:x,register:function(a,b){return X.register(a,b)},deregister:function(a,b){return X.deregister(a,b)},closeReader:Na,getMaxPosition:c,getSelection:function(){return Y}}}
var KindleReaderUI=KindleReaderUIFactory(),KindleX=KindleReaderUI,KindleLibraryBookCover=function(){function b(){m||(m=KindleHostDeviceDetector.isiPad()?a:k);return m}function l(a){n||(n=e,n=n.replace("{width}",b().width),n=n.replace("{height}",b().height));var g=n;return g=g.replace("{asin}",a)}var e="/cover/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",k={width:255,height:255},a={width:255,height:255},j=null,n=null,m=null;return{getBookCoverUrl:function(a){j||(j="https://images-na.ssl-images-amazon.com/images/P/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",
j=j.replace("{width}",b().width),j=j.replace("{height}",b().height));var e=j;return e=e.replace("{asin}",a)},getOfflineCover:function(a){var b=new jQuery.Deferred,a=l(a);$.ajax({url:a,beforeSend:function(a){a.overrideMimeType("text/plain; charset=x-user-defined")},success:function(a){a="data:image/jpeg;base64,"+KindleO_Aaa.o_aaa(a);b.resolve(a)},error:b.reject});return b.promise()}}}(),KindleReaderArrhythmicHeartBeatHandler=function(){function b(){return c!==void 0}function l(){}function e(){}function k(){a();
navigator.onLine&&(f=setTimeout(j,h))}function a(){clearTimeout(f);clearTimeout(c)}function j(){var a=d();v&&(s?s:KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT)).stillReading({asin:o,position:a,positionType:r,localTimeOffset:t,countryCode:x,refEmId:q,kindleSessionId:w}).then(l,e);f=void 0;navigator.onLine&&(c=setTimeout(n,g))}function n(){c=void 0}function m(){clearTimeout(f);f=void 0;clearTimeout(c);r=q=o=c=void 0}var h=5E3,g=6E5,d,f,c,s,o,r,q,w,v,x="US",t=-(new Date).getTimezoneOffset();
return{onReadingStart:function(a,c,f,e,g,h){if(a!==o)return b()&&m(),o=a,r=h,q=c,w=f,d=e,v=g,j(),k},onReadingEnd:m,isStillReading:b,setNetworkModule:function(a){s=a},handleHeartBeat:k,cancelCurrentHeartBeat:a}}(),KindleReaderLPRManager=function(){function b(a){k.getAppDb().updateLastReadTime(l,(new Date).getTime(),a,function(){})}var l,e,k;return{NEVER:-1,initialize:function(a){var b=new jQuery.Deferred,n=this;l=a;KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(a){k=a;k.getAppDb().getBook(l,
function(a){e={lastPositionRead:a.lastPositionRead,lastTimeRead:a.lastTimeRead?a.lastTimeRead:-1,lastSyncTime:a.lastFPRSyncTime};b.resolve(n)})});return b.promise()},clear:function(){e=l=void 0},getLastPositionRead:function(){return e.lastPositionRead},onReadingStart:function(a,j,k,m){$.when(k.locationFromPosition(j),k.locationFromPosition(a.position)).done(function(h,g){g>h&&e.lastTimeRead!==-1&&a.syncTime!==e.lastSyncTime&&m({currentLocation:h,currentPosition:j,fprPosition:a.position,fprLocation:g,
fprDevice:a.deviceName,fprDateTime:a.syncTime});b(a.syncTime)})},onPageChange:function(a){e.lastPositionRead=a;e.lastTimeRead=(new Date).getTime();k.getAppDb().updateLastPositionRead(l,e.lastPositionRead,e.lastTimeRead,function(a){function b(){window.location.reload(!0)}a&&(a.code===Kindle.DB.DATABASE_ERR||a.code===Kindle.DB.SYNTAX_ERR)&&a.message.indexOf("no such table")>=0&&_metricsManager.emitNow("App::DatabaseGoneOnUpdateLPR",{breakdown:["Browser"]}).then(b,b)})},onReadingEnd:function(){l=null;
e=void 0},getStartReadingPosition:function(){return e},updateFprSyncTime:function(a){a.syncTime!==e.lastSyncTime&&k.getAppDb().updateLastFPRSyncTime(l,a.syncTime,function(){})}}}(),KindleReaderMetrics=function(){function b(){c||(c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));return c}var l=!1,e,k,a,j,n,m,h,g="",d=1,f,c;return{NEXT_PAGE:0,PREV_PAGE:1,setBookType:function(a){g=a},setColumnCount:function(a){d=Number(a)||1},startGoToMetrics:function(){k=b().createTimer()},endGoToMetrics:function(){k&&
(k.emit("Reader::GoToPosition::"+g),k=null)},startPageTurnTimer:function(c,d){l||(l=!0,f=d,c===0&&!a?(a=b().createTimer(),e=c):c===1&&!j&&(j=b().createTimer(),e=c))},endPageTurnTimer:function(){l&&(e===0&&a?(a.emit([{name:"Reader::NextPage::"+g,params:{submetrics:[{name:"columnCount",value:d}]}},{name:"Reader::NextPage:Version",params:{breakdown:["Version"]}}]),a=null,f&&b().emit("Reader::NextPage::"+f)):e===1&&j&&(j.emit("Reader::PrevPage::"+g,{submetrics:[{name:"columnCount",value:d}]}),j=null,
f&&b().emit("Reader::PrevPage::"+f)),l=!1)},startSpinnerTimer:function(){l&&(e===0&&!n?n=b().createTimer():e===1&&!m&&(m=b().createTimer()))},endSpinnerTimer:function(){l&&(e===0&&n?(n.emit("Reader::NextPageSpinner::"+g,{submetrics:[{name:"columnCount",value:d}]}),n=null):e===1&&m&&(m.emit("Reader::PrevPageSpinner::"+g,{submetrics:[{name:"columnCount",value:d}]}),m=null))},reportContentNotAvailableMetrics:function(){b().emit("Reader::ContentNotAvailableOffline")},reportTimeOutMetrics:function(){b().emit("Reader::PageTurnTimeOut::"+
g)},reportBackButtonUsage:function(){b().emit("Reader::BackButton")},notifyAnnotationsReady:function(){h=b().createTimer()},reportAnnotationsPaneOpened:function(){b().emit("Reader::OpenAnnotationsPane");h&&(h.emit("Reader::OpenAnnotationsPane::Time"),h=null)}}}(),KindleReaderOverlayManager=function(b){var l=new ListenerManager;b.addEventListener(b.SELECTION_CHANGED_EVENT,function(b){b.oldValue&&l.callEventListeners("overlayRemoved",{type:"overlayRemoved",overlay:{type:"kindle.selection",start:b.oldValue.start,
end:b.oldValue.end}});b.newValue&&l.callEventListeners("overlayAdded",{type:"overlayAdded",overlay:{type:"kindle.selection",start:b.newValue.start,end:b.newValue.end}})});return{OVERLAY_ADDED_EVENT:"overlayAdded",OVERLAY_REMOVED_EVENT:"overlayRemoved",getOverlaysInRange:function(e,k){var a=[],j=KindleReaderAnnotationManager.getAnnotationsInRange(e,k,KindleReaderAnnotationManager.NOTE),l=KindleReaderAnnotationManager.getAnnotationsInRange(e,k,KindleReaderAnnotationManager.HIGHLIGHT),m=b.getSelection();
j&&Array.prototype.push.apply(a,j);l&&Array.prototype.push.apply(a,l);m&&e<=m.end&&m.start<=k&&a.push({type:"kindle.selection",start:m.start,end:m.end});return a},addEventListener:l.addEventListener,removeEventListener:l.removeEventListener}},KindleReaderSelectionRenderer=function(){var b=null,l=null,e=null,k=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMSPointerEnabled();return{initialize:function(a){e=a;k&&(b=document.createElement("DIV"),$(b).addClass("amazon-grabHandleBegin"),
$(b).hide(),$("body").append(b),l=document.createElement("DIV"),$(l).addClass("amazon-grabHandleEnd"),$(l).hide(),$("body").append(l))},getGrabHandleBegin:function(){return b},getGrabHandleEnd:function(){return l},setSelection:function(a){if(a.touchSelected&&k){var j=KindleListUtilities.first(e.getBounds(a.start)),a=KindleListUtilities.last(e.getBounds(a.end)),n=$("#kindleReader_content");b.style.top=j.top+n.offset().top+"px";b.style.left=j.left+n.offset().left+"px";l.style.top=a.bottom+n.offset().top+
"px";l.style.left=a.right+n.offset().left+"px";$(b).show();$(l).show()}},clearSelection:function(){k&&($(b).hide(),$(l).hide())}}}(),KINDLE_READER_SETTINGS_COLOR_MODE={WHITE:{id:"#kindleReader_controlPanel_colorWhite",persistedValue:0},SEPIA:{id:"#kindleReader_controlPanel_colorSepia",persistedValue:1},BLACK:{id:"#kindleReader_controlPanel_colorBlack",persistedValue:2}},KINDLE_READER_SETTINGS_FONT_SIZE={XSMALL:{id:"#kindleReader_controlPanel_xSmallFont",size:14},SMALL:{id:"#kindleReader_controlPanel_smallFont",
size:16},MEDIUM:{id:"#kindleReader_controlPanel_mediumFont",size:20},LARGE:{id:"#kindleReader_controlPanel_largeFont",size:28},XLARGE:{id:"#kindleReader_controlPanel_xLargeFont",size:44}},KINDLE_READER_SETTINGS_GLYPH_SCALE={14:1,16:1.25,20:1.5,28:2,44:3},KINDLE_READER_SETTINGS_MARGIN={XSMALL:{id:"#kindleReader_controlPanel_xSmallMargin",size:0},SMALL:{id:"#kindleReader_controlPanel_smallMargin",size:10},MEDIUM:{id:"#kindleReader_controlPanel_mediumMargin",size:18},LARGE:{id:"#kindleReader_controlPanel_largeMargin",
size:20},XLARGE:{id:"#kindleReader_controlPanel_xLargeMargin",size:22}},KINDLE_READER_SETTINGS_COLUMN_MODE={OFF:{id:"#kindleReader_controlPanel_columnButton_off",persistedValue:"true"},ON:{id:"#kindleReader_controlPanel_columnButton_on",persistedValue:"false"}},KindleReaderSettings=function(){var b=KINDLE_READER_SETTINGS_FONT_SIZE.MEDIUM.size,l=KINDLE_READER_SETTINGS_MARGIN.MEDIUM.size,e=KINDLE_READER_SETTINGS_COLOR_MODE.WHITE,k=KINDLE_READER_SETTINGS_COLUMN_MODE.OFF.persistedValue;return function(){var a,
j,n,m,h,g,d,f,c,s;this.copy=function(b){a=b.getFontSize();j=b.getMargin();this.setColorMode(b.getColorMode());s=b.getShowColumns()};this.reset=function(){a=b;j=l;this.setColorMode(e);s=k};this.getFontSize=function(){return a};this.getGlyphScale=function(){return KINDLE_READER_SETTINGS_GLYPH_SCALE[a]};this.setFontSize=function(b){a=b};this.getMargin=function(){return j};this.setMargin=function(a){j=a};this.getLineHeight=function(){return 1.4};this.getBGColor=function(){return m};this.getFGColor=function(){return h};
this.getBodyColor=function(){return g};this.getTitleColor=function(){return d};this.getHighlightColor=function(){return f};this.getSelectionColor=function(){return selectionColor};this.getColorMode=function(){return n};this.getInsertBGColor=function(){return c};this.setColorMode=function(a){a===KINDLE_READER_SETTINGS_COLOR_MODE.WHITE?(m="#ffffff",h="#111111",g="#ffffff",d="#999999",f="#fff5ad",selectionColor="#cdd0d4",c="#cccccc"):a===KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA?(m="#FBF0D9",h="#5F4B32",
g="#FBF0D9",d="#84725B",f="#fff5ad",selectionColor="#d7d0c0",c="#d8c69f"):a===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK&&(m="#000000",h="#FFFFFF",g="#000000",d="#999999",f="#60abeb",selectionColor="#6d6d6d",c="#333333");n=a};this.getShowColumns=function(){return s};this.setShowColumns=function(a){s=a};this.save=function(b){if(b)try{b.setItem("KindleReaderSettings.fontSize",a),b.setItem("KindleReaderSettings.margin",j),b.setItem("KindleReaderSettings.colorMode",n.persistedValue),b.setItem("KindleReaderSettings.showColumns",
s)}catch(c){}};this.load=function(b){if(b){b.getItem("KindleReaderSettings.fontSize")!==null&&(a=parseInt(b.getItem("KindleReaderSettings.fontSize"),10));b.getItem("KindleReaderSettings.margin")!==null&&(j=parseInt(b.getItem("KindleReaderSettings.margin"),10));if(b.getItem("KindleReaderSettings.colorMode")!==null){var c=parseInt(b.getItem("KindleReaderSettings.colorMode"),10),d;for(d in KINDLE_READER_SETTINGS_COLOR_MODE)KINDLE_READER_SETTINGS_COLOR_MODE[d].persistedValue===c&&this.setColorMode(KINDLE_READER_SETTINGS_COLOR_MODE[d])}b.getItem("KindleReaderSettings.showColumns")!==
null&&(s=b.getItem("KindleReaderSettings.showColumns")==="false"?"false":"true")}}}}(),KindleReaderZoomableManager=function(){function b(){j=KindleRenderer.getZoomableList();n=!!j;j&&j.length>0&&(m===k.PREV?(a=j.length-1,j[a].activate()):m===k.NEXT&&(a=0,j[a].activate()),m=null)}function l(){n&&(j&&j.length>0&&j[a].deactivate(),a=null,n=!1)}function e(){j=null}var k={NEXT:"next",PREV:"prev"},a=null,j=null,n=!1,m=null;return{activateZoomableAtPosition:function(b,e){var d=KindleRenderer.getZoomableAt(b,
e);l();if(d&&d.activate){j||(j=KindleRenderer.getZoomableList(),n=!!j);a:{for(var f=0;f<j.length;f++)if(j[f].isSame(d)){a=f;break a}a=void 0}j[a].activate();n=!0}},gotoNextZoomable:function(){function h(){e();if(KindleRenderer.hasNextScreen())m=k.NEXT;KindleReaderUI.nextPage()&&b()}j&&(j.length===0?h():(j[a].deactivate(),a<j.length-1?j[++a].activate():h()))},gotoPreviousZoomable:function(){function h(){e();if(KindleRenderer.hasPreviousScreen())m=k.PREV,KindleReaderUI.prevPage()&&b()}j&&(j.length===
0?h():(j[a].deactivate(),a>0?j[--a].activate():h()))},isZoomed:function(){return n},activateZoomableOnPageTurn:b,deactivateZoomable:l,clearZoomables:e}}(),KindleSelectionEvents=function(){function b(a){if(!a.pageX&&!a.pageY){var b=a.target.getBoundingClientRect();return{x:b.left+a.clientX,y:b.top+a.clientY}}return{x:a.pageX,y:a.pageY}}function l(a){if(!r&&!q&a.which!==3){var c=b(a),c=G(c.x,c.y,O);c>=0&&(w=!0,t=x=!1,v=c,y.setSelection(null),a.preventDefault())}}function e(a){if(w&&v&&a.which!==3){var c=
b(a);w=!1;x&&y.getSelection()&&(c=G(c.x,c.y),y.setSelection({start:Math.min(v,c),end:Math.max(v,c)}),y.processSelection());a.stopPropagation()}x=!1}function k(a){x=!0;if(w&&v){var c=b(a),c=G(c.x,c.y);y.setSelection({start:Math.min(v,c),end:Math.max(v,c)});t=!0}else t=!1;a.stopPropagation()}function a(a){if(J)return!1;var c=b(a),c=G(c.x,c.y,O);c>=0&&(y.setSelection({start:c,end:c}),y.processSelection(),a.stopPropagation())}function j(){t||y.setSelection(null)}function n(a){r=!0;q=!1;v=y.getSelection().end;
a.stopPropagation();return!1}function m(a){r=!1;q=!0;v=y.getSelection().start;a.stopPropagation();return!1}function h(){!r&&!q&&y.setSelection(null)}function g(a){y.getSelection()&&(y.processSelection(),q=r=!1,v=null,a.stopPropagation())}function d(a){function c(){var d=y.getSelection(),f;a.originalEvent&&a.originalEvent.touches?f=G(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY):(f=b(a),console.log("move:"+f.x+","+f.y),f=G(f.x,f.y));r?y.setSelection({start:Math.min(v,f),end:d.end,
touchSelected:!0}):q&&y.setSelection({start:d.start,end:Math.max(v,f),touchSelected:!0},!0)}if(v&&(r||q))setTimeout(c,10),a.stopPropagation()}function f(a){var b=G(a.startX,a.startY,O);b>=0&&(y.setSelection({start:b,end:b,touchSelected:!0}),y.processSelection(),t=!0,a.stopPropagation&&a.stopPropagation())}function c(a,b){for(var c=a.length,d=0;d<c;d+=1){var f=a[d],e=$(f).offset();if(e.top-10<b.y&&b.y<e.top+$(f).height()+10&&e.left-10<b.x&&b.x<e.left+$(f).width()+10)return!0}return!1}function s(a){return function(b){if(b.pointerType===
b.MSPOINTER_TYPE_MOUSE||b.pointerType===b.MSPOINTER_TYPE_PEN)J=!1,a(b)}}function o(a){return function(b){b.pointerType===b.MSPOINTER_TYPE_TOUCH&&(J=!0,a(b))}}var r=!1,q=!1,w=!1,v,x=!1,t=!1,G,O=225,y,J=!1;return{initialize:function(q){G=q.getBookPositionAt;y=q.selectionStateManager;KindleHostDeviceDetector.isMSPointerEnabled()?(q.mouseDownEventSource&&($(q.mouseClickOutsideEventSource).click(j),$(q.mouseDownEventSource).dblclick(a),q.mouseEventSource.addEventListener("MSPointerMove",s(k)),q.mouseEventSource.addEventListener("MSPointerDown",
s(function(a){!c($(".ui-dialog:visible"),b(a))&&l(a)})),q.mouseEventSource.addEventListener("MSPointerUp",s(function(a){!c($(".ui-dialog:visible"),b(a))&&e(a)}))),q.touchEventSource&&(q.selectionHandleLeft.addEventListener("MSPointerDown",o(n)),q.selectionHandleRight.addEventListener("MSPointerDown",o(m)),q.selectionHandleLeft.addEventListener("MSPointerUp",o(g)),q.selectionHandleRight.addEventListener("MSPointerUp",o(g)),q.touchEventSource.addEventListener("MSPointerMove",o(d)),q.touchEventSource.addEventListener("MSPointerUp",
o(g)),q.touchEventSource.addEventListener("MSPointerDown",o(h)),$(q.touchEventSource).tapHold(f,{touchOnly:!0}))):(q.mouseDownEventSource&&($(q.mouseDownEventSource).dblclick(a),$(q.mouseDownEventSource).mousedown(l),$(q.mouseEventSource).mousemove(k),$(q.mouseEventSource).mouseup(e),$(q.mouseClickOutsideEventSource).click(j)),q.touchEventSource&&($(q.selectionHandleLeft).bind("touchstart",n),$(q.selectionHandleLeft).bind("touchmove",d),$(q.selectionHandleLeft).bind("touchend",g),$(q.selectionHandleRight).bind("touchstart",
m),$(q.selectionHandleRight).bind("touchmove",d),$(q.selectionHandleRight).bind("touchend",g),KindleDebug.log("binding touchstart & tapHold..."),$(q.touchEventSource).bind("touchstart",h),$(q.touchEventSource).tapHold(f),KindleDebug.log("...bound")))}}}();
KindleSelectionHelper=function(b){return{getBookPositionAt:function(l,e,k){var a=b(),k=k||Infinity,j=-1,n;for(n in a)for(var m=a[n],h=0;h<m.length;h++){var g;g=m[h];var d=void 0,f=void 0,d=l<g.left?g.left-l:l<g.right?0:l-g.right,f=e<g.top?g.top-e:e<g.bottom?0:e-g.bottom;g=d*d+f*f;if(g<k&&(k=g,j=n,g<=0))break}return+j},getBounds:function(l){return b()[l]||null}}};
var KindleSelectionStateManagerFactory=function(){function b(){return e?{start:e.start,end:e.end,touchSelected:e.touchSelected}:null}var l=ListenerManager(),e=null,k=0;l.setEventProperties("selectionChanged",{vetoable:!0});return{SELECTION_CHANGED_EVENT:"selectionChanged",PROCESS_SELECTION_EVENT:"processSelection",addEventListener:l.addEventListener,setSelection:function(a){if(!k&&(!a||a.start&&a.end)){if(a&&(a.start=Number(a.start),a.end=Number(a.end),a.start>a.end)){var j=a.start;a.start=a.end;
a.end=j}a===null&&e===null||a!==null&&e!==null&&a.start===e.start&&a.end===e.end||(j=b(),l.callEventListeners("selectionChanged",{type:"selectionChanged",oldValue:j,newValue:a})&&(e=a))}},processSelection:function(){k||e&&l.callEventListeners("processSelection",{type:"processSelection",selection:b()})},getSelection:b,enable:function(){k--;KindleAssert(k>=0,"Mismatched selection disable/enable")},disable:function(){k++;e=null}}},KindleUserLocationConverter;
KindleUserLocationConverter=function(){function b(){return{locationFromPosition:function(a){return $.Deferred().resolve(Math.floor(a*2/300+1))},positionFromLocation:function(a){a*=100;a<100&&(a=100);return $.Deferred().resolve(Math.floor((a-100)*3/2))},flavor:function(){return k}}}function l(){return{locationFromPosition:function(a){return $.Deferred().resolve(Math.floor((a*j+100)/100))},positionFromLocation:function(a){a*=100;a<100&&(ASSERT(0),a=100);return $.Deferred().resolve(Math.floor((a-100)/
j))},flavor:function(){return a}}}function e(a){function b(a){if(v[a])return v[a].deferred;var c,d,f;c=q(a);c.done(e);x++;v[a]={deferred:c,cacheEntrySeq:x};if(x>t){a=x;for(d in v)if(v[d].cacheEntrySeq<a)f=d,a=v[d].cacheEntrySeq;a!==x&&delete v[f]}return c}function e(a){var b=a.metadata.id;if(!w[b]||!w[b].firstPos){w[b]=w[b]||{};var c,d,g=a.metadata.id;try{$.isArray(a.locations)?(c=a.locations[0],d=a.locations[a.locations.length-1]):(c=a.locations[g*l+f],d=a.locations[Math.min((g+1)*l+f-1,k)])}catch(h){c=
Number.MAX_VALUE;d=-1;for(var j in a.locations)a.locations.hasOwnProperty(j)&&a.locations[j]&&(c=Math.min(a.locations[j],c),d=Math.max(a.locations[j],d))}a={firstPos:c,lastPos:d};if(!w[b].lastPos)w[b].lastPos=a.lastPos;if(!w[b].firstPos&&(w[b].firstPos=a.firstPos,b>0))w[b-1]=w[b-1]||{},w[b-1].lastPos=a.firstPos-1}}function g(a){var b,c,d=a.metadata.id;try{$.isArray(a.locations)?(b=0,c=a.locations.length-1,offset=d*l+f):(b=d*l+f,c=Math.min((d+1)*l+f-1,k),offset=0)}catch(e){b=Number.MAX_VALUE;c=-1;
for(var g in a.locations)a.locations.hasOwnProperty(g)&&a.locations[g]&&(b=Math.min(g,b),c=Math.max(g,c))}return{firstIx:b,lastIx:c,offset:offset}}function d(a){function c(d,f){if(d===f)b(d).then(h.resolve,h.reject);else{var e=Math.floor((d+f)/2);e===d&&f===d+1&&(e=f);b(e).done(function(b){var g=w[b.metadata.id];g.firstPos>a?c(d,e-1):g.lastPos>=a?h.resolve(b):c(e,f)}).fail(h.reject)}}var d,e,g;e=0;g=Math.floor((k-f)/l);for(d=0;d<w.length;d++)if(w[d])if(w[d].firstPos){if(w[d].firstPos<=a&&w[d].lastPos>=
a)return b(d);if(w[d].firstPos>a){g=d-1;break}else e=d}else if(w[d].lastPos){if(w[d].lastPos===a)return b(d);if(w[d].lastPos>a){g=d;break}else e=d+1}var h=new jQuery.Deferred;c(e,g);return h.promise()}var f=1,c=a.minPosition,j=a.maxPosition,k=a.locationsInfo.numOfLocations,l=a.locationsInfo.mapSize,q=a.mapGetter,w=[],v={},x=1,t=Math.max(5,Math.floor(2E4/l));return{locationFromPosition:function(a){var b=new jQuery.Deferred;d(a).done(function(c){function d(c,e,g){var h=Math.floor((c+e)/2);g[h]===a?
b.resolve(h+f.offset):g[h]>a?d(c,h-1,g):h===e||g[h+1]>a?b.resolve(h+f.offset):d(h+1,e,g)}var f=g(c);d(f.firstIx,f.lastIx,c.locations)}).fail(function(){a<=c?b.resolve(f):a>=j?b.resolve(k-1+f):b.resolve(Math.floor((a-c)/(j-c)*(k-f)+f))});return b},positionFromLocation:function(a){var d=new jQuery.Deferred;b(Math.floor((a-f)/l)).done(function(b){var c,e;try{$.isArray(b.locations)?(c=(a-f)%l,e=b.locations[c]):e=b.locations[a]}catch(g){e=1}d.resolve(e)}).fail(function(){a<=f?d.resolve(c):a>=k-1+f?d.resolve(j):
(p=(a-f)/k,d.resolve(Math.floor(p*(j-c)+c)))});return d.promise()}}}var k="mobi",a="topaz",j=3;return{MOBI_FLAVOR:k,TOPAZ_FLAVOR:a,mobiLocationConverter:b,topazLocationConverter:l,getLocationConverter:function(a,j){return a==="topaz"?l():a==="mobi8"?e(j):b()}}}();
var KindleReaderClippingManager=function(){function b(l,e,k,a,j){for(var n=!0;n;){if(e<=0){j.resolve(a+"...");return}n=l.getItem();if(n.pos>k){j.resolve(a);return}e--;a+=n.text;n=l.next()}l.getLoadingDfd().then(function(m){m?b(l,e,k,a,j):j.resolve(a)},j.reject)}return{getSelectedText:function(l){var e=KindleReaderUI.getSelection().getSelection();if(!e)return(new jQuery.Deferred).reject().promise();var k=$.Deferred(),a=KindleRenderer.createWordIterator(),j,n=$.Deferred();l?(j=$.Deferred(),a.gotoPosition(e.start).then(function(){b(a,
l,e.end,"",j)},j.reject),j.then(function(){var b=a.getItem().pos;n.resolve((b-e.start)/KindleReaderUI.getMaxPosition()*100)},n.reject)):(j=a.getText(e.start,e.end),n.resolve((e.end-e.start)/KindleReaderUI.getMaxPosition()*100));$.when(j,n).then(function(a,b){k.resolve({text:a,percent:b})},k.reject);return k.promise()}}}();
function ReaderOptions(b){if(!this instanceof ReaderOptions)return new ReaderOptions(b);Object.defineProperty(this,"PORTRAIT",{value:"portrait"});Object.defineProperty(this,"LANDSCAPE",{value:"landscape"});Object.defineProperty(this,"AUTO",{value:"auto"});var l=!0,e=!0,k=!0,a=!0,j=this.AUTO,n=!0,m=!0,h=KindleDeviceCapabilities.multiColumnMode()?2:1,g=!0;showTitle=viewSettings=!0;Object.defineProperty(this,"bookmarks",{get:function(){return l},set:function(a){l=!!a},enumerable:!0});Object.defineProperty(this,
"annotations",{get:function(){return e},set:function(){e=!!d},enumerable:!0});Object.defineProperty(this,"selection",{get:function(){return k},set:function(){k=!!d},enumerable:!0});Object.defineProperty(this,"trackLpr",{get:function(){return a},set:function(){a=!!d},enumerable:!0});Object.defineProperty(this,"fontSize",{get:function(){return n},set:function(a){n=!!a},enumerable:!0});Object.defineProperty(this,"margins",{get:function(){return m},set:function(a){m=!!a},enumerable:!0});Object.defineProperty(this,
"colors",{get:function(){return g},set:function(a){g=!!a},enumerable:!0});Object.defineProperty(this,"orientation",{get:function(){return j},set:function(a){if(a===this.PORTRAIT||a===this.LANDSCAPE||a===this.AUTO)j=a},enumerable:!0});Object.defineProperty(this,"columns",{get:function(){return h},set:function(a){a=Math.round(a);a>0&&(h=a)},enumerable:!0});Object.defineProperty(this,"viewSettings",{get:function(){return viewSettings},set:function(a){viewSettings=!!a},enumerable:!0});Object.defineProperty(this,
"showTitle",{get:function(){return showTitle},set:function(a){showTitle=!!a},enumerable:!0});var b=b||{},d;for(d in b)b.hasOwnProperty(d)&&this.hasOwnProperty(d)&&(this[d]=b[d])}
var dictionary=function(){var b=null,l={en:!0};return{getDictionary:function(){return b=b||dictionaryDotComFactory()},isLanguageSupported:function(b){return!!l[b.substring(0,2)]}}}(),IDictionary=function(){var b={lookup:function(){throw Error("Failed to implement lookup");}};Object.defineProperty(b,"NOT_WORD",{value:"Not a word",enumerable:!0});Object.defineProperty(b,"NOT_FOUND",{value:"No definition found",enumerable:!0});Object.defineProperty(b,"LOOKUP_FAILED",{value:"Word lookup failed",enumberable:!0});
Object.defineProperty(b,"OFFLINE",{value:"Offline",enumberable:!0});return b}(),ILookup=function(){return{entry:"",getDefinitions:function(){throw Error("Failed to implement getDefinitions");},getPronunciation:function(){throw Error("Failed to implement pronunciation");},getPronunciationUrls:function(){throw Error("Failed to implement pronunciationUrl");}}}();
function dictionaryDotComFactory(){function b(a){return(a=l.exec(a))&&a.length===2?a[1]:""}var l=/^\W*(\w+(?:-\w+)*(?:'\w+)?)\W*$/,e="https://app.dictionary.com/dictaudio/{audio_file}.mp3",k="https://app.dictionary.com/dictaudio/lunawav/{audio_file}.wav",a=Object.create(IDictionary);a.lookup=function(a){function l(a){function b(a,c){function d(a){$.each(a.definitions,function(a,b){b.content&&f.push(b.content)})}function e(a,b){b&&(b.type==="group"?d(b):b.definition.content&&f.push(b.definition.content))}
var f=[];a&&c&&($.each(c,e),f.length&&m.push({partOfSpeech:a,definitions:f}))}a&&a.result&&typeof a.result==="string"&&(a=JSON.parse(a.result));if(!a||!a.entries||!a.entries.length)h.reject(IDictionary.NOT_FOUND);else{var f=a.entries[0],a=f.entry,c=f.pronunciation_spell,j;if(f.audio_file)j={},j.mp3=encodeURI(e.replace("{audio_file}",f.audio_file)),j.wav=encodeURI(k.replace("{audio_file}",f.audio_file));var m=[];f.definitions&&$.each(f.definitions,b);f=Object.create(ILookup);Object.defineProperty(f,
"entry",{value:a,enumerable:!0});f.getDefinitions=function(){return m};f.getPronunciation=function(){return c};f.getPronunciationUrls=function(){return j};h.resolve(f)}}function m(a){h.reject(a.status?IDictionary.LOOKUP_FAILED:IDictionary.OFFLINE)}var h=new jQuery.Deferred,a=KindleStringUtilities.replaceAccentedChars(a);word=b(a);(a=word.replace("'","%27"))?KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline(6E4)!==!1?KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).getWordDefinition(a).then(l,
m):h.reject(IDictionary.OFFLINE):h.reject(IDictionary.NOT_FOUND);return h.promise()};return(new jQuery.Deferred).resolve(a).promise()}
var KindleDialogOverlay=function(){return{showOverlay:function(b){$("body").append("<div class='ui-widget-overlay ui-widget-overlay-kcr-ios-hack'></div>");$(".ui-widget-overlay-kcr-ios-hack").attr("style","z-index: 1000;").width(window.outerWidth).height(window.outerHeight);(function(){var l=b.component.dialog("option","position");$("body",Kindle.top.document).bind("orientationchange.dialog",function(){b.dialogSettings.k4w_transparent_modal_overlay&&$(".ui-widget-overlay-kcr-ios-hack").css({width:0,
height:0});$(".ui-widget-overlay-kcr-ios-hack").css({width:window.outerWidth+"px",height:window.outerHeight+"px"});b.component.dialog("option","position",l)})})();(function(){b.callbacks.onOverlayClicked&&$(".ui-widget-overlay-kcr-ios-hack").tap(function(b){b.preventDefault()})})()},removeOverlay:function(){$(".ui-widget-overlay-kcr-ios-hack").remove();$("body",Kindle.top.document).unbind("orientationchange.dialog")}}}(),KindleEnableOfflineDialog=function(){function b(){KindleUXComponentManager.closeDialog(l)}
var l="KindleEnableOfflineDialog",e={BUTTON_TEXT:"k_dialog_enableOffline_button_text",OFFLINE_TITLE:"k_dialog_enable_offline_title",FIREFOX_MSG:"k_dialog_enable_offline_firefox_msg"},k={DIALOG:"kindle_dialog_enableOffline",CONTENT:"kindle_dialog_enableOffline_content",BUTTON:"kindle_dialog_enableOffline_button"},a={TITLE:"enable_offline_title",TOP_MSG:"enable_offline_top_msg"},j,n={getDialogSettings:function(){return{autoOpen:!1,width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"enableOfflineDialog"}},
beforeDialogOpen:function(m){j=m;var h,g;KindleHostDeviceDetector.isFirefox()&&(h=ResourceBundle.getLocalizedString(e.OFFLINE_TITLE),g=ResourceBundle.getLocalizedString(e.FIREFOX_MSG,{linkStart:"<a href='http://www.amazon.com/gp/help/customer/display.html/ref=kcr_help_menu?nodeId=200732370#fxoffline' target='_blank'>",linkEnd:"</a>"}));m={title:h,topInstruction:g,topInstructionClass:void 0};j.find("#"+a.TITLE).html(m.title);j.find("#"+a.TOP_MSG).html(m.topInstruction);m.topInstructionClass&&j.find("#"+
a.TOP_MSG).addClass(m.topInstructionClass);m=j.find("#"+k.BUTTON);m.html(ResourceBundle.getLocalizedString(e.BUTTON_TEXT));m.one("click",b)},onDialogOpen:function(){var a=$("#"+k.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")}};return{open:function(){KindleUXComponentManager.openDialog(l,n)},close:function(){KindleUXComponentManager.closeDialog(l)}}}(),KindleFirstRunDialog=function(){function b(){KindleUXComponentManager.closeDialog(k);
m()}function l(){var b,e,c,g,h;KindleHostDeviceDetector.isChromeApp()?(e=ResourceBundle.getLocalizedString(a.CHROME_APP_TITLE),c=ResourceBundle.getLocalizedString(a.CHROME_APP_MSG)):KindleHostDeviceDetector.isChrome()?(g="continue",e=ResourceBundle.getLocalizedString(a.OFFLINE_TITLE),c=ResourceBundle.getLocalizedString(a.CHROME_MSG)):KindleHostDeviceDetector.isiOS()?(b="ipad_prompt",e=ResourceBundle.getLocalizedString(a.OFFLINE_TITLE),c=ResourceBundle.getLocalizedString(a.IOS_PROMPT_MSG)):KindleHostDeviceDetector.isFirefox()?
(b="ff_prompt",e=ResourceBundle.getLocalizedString(a.OFFLINE_TITLE),c=ResourceBundle.getLocalizedString(a.FIREFOX_MSG),h="ff-db-msg"):(b="safari_prompt",e=ResourceBundle.getLocalizedString(a.OFFLINE_TITLE),c=ResourceBundle.getLocalizedString(a.SAFARI_PROMPT_MSG));return{topImgClass:b,title:e,topInstruction:c,bottomImgClass:g,topInstructionClass:h}}function e(){KindleUXComponentManager.closeDialog(k)}var k="KindleFirstRunDialog",a={BUTTON_TEXT:"k_dialog_firstRun_button_text",BUTTON_TEXT_CHROME:"k_dialog_firstRun_button_text_chrome",
CRX_BUTTON_TEXT:"k_dialog_firstRun_button_crx_text",INSTALLING_BUTTON_TEXT:"k_dialog_firstRun_button_installing_text",INSTALLED_BUTTON_TEXT:"k_dialog_firstRun_button_installed_text",CONTINUE_BUTTON_TEXT:"k_dialog_firstRun_button_text_chrome_done",OFFLINE_TITLE:"k_dialog_firstRun_offline_title",CHROME_APP_TITLE:"k_dialog_firstRun_chrome_app_title",CHROME_APP_MSG:"k_dialog_firstRun_chrome_app_msg",CHROME_MSG:"k_dialog_firstRun_chrome_msg",FIREFOX_MSG:"k_dialog_firstRun_firefox_msg",IOS_PROMPT_MSG:"k_dialog_firstRun_ios_prompt_msg",
SAFARI_PROMPT_MSG:"k_dialog_firstRun_safari_prompt_msg"},j={DIALOG:"kindle_dialog_firstRun",CONTENT:"kindle_dialog_firstRun_content",BUTTON:"kindle_dialog_firstRun_button",CRX_BUTTON:"kindle_dialog_firstRun_button_crx"},n={TITLE:"first_run_title",TOP_MSG:"first_run_top_msg",TOP_IMG:"first_run_top_img",BOTTOM_IMG:"first_run_bottom_img"},m,h,g={getDialogSettings:function(){return{autoOpen:!1,width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"firstRunDialog"}},beforeDialogOpen:function(d){function f(){KindleChromeInstaller.install();
e()}h=d;d=l();h.find("#"+n.TITLE).html(d.title);h.find("#"+n.TOP_MSG).html(d.topInstruction);d.topImgClass&&h.find("#"+n.TOP_IMG).addClass(d.topImgClass);d.bottomImgClass&&h.find("#"+n.BOTTOM_IMG).addClass(d.bottomImgClass);d.topInstructionClass&&h.find("#"+n.TOP_MSG).addClass(d.topInstructionClass);d=h.find("#"+j.BUTTON);d.html(ResourceBundle.getLocalizedString(a.BUTTON_TEXT));d.one("click",b);KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()&&(d.removeClass("primary_btn").addClass("chrome_btn").html(ResourceBundle.getLocalizedString(a.BUTTON_TEXT_CHROME)),
d=h.find("#"+j.CRX_BUTTON),d.removeClass("disabled").html(ResourceBundle.getLocalizedString(a.CRX_BUTTON_TEXT)),d.unbind("click"),d.one("click",f),d.show())},onDialogOpen:function(){var a=$("#"+j.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")},onDialogClose:function(){}};return{open:function(a){m=a;KindleUXComponentManager.openDialog(k,g)},close:e}}(),KindleMessageDialog=function(){var b={TITLE_ID:"kindle_dialog_message_title_text",
TEXT_ID:"kindle_dialog_message_text"},l={dismiss:"k_dialog_message_dismissButton_text"},e,k,a,j,n=function(){KindleUXComponentManager.closeDialog("KindleMessageDialog")},m={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(e){var d={};j?d[j]=n:d[ResourceBundle.getLocalizedString(l.dismiss)]=n;if(_additionalButtons)for(var f=0;f<_additionalButtons.length;f++){var c=_additionalButtons[f];d[c.buttonText]=c.callback}e.dialog("option",
"buttons",d);e.find("#"+b.TITLE_ID).empty().append(a);e.find("#"+b.TEXT_ID).empty().append(k)},onDialogClose:function(){e&&e()}},h=function(b,d,f,c,h){e=f;a=b;k=d;_additionalButtons=h;j=c?c:ResourceBundle.getLocalizedString(l.dismiss);KindleUXComponentManager.openDialog("KindleMessageDialog",m)};return{open:h,close:n,showError:function(a,b,e,c){a=KindleErrorMap.getErrorText(a);h(a.title,a.text,b,e,c)}}}(),KindleNotificationDialog=function(){function b(a){$(window).unbind("touchstart.notification mousedown.notification");
KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).unbind("orientationchange.notification"):$(window).unbind("resize.notification");a.removeClass(g.SHOWN);setTimeout(function(){a.remove()},o)}function l(a){function b(c){var d,e,f,h;if(d=m[c.optionProperty])if(typeof d==="string"?e=d:(e=d.id,f=d.localizationParams,h=d.htmlClass),d=ResourceBundle.getLocalizedString(e,f))c=$(c.tag).addClass(c.htmlClass).html(d),h&&c.addClass(h),a.find("."+g.CONTAINER).append(c)}a.find("."+g.CONTAINER).empty();
b(g.PRETITLE);b(g.TITLE);b(g.BODY);b(g.LEGAL)}function e(a,b){var c=$("#kindleNotificationArrow"),d=$("#"+b.targetElementId),e=0,f=0;b.targetAlignment==="right"?(e=d.offset().left+d.outerWidth(),e-=a.outerWidth()):(e=d.offset().left+d.outerWidth()/2,e-=a.outerWidth()/2);(function(){var b=$("body").outerWidth();e+a.outerWidth()>b&&(e=b-a.outerWidth());e<0&&(e=0)})();(function(){var a=b.targetBeakOffset||0;f=d.offset().left-e+d.outerWidth()/2+a})();a.css("left",e+"px");c.css("left",f+"px")}function k(a){function d(){e(a,
m);KindleHostDeviceDetector.isiOS()&&a.show();g=null}function f(){g?clearTimeout(g):KindleHostDeviceDetector.isiOS()&&a.hide();g=setTimeout(d,r)}function h(){v=!0;w&&x.increment();b(a)}var g;$(window).bind("touchstart.notification mousedown.notification",function(a){(!a.srcElement||!a.srcElement.id||!m.clickIdsToIgnore||!m.clickIdsToIgnore[a.srcElement.id])&&setTimeout(h,s)});KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).bind("orientationchange.notification",f):$(window).bind("resize.notification",
f);setTimeout(h,c)}function a(a){k(a);$("body").append(a);e(a,m);setTimeout(function(){v||(a.addClass(g.SHOWN),setTimeout(function(){w=!0},f))},d)}function j(b){l(b);a(b)}function n(a){var b=$("<canvas id='kindleNotificationArrow' width='32' height='32'></canvas>"),c=b[0].getContext("2d");c.beginPath();c.moveTo(0,24);c.lineTo(0,25);c.lineTo(32,25);c.lineTo(32,24);c.lineTo(16,0);c.closePath();c.fillStyle="#eee";c.fill();c.beginPath();c.moveTo(0,24);c.lineTo(16,0);c.lineTo(32,24);c.strokeStyle="rgba(32,32,32,0.8)";
c.stroke();b.css("top","-24px");b.css("left","50%");b.css("margin-left","-16px");b.css("position","absolute");a.prepend(b);q.resolve(a)}var m={},h={},g={BODY:{htmlClass:"notificationBodyText",tag:"<div></div>",optionProperty:"bodyId"},LEGAL:{htmlClass:"notificationLegalText",tag:"<div></div>",optionProperty:"legalId"},TITLE:{htmlClass:"notificationTitleText",tag:"<span></span>",optionProperty:"titleId"},PRETITLE:{htmlClass:"notificationPreTitleText",tag:"<span></span>",optionProperty:"preTitleId"},
CONTAINER:"notificationContainer",SHOWN:"shown"},d=2E3,f=1E3,c=2E4,s=250,o=3E3,r=100,q=null,w=!1,v=!1,x;return{show:function(a){m=$.extend({},h,a);x=LocalStorageCounter("kcrNotifications."+m.notificationId);a=m.notificationCount|1;x.getValue()<a&&(q||(q=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleNotificationDialog",n)),q.done(j))},hide:function(){var a=$("#kindleNotification");b(a)}}}(),KindlePopupMenu=function(){function b(a){var b=KindleUXComponentManager.renderTemplate(k),
c=b.find("#kindle_menu_border"),j=f[a].menuItems,n=!0,v,x;for(x in j)v=$(document.createElement("div")).addClass(m).addClass(h).text(j[x].content).attr("id",j[x].elementId),n&&(v.addClass(g),n=!1),v.tap(l(v,j[x].clickHandler)),c.append(v);v.addClass(d);KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$("body",Kindle.top.document).bind("orientationchange",function(){KindleUXComponentManager.hideMenu(a)});f[a].doneCallback(b,e(a))}function l(a,b){return function(){a.hasClass(h)&&b()}}
function e(b){return{getDialogSettings:function(){var c=a,d=f[b];d.buttonID&&(c+=" "+(d.position==="down"?j:n));return{autoOpen:!1,draggable:!1,resizable:!1,modal:!0,minHeight:0,width:"auto",dialogClass:c,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var c=f[b].buttonID,d=f[b].position,e=[];c?(c=$("#"+c),d==="down"?(d=c.offset().top+c.outerHeight(),e[0]=KindleHostDeviceDetector.isMetro()?c.offset().left+23:c.offset().left,e[1]=KindleHostDeviceDetector.isMetro()?d+10:d):(e[0]="right",
e[1]="bottom")):e=d;a.dialog("option","position",e)},onDialogOpen:function(){c=!0},onDialogClose:function(){c=!1},onOverlayClicked:function(){c&&KindleUXComponentManager.hideMenu(b)}}}var k="KindlePopupMenu",a="kindle_menu",j="down_menu",n="up_menu",m="kindle_menu_button",h="button_enabled",g="ui-corner-top",d="ui-corner-bottom",f={},c=!1;return{ITEM_ENABLED:0,ITEM_DISABLED:1,ITEM_HIDDEN:2,initialize:function(a,c,d,e,h){f[a]={menuItems:d,doneCallback:h,buttonID:c,position:e};KindleUXComponentManager.hasTemplate(k)?
b(a):KindleUXComponentManager.initializeTemplate(k,function(){b(a)})},updateMenu:function(a,b){for(var c,e,f=0;f<b.length;f++)b[f]!==2&&(c===void 0&&(c=f),e=f);a.find("."+m).each(function(a){$(this).removeClass().addClass(m);switch(b[a]){case 0:$(this).addClass(h);break;case 1:$(this).addClass("button_disabled");break;case 2:$(this).addClass("button_hidden")}a===c&&$(this).addClass(g);a===e&&$(this).addClass(d)})},updatePosition:function(a,b){f[a].position=b}}}(),KindlePromptDialog=function(){var b=
{OK_BUTTON_STRING_ID:"k_common_confirm_button",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button"},l={TEXT_LABEL_ID:"kindle_dialog_prompt_label"},e,k,a,j=function(){a="ok";KindleUXComponentManager.closeDialog("KindlePromptDialog")},n=function(){a="cancel";KindleUXComponentManager.closeDialog("KindlePromptDialog")},m={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(b.CANCEL_BUTTON_STRING_ID)]=n;a[ResourceBundle.getLocalizedString(b.OK_BUTTON_STRING_ID)]=j;return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(k);a.find("#"+l.TEXT_LABEL_ID).empty().append(b)},onDialogClose:function(){e(a)}};return{open:function(b,g){e=g;a=!1;k=b;KindleUXComponentManager.openDialog("KindlePromptDialog",m)}}}(),KindleSigningOutDialog=function(){var b={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,width:"450px"}}};return{show:function(){KindleUXComponentManager.openDialog("KindleSigningOutDialog",
b)},hide:function(){KindleUXComponentManager.closeDialog("KindleSigningOutDialog")}}}(),KindleSpinner=function(){function b(){j||(j=new jQuery.Deferred,KindleUXComponentManager.initializeComponent(k,l));return j.promise()}function l(b){a=b;j.resolve()}function e(){$("body").append(a);var b=window.innerWidth>1?window.innerWidth:window.outerWidth,e=parseInt(a.css("width"),10),h=window.innerHeight>1?window.innerHeight:window.outerHeight,g=parseInt(a.css("height"),10);a.css("top",(h-g)/2+"px").css("left",
(b-e)/2+"px")}var k="KindleSpinner",a,j;return{overlay:function(){var a=b();$.when(a).then(function(){e()})},show:function(){var a=b();$.when(a).then(function(){e()})},hide:function(){var a=b();$.when(a).then(function(){$("#loading_spinner").detach()})}}}(),KindleUnoptimizedFormatDialog=function(){var b={TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_message",METRO_TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_metro_message",CLOSE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_close",STOP_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_stopSave",
CONTINUE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_continue"},l={TEXT_LABEL_ID:"kindleReader_dialog_unoptimizedFormat_message_id"},e,k,a,j=function(){KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},n=function(){k=!0;KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},m={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(b.CLOSE_BUTTON_STRING_ID)]=j;a[ResourceBundle.getLocalizedString(b.CONTINUE_BUTTON_STRING_ID)]=n;return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(e){var g=KindleHostDeviceDetector.isIE()?b.METRO_TEXT_LABEL_STRING_ID:b.TEXT_LABEL_STRING_ID,g=ResourceBundle.getLocalizedString(g,{linkStart:"<a href='http://itunes.apple.com/us/app/kindle/id302584613?mt=8'>",linkEnd:"</a>"});e.find("#"+l.TEXT_LABEL_ID).empty().append(g);$(e[0].parentNode).find(".ui-button-text").first().text(a)},onDialogClose:function(){e(k)}};return{open:function(h){a=ResourceBundle.getLocalizedString(b.CLOSE_BUTTON_STRING_ID);
e=h;k=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",m)},openPinning:function(h){a=ResourceBundle.getLocalizedString(b.STOP_BUTTON_STRING_ID);e=h;k=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",m)}}}(),KindleAnnotationComponentFactory=function(){function b(a,b){return a.replace(".","_")+"_"+b}function l(a,b){a.find("."+o.CONTEXT).tap(function(){b(a)})}function e(a,b){var d=function(c){return function(){var d=b[s[c]];d&&d(a)}},e;for(e in c){var f=a.find("."+
c[e]);b[s[e]]||f.remove();f.tap(d(e))}}function k(a,b){b.length>q?a.find("."+o.CONTEXT).text(b.substring(0,q)+" ..."):a.find("."+o.CONTEXT).text(b)}var a=0,j=a++,n=a++,m=a++,h=a++,g=a++,d=a++,f=a++,c={TRASH_CAN:"kindleReader_annotation_pane_notes_trashcan",EDIT:"kindleReader_annotation_pane_notes_edit",GOTO:"kindleReader_annotation_pane_notes_goto",SAVE:"kindleReader_annotation_pane_notes_save",CANCEL:"kindleReader_annotation_pane_notes_cancel",YES:"kindleReader_annotation_pane_notes_yes",NO:"kindleReader_annotation_pane_notes_no"},
s={TRASH_CAN:n,EDIT:j,GOTO:m,SAVE:h,CANCEL:g,YES:d,NO:f},o={CONTEXT:"kindleReader_annotation_pane_notes_context"},r={TEXT_AREA:"kindleReader_annotation_pane_edit_textArea"},q=430,w=function(){return KindleUserLocationConverter},v=function(){return KindleUXComponentManager},x=function(){return KindleReaderAnnotationManager};return{EVENT_EDIT_CLICKED:j,EVENT_DELETE_CLICKED:n,EVENT_GOTO_CLICKED:m,EVENT_SAVE_CLICKED:h,EVENT_CANCEL_CLICKED:g,EVENT_YES_CLICKED:d,EVENT_NO_CLICKED:f,MAX_NOTE_CONTEXT_LENGTH:q,
initialize:function(a){var b=w(),c=v();b.mobiLocationConverter();c.initializeTemplate("KindleAnnotationComponentFactory",a)},createAnnotationComponent:function(a,c,m,n){var s=new jQuery.Deferred,w=v(),H=x(),I,z={context:a.note||a.context,start:a.start,location:"",id:b(a.type,a.start),maxContextLength:q};c.locationFromPosition(a.start).done(function(b){z.location=ResourceBundle.getLocalizedString("k_R_annotation_pane_notes_location",{location:b});switch(a.type){case H.BOOKMARK:z.type=ResourceBundle.getLocalizedString("k_R_annotation_pane_bookmark_label");
I=w.renderTemplate("KindleAnnotationComponentFactory",z);I.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_bookmark");n[j]=null;n[h]=null;n[g]=null;n[d]=null;n[f]=null;break;case H.HIGHLIGHT:z.type=ResourceBundle.getLocalizedString("k_R_annotation_pane_note_highlight");I=w.renderTemplate("KindleAnnotationComponentFactory",z);I.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_highlight");n[j]=null;n[h]=null;n[g]=null;n[d]=
null;n[f]=null;break;case H.NOTE:z.type=ResourceBundle.getLocalizedString("k_R_annotation_pane_note_label"),I=w.renderTemplate("KindleAnnotationComponentFactory",$.extend({},z,{maxNoteChars:Kindle.opt.maxNoteChars})),I.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_note"),KindleTouchEventsToggler.isRequired()&&(I.find("#"+r.TEXT_AREA).focus(function(){KindleTouchEventsToggler.off()}),I.find("#"+r.TEXT_AREA).blur(function(){KindleTouchEventsToggler.on()}))}if(z.context){if(k(I,
z.context),a.type===H.NOTE)b=I.find("."+o.CONTEXT)[0],b.innerHTML=b.innerHTML.replace(/\n/g,"<br />")}else I.find("."+o.CONTEXT).remove();l(I,m);e(I,n);s.resolve(I)});return s.promise()},setAnnotationContext:k,getAnnotationID:b,setUserLocationConverter:function(a){w=a},setUXComponentManager:function(a){v=a},setAnnotationManager:function(a){x=a}}}(),KindleImageViewer=function(b){function l(){k=e.find(".imageViewerImage");$("<img/>").attr("src",k.attr("src")).load(function(){var a=this.width/this.height,
e=b.parent.width()/b.parent.height();a>e?(k.css("height","auto"),k.css("width","100%")):(k.css("height","100%"),k.css("width","auto"));k.css("max-width",Math.min(this.width,$(window).width()));k.css("max-height",Math.min(this.height,$(window).height()))})}var e,k,a=new jQuery.Deferred;KindleUXComponentManager.initializeTemplate("KindleImageViewer",function(){var j=KindleUXComponentManager.renderTemplate("KindleImageViewer",{imageSource:b.imageSource});e=$(j).hide();l();$("body",Kindle.top.document).bind("orientationchange",
l);$(window).resize(l);$(k).bind("dragstart",function(){return!1});a.resolve({backdrop:e,image:k})});return a},KindleReaderAnnotationsPane=function(){function b(){K=J;J=Math.max(K-G,0);k();f("bottom")}function l(){J=K;K=Math.min(J+G,y.length);k();f(0)}function e(a){a.appendTo(d())}function k(){d().empty();T.remove();D.add(R).remove();for(var b=J;b<K;++b)j(y[b]).done(e);a();h()}function a(){var a=d();J>0&&D.unbind("click.goPrev").bind("click.goPrev",b).add(R).prependTo(a);K<y.length&&T.unbind("click.goNext").bind("click.goNext",
l).appendTo(a)}function j(b){function f(c){var d;jQuery.each(y,function(a,c){c.start===b.start&&c.end===b.end&&c.type===b.type&&(d=a)});c.remove();d!==-1&&(d<J||K<=d?y.splice(d,1):(y.splice(d,1),c=K-1,c<y.length&&y.length>0&&(T.remove(),D.add(R).remove(),j(y[c]).done(e),a())));y.length===0&&C.find("#"+x.EMPTY_MESSAGE).show();h()}d();var g=aa(),q={};q[g.EVENT_DELETE_CLICKED]=function(a){b.type===KindleReaderAnnotationManager.NOTE?(a.find("."+t.DELETE_ICON).hide(),a.find("."+t.EDIT_ICON).hide(),a.find("."+
t.GOTO_ICON).hide(),a.find("."+t.CANCEL_BTN).hide(),a.find("."+t.SAVE_BTN).hide(),a.find("."+t.CONFIRMATION).show(),a.find("."+t.YES_BTN).show(),a.find("."+t.NO_BTN).show()):(f(a),H(b))};q[g.EVENT_EDIT_CLICKED]=function(a){a.find("."+t.CONTEXT).hide();a.find("."+t.EDIT_ICON).hide();a.find("."+t.GOTO_ICON).hide();a.find("."+t.DELETE_ICON).hide();a.find("#"+x.EDIT_NOTE).show();a.find("."+t.CANCEL_BTN).show();a.find("."+t.SAVE_BTN).show();W().isiOS()||a.find("#"+x.EDIT_NOTE).focus();m()};q[g.EVENT_GOTO_CLICKED]=
function(){c();z(b)};q[g.EVENT_SAVE_CLICKED]=function(a){var c=a.find("#"+x.EDIT_NOTE).val().trim();if(c){var d=a.find("."+t.CONTEXT);d.empty();KindleAnnotationComponentFactory.setAnnotationContext(a,c);d=d[0];d.innerHTML=d.innerHTML.replace(/\n/g,"<br />");r(a)}else f(a);I(c,b)};q[g.EVENT_CANCEL_CLICKED]=function(a){a.find("#"+x.EDIT_NOTE).val(b.note);r(a)};q[g.EVENT_NO_CLICKED]=function(a){a.find("."+t.DELETE_ICON).show();a.find("."+t.EDIT_ICON).show();a.find("."+t.GOTO_ICON).show();a.find("."+
t.CONFIRMATION).hide();a.find("."+t.YES_BTN).hide();a.find("."+t.NO_BTN).hide()};q[g.EVENT_YES_CLICKED]=function(a){f(a);H(b)};return g.createAnnotationComponent(b,_locationConverter,function(a){var c=b;if(M){var e=KindleAnnotationComponentFactory.getAnnotationID(M.type,M.start),e=d().find("#"+e);KindleAnnotationComponentFactory.setAnnotationContext(e,M.note||M.context)}M=c;c=c.note||c.context;a.find("."+t.CONTEXT).text(c);a=a.find("."+t.CONTEXT)[0];a.innerHTML=a.innerHTML.replace(/\n/g,"<br />");
m()},q)}function n(a){a.stopPropagation()}function m(){if(W().isiOS())Q?Q.refresh():Q=new iScroll(x.SCROLL_WRAPPER,{vScrollbar:!1});else{var a=g();a.jScrollPane({showArrows:!0,verticalGutter:10});a.removeAttr("tabindex");$(".jspContainer").keypress(n).keyup(n).keydown(n)}}function h(){var a=g(),b=C.height(),c=C.width();W().isiOS()?C.find("#"+x.SCROLL_WRAPPER).height(b):(a.height(b-6),a.width(c));$(a).animate({opacity:1},100);m()}function g(){return C.find("#"+x.CONTAINER)}function d(){return W().isiOS()?
g():g().data("jsp").getContentPane()}function f(a){if(W().isiOS())a==="bottom"&&(a=-9999),Q.scrollTo(0,a);else{var b=g().data("jsp");a==="bottom"?b.scrollToBottom():b.scrollToY(0)}}function c(){q();KindleUXComponentManager.closeDialog(w)}function s(a){M=null;C=a;var b;$(window).resize(function(){clearTimeout(b);b=setTimeout(h,50)});W().isiOS()||(g().jScrollPane({showArrows:!0,verticalGutter:10}),$(".jspContainer").keypress(n).keyup(n).keydown(n));g().hover(function(){document.onmousewheel=function(){return!0}},
function(){document.onmousewheel=function(){return!1}})}function o(a){var b=y.length;if(y.length===0)return-1;for(var c=0;c<b;c++)if(y[c].end>=a||y[c].start>=a)break;return c}function r(a){a.find("."+t.CONTEXT).show();a.find("."+t.EDIT_ICON).show();a.find("."+t.GOTO_ICON).show();a.find("."+t.DELETE_ICON).show();a.find("#"+x.EDIT_NOTE).hide();a.find("."+t.CANCEL_BTN).hide();a.find("."+t.SAVE_BTN).hide();m()}function q(){y=M=null;K=J=0;d().empty();m()}var w="KindleReaderAnnotationsPane",v={CLOSE_BUTTON_STRING_ID:"k_common_close_button",
CLICK_FOR_PREVIOUS:"k_R_annotation_pane_previous",CLICK_FOR_NEXT:"k_R_annotation_pane_next"},x={PANE:"kindleReader_annotations_pane",HEADER:"kindleReader_annotations_pane_header",CONTAINER:"kindleReader_annotations_pane_container",SCROLL_WRAPPER:"kindleReader_annotations_pane_scrollWrapper",EMPTY_MESSAGE:"kindleReader_annotations_pane_notes_empty",EDIT_NOTE:"kindleReader_annotation_pane_edit_textArea"},t={SELECTED:"kindleReader_annotation_pane_notes_selected",CONTEXT:"kindleReader_annotation_pane_notes_context",
EDIT_ICON:"kindleReader_annotation_pane_notes_edit",GOTO_ICON:"kindleReader_annotation_pane_notes_goto",CANCEL_BTN:"kindleReader_annotation_pane_notes_cancel",SAVE_BTN:"kindleReader_annotation_pane_notes_save",YES_BTN:"kindleReader_annotation_pane_notes_yes",NO_BTN:"kindleReader_annotation_pane_notes_no",CONFIRMATION:"kindleReader_annotation_notes_delete_confirm",DELETE_ICON:"kindleReader_annotation_pane_notes_trashcan"},G=100,O=1/3,y=[],J,K,H,I,z,C,D,R,T,Q,M,aa=function(){return KindleAnnotationComponentFactory},
W=function(){return KindleHostDeviceDetector},ra={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(v.CLOSE_BUTTON_STRING_ID)]=c;var b={},d,b={autoOpen:!1,width:"90%",height:d,modal:!0,draggable:!1,resizable:!1,buttons:a};d=W().isiOS()?$("body",Kindle.top.document).height()-80:KindleHostDeviceDetector.isMetro()?window.outerHeight-250:window.outerHeight-150;b.height=d;return b},onInitializationDone:s,onDialogOpen:function(){KindleReaderMetrics.reportAnnotationsPaneOpened();
W().isiOS()&&($("#kindleReader_annotations_pane").height($("body",Kindle.top.document).height()-212),$("#kindleReader_annotations_pane_scrollWrapper").height($("body",Kindle.top.document).height()-212))}};return{open:function(){aa().initialize(function(){KindleUXComponentManager.openDialog(w,ra)})},scrollToPosition:function(a){if(y&&(a=Math.min(o(a),y.length-1),$("#"+x.PANE).offset(),C.parent().height(),a!==-1)){J<=a&&a<K||(K=Math.min(Math.max(a-Math.floor(O*G),0)+G,y.length),J=Math.max(0,K-G),k());
var b=y[a],a=0,b=KindleAnnotationComponentFactory.getAnnotationID(b.type,b.start),c=C.find("#"+b),a=a||0;W().isiOS()?Q.scrollToElement("#"+b,a):g().data("jsp").scrollToElement(c,!0,!!a)}},loadAnnotations:function(a,b,c,e,f){a.length===0?(q(),C.find("#"+x.EMPTY_MESSAGE).show()):(C.find("#"+x.EMPTY_MESSAGE).hide(),z=c,H=e,I=f,d(),y=a.slice(),_locationConverter=b,M=null,D=$("<div/>",{"class":"kindleReader_annotation_pane_notes_prev",text:ResourceBundle.getLocalizedString(v.CLICK_FOR_PREVIOUS)}),R=$("<div/>",
{"class":"kindleReader_annotation_pane_notes_divider_top"}),R=R.add($("<div/>",{"class":"kindleReader_annotation_pane_notes_divider_bottom"})),T=$("<div/>",{"class":"kindleReader_annotation_pane_notes_next",text:ResourceBundle.getLocalizedString(v.CLICK_FOR_NEXT)}),J=0,K=Math.min(G,y.length),k())},setUXComponentManager:function(){},setAnnotationComponentFactory:function(a){aa=a},setHostDeviceDetector:function(a){W=a},onInitializationDone:s}}(),KindleReaderBookmarkOverlay=function(){function b(b){e=
b;e.tap(function(){a()});l();k(b)}function l(){j?e.addClass("preBookmark").addClass("hasBookmark").fadeIn(250):e.removeClass("hasBookmark").removeClass("preBookmark")}var e,k,a,j;return{initialize:function(e,j){k=e;a=j;KindleUXComponentManager.initializeComponent("KindleReaderBookmarkOverlay",b)},setIsBookmarked:function(a){j=a;e&&l()},setImmersiveMode:function(a){a?e.addClass("immersiveBookmark"):e.removeClass("immersiveBookmark")},setVisible:function(a){e.css("visibility",a?"visible":"hidden")}}}(),
KindleReaderContextMenu=function(){function b(){KindleUXComponentManager.isVisible(l)&&($(".ui-widget-overlay").show(),KindleUXComponentManager.closeDialog(l),q=Date.now())}var l="KindleReaderContextMenu",e="kindle_menu_button",k="button_enabled",a={};a[KindlePopupMenu.ITEM_ENABLED]=k;a[KindlePopupMenu.ITEM_DISABLED]="button_disabled";a[KindlePopupMenu.ITEM_HIDDEN]="button_hidden";var j=["k_R_context_createHighlight","k_R_context_deleteHighlight","k_R_context_createNote","k_R_context_editNote"],n=
0,m=n++,h=n++,g=n++,d=n++,f=n++,c,s,o,r,q,w={onInitializationDone:function(a){function c(a){var d=ResourceBundle.getLocalizedString(j[a]),f=$("<div></div>").addClass(e).addClass(k).text(d);f.tap(function(){f.hasClass(k)&&(b(),o[a]())});return f}a=a.find("#kindle_menu_border");a.append(c(0));for(var d=1;d<j.length;d++)a.append('<div class="kindle_menu_separator"></div>'),a.append(c(d));KindleReaderContextMenuDictionary.initialize()},beforeDialogOpen:function(d){var g=d.find("#kindle_menu_border"),
h,j,m;g.find("."+e).each(function(b){var d=$(this);d.removeClass().addClass(e);d.addClass(a[c[b]])});g.children().each(function(){var a=$(this);a.hasClass(e)?a.hasClass("button_hidden")||(h||(h=a),j=a,m=null):a.hasClass("kindle_menu_separator")&&(!h||m?a.hide():m=a)});h.addClass("ui-corner-left");j.addClass("ui-corner-right");m&&m.hide();c[f]===KindlePopupMenu.ITEM_ENABLED&&$(window).width()!==320&&(KindleReaderContextMenuDictionary.updateMenuWithDefinition(d,r),s[0]-=180);d.dialog("option","position",
s);d.parent().css("bottom","auto");$(window).bind("resize",b)},getDialogSettings:function(){return{autoOpen:!1,draggable:!1,modal:!0,resizable:!1,minHeight:0,width:"auto",dialogClass:"kindle_menu",k4w_transparent_modal_overlay:!0}},onDialogClose:function(){KindleReaderContextMenuDictionary.removeDefinition();$(window).unbind("resize",b)},onDialogOpen:function(a){var b=c[f]===KindlePopupMenu.ITEM_ENABLED,d=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()?60:30,e=a.parent();if(b&&
s[1]>320||!b&&$(window).height()-s[1]<100)e.css("top","auto"),e.css("bottom",$(window).height()-s[1]+d);s[0]+e.width()>$(window).width()&&e.css("left",$(window).width()-e.width()-25);a.css("height","auto")}};return{CREATE_HIGHLIGHT:m,CREATE_NOTE:g,EDIT_NOTE:d,DELETE_HIGHLIGHT:h,DEFINITION:f,show:function(a,b,d,e){c=a;s=b;o=d;r=e;KindleUXComponentManager.openDialog(l,w);$(".ui-widget-overlay").hide()},hide:b,wasVisible:function(){return Date.now()-q<500}}}(),KindleReaderContextMenuDictionary=function(){function b(a){if(a.getPronunciationUrls()){var b,
c;s===void 0&&(s=document.createElement("audio").canPlayType("audio/mpeg")!=="");c=s?a.getPronunciationUrls().mp3:a.getPronunciationUrls().wav;d.find("#dictionary_audio").tap(function(){b=b||new Audio(c);KindleHostDeviceDetector.isSafari()&&!KindleHostDeviceDetector.isiPad()&&b.load();b.play();f.emit("Reader::Dictionary::SoundPlayed")});d.find(".view_full_link").click(function(){f.emit("Reader::Dictionary::ViewFull")})}}function l(b){if(!d.is(":hidden")){var c=b.getPronunciationUrls();a();d.addClass("dictionary_enabled");
d.prepend(KindleUXComponentManager.renderTemplate(m,{entry:b.entry,pronunciation:n(b),audio_url_mp3:c?b.getPronunciationUrls().mp3:"",audio_url_wav:c?b.getPronunciationUrls().wav:"",definition:j(b),view_full:ResourceBundle.getLocalizedString("k_R_dictionary_view_full"),view_full_url:"http://dictionary.reference.com/browse/"+b.entry}));c||d.find("#dictionary_audio").hide();setTimeout(function(){d.find(".dictionary").addClass("expanded")},50)}}function e(){var a=$("#KindleReaderSimpleSpinner").text();
d.find(".dictionary_loading").append(a)}function k(b){var e="";a();d.addClass("dictionary_enabled");switch(b){case IDictionary.NOT_FOUND:e=ResourceBundle.getLocalizedString("k_R_dictionary_not_found");c.emit("Reader::Dictionary::WordNotFound");break;case IDictionary.OFFLINE:e=ResourceBundle.getLocalizedString("k_R_dictionary_offline");c.emit("Reader::Dictionary::Offline");break;case IDictionary.LOOKUP_FAILED:e=ResourceBundle.getLocalizedString("k_R_dictionary_not_available");c.emit("Reader::Dictionary::LookupFailed");
break;default:e=ResourceBundle.getLocalizedString("k_R_dictionary_not_available"),c.emit("Reader::Dictionary::LookupFailed")}d.prepend(g.replace("{{error}}",e))}function a(){d&&d.hasClass("dictionary_enabled")&&(d.find(".dictionary").remove(),d.find(".dictionary_loading").remove(),d.find(".dictionary_error").remove(),d.removeClass("dictionary_enabled"))}function j(a,b){for(var c=0,d=[],e=a.getDefinitions(),b=b||h,f=0;f<e.length&&c<=b;f++){var g=e[f].definitions;e[f].partOfSpeech&&d.push('<span class="word_type">'+
e[f].partOfSpeech+"</span>");d.push('<ol class="definitions_list">');for(var j=0;j<g.length&&c<=b;j++)d.push("<li>"+g[j]+"</li>"),c++;d.push("</ol>")}return d.join("").replace(/(<[\/]?a[^>]*>)/ig,"")}function n(a){return(a=a.getPronunciation())?"["+a+"]":""}var m="KindleReaderContextMenuDictionary",h=5,g='<div class="dictionary_error">{{error}}</div>',d,f,c,s;return{updateMenuWithDefinition:function(g,h){c=f.createTimer();d=g;h.start===h.end&&(d.prepend('<div class="dictionary_loading"></div>'),d.addClass("dictionary_enabled"),
$.when(KindleReaderAnnotationManager.getContext(h.start,h.end),dictionary.getDictionary()).done(function(d,f){d?(e(),f.lookup(d).then(function(a){l(a);b(a);c.emit("Reader::Dictionary::WordFound")},k)):a()}))},removeDefinition:a,initialize:function(){KindleUXComponentManager.hasTemplate(m)||KindleUXComponentManager.initializeTemplate(m,function(){});f=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER])}}}(),KindleReaderEditNoteDialog=function(){function b(){return h.find("#kindleReader_dialog_editNote_title")}
function l(){return h.find("#kindleReader_dialog_editNote_noteText")}function e(){o=!0;n();d&&d(g)}function k(){o=!0;n();f&&f()}function a(){o=!0;n();c&&c()}function j(){l().val(g);var a;a=ResourceBundle.getLocalizedString("k_R_dialog_editNote_delete");a=h.dialog("widget").find('.ui-button:contains("'+a+'")');f?(b().text(ResourceBundle.getLocalizedString("k_R_dialog_editNote_title_edit")),a.show()):(b().text(ResourceBundle.getLocalizedString("k_R_dialog_editNote_title_create")),a.hide());KindleHostDeviceDetector.isiOS()&&
l().attr("tabindex","-1");h.find("#kindleReader_dialog_editNote_noteText").off("keydown",r);h.find("#kindleReader_dialog_editNote_noteText").on("keydown",r)}function n(){KindleUXComponentManager.closeDialog(m)}var m="KindleReaderEditNoteDialog",h,g,d,f,c,s,o=!1,r=function(b){b.which===27&&a()},q={getDialogSettings:function(){var b={};b[ResourceBundle.getLocalizedString("k_R_dialog_editNote_cancel")]=a;b[ResourceBundle.getLocalizedString("k_R_dialog_editNote_delete")]=k;b[ResourceBundle.getLocalizedString("k_R_dialog_editNote_save")]=
e;s=KindleHostDeviceDetector.isiOS()?"70%":"40%";return{width:s,autoOpen:!1,buttons:b,draggable:!1,modal:!0,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:j,onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||l().focus()},onDialogClose:function(){!o&&c&&c();g=$.trim(l().val());if(KindleHostDeviceDetector.isMetro()){var a=l().parent();l().detach().appendTo(a)}},onInitializationDone:function(a){h=a;KindleTouchEventsToggler.isRequired()&&(l().focus(function(){KindleTouchEventsToggler.off()}),
l().blur(function(){KindleTouchEventsToggler.on()}));j()}};return{open:function(a,b,e,h){g=a||"";d=b;f=e;c=h;o=!1;KindleUXComponentManager.openDialog(m,q,{maxNoteChars:Kindle.opt.maxNoteChars})},close:n,isVisible:function(){return KindleUXComponentManager.isVisible(m)}}}(),KindleReaderGoToDialog=function(){function b(a){var b;/(^[0]*\d*$)/.exec(a)&&(b=parseInt(a,10));isNaN(b)&&(b=void 0);return b}var l={DIALOG_TITLE_ID:"k_R_goto_menu_goto_location_title",DIALOG_TEXT_ID:"k_R_goto_menu_goto_message",
DIALOG_LOCATION_TEXT_ID:"k_R_goto_menu_goto_location",DIALOG_OK_BTN_ID:"k_R_goto_menu_goto_button",DIALOG_CANCEL_BTN_ID:"k_common_cancel_button"},e={TITLE_LABEL_ID:"kindleReader_dialog_gotoTitle",TEXT_LABEL_ID:"kindleReader_dialog_gotoLabel",LOCATION_LABEL_ID:"kindleReader_dialog_gotoLocation",INPUT_FIELD_ID:"kindleReader_dialog_gotoField",OK_BUTTON_ID:"kindleReader_dialog_gotoGoButton",CANCEL_BUTTON_ID:"kindleReader_dialog_gotoCancelButton"},k,a,j,n,m,h=function(){var c=b(m.find("#"+e.INPUT_FIELD_ID).val());
c===void 0||c<a.minLocation||c>a.maxLocation?(m.find("#"+e.INPUT_FIELD_ID).css("background-color","#ff0000"),m.find("#"+e.INPUT_FIELD_ID).val(""),KindleHostDeviceDetector.isiOS()||m.find("#"+e.INPUT_FIELD_ID).focus(),setTimeout(function(){$("#kindleReader_dialog_gotoField").css("background-color","#ffffff")},2E3)):(j=!0,n=c,KindleUXComponentManager.closeDialog("KindleReaderGoToDialog"))},g=function(){KindleUXComponentManager.closeDialog("KindleReaderGoToDialog")},d=function(a){a.which===13?(m.focus(),
h()):a.which===27&&g()},f={onInitializationDone:function(a){m=a;KindleTouchEventsToggler.isRequired()&&(m.find("#"+e.INPUT_FIELD_ID).focus(function(){KindleTouchEventsToggler.off()}),m.find("#"+e.INPUT_FIELD_ID).blur(function(){KindleTouchEventsToggler.on()}))},getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(l.DIALOG_CANCEL_BTN_ID)]=g;a[ResourceBundle.getLocalizedString(l.DIALOG_OK_BTN_ID)]=h;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},
beforeDialogOpen:function(){var b=ResourceBundle.getLocalizedString(l.DIALOG_TITLE_ID);m.find("#"+e.TITLE_LABEL_ID).empty().append(b);b=ResourceBundle.getLocalizedString(l.DIALOG_TEXT_ID);m.find("#"+e.TEXT_LABEL_ID).empty().append(b);b=ResourceBundle.getLocalizedString(l.DIALOG_LOCATION_TEXT_ID,{firstLocation:a.minLocation,lastLocation:a.maxLocation});m.find("#"+e.LOCATION_LABEL_ID).empty().append(b);m.find("#"+e.INPUT_FIELD_ID).val("");m.find("#"+e.INPUT_FIELD_ID).bind("keyup",d);KindleHostDeviceDetector.isiOS()&&
m.find("#"+e.INPUT_FIELD_ID).attr("tabindex","-1")},onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||m.find("#"+e.INPUT_FIELD_ID).focus()},onDialogClose:function(){var a=m.find("#"+e.INPUT_FIELD_ID);a.blur();a.unbind("keyup",d);k(j,n);if(KindleHostDeviceDetector.isMetro()){var b=a.parent();a.detach().appendTo(b)}}};return{open:function(b,d){k=d;a=b;j=!1;n=-1;KindleUXComponentManager.openDialog("KindleReaderGoToDialog",f)},parseLocationString:b}}(),KindleReaderGoToMenu=function(){function b(){h();
var a={minLocation:1,maxLocation:s.getMaxUserLocation()};KindleReaderGoToDialog.open(a,l)}function l(a,b){a&&s.gotoUserLocation(b)}function e(){s.gotoPosition(c.cover);h()}function k(){s.gotoPosition(c.toc);h()}function a(){s.gotoPosition(c.srp);h()}function j(){s.openBookExtras();h()}function n(){function c(a,b,d){return{elementId:a,content:b,clickHandler:d}}var g={};g.BUTTON_COVER=c(f.ITEM_COVER,ResourceBundle.getLocalizedString(d.GOTO_COVER_ID),e);g.BUTTON_TOC=c(f.ITEM_TOC,ResourceBundle.getLocalizedString(d.GOTO_TOC_ID),
k);g.BUTTON_BEGINNING=c(f.ITEM_BEGINNING,ResourceBundle.getLocalizedString(d.GOTO_SRP_ID),a);g.BUTTON_LOCATION=c(f.ITEM_LOCATION,ResourceBundle.getLocalizedString(d.GOTO_LOCATION_ID),b);if(!KindleHostDeviceDetector.isIE())g.BUTTON_BEX=c(f.ITEM_BEX,ResourceBundle.getLocalizedString(d.BEX_ID),j);return g}function m(a){var b=KindlePopupMenu.ITEM_ENABLED,d=KindlePopupMenu.ITEM_DISABLED;o=[b,d,d,b,KindlePopupMenu.ITEM_HIDDEN];c.cover=0;if(a!==void 0){if(a.cover!==void 0&&a.cover>=0)c.cover=a.cover;if(a.toc!==
void 0&&a.toc>=0)c.toc=a.toc,o[1]=b;c.srp=a.srl!==void 0&&a.srl>=0?a.srl:c.cover;o[2]=b}KindleUXComponentManager.updateMenu(g,o)}function h(){KindleUXComponentManager.hideMenu(g)}var g="KindleReaderGotoMenu",d={GOTO_COVER_ID:"k_R_cover_title",GOTO_TOC_ID:"k_R_table_of_contents_title",GOTO_SRP_ID:"k_R_beginning_title",GOTO_LOCATION_ID:"k_R_goto_location_title",BEX_ID:"k_R_book_extras_title"},f={ITEM_COVER:"kindleReader_goToMenuItem_goToCover",ITEM_TOC:"kindleReader_goToMenuItem_goToTOC",ITEM_BEGINNING:"kindleReader_goToMenuItem_goToBeginning",
ITEM_LOCATION:"kindleReader_goToMenuItem_goToLocation",ITEM_BEX:"kindleReader_goToMenuItem_bex"},c={},s,o;return{show:function(){o&&KindleUXComponentManager.showMenu(g,"kindleReader_button_goto",n(),"down",o)},hide:h,bookIsReady:function(a,b){s=a;b.getBookPositions().done(m)},disable:function(){o=void 0},updateGoToMenu:function(a){if(o){for(var b in a)o[b]=a[b];KindleUXComponentManager.updateMenu(g,o)}},extractPositionsFromMetadata:m,interestingPositions:c}}(),KindleReaderHeaderBar=function(){function b(b){return function(){if(a[b]&&
m[b])m[b]()}}function l(d){h=d;KindleHostDeviceDetector.isiOS()&&(d.find("#"+k.BUTTON_LOGO).remove(),d.find("#"+k.BUTTON_IMMERSIVE).remove());KindleHostDeviceDetector.isMetro()||d.find("#"+k.BUTTON_PIN_TO_START_METRO).remove();var f,c;for(c in k)if(f=d.find("#"+k[c]),f.tap(b(k[c])),a[k[c]]||f.addClass(j),KindleHostDeviceDetector.isMetro()){var m=f.attr("btnLbl");m&&typeof m==="string"&&f.text(m)}g&&(h.find("#"+k.BUTTON_CLOSE).html(g),e(k.BUTTON_CLOSE,!0));n(d)}function e(b,e){a[b]=e;var c;h&&(c=h.find("#"+
b),e?c.removeClass(j):c.addClass(j))}var k={BUTTON_LOGO:"kindleReader_kindleLogo",BUTTON_CLOSE:"kindleReader_button_close",BUTTON_GOTO:"kindleReader_button_goto",BUTTON_CONTROL_PANEL:"kindleReader_button_controlPanel",BUTTON_BOOKMARK:"kindleReader_bookmark",BUTTON_SYNC:"kindleReader_button_sync",BUTTON_NOTE:"kindleReader_button_note",BUTTON_BACK:"kindleReader_button_back",BUTTON_IMMERSIVE:"kindleReader_button_enter_immersive",BUTTON_PIN_TO_START_METRO:"kindleReader_button_pin_start_metro",BUTTON_COLUMN_MODE:"kindleReader_button_column_mode"},
a={},j="disabled",n,m,h,g;return $.extend({},k,{initialize:function(b,e){n=b;m=e;a[k.BUTTON_IMMERSIVE]=!0;KindleUXComponentManager.initializeComponent("KindleReaderHeaderBar",l)},setButtonEnabled:e,setCloseButtonEnabled:function(a){h?(h.find("#"+k.BUTTON_CLOSE).html(a).attr("title",a),e(k.BUTTON_CLOSE,!0)):g=a},clickElementWithID:function(a){if(m[a])m[a]()}})}(),KindleReaderImmersiveModeExit=function(){function b(a){l=a;l.tap(function(){k()});e(a)}var l,e,k;return{initialize:function(a,j){e=a;k=j;
KindleUXComponentManager.initializeComponent("KindleReaderImmersiveModeExit",b)}}}(),KindleReaderLocationBar=function(){function b(a){var b=t.find("#"+q.PROGRESS_BAR_ID),c=t.find("#"+q.POPUP_LABEL_ID),d=c.outerWidth(),e=$(window).width(),f=(e-b.width())/2,a=(a-G)/(O-G)*b.width(),a=a<0?0:a;a+=f;disX=d/2+5+f>a?5+f:e-f-a<d/2+5?e-f-d-5:a-d/2;c.css("left",disX+"px")}function l(c,d){J=!0;a(d.value);b(d.value)}function e(a,b){J=!1;O>0&&x(b.value)}function k(){t&&O>0&&G>=0&&t.find("#"+q.PROGRESS_BAR_ID).slider("option",
"min",G).slider("option","max",O).slider("option","disabled",!1)}function a(a){var b=ResourceBundle.getLocalizedString("k_R_slider_location_popup",{location:a,totalLocations:O});t.find("#"+q.POPUP_LABEL_ID).text(b);a=ResourceBundle.getLocalizedString("k_R_slider_percentage",{percent:Math.round(a/O*100)})+" \u00b7 "+ResourceBundle.getLocalizedString("k_R_slider_location",{location:a,totalLocations:O});z.text(a)}function j(){if(t&&y>=0){var b=y;t.find("#"+q.PROGRESS_BAR_ID).slider("option","value",
b);a(y)}}function n(a){J||a<0?clearTimeout(H):H=setTimeout(function(){c()},a)}function m(a){J||a<0?clearTimeout(K):K=setTimeout(function(){c()},a)}function h(){I?t.find("#"+q.PROGRESS_BAR_ID).addClass("black"):t.find("#"+q.PROGRESS_BAR_ID).removeClass("black")}function g(a){var a=a.originalEvent,b=a.changedTouches[0],c="";switch(a.type){case "touchstart":c="mousedown";break;case "touchmove":c="mousemove";break;case "touchend":c="mouseup";break;default:return}var d=document.createEvent("MouseEvent");
d.initMouseEvent(c,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);b.target.dispatchEvent(d);a.preventDefault()}function d(a){t=a;z=t.find("#"+q.MESSAGE_LABEL_ID);C=t.find("#"+q.DOWNLOAD_PROGRESS_ID);D=t.find("#"+q.DOWNLOAD_PROGRESS_MESSAGE_ID);C.prepend($("#KindleReaderSimpleSpinner").text());R=t.find(".spinner");R.attr("id",q.DOWNLOAD_PROGRESS_SPINNER_ID);var b=a.find("#"+q.PROGRESS_BAR_ID);b.slider({range:"min",value:1,max:100,min:1,step:1,animate:!0,disabled:!0,slide:l,
stop:e});b.find("."+w.RANGE).addClass("ui-corner-left");b.find("."+w.HANDLE).removeAttr("href");b.find("."+w.HANDLE).attr("id",q.PROGRESS_BAR_HANDLE_ID);s();h();k();j();KindleHostDeviceDetector.isiPad()&&(t.bind("touchstart",g),t.bind("touchmove",g),t.bind("touchend",g),t.bind("touchmove",f),t.bind("touchend",c),t.bind("touchcancel",c));v(a)}function f(){var a=t.find("#"+q.PROGRESS_BAR_ID),c=t.find("#"+q.POPUP_ID);O>0&&(c.show(),b(a.slider("option","value")))}function c(){t&&t.find("#"+q.POPUP_ID).hide()}
function s(){function a(){O>0&&(m(-1),M&&r())}function b(){J&&t.mouseup();m(2E3)}!KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isMetro()&&(t.find("#"+q.PROGRESS_BAR_ID).find("."+w.HANDLE).hover(function(){O>0&&(n(-1),f())},function(){n(500)}),t.hover(a,b),m(2E3))}function o(a){function b(){t.removeClass("downloading").addClass("download_completed")}R.removeClass("spinner");a>0&&(a=ResourceBundle.getLocalizedString("k_R_downloaded",{percent:100}),C.addClass("finished"),D.text(a));(KindleHostDeviceDetector.isiOS()?
!aa:D.is(":visible"))?b():M=b}function r(){setTimeout(function(){M&&(M(),M=null)},1E3)}var q={PROGRESS_BAR_ID:"kindleReader_progressbar_div",PROGRESS_BAR_HANDLE_ID:"kindleReader_progressbar_handle",MESSAGE_LABEL_ID:"kindleReader_footer_message",POPUP_ID:"kindleReader_locationPopup_div",POPUP_LABEL_ID:"kindleReader_locationPopup_labelDiv",DOWNLOAD_PROGRESS_ID:"kindleReader_download_progress",DOWNLOAD_PROGRESS_MESSAGE_ID:"kindleReader_download_progress_message",DOWNLOAD_PROGRESS_SPINNER_ID:"kindleReader_download_spinner"},
w={HANDLE:"ui-slider-handle",RANGE:"ui-slider-range"},v,x,t,G=-1,O=-1,y=-1,J=!1,K,H,I,z,C,D,R,T={IN_PROGRESS:"in_progress",COMPLETED:"completed",DISK_ERROR:"disk_error",NETWORK_ERROR:"network_error"},Q=-1,M,aa=!1;return{DOWNLOAD_COMPLETED:T.COMPLETED,DOWNLOAD_IN_PROGRESS:T.IN_PROGRESS,DOWNLOAD_DISK_ERROR:T.DISK_ERROR,DOWNLOAD_NETWORK_ERROR:T.NETWORK_ERROR,initialize:function(a,b){v=a;x=b;KindleUXComponentManager.initializeComponent("KindleReaderLocationBar",d)},setMinMaxLocation:function(a,b){O=b;
G=a;k()},updateLocation:function(a){y=a;j()},setLocationBarBlack:function(a){I=a;t&&h()},hidePopup:c,updateDownloadProgress:function(a,b){z.is(":visible")||(C.hide(),R.removeClass("spinner"));switch(a){case T.COMPLETED:o(Q);break;case T.IN_PROGRESS:Q=b;if(t&&b>=0&&b<=100){var c=ResourceBundle.getLocalizedString("k_R_downloading",{percent:b});t.addClass("downloading");D.text(c);R.addClass("spinner")}break;case T.DISK_ERROR:case T.NETWORK_ERROR:c=Q>0?Q+"% ":"",t.removeClass("downloading").addClass("download_error"),
c=a===T.DISK_ERROR?ResourceBundle.getLocalizedString("k_R_download_disk_error",{percent:c}):ResourceBundle.getLocalizedString("k_R_download_network_error",{percent:c}),D.text(c)}},setImmersiveMode:function(a){aa=a;!aa&&M&&r()}}}(),KindleReaderPageArrow=function(){function b(a){h=a;h.find("#"+k.LEFT_AREA_ID).click(j);h.find("#"+k.RIGHT_AREA_ID).click(n);m(h);l();e()}function l(){g?h.find("#"+k.LEFT_AREA_ID).addClass("pageArrow"):h.find("#"+k.LEFT_AREA_ID).removeClass("pageArrow");d?h.find("#"+k.RIGHT_AREA_ID).addClass("pageArrow"):
h.find("#"+k.RIGHT_AREA_ID).removeClass("pageArrow")}function e(){switch(f){case KINDLE_READER_SETTINGS_COLOR_MODE.WHITE:h.find("."+a).removeClass("black");h.find("."+a).removeClass("sepia");break;case KINDLE_READER_SETTINGS_COLOR_MODE.BLACK:h.find("."+a).removeClass("sepia");h.find("."+a).addClass("black");break;case KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA:h.find("."+a).removeClass("black"),h.find("."+a).addClass("sepia")}}var k={LEFT_AREA_ID:"kindleReader_pageTurnAreaLeft",RIGHT_AREA_ID:"kindleReader_pageTurnAreaRight"},
a="kindleReader_pageTurnArea",j,n,m,h,g,d,f;return{initialize:function(a,d,e){m=a;j=d;n=e;KindleUXComponentManager.initializeComponent("KindleReaderPageArrow",b)},setArrowEnabled:function(a,b){g=a;d=b;h&&l()},setArrowColor:function(a){f=a;h&&e()}}}(),KindleReaderSampleEnd=function(){var b={TITLE_LABEL_STRING_ID:"k_endOfSample_Title",TEXT_LABEL_STRING_ID:"k_endOfSample_Text",BUY_BUTTON_STRING_ID:"k_endOfSample_buy_button",CANCEL_BUTTON_STRING_ID:"k_endOfSample_cancel_button"},l={TITLE_LABEL_ID:"kindle_sample_end_title_text",
TEXT_LABEL_ID:"kindle_sample_end_message_text"},e,k,a=function(){k="buy";KindleUXComponentManager.closeDialog("KindleReaderSampleEnd")},j=function(){k="cancel";KindleUXComponentManager.closeDialog("KindleReaderSampleEnd")},n={getDialogSettings:function(){var e={};e[ResourceBundle.getLocalizedString(b.CANCEL_BUTTON_STRING_ID)]=j;e[ResourceBundle.getLocalizedString(b.BUY_BUTTON_STRING_ID)]=a;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:e,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(a){var e=
ResourceBundle.getLocalizedString(b.TITLE_LABEL_STRING_ID),g=ResourceBundle.getLocalizedString(b.TEXT_LABEL_STRING_ID);a.find("#"+l.TITLE_LABEL_ID).empty().append(e);a.find("#"+l.TEXT_LABEL_ID).empty().append(g)},onDialogClose:function(){e(k)}};return{open:function(a){e=a;k=!1;KindleUXComponentManager.openDialog("KindleReaderSampleEnd",n)}}}(),KindleReaderSettingsDialog=function(){function b(){var a=r.find(v.FONT_SIZE_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_FONT_SIZE[a].size;
c.getFontSize()!==b&&(c.setFontSize(b),d(),l(),s=!0)}},e;for(e in KINDLE_READER_SETTINGS_FONT_SIZE)a.find(KINDLE_READER_SETTINGS_FONT_SIZE[e].id).tap(b(e))}function l(){var a=c.getFontSize(),b;for(b in KINDLE_READER_SETTINGS_FONT_SIZE)a===KINDLE_READER_SETTINGS_FONT_SIZE[b].size?r.find(KINDLE_READER_SETTINGS_FONT_SIZE[b].id+"Selected").css("visibility","visible"):r.find(KINDLE_READER_SETTINGS_FONT_SIZE[b].id+"Selected").css("visibility","hidden")}function e(){var a=r.find(v.MARGIN_PANEL_ID).buttonset(),
b=function(a){return function(){var b=KINDLE_READER_SETTINGS_MARGIN[a].size;c.getMargin()!==b&&(c.setMargin(b),k(),s=!0)}},d;for(d in KINDLE_READER_SETTINGS_MARGIN)a.find(KINDLE_READER_SETTINGS_MARGIN[d].id).tap(b(d))}function k(){var a=c.getMargin(),b;for(b in KINDLE_READER_SETTINGS_MARGIN)a===KINDLE_READER_SETTINGS_MARGIN[b].size?r.find(KINDLE_READER_SETTINGS_MARGIN[b].id+"Selected").css("visibility","visible"):r.find(KINDLE_READER_SETTINGS_MARGIN[b].id+"Selected").css("visibility","hidden")}function a(){var a=
r.find(v.COLUMN_MODE_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_COLUMN_MODE[a].persistedValue;c.getShowColumns()!==b&&(c.setShowColumns(b),j(),s=!0)}},d;for(d in KINDLE_READER_SETTINGS_COLUMN_MODE)q.columns&&q.columns!==1&&a.find(KINDLE_READER_SETTINGS_COLUMN_MODE[d].id).tap(b(d))}function j(){var a=c.getShowColumns(),b;for(b in KINDLE_READER_SETTINGS_COLUMN_MODE)a===KINDLE_READER_SETTINGS_COLUMN_MODE[b].persistedValue?r.find(KINDLE_READER_SETTINGS_COLUMN_MODE[b].id).addClass("on"):
r.find(KINDLE_READER_SETTINGS_COLUMN_MODE[b].id).removeClass("on")}function n(){var a=r.find(v.COLOR_MODE_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_COLOR_MODE[a];c.getColorMode()!==b&&(c.setColorMode(b),d(),m(),s=!0)}},e;for(e in KINDLE_READER_SETTINGS_COLOR_MODE)a.find(KINDLE_READER_SETTINGS_COLOR_MODE[e].id).tap(b(e))}function m(){var a=c.getColorMode(),b;for(b in KINDLE_READER_SETTINGS_COLOR_MODE)a===KINDLE_READER_SETTINGS_COLOR_MODE[b]?r.find(KINDLE_READER_SETTINGS_COLOR_MODE[b].id+
"Selected").css("visibility","visible"):r.find(KINDLE_READER_SETTINGS_COLOR_MODE[b].id+"Selected").css("visibility","hidden");r.find(":not("+a.id+")").removeClass("selected");r.find(a.id).addClass("selected")}function h(){o=!0;KindleUXComponentManager.closeDialog(f)}function g(){KindleUXComponentManager.closeDialog(f)}function d(){var a=r.find(v.PREVIEW_ID);c.getColorMode()===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK?a.css({"box-shadow":"inset 0 0 10px #444444","-moz-box-shadow":"inset 0 0 10px #444444",
"-webkit-box-shadow":"inset 0 0 10px #444444","border-color":"#AAAAAA"}):a.css({"box-shadow":"inset 0 0 10px #666666","-moz-box-shadow":"inset 0 0 10px #666666","-webkit-box-shadow":"inset 0 0 10px #666666","border-color":"#000000"});a.css({color:c.getFGColor(),"font-size":c.getFontSize()+"px",backgroundColor:c.getBGColor()})}var f="KindleReaderSettingsDialog",c,s,o,r,q,w={SAMPLE_STRING_ID:"k_R_settings_sampleText",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button",APPLY_BUTTON_STRING_ID:"k_R_settings_apply_button",
COLUMN_MODE_ON_BUTTON_STRING_ID:"k_R_settings_column_on_button",COLUMN_MODE_OFF_BUTTON_STRING_ID:"k_R_settings_column_off_button"},v={PREVIEW_ID:"#kindleReader_controlPanel_preview",FONT_SIZE_PANEL_ID:"#kindleReader_controlPanel_fontSize",COLOR_MODE_PANEL_ID:"#kindleReader_controlPanel_colorMode",MARGIN_PANEL_ID:"#kindleReader_controlPanel_margin",COLUMN_MODE_PANEL_ID:"#kindleReader_controlPanel_multiColumn",COLUMN_MODE_ON_ID:"#kindleReader_controlPanel_columnButton_on",COLUMN_MODE_OFF_ID:"#kindleReader_controlPanel_columnButton_off",
COLUMN_MODE_MSG_ID:"#kindleReader_controlPanel_optionButtons_msg"},x,t={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(w.CANCEL_BUTTON_STRING_ID)]=g;a[ResourceBundle.getLocalizedString(w.APPLY_BUTTON_STRING_ID)]=h;return{autoOpen:!1,width:KindleHostDeviceDetector.isIE()?400:380,modal:!0,draggable:!1,resizable:!1,buttons:a,dialogClass:"settings_dialog"}},onInitializationDone:function(c){r=c;r.find(v.PREVIEW_ID).text(ResourceBundle.getLocalizedString(w.SAMPLE_STRING_ID));
b();e();n();a()},beforeDialogOpen:function(a){r=a;d();l();k();m();j()},onDialogClose:function(){o&&s&&x(c)}};return{open:function(a,b,d){!/iPod/.test(navigator.userAgent)&&!/iPhone/.test(navigator.userAgent)&&(c=new KindleReaderSettings,c.copy(a),s=!1,x=d,o=s=!1,q=b,KindleUXComponentManager.openDialog(f,t),KindleDeviceCapabilities.multiColumnMode()?b.columns&&b.columns!==1?$(v.COLUMN_MODE_MSG_ID).removeClass("show"):($(v.COLUMN_MODE_MSG_ID).addClass("show"),$(v.COLUMN_MODE_ON_ID).addClass("on"),$(v.COLUMN_MODE_ON_ID).unbind("tap"),
$(v.COLUMN_MODE_OFF_ID).toggle(!1),$(v.COLUMN_MODE_OFF_ID).removeClass("on")):$(v.COLUMN_MODE_PANEL_ID).hide())}}}(),KindleReaderSyncPositionDialog=function(){var b={TEXT_LABEL_STRING_ID:"k_R_syncPosition_labelText",TEXT_LABEL_STRING_ID_NO_DEVICE_NAME:"k_R_syncPosition_noDeviceName_labelText",CANCEL_BUTTON_STRING_ID:"k_R_syncPosition_cancelText",SYNC_BUTTON_STRING_ID:"k_R_syncPosition_sync",RESET_BUTTON_STRING_ID:"k_R_syncPosition_reset"},l={TEXT_LABEL_ID:"kindleReader_dialog_syncPosition_label",
CANCEL_BUTTON_ID:"kindleReader_syncPosition_cancel",RESET_BUTTON_ID:"kindleReader_dialog_syncPosition_reset_btn",SYNC_BUTTON_ID:"kindleReader_dialog_syncPosition_sync_btn"},e={CANCEL:0,SYNC:1,RESET:2},k,a,j,n,m=function(){j=e.SYNC;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},h=function(){j=e.RESET;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},g=function(){j=e.CANCEL;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},d={getDialogSettings:function(){var a=
{};a[ResourceBundle.getLocalizedString(b.CANCEL_BUTTON_STRING_ID)]=g;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a}},beforeDialogOpen:function(d){var c;if(a.fprDevice&&a.fprDevice!=="null"){var e=new Date(a.fprDateTime);c=ResourceBundle.getLocalizedTime(e);e=ResourceBundle.getLocalizedDate(e);c=ResourceBundle.getLocalizedString(b.TEXT_LABEL_STRING_ID,{currentLocation:a.currentLocation,location:a.fprLocation,deviceName:a.fprDevice,time:c,date:e})}else c=ResourceBundle.getLocalizedString(b.TEXT_LABEL_STRING_ID_NO_DEVICE_NAME,
{currentLocation:a.currentLocation,location:a.fprLocation});d.find("#"+l.TEXT_LABEL_ID).empty().append(c)},onDialogClose:function(){k(j)},onInitializationDone:function(a){n=a;n.find("#"+l.SYNC_BUTTON_ID).click(m);n.find("#"+l.RESET_BUTTON_ID).click(h)}};return{open:function(b,c){k=c;j=e.CANCEL;a=b;KindleUXComponentManager.openDialog("KindleReaderSyncPositionDialog",d)},USER_RESPONSES:e}}(),KindleReaderTutorial=function(b){function l(a){function b(){a.image.fadeOut("slow",function(){a.backdrop.fadeOut("slow",
function(){a.backdrop.remove()})})}e.increment();a.image.click(b);a.backdrop.click(b);$(document).keyup(function(a){a.keyCode===13&&b();a.keyCode===27&&b()});a.backdrop.hide().appendTo(k);a.image.hide();a.backdrop.fadeIn("slow",function(){a.image.fadeIn("slow")})}var e,k=$("#kindleReader_book_container");e=LocalStorageCounter("kcrNotifications.zTutorial."+b);if(e.getValue()===0){var a,j=KindleHostDeviceDetector.isTouchDevice();if(b===Kindle.BookInfo.PublisherMetadata.COMIC)a=j?"images/uncached/tutorial_zoomables_comics_tap.png":
"images/uncached/tutorial_zoomables_comics.png";else if(b===Kindle.BookInfo.PublisherMetadata.CHILDREN)a=j?"images/uncached/tutorial_zoomables_childrens_tap.png":"images/uncached/tutorial_zoomables_childrens.png";else return;KindleHostDeviceDetector.isNetworkAvailable().done(function(){KindleImageViewer({imageSource:a,parent:k}).done(l)})}},KindleErrorMap=function(){var b,l;return{getErrorText:function(e){if(!b)b={},b[Kindle.ERROR.OUT_OF_SPACE]={title:"k_L_saveBookOutOfSpace_Title",text:"k_L_saveBookOutOfSpace_Text",
textParams:{linkStart:"<a href='http://www.amazon.com/gp/help/customer/display.html/ref=kcr_help_menu?nodeId=200732370#fxoffline' target='_blank'>",linkEnd:"</a>"}},b[Kindle.ERROR.TIMEOUT]={title:"k_L_openBookTimeoutError_Title",text:"k_L_openBookTimeoutError_Text"},b[Kindle.ERROR.LOAD_FAILURE]={title:"k_L_openBookLoadFailure_Title",text:"k_L_openBookLoadFailure_Text"},b[Kindle.ERROR.REMOVE_FAILURE]={title:"k_L_removeBookError_Title",text:"k_L_removeBookError_Text"},b[Kindle.ERROR.REMOVE_NETWORK_FAILURE]=
{title:"k_L_removeBookNetworkError_Title",text:"k_L_removeBookNetworkError_Text"},b[Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED]={title:"k_bookextras_open_failed_Error_Title",text:"k_bookextras_open_failed_Error_Text"},b[Kindle.ERROR.BOOKEXTRAS_NO_CACHE_ERROR]={title:"k_bookextras_offline_cache_failed_Error_Title",text:"k_bookextras_offline_cache_failed_Error_Text"},b[Kindle.ERROR.CONTENT_LOANED]={title:"k_L_openBookContentLoanedError_Title",text:"k_L_openBookContentLoanedError_Text"},b[Kindle.ERROR.CONTENT_LOAN_ENDED]=
{title:"k_L_openBookContentLoanEndedError_Title",text:"k_L_openBookContentLoanEndedError_Text"},b[Kindle.ERROR.CONTENT_LICENSE_EXCEEDED]={title:"k_L_openBookContentLicenseExceededError_Title",text:"k_L_openBookContentLicenseExceededError_Text"},b[Kindle.ERROR.CONTENT_UNSUPPORTED]={title:"k_L_openBookContentUnsupportedError_Title",text:"k_L_openBookContentUnsupportedError_Text"},b[Kindle.ERROR.CONTENT_UNSUPPORTED_METRO]={title:"k_L_openBookContentUnsupportedErrorMetro_Title",text:"k_L_openBookContentUnsupportedErrorMetro_Text"},
b[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]={title:"k_L_openBookContentRentalExpiredError_Title",text:"k_L_openBookContentRentalExpiredError_Text"},b[Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO]={title:"k_L_openBookContentRentalExpiredErrorMetro_Title",text:"k_L_openBookContentRentalExpiredErrorMetro_Text",textParams:{link:"<a href='http://kindle.amazon.com/' target='_blank'>http://kindle.amazon.com/</a>"}},b[Kindle.ERROR.CONTENT_UPGRADE]={title:"k_L_openBookContentUpgrade_Title",text:"k_L_openBookContentUpgrade_Text"},
b[Kindle.ERROR.SESSION_LIMIT_EXCEEDED]={title:"k_L_openBookSessionLimitExceededError_Title",text:"k_L_openBookSessionLimitExceededError_Text"},b[Kindle.ERROR.BOOK_NOT_AVAILABLE]={title:"k_L_bookNotAvailable_Title",text:"k_L_bookNotAvailable_Text"},b[Kindle.ERROR.STORE_NOT_AVAILABLE]={title:"k_L_storeNotAvailable_Title",text:"k_L_storeNotAvailable_Text"},b[Kindle.ERROR.STORE_OPEN_FAILED]={title:"k_store_open_failed_Error_Title",text:"k_store_open_failed_Error_Text"},b[Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED]=
{title:"k_store_open_failed_offline_Error_Title",text:"k_store_open_failed_offline_Error_Text"},b[Kindle.ERROR.SYNC_FAILED]={title:"k_L_syncFailedError_Title",text:"k_L_syncFailedError_Text"},b[Kindle.ERROR.SYNC_FAILED_OFFLINE]={title:"k_L_syncFailedOfflineError_Title",text:"k_L_syncFailedOfflineError_Text"},b[Kindle.ERROR.NOT_IMPLEMENTED]={title:"k_lib_unimplementedFeature_Error_Title",text:"k_lib_unimplementedFeature_Error_Text"},b[Kindle.ERROR.LIBRARY_LOAD_FAILED]={title:"k_L_loadFailedError_Title",
text:"k_L_loadFailedError_Text"},b[Kindle.ERROR.NETWORK]={title:"k_L_openBookNetworkError_Title",text:"k_L_openBookNetworkError_Text"},b[Kindle.ERROR.UNKNOWN_ERR]={title:"k_L_unknownError_Title",text:"k_L_unknownError_Text"},b[Kindle.ERROR.OUTDATED_CHROME]={title:"k_L_outdatedChrome_Title",text:"k_L_outdatedChrome_Text",textParams:{linkStart:"<a href='https://www.google.com/chrome/' target='_blank'>",linkEnd:"</a>"}},l={},l[Kindle.ERROR.CONTENT_UNSUPPORTED]=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO,
l[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]=Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO;KindleHostDeviceDetector.isMetro()&&(e=l[e]||e);(e=b[e])||(e=b[Kindle.ERROR.UNKNOWN_ERR]);return{title:ResourceBundle.getLocalizedString(e.title,e.titleParams),text:ResourceBundle.getLocalizedString(e.text,e.textParams)}}}}(),KindleIOSScrollStopper={stopScroll:function(b){b.preventDefault()}},KindleListUtilities=function(){return{binarySearch:function(b,l,e){if(!b.length)return 0;for(var k=b.length-1,a=0,j=0,n=null,m=
0;a<=k;)if(j=Math.floor((a+k)/2),n=b[j],m=0,e===void 0?n>l?m=1:n<l&&(m=-1):m=e(l,n),m>0)k=j-1;else if(m<0)a=j+1;else return j;return j===0||m<0?j:j-1},first:function(b){return b[0]},last:function(b){return b[b.length-1]}}}(),KindleOffline=function(){function b(a){var b=new jQuery.Deferred;setTimeout(b.resolve,a);return b.promise()}function l(a,b,k){if(a.indexOf(e)>=0&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()){var m=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),
h=m.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.openPinning(function(a){a?(m.increaseSubCounter(h,"Continue",1),m.endMetrics(h),m=null,b()):(m.increaseSubCounter(h,"Cancel",1),m.endMetrics(h),m=null,k())})}else b()}var e="topaz",k=null;return{isFirstTime:function(){return KindleLocalStorage.localStorageObject.getItem("haveRun")?!1:!0},isEnabled:function(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled()},firstRunMessage:function(){var a=
new jQuery.Deferred;KindleFirstRunDialog.open(function(){KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(a.resolve,a.reject);KindleLocalStorage.localStorageObject.setItem(Kindle.App.HAVE_RUN,"true")});return a.promise()},enableOfflineMessage:function(){var a=new jQuery.Deferred;KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(a.resolve,a.reject);setTimeout(function(){a.isRejected()&&KindleEnableOfflineDialog.open()},500);return a.promise()},
pinBook:function(a,e){function k(){s.cancelDownloading();KindleLibraryProgressDialog.close();d.reject()}function m(){KindleLibraryProgressDialog.updateValue(100);$.when(f,b(200)).then(function(){KindleLibraryProgressDialog.close();d.resolve()})}function h(a){KindleLibraryProgressDialog.close();a!==Kindle.ERROR.CANCELLED&&e(a);d.reject(a)}function g(){function a(b,c){KindleLibraryProgressDialog.updateValue(Math.round(100*Math.min(b,c)/Math.max(1,c)))}s.getSizeInfo().then(function(b){b.bookSize*1.53>
b.quota?h(Kindle.ERROR.OUT_OF_SPACE):s.getBookInfoDfd().then(function(){var b=s.getBookType();l(b,function(){r.resolve(!0);s.getDownloadComplete(a).then(m,h)},function(){r.reject();k()})})})}var d,f,c,s,o,r;d=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return d.reject(),d.promise();c=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(d){c.registerModuleList(d);o=c.getModuleSync(c.METRICS_MANAGER).startMetrics("Pin");
a.isSample=!1;s=KindleReaderBookInfoProvider.BookInfo(a,c);f=b(1500);r=new jQuery.Deferred;KindleLibraryProgressDialog.open(k);s.startDownloading(o,h,r).then(g,h)});return d.promise()},unpinBook:function(a,b){function e(a){KindleSpinner.hide();f.endMetrics(c);b(a===Kindle.ERROR.NETWORK?Kindle.ERROR.REMOVE_NETWORK_FAILURE:Kindle.ERROR.REMOVE_FAILURE);g.reject(a)}function m(){KindleSpinner.hide();f.endMetrics(c);g.resolve()}function h(b){b.cacheState!==Kindle.BookInfo.CachedState.PINNED?b=!0:KindleHostDeviceDetector.isOnline()?
(b={asin:a.asin,kindleSessionId:b.context.kindleSessionId,isOffline:!1},b=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(b)):b=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return b}var g,d,f,c;KindleSpinner.show();g=new jQuery.Deferred;f=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);c=f.startMetrics("Unpin");d=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();d.getRecord("bookinfo",{asin:a.asin},
{cacheState:!0,context:!0}).then(function(b){b&&b.length>0?$.when(h(b[0])).fail(e).done(function(){d.deleteBooksData([a.asin]).then(m,e)}):m()},e);return g.promise()},downloadBook:function(a,e,l,m){function h(){$.when(c,b(200)).then(function(){f.resolve();l()})}function g(a){if(a!==Kindle.ERROR.CANCELLED){if(a===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())a=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;var b=KindleErrorMap.getErrorText(a);b.code=a;m(b)}f.reject(a)}function d(){function a(b,
c){e(Math.round(100*Math.min(b,c)/Math.max(1,c)))}k.getSizeInfo().then(function(b){b.bookSize*1.53>b.quota?g(Kindle.ERROR.OUT_OF_SPACE):(r.resolve(!0),k.getDownloadComplete(a).then(h,g))})}var f,c,s,o,r;f=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return f.reject(),f.promise();s=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(e){s.registerModuleList(e);o=s.getModuleSync(s.METRICS_MANAGER).startMetrics("Pin");
k=KindleReaderBookInfoProvider.BookInfo(a,s);c=b(1500);r=new jQuery.Deferred;k.startDownloading(o,g,r).then(d,g)});return f.promise()},removeBook:function(a,b,e){function m(a){f.endMetrics(c);e(a)}function h(){f.endMetrics(c);b()}function g(b){b.cacheState!==Kindle.BookInfo.CachedState.PINNED||b.context.isSample?b=!0:KindleHostDeviceDetector.isOnline()?(b={asin:a.asin,kindleSessionId:b.context.kindleSessionId,isOffline:!1},b=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(b)):
b=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return b}var d,f,c;f=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);c=f.startMetrics("Unpin");d=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();d.getRecord("bookinfo",{asin:a.asin},{cacheState:!0,context:!0}).then(function(b){b&&b.length>0?$.when(g(b[0])).fail(m).done(function(){d.deleteBooksData([a.asin]).then(h,m)}):h()},m)},cancelBookDownload:function(){k.cancelDownloading()}}}(),KindleStringUtilities=
function(){var b={"\u2019":"'","\uff07":"'","\u00e0":"a","\u00e1":"a","\u00e2":"a","\u00e3":"a","\u00e4":"a","\u00e5":"a","\u00c0":"a","\u00c1":"a","\u00c2":"a","\u00c3":"a","\u00c4":"a","\u00c5":"a","\u00e8":"e","\u00e9":"e","\u00ea":"e","\u00eb":"e","\u00c8":"e","\u00c9":"e","\u00ca":"e","\u00cb":"e","\u00ec":"i","\u00ed":"i","\u00ee":"i","\u00ef":"i","\u00cc":"i","\u00cd":"i","\u00ce":"i","\u00cf":"i","\u00f2":"o","\u00f3":"o","\u00f4":"o","\u00f5":"o","\u00f6":"o","\u00f8":"o","\u00d2":"o","\u00d3":"o",
"\u00d4":"o","\u00d5":"o","\u00d6":"o","\u00d8":"o","\u00f9":"u","\u00fa":"u","\u00fb":"u","\u00fc":"u","\u00d9":"u","\u00da":"u","\u00db":"u","\u00dc":"u","\u00fd":"y","\u00ff":"y","\u00dd":"y","\u0178":"y","\u00e7":"c","\u00c7":"c","\u00f1":"n","\u00d1":"n","\u00df":"s","\u00e6":"ae","\u00c6":"ae","\u0153":"oe"};return{replaceAccentedChars:function(l){return l=l.replace(/[^A-Za-z0-9 ]+/g,function(e){return b[e]?b[e]:e})},stripNonAlphaNumericChars:function(l){return l=l.replace(/^[^A-Za-z0-9 ]+/g,
function(e){return b[e]?e:""})}}}(),KindleTouchEventsToggler=function(){function b(a){if(n)for(var b=$(":hasTouchEvent"),e=0;e<b.length;e++){var d=b[e];if((!a||!a(d))&&d._listeners)for(var f=d._listeners.slice(0),c=0;c<f.length;c++){var k=f[c][0];if(k==="touchstart"||k==="touchmove"||k==="touchend")k={element:d,type:k,func:f[c][1],useCapture:f[c][2]},j.push(k),d.removeEventListener(k.type,k.func,k.useCapture)}}}function l(){if(n){for(var a=0;a<j.length;a++){var b=j[a];b.element.addEventListener(b.type,
b.func,b.useCapture)}j=[]}}var e=null,k=null,a=!1,j=[],n=!1;return{initialize:function(){if(!a)e=HTMLElement.prototype.addEventListener,HTMLElement.prototype.addEventListener=function(){if(!this._listeners)this._listeners=[];this._listeners.push(arguments);e.apply(this,arguments)},k=HTMLElement.prototype.removeEventListener,HTMLElement.prototype.removeEventListener=function(){function a(b,d){try{return typeof b==="function"&&typeof d==="function"?b===d:b.handleEvent===d.handleEvent}catch(e){}return!1}
if(this._listeners)for(var b=0;b<this._listeners.length;++b)if(this._listeners[b][0]===arguments[0]&&a(this._listeners[b][1],arguments[1])){this._listeners.splice(b,1);break}k.apply(this,arguments)},n=a=!0,$.expr[":"].hasTouchEvent=function(a){if(a._listeners)for(var b=0;b<a._listeners.length;b++){var e=a._listeners[b][0];if(e==="touchstart"||e==="touchmove"||e==="touchend")return!0}return!1},$.expr[":"].hasListeners=function(a){return a._listeners!==void 0}},deInitialize:function(){if(a){var b=0;
$(":hasListeners").each(function(a,e){for(var d=e._listeners.slice(0),f=0;f<d.length;f++)e.removeEventListener(d[f][0],d[f][1]),b++});HTMLElement.prototype.addEventListener=e;HTMLElement.prototype.removeEventListener=k;j=[];a=!1}},on:l,off:b,disallowTouchEvents:function(){n=!0;b();n=!1},allowTouchEvents:function(){n=!0;l()},isRequired:function(){return KindleHostDeviceDetector.isiOS()}}}();
(function(b){var l=["tap","tapHold","swipeLeft","swipeRight","activate","pinch","zoom","doubletap"];b.each(l,function(e,k){b.fn[k]=function(a,e){e=e||{};return k==="tap"?KindleHostDeviceDetector.isTouchDevice()?a?gt(this).on(k,a,b.extend(e,{expire:700,moveThreshold:10})):this.trigger(k):a?this.click(a):this.trigger("click"):a?gt(this).on(k,a,e):this.trigger(k)};b.attrFn[k]=!0});b.each(l,function(e,k){var a="unbind"+k.slice(0,1).toUpperCase()+k.slice(1);b.fn[a]=function(a){return k==="tap"&&!KindleHostDeviceDetector.isiOS()&&
!KindleHostDeviceDetector.isMSPointerEnabled()?a?this.unbind("click",a):this.unbind("click"):gt(this).off(k,a)};b.attrFn[a]=!0})})(jQuery);
var KindleUXComponentManager=function(){function b(a,b){var c=$.extend({},b,{s:ResourceBundle.getLocalizedString});return $.tmpl(a,{},c)}function l(a){if(a.callbacks.onDialogOpen)a.callbacks.onDialogOpen(a.component);a.callbacks.onOverlayClicked&&$(".ui-widget-overlay").tap(a.callbacks.onOverlayClicked).bind("contextmenu",function(b){a.callbacks.onOverlayClicked();b.preventDefault()})}function e(a,c,e){m(a,function(){var f;f=b(a,e);d[a]={component:f};c(f)})}function k(a){a.stopPropagation()}function a(a,
b,e,f){var g=d[a];g.callbacks=e;if(e.onInitializationDone)e.onInitializationDone(b);if(e.getDialogSettings)g.dialogSettings=e.getDialogSettings();if(g.dialogSettings.width===void 0){if(KindleHostDeviceDetector.isiPad())a=c;else if(KindleHostDeviceDetector.isMetro()){if(a=o,g.dialogSettings.dialogClass="wide-dialog",!f)g.dialogSettings.k4w_transparent_modal_overlay=!1}else a=s;g.dialogSettings.width=a}g.dialogSettings.modal&&b.keydown(k).keyup(k);if(KindleHostDeviceDetector.isiOS_5xOrGreater()){a=
g.dialogSettings;if(a.modal)a.modal=!1,a.k4w_modal=!0;b=b.dialog(a)}else b=b.dialog(g.dialogSettings);g.component=b;if(!f&&!KindleHostDeviceDetector.isiOS_5xOrGreater()){var h=b.dialog("option","position");$(window).resize(function(){b.dialog("option","position",h)})}b.bind("dialogopen",function(){l(g)});b.bind("dialogclose",function(){if(g.callbacks.onDialogClose)g.callbacks.onDialogClose(g.component);g.dialogSettings.k4w_modal&&KindleDialogOverlay.removeOverlay()});b.bind("dialogbeforeclose",function(){$(".ui-widget-overlay").unbindTap();
g.dialogSettings.modal&&r&&r(!0);g.callbacks.beforeDialogClose&&g.callbacks.beforeDialogClose(g.component)});j(g)}function j(a){a.component.dialog("isOpen")||(a.dialogSettings.k4w_transparent_modal_overlay?$("body").addClass(f):$("body").removeClass(f),a.callbacks.beforeDialogOpen&&a.callbacks.beforeDialogOpen(a.component),a.dialogSettings.modal&&r&&r(!1),a.dialogSettings.k4w_modal&&KindleDialogOverlay.showOverlay(a),a.component.dialog("open"))}function n(a){d[a]&&d[a].component.dialog("isOpen")&&
d[a].component.dialog("close")}function m(a,b){h(a).then(function(c){g[a]||($.template(a,c),b())},function(){KindleDebug.error("Template "+a+" is missing")})}function h(a){var b=$.Deferred(),a=$("#"+a);a.length!==1?b.reject():b.resolve(a);return b.promise()}function g(a){return $.template[a]}var d=[],f="transparent_overlay",c=475,s=400,o="100%",r;return{initializeTemplate:m,hasTemplate:g,renderTemplate:function(a,c){if(!$.template[a])throw{name:"initializationError",message:"Please call KindleUXComponentManager.initializeTemplate function first"};
return b(a,c)},initializeComponent:e,openDialog:function(b,c,f){var g=d[b];g?j(g):g!==null&&(d[b]=null,e(b,function(d){a(b,d,c)},f))},closeDialog:n,isVisible:function(a){return d[a]&&d[a].component.dialog("isOpen")?!0:!1},showMenu:function(b,c,e,f,g){var h=d[b];h?(c||KindlePopupMenu.updatePosition(b,f),g&&KindlePopupMenu.updateMenu(h.component,g),j(h)):KindlePopupMenu.initialize(b,c,e,f,function(c,e){g&&KindlePopupMenu.updateMenu(c,g);d[b]={component:c};a(b,c,e,!0)})},updateMenu:function(a,b){var c=
d[a];c&&KindlePopupMenu.updateMenu(c.component,b)},hideMenu:n,registerKeyEventsEnabledCallback:function(a){r=a}}}();
