/*
 * Copyright (c) 2012 Amazon.com, Inc. All rights reserved.
 */
function KindleAppFactory(){function b(){Q||(Q=$(document.createElement("iframe")).attr("id",N.KINDLE_READER_ID).attr("src",KINDLE_READER_SRC).addClass(ja),$("#"+N.KINDLE_READER_CONTAINER_ID).append(Q))}function e(){V||(V=$(document.createElement("iframe")).attr("id",N.KINDLE_LIBRARY_ID).attr("src",KINDLE_LIBRARY_SRC).addClass(ja),$("#"+N.KINDLE_LIBRARY_CONTAINER_ID).append(V))}function f(a){if(a)a.readerClass?x.readerClass=a.readerClass:delete x.readerClass,a.readerAppBar?x.readerAppBar=a.readerAppBar:
delete x.readerAppBar,a.cacheSample?x.cacheSample=a.cacheSample:delete x.cacheSample,a.returnToLibrary?x.returnToLibrary=a.returnToLibrary:delete x.returnToLibrary,a.location?x.location=Number(a.location):delete x.location,x.asin=a.asin,a.isSample!==void 0?x.isSample=a.isSample?!0:!1:delete x.isSample;x.standAlone=V===void 0;if(x.asin&&F)X=KindleMetricsManager.createTimer(),x.metricsId=KindleMetricsManager.startMetrics("Reader:Open"),KindleMetricsManager.startSubTimer(x.metricsId,"initialize"),F.openBook(x),
Q&&Q.focus(),x.standAlone&&$("#"+N.KINDLE_READER_CONTAINER_ID).removeClass("hidden")}function j(a){x.asin=void 0;x.metricsId=void 0;KindleLocalStorage.localStorageObject.setItem(U,"");Kindle.URL.removeASIN();F&&(F.unloadReader(),F=null);$("#"+N.KINDLE_READER_CONTAINER_ID).addClass("hidden").empty();Q=void 0;a&&(ba=a);if(O)O.onReaderClose()}function h(){ca=setTimeout(function(){$("#"+N.KINDLE_LIBRARY_CONTAINER_ID).addClass("hidden")},3E3)}function l(){ca&&(clearTimeout(ca),ca=void 0);$("#"+N.KINDLE_LIBRARY_CONTAINER_ID).removeClass("hidden");
V&&V.focus()}function k(){ba&&(KindleMetricsManager.endMetrics(ba),ba=null);b()}function o(){F&&F.unloadReader();KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).done(function(a){a.persistDB()})}function s(a){var c=KindleLocalStorage.localStorageObject.getItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE);if(a)KindleLocalStorage.localStorageObject.setItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE,"true");else if(c!=="true")return KindleLocalStorage.localStorageObject.setItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE,
"true"),ka(Kindle.URL.getLandingPageURL()),!0;return!1}function y(){var a,c=!0;KindleHostDeviceDetector.isCookieEnabled()?KindleHostDeviceDetector.isLocalStorageEnabled()||(a=KINDLE_NO_LOCAL_STORAGE_SRC,c=!1):(a=KINDLE_NO_COOKIE_SRC,c=!1);c||(a=$(document.createElement("iframe")).attr("src",a).addClass(ja),$("body").append(a));return c}function n(){function a(d){KindleAppCacheEventHandler.addEventListener(d,function(){if(KindleHostDeviceDetector.isOnline())switch(d){case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:E.onAppCacheStatus("error");
c=!1;break;case Kindle.APP_CACHE.CACHE_PROGRESS:c||(E.onAppCacheStatus("incomplete"),c=!0);break;case Kindle.APP_CACHE.CACHE_DONE:case Kindle.APP_CACHE.CACHE_CACHED:E.onAppCacheStatus("success");if(window.applicationCache.status===window.applicationCache.UPDATEREADY)E.onAppCacheUpdateReady();c=!1}})}var c=!1;a(Kindle.APP_CACHE.CACHE_NEEDS_RETRY);a(Kindle.APP_CACHE.CACHE_PROGRESS);a(Kindle.APP_CACHE.CACHE_DONE);a(Kindle.APP_CACHE.CACHE_CACHED)}function u(){KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseI18NSupported(R,
x.language)?v("langSupport"):KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseVersionNonSupported(R)&&v();KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseCountryNotSupported(R,x.language,x.ip).done(function(a){a&&v("countryBlk")})}function v(a){if(E){var c=Kindle.URL.getBasePathURL();c.indexOf("k4w")===-1&&(c=Kindle.URL.getHostURL()+"/");var d=KINDLE_UPGRADE_SRC.substr(1+KINDLE_UPGRADE_SRC.indexOf("/")),g=x.language||KindleHostDeviceDetector.getBrowserLanguage();c+=d+"?language="+g;
c+=a?"&type="+a:"";E.showWebPage({url:c})}}function r(){var a,c,d;if(!E){d="library";if(x.asin)d="book";else if(x.clear)Kindle.URL.removeQueryParameter("clear");else if(c=KindleLocalStorage.localStorageObject.getItem(U))try{a=JSON.parse(c);if(a.isSample!==void 0)x.isSample=a.isSample;if(a.type==="reader")d="book",x.asin=a.asin}catch(g){x.asin=c}d==="library"&&(e(),l())}b();a=!!KindleHostDeviceDetector.isInAppMode();c=!!x.asin;d=!!KindleHostDeviceDetector.isOnline();KindleMetricsManager.emit("App::Open",
{submetrics:[{name:a?"inApp":"inBrowser",value:1},{name:c?"inReader":"inLibrary",value:1},{name:d?"online":"offline",value:1}],breakdown:["Browser"]})}function p(a){var c=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(d){KindleHostDeviceDetector.isOnline()?d.getOwnedContent(a).then(c.resolve,c.reject):c.reject("offline")},c.reject);return c.promise()}function m(){return{setLoginParameters:function(c){a(c)},setFocusToReader:function(){F&&F.setFocus()},
showAppbar:function(){F&&F.setToolbarVisible(!0)},hideAppbar:function(){F&&F.setToolbarVisible(!1)},openBook:function(a){x.asin&&(j(),b());f(a)},deregister:function(){return Y(!1,!0)},clearDatabases:function(){return KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).pipe(function(a){return a.clear()})},clearLocalStorage:function(){KindleLocalStorage.localStorageObject.clear();return $.Deferred().resolve({success:!0}).promise()},sendMetrics:function(a){a.metrics.method?KindleMetricsManager.emit(a.metrics.method,
a.metrics):KindleMetricsManager.emit(a.metrics)},sendMetricsNow:function(a){a.metrics.method?KindleMetricsManager.emitNow(a.metrics.method,a.metrics):KindleMetricsManager.emitNow(a.metrics)},sendFeedback:function(a){if(typeof a==="string"){var c=a,a={};a.text=c}return KindleRemoteClient.uploadFeedback(a)},getOwnedContent:function(a){return p(a?a.lastSyncTime||null:null)},requestDeviceName:function(){KindleDebug.warn("requestDeviceName not implemented yet (waiting for new service api)")},requestDownloadedBookList:function(){return z()},
getDownloadedBookInfo:function(a){return D(a)},downloadBook:function(a){t(a)},cancelBookDownload:function(){F&&F.cancelBookDownload()},removeBook:function(a){var c=$.Deferred();F?F.removeBook(a,c.resolve,c.reject):c.reject();return c.promise()},requestOemAssociateId:function(a){var c=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(d){d.getOemAssociateId(a).then(c.resolve,c.reject)},c.reject);return c.promise()},getTodoItems:function(a){var c=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(d){d.getTodoItems(a).then(c.resolve,c.reject)},c.reject);return c.promise()},removeTodoItems:function(a){var c=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(d){d.removeTodoItems(a).then(c.resolve,c.reject)},c.reject);return c.promise()},uploadSnapshot:function(a){var c=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(d){d.uploadSnapshot(a).then(c.resolve,
c.reject)},c.reject);return c.promise()},getSelectedText:function(a){return F.getSelectedText(a)},hideContextMenu:function(){F.hideContextMenu()},setServiceHost:function(a){KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).done(function(c){c.setServiceHost(a)})},uploadJournal:function(){return KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).pipe(function(a){return a.uploadJournal()})},setStoreCookies:function(a){var c=$.Deferred();try{for(var d=0;d<a.length;d++)document.cookie=
a[d].value;setTimeout(c.resolve,0);return c.promise()}catch(g){return c.reject(g)}},updateAppCache:function(){window.applicationCache.update()},getTOSParams:function(a){var c=$.Deferred(),a=a||{};a.width=a.hasTouch?1366:2560;a.height=a.hasTouch?768:1440;a.dpi=a.hasTouch?148:72;return c.resolve({cachePollAttemptInterval:18E5,cachePollWaitAfterSuccess:432E5,width:a.width,height:a.height,dpi:a.dpi}).promise()}}}function z(){var a=jQuery.Deferred();KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(c){(c=
c[KindleModuleManager.DB_CLIENT].getAppDb())&&c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(a.resolve,a.reject)},a.reject);return a.promise()}function D(a){function c(g){var J,C,b={asin:a.asin};g.context=g.context||{};g.metadata=g.metadata||{};for(J in a)J!=="asin"&&a.hasOwnProperty(J)&&(C=g[J]||g.context[J]||g.metadata[J],C!==void 0&&(b[J]=C));d.resolve(b)}var d=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).then(function(g){g.getBookDb().BookInfoDB(a.asin).getBookInfo().then(c,
d.reject)},d.reject);return d.promise()}function t(a){function c(){E.onBookDownloadComplete({asin:a.asin})}function d(c){E.onBookDownloadFailed({asin:a.asin,error:c})}function g(c){E.onBookDownloadProgress({asin:a.asin,pct:c})}F&&F.downloadBook(a,g,c,d)}function B(){f()}function G(a,c,d){KindleTOS.setOpenBookReady();Z();a?(d||X.emit("Library::ReaderOpenOffline"),$("#"+N.KINDLE_READER_CONTAINER_ID).removeClass("hidden"),h()):(d=w(c),X.emit("Library::ReaderOpenFail"),d&&X.emit("Library::ReaderOpenFail::"+
d),q());if(O)O.onReaderOpenStatus(a,c)}function w(a){if(a)switch(a.toLowerCase()){case "loadfailure":return"LoadFailure";case "abort":case "timeout":case "error":return"NetworkError";case "contentloaned":case "contentloanended":case "contentlicenseexceeded":case "contentunsupported":case "formatunsupported":case "contentnotowned":case "contentrentalexpired":case "sessionlimitexceeded":return"ContentUnavailable";default:return"Unknown"}}function q(a){j(a);e();l()}function H(a,c,d){delete x.metricsId;
var g=[{name:"Library::ReaderOpen"+(a==="topaz"?"Topaz":"Mobi")},{name:"Library::ReaderOpen::"+a}];d&&g.push({name:"Library::ReaderOpen::"+a+"::"+d});X.emit(g);a={asin:x.asin,type:"reader"};if(x.isSample!==void 0)a.isSample=x.isSample;(!c||KindleHostDeviceDetector.isiOS())&&KindleLocalStorage.localStorageObject.setItem(U,JSON.stringify(a))}function a(a){var c={hostApp:d(),loginParams:a};KindleModuleManager.define(Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,[],function(){return c})}function g(a){function c(){KindleLocalStorage.localStorageObject.setItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE,
"true");window.location.reload(!0)}switch(a.newState){case Kindle.Service.AuthOK:da.resolve();break;case Kindle.Service.AuthError:a.prevState===Kindle.Service.AuthOK?Y(!0):ea();break;case Kindle.Service.AuthUserMismatch:KindleMetricsManager.emitNow("Service::ClientHashMismatch",{breakdown:["Browser"]});KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).then(function(a){a.clear().then(c,c)});break;case Kindle.Service.AuthTokenMismatch:c()}}function d(){return E?{onServiceAuthState:E.onServiceAuthState,
getRequestSigningHeaders:E.getRequestSigningHeaders}:{onServiceAuthState:g,getRequestSigningHeaders:function(){KindleDebug.error("Non-Embedded applications do not use signed request headers.")}}}function c(){KindleModuleManager.define(Kindle.MODULE.APPLICATION_ARGS,[],x);KindleStreamingReaderClient.initialize();KindleDBClient.initialize();if(!E){var c={};c.srsBasePath=x.srsBasePath;a(c)}KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.JOURNAL_MANAGER,KindlJournalManager.initialize());
var c=KindleHostDeviceDetector.getDeviceType()+":"+KindleHostDeviceDetector.getDevicePlatform(),d=KindleUserAgentMetricsInfo.browserWithVersionString();E&&KindleHostDeviceDetector.isMetro()&&(R||(R="metro@1.0.1.13"),d=R);KindleMetricsManager.initialize(KindleModuleManager.getModuleSync(Kindle.MODULE.METRICS_UPLOADER).uploadMetrics,{version:"1.0",clientName:KindleHostDeviceDetector.getClientName(),devicePlatform:c});KindleMetricsManager.setBreakdown("Version",KindleVersion.getMetricsVersion());KindleMetricsManager.setBreakdown("Browser",
d);M=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);E&&M.emit("zzz::HostVersion_"+R+"_kcr@"+KindleVersion.getMetricsVersion())}function C(a,c){var d=M.startMetrics("Store::TOSOpen"),c=$.extend({storeStartTime:Date.now()},c),g=a===S.LIBRARY?O&&O.onStoreOpenStatus:F&&F.onStoreOpenStatus;fa||(fa=!0,KindleTOS.open(c).then(function(c){g&&g(Kindle.STORE.OPEN_STORE);c?KindleLocalStorage.localStorageObject.removeItem(U):(a!==S.LIBRARY&&(j(),b()),h(),Z(),a!==S.BOOKEXTRAS?KindleTOS.setStoreClosedCallback(P):
KindleTOS.setStoreClosedCallback(T));M.endMetrics(d);fa=!1},function(){g&&g(Kindle.STORE.GENERIC_ERROR);M.modifyMetricsMethod(d,"Store::TOSOpenFail");M.endMetrics(d);fa=!1}))}function I(){var a=!!x.storePath;return KindleHostDeviceDetector.isiOS()||a}function K(a,c){var d=a===S.LIBRARY?O&&O.onStoreOpenStatus:F&&F.onStoreOpenStatus;if(!KindleHostDeviceDetector.isOnline()&&d)d(Kindle.STORE.OFFLINE_ERROR);else if(I())C(a,c);else{var g,J;c.asin?(g="http://www.amazon.com/dp/"+c.asin+"/ref=kcr_store_sample",
KindleLocalStorage.localStorageObject.removeItem(U)):(g=c.isSourceEmptyLibBtn?"/ref=kcr_store_emptylib_desktop":"/ref=kcr_store_libbutton_desktop",J=c.kids?Kindle.STORE.CHILDRENS_NODE:c.comix?Kindle.STORE.COMICS_NODE:Kindle.STORE.KINDLE_NODE,g="http://www.amazon.com/b"+g+"?_encoding=UTF8&node="+J);ka(g);d&&d(Kindle.STORE.OPEN_STORE)}}function P(){A()}function T(){J(0);var a=KindleLocalStorage.localStorageObject.getItem(U);if(a)try{if(a=JSON.parse(a),a.type==="store"&&a.asin){L(a.asin,!1);return}}catch(c){A()}A()}
function A(){x.asin?(b(),J(1E3)):(e(),l(),O&&O.libraryUpdateNeeded())}function L(a,c){var d=M.startMetrics("BEX::Open"),g=F&&F.onBookExtrasOpenStatus;J(100);ga||(F&&F.pauseReader(),ga=!0,KindleBEX.open(a,!!c).then(function(){var J=null;g&&g(Kindle.BOOKEXTRAS.OPEN_BEX);c||(j(),b());F&&F.pauseReader();$("#"+N.KINDLE_READER_CONTAINER_ID).addClass("hidden");Z();ga=!1;J={asin:a,type:"reader"};KindleLocalStorage.localStorageObject.setItem(U,JSON.stringify(J));M.increaseSubCounter(d,"Open",1);M.endMetrics(d)},
function(){g&&(F.resumeReader(),g(Kindle.BOOKEXTRAS.GENERIC_ERROR));Z();ga=!1;M.increaseSubCounter(d,"OpenFail",1);M.endMetrics(d)}))}function ha(a){J(0);K(S.BOOKEXTRAS,{asin:a})}function W(a){x.asin===void 0&&f({asin:a});F&&F.resumeReader();$("#"+N.KINDLE_READER_CONTAINER_ID).removeClass("hidden");Q&&Q.focus()}function ia(a){var c=M.startMetrics("BEX::Opened");M.increaseSubCounter(c,a,1);M.endMetrics(c)}function J(a){la=setTimeout(function(){aa&&($("body").append(aa),aa=null);var a=$("#loading_spinner"),
c=$(window).width(),d=parseInt(a.css("width"),10),g=$(window).height(),J=parseInt(a.css("height"),10);a.css("top",(g-J)/2+"px").css("left",(c-d)/2+"px").show()},a)}function Z(){la&&clearTimeout(la);var a=$("#loading_spinner").detach();a.length&&!aa&&(aa=a)}function ka(a){E?KindleDebug.error("Oops, tried to go to a different in URL in embedded"):window.location=a}function ea(){return KindleRegistrationHandler.register()}function Y(a,c){return KindleRegistrationHandler.deregister(a,c).then(function(){if(E&&
E.onDeregister)E.onDeregister(!0)},function(){if(E&&E.onDeregister)E.onDeregister(!1)})}var N={KINDLE_READER_ID:"KindleReaderIFrame",KINDLE_READER_CONTAINER_ID:"KindleReaderContainer",KINDLE_LIBRARY_ID:"KindleLibraryIFrame",KINDLE_LIBRARY_CONTAINER_ID:"KindleLibraryContainer",KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer",KINDLE_BOOK_EXTRAS_CONTAINER_ID:"KindleBookExtrasContainer"},S={LIBRARY:"fromLibrary",READER:"fromReader",BOOKEXTRAS:"fromBookExtras"},ma,ja="KindleIFrame",U="last_app_activity",
Q,V,x={},F=null,O=null,ba,X,fa=!1,ga=!1,ca,la,aa,M,na,R,E,da,oa=!1;return{initialize:function(){if(!oa&&(oa=!0,KindleHostDeviceDetector.isiOSAppMode()||(Kindle.URL.normalizeQueryString(),x=$.extend({},Kindle.URL.getFragIdParameters(),Kindle.URL.getQueryParameters())),Z(),ma=[Kindle.MODULE.APPCACHE_EVENTHANDLER,KindleModuleManager.RESOURCE_BUNDLE,KindleModuleManager.DB_CLIENT,KindleModuleManager.METRICS_MANAGER,KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.CONSTANTS,KindleModuleManager.NETWORK],
KindleModuleManager.registerModule(KindleModuleManager.CONSTANTS,Kindle),KindleModuleManager.registerModule(KindleModuleManager.RESOURCE_BUNDLE,ResourceBundle),KindleModuleManager.registerModule(KindleModuleManager.NETWORK,KindleNetwork),KindleModuleManager.registerModule(KindleModuleManager.METRICS_MANAGER,KindleMetricsManager),ResourceBundle.setStringIDMode(!!x.stringIDMode),ResourceBundle.setLanguageCultureAndRegion(x.language,x.region),da=new jQuery.Deferred,KindleAppCacheManager.initialize(da),
KindleHostDeviceDetector.isiOS()&&$("body").addClass("ipad"),y())){window.onbeforeunload=o;var a=x.lnd==="true"||x.asin||x.host;if(x.host){if(!KindleHostDeviceDetector.isMetro()||!/^(ms-appx:\/\/)?amznmobilellc.kindleforwindows8$/.test(x.host)){console.error("unknown embedded host: "+x.host);return}na=x.host;R=x.hostVersion;E=ReaderHostInterfaceFactory(m(),na);Kindle.URL.removeQueryParameter("host");u();E.onReaderLoaded();n();KindleHostDeviceDetector.isMetro()&&KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(a){a[KindleModuleManager.DB_CLIENT].enableFullDb().then(function(){KindleDebug.log("In metro mode, enabling full database")},
function(){KindleDebug.error("In metro mode, was not able to enable full database.")})})}s(a)||(x.lnd&&Kindle.URL.removeQueryParameter("lnd"),c(),x.storePath&&KindleTOS.setStoreURL(decodeURIComponent(x.storePath)),KindleTOS.setOpenBookCallback(f),KindleTOS.setStoreClosedCallback(P),KindleBEX.setBookExtrasStoreOpenCallback(ha),KindleBEX.setBookExtrasClosedCallback(W),KindleBEX.setBookExtrasLogMetricCallback(ia),KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT]).then(r),E&&da.resolve(),
KindleChromeInstaller.initialize())}},registerEventCallback:function(a,c){var d=[],g;for(g in Kindle.APP_CACHE)d.push(Kindle.APP_CACHE[g]);d.indexOf(a)>=0&&KindleAppCacheEventHandler.addEventListener(a,c)},getSharedModuleSync:function(a){ma.indexOf(a)===-1&&KindleDebug.error(a+"is not a shared module");return KindleModuleManager.getModuleSync(a)},getSharedModules:function(){return KindleModuleManager.getModuleList(ma)},getAppInterfaceForReader:function(){function a(c){setTimeout(function(){j(c);b()},
0)}return E?{onReaderReady:B,closeReader:function(c){E.onBookClose();a(c)},onStartReadingStatus:function(c,d,g){E.onBookOpenStatus({canOpen:c,errorCode:d,isOnline:g});c||a()},onRendererLoaded:H,openBookExtras:L,openStore:function(c){E.onOpenStore({origin:S.READER,asin:c});E.onBookClose();a()},pinBookToStart:function(a){E.pinBookToStart(a)},onReaderTapped:function(){E.onReaderTapped()},hideAppBar:function(){E.hideAppBar()},onBookDownloadComplete:function(a){E.onBookDownloadComplete(a)}}:{onReaderReady:B,
closeReader:q,onStartReadingStatus:G,onRendererLoaded:H,openBookExtras:L,openStore:function(a){K(S.READER,{asin:a})},register:ea,deregister:Y,pinBookToStart:function(){},onReaderTapped:function(){},hideAppBar:function(){},onBookDownloadComplete:function(){}}},setReaderInterface:function(a){KindleInterfaces.assertImplements(a,KindleInterfaces.IKindleReader);F=a},getAppInterfaceForLibrary:function(){return{storeIsTOS:I,openStore:function(a){K(S.LIBRARY,a)},openBook:f,onLibraryLoaded:k,getQueryParameters:function(){return x},
register:ea,deregister:Y}},setLibraryInterface:function(a){KindleInterfaces.assertImplements(a,KindleInterfaces.IKindleLibrary);O=a},register:ea,deregister:Y,getQueryParams:function(){return x},gotoURL:ka,isEmbedded:function(){return!!E},getEmbeddorHostname:function(){return na}}}var KindleApp=KindleAppFactory();typeof amznJQ!=="undefined"&&amznJQ.declareAvailable("cascade");
var KindleBEX=function(){function b(b){n&&$("#"+o.KINDLE_BOOK_EXTRAS_CONTAINER_ID).addClass("hidden").empty();var m=new Date;n=$(document.createElement("iframe")).attr("id",o.KINDLE_BOOK_EXTRAS_ID+m.getTime()).attr("src",b).addClass(s);$("#"+o.KINDLE_BOOK_EXTRAS_CONTAINER_ID).append(n)}function e(){$("#"+o.KINDLE_BOOK_EXTRAS_CONTAINER_ID).addClass("hidden").empty();n=null;r&&r(v)}function f(){clearTimeout(u);$("#"+o.KINDLE_BOOK_EXTRAS_CONTAINER_ID).removeClass("hidden");y.resolve(!1)}function j(){e()}
function h(b){p&&p(b)}function l(b){m&&m("BookExtras::"+b)}function k(b){switch(b){case 0:y.reject();e();break;case 1:y.reject();e();break;case 4:KindleLocalStorage.localStorageObject.setItem(Kindle.BOOKEXTRAS.APP_CACHED,!0);break;case 5:KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().updateBookExtras(v,Kindle.BOOKEXTRAS.BEX_CACHED,function(){})}}var o={KINDLE_BOOK_EXTRAS_ID:"bex",KINDLE_BOOK_EXTRAS_CONTAINER_ID:"KindleBookExtrasContainer"},s="KindleIFrame",y,n,u,v,r,p,
m;return{open:function(m){y=new $.Deferred;v=m;BexBrowserHost=new BexK4WBrowserHost({},{onBookExtrasReady:f,closeBookExtras:j,openStoreFromBex:h,logMetric:l,logBexStatus:k});u=setTimeout(function(){y.reject();e()},15E3);b(Kindle.BOOKEXTRAS.BEX_URL+v+"?ua=4");KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$(n).bind("orientationchange",BexBrowserHost.onOrientationChanged);return y.promise()},setBookExtrasStoreOpenCallback:function(b){p=b},setBookExtrasClosedCallback:function(b){r=
b},setBookExtrasLogMetricCallback:function(b){m=b}}}(),KindleBuildInfo=function(){function b(b,j,h){var l=$.Deferred();$.getJSON(e,Math.floor(Math.random()*1E9),function(e){e=e[b];h(e)?l.resolve(e):l.reject(j)}).error(function(){l.reject(j)});return l.promise()}var e="./offline/build_info.uncached.js";return{getCurrentTotalAppcacheFileCount:function(){return b("filecount",-1,function(b){return typeof b==="number"&&b>1})}}}(),Kindle=$.extend(Kindle||{},{top:window,VERSION:{MAJOR:9,MINOR:9,PATCH:9},
MODULE:{SERVICE_INITIALIZATION_ARGS:"ServiceInitArgs",APPLICATION_ARGS:"ApplicationArgs",SERVICE_CLIENT:"ServiceClient",METRICS_UPLOADER:"MetricsUploader",DB_CLIENT:"DBClient",APPCACHE_EVENTHANDLER:"AppCacheEventHandler"},ERROR:{OUT_OF_SPACE:"OutOfSpace",UNKNOWN_DB_ERROR:"UnknownDBError",TIMEOUT:"timeout",LOAD_FAILURE:"LoadFailure",REMOVE_FAILURE:"RemoveFailure",REMOVE_NETWORK_FAILURE:"RemoveNetworkFailure",CONTENT_LOANED:"ContentLoaned",CONTENT_LOAN_ENDED:"ContentLoanEnded",CONTENT_LICENSE_EXCEEDED:"ContentLicenseExceeded",
CONTENT_UNSUPPORTED:"ContentUnsupported",CONTENT_UNSUPPORTED_METRO:"ContentUnsupportedMetro",CONTENT_RENTAL_EXPIRED:"ContentRentalExpired",CONTENT_RENTAL_EXPIRED_METRO:"ContentRentalExpiredMetro",SESSION_LIMIT_EXCEEDED:"SessionLimitExceeded",BOOK_NOT_AVAILABLE:"BookNotAvailable",STORE_NOT_AVAILABLE:"StoreNotAvailable",BOOKEXTRAS_OPEN_FAILED:"BookExtrasFailed",BOOKEXTRAS_NO_CACHE_ERROR:"BookExtrasCacheFailed",STORE_OPEN_FAILED:"StoreOpenFailed",STORE_OPEN_OFFLINE_FAILED:"StoreOpenOfflineFailed",SYNC_FAILED:"SyncFailed",
SYNC_FAILED_OFFLINE:"SyncFailedOffline",NOT_IMPLEMENTED:"NotImplemented",NETWORK:"Network",CANCELLED:"cancelled",CONTENT_UPGRADE:"ContentUpgrade",PINNED_CONTENT_UPGRADE:"PinnedContentUpgrade",LIBRARY_LOAD_FAILED:"LibraryLoadFailed",UNKNOWN_ERR:"unknown",OUTDATED_CHROME:"OutdatedChrome"},BookInfo:{CachedState:{PARTIAL:"partial",CACHED:"cached",PINNING:"pinnning",PINNED:"pinned",FULLY_DOWNLOADED:["cached","pinned"],MAYBE_DOWNLOADED:["partial","cached","pinning","pinned"],isFullyDownloaded:function(b){return Kindle.BookInfo.CachedState.FULLY_DOWNLOADED.indexOf(b)>=
0},isMaybeDownloaded:function(b){return Kindle.BookInfo.CachedState.MAYBE_DOWNLOADED.indexOf(b)>=0}},PublisherMetadata:{COMIC:"comic",CHILDREN:"children"}},Service:{AuthOK:"AuthOK",AuthError:"AuthError",AuthUserMismatch:"AuthUserMismatch",AuthTokenMismatch:"AuthTokenMismatch",DeviceTokenKey:"kindleDeviceToken",UserHashIdKey:"kindleUserHashId",EidKey:"eid"},App:{LOGGED_IN:"logged_in",BYPASS_LANDING_PAGE_STORAGE:"bypass_landing_page",HAVE_RUN:"haveRun",LIBRARY_FAIL_FLAG:"lf"},DB:{NEVER:-1,UNKNOWN_ERR:0,
DATABASE_ERR:1,VERSION_ERR:2,TOO_LARGE_ERR:3,QUOTA_ERR:4,SYNTAX_ERR:5,CONSTRAINT_ERR:6,TIMEOUT_ERR:7,TEXT_TYPE:1,NUMBER_TYPE:2,OBJECT_TYPE:4,ALLOW_NULL:8,PRIMARY_KEY:16,AUTO_INCREMENT:32,PIECE_ID_TYPE:64,SECONDARY_KEY:128,OPERATOR:"operator",VALUES:"values",NOT_EQUAL:"notEqual",IN_ARRAY:"inArray",INSERT_LIST_OPERATION:"insertList",UPDATE_RECORD_OPERATION:"updateRecord",UPSERT_RECORD_OPERATION:"upsertRecord",DELETE_RECORD_OPERATION:"deleteRecord",GET_RECORD_OPERATION:"getRecord",CREATE_TABLE_OPERATION:"createTable",
ALTER_TABLE_OPERATION:"alterTable"},STORE:{OPEN_STORE:"open_store",GENERIC_ERROR:"generic_error",OFFLINE_ERROR:"offline_error",KINDLE_NODE:"1286228011",COMICS_NODE:"156104011",CHILDRENS_NODE:"726696011"},APP_CACHE:{CACHE_PROGRESS:"cacheProgress",CACHE_CACHED:"cacheCached",CACHE_DONE:"cacheDone",CACHE_NEEDS_RETRY:"cacheNeedsRetry",CACHE_NEEDS_BROWSER_RESTART:"cacheNeedsBrowserRestart"},BOOKEXTRAS:{OPEN_BEX:"open_book_extras",BEX_LOCAL_STORAGE:"bex.data.",GENERIC_ERROR:"generic_error",BEX_URL:"https://bookextras.amazon.com/bookextras/",
BEX_ISAVAILABLE:1,BEX_CACHED:2,APP_CACHED:"book_extras_cached"},opt:{maxNoteChars:5E4},ClientName:{KCR:"K4W",Metro:"KW8"},DeviceType:{KCR:"A2CTZ977SKFQZY",Metro:"A3C2X3KG4GJCOD"}});Kindle.VERSION.toString=function(){return this.MAJOR+"."+this.MINOR+"."+this.PATCH};
var KindleMetricsManager=function(){function b(){return(new Date).getTime()}function e(){if(D.length>0){var a=D;D=[];s().insertList(a).fail(function(){Array.prototype.push.apply(a,D);D=a})}}function f(a){if($.isArray(a))return a;var g;if(a){g=[];for(var d in a)g.push(a[d])}return g}function j(a){var g=a[q.FIELD_SUB_TIMERS];if(g)for(var d in g);a[q.FIELD_SUB_TIMERS]=f(a[q.FIELD_SUB_TIMERS]);a[q.FIELD_SUB_COUNTERS]=f(a[q.FIELD_SUB_COUNTERS])}function h(a){for(var g=new jQuery.Deferred,d=0;d<a.length;d++)j(a[d]);
a.length>0&&s()?s().insertList(a).then(function(){g.resolve(a)},function(){k(a).then(function(){g.resolve(a)},function(){Array.prototype.push.apply(D,a);g.reject(a)})}):(Array.prototype.push.apply(D,a),g.resolve(a));return g.promise()}function l(a,g,d){var c=B[a];(a=c[q.FIELD_SUB_COUNTERS])||(a=c[q.FIELD_SUB_COUNTERS]={});c=a[g];c||(c=a[g]={},c[q.FIELD_NAME]=g,c[q.FIELD_COUNT]=0,d&&(typeof d==="string"&&(d=[d]),c[q.FIELD_BREAK_DOWN]=d));return c}function k(a){var g=new jQuery.Deferred,d=/exception/i;
KindleHostDeviceDetector.isOnline()?G(w.devicePlatform,w.clientName,w.version,w.breakdownDeclarations,a).then(function(c){c.Output.metricProcessCount&&c.Output.metricProcessCount>0||c.Output.__type&&c.Output.__type.match(d)?g.resolve(a):g.reject(a)},function(){g.reject(a)}):g.reject(a);return g.promise()}function o(){var a,g=new jQuery.Deferred;if(KindleHostDeviceDetector.isOnline()){if(!s())return g.reject(),g.promise();s().batchTransaction([{operation:Kindle.DB.GET_RECORD_OPERATION,tableName:m,
params:[]},{operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:m,params:[]}]).done(function(d){if(d[0]&&d[0].length>0){a=d[0];for(d=0;d<a.length;d++){var c=a[d];if(c.breakDown)c.breakdown=c.breakDown,delete c.breakDown}k(a).done(g.resolve).fail(function(){s()&&s().insertList(a);g.reject()})}}).fail(function(){g.reject()})}else g.reject();return g.promise()}function s(){try{if(z)return z.getAppDb().getTable(m)}catch(a){}return null}function y(a){function g(a,c){var d={};d[q.FIELD_NAME]=c.name;d[q.FIELD_COUNT]=
c.value;var g=n(c.breakdown);g.length>0&&(d[q.FIELD_BREAK_DOWN]=g);a[q.FIELD_SUB_COUNTERS]||(a[q.FIELD_SUB_COUNTERS]=[]);a[q.FIELD_SUB_COUNTERS].push(d)}if(!(typeof a==="object"&&typeof a.name==="string"&&typeof a.params==="undefined"||typeof a.params==="object"))return null;var d={},c=a.name,a=$.extend({},a.params);d[q.FIELD_METHOD]=c;d[q.FIELD_TIME]=0;if(a){if(a.time&&isNumber(a.time))d[q.FIELD_TIME]=a.time;if(a.submetrics){if(!$.isArray(a.submetrics))a.submetrics=[a.submetrics];for(c=0;c<a.submetrics.length;c++)g(d,
a.submetrics[c])}c=n(a.breakdown);c.length>0&&(d[q.FIELD_BREAK_DOWN]=c)}return d}function n(a){var g=[];if(a===void 0)return g;$.isArray(a)||(a=[a]);for(var d=0;d<a.length;d++)typeof a[d]==="string"&&(H.indexOf(a[d]),g.push(a[d]));return g}function u(a){a||(a={});if(!a.startTime)a.startTime=b();isNumber(a.startTime);this.params=a}function v(a,g){return a=$.map(a,function(a){a[q.FIELD_TIME]=g;return a})}function r(a){if(typeof a[0]==="string"){var g={};g.name=a[0];if(a[1])g.params=a[1];a=[g]}else a=
$.isArray(a[0])?a[0]:[];return $.map(a,y)}function p(){}var m="metrics",z=null,D=[],t=0,B={},G,w={breakdownDeclarations:{}},q={FIELD_METHOD:"method",FIELD_NAME:"name",FIELD_TIME:"time",FIELD_SUB_TIMERS:"timers",FIELD_SUB_COUNTERS:"counters",FIELD_BREAK_DOWN:"breakDown",FIELD_TIMER_START:"timerStart",FIELD_COUNT:"count",FIELD_VALUE:"value"},H=["Browser","Version"];u.prototype.elapsed=function(){var a=0;isNumber(this._elapsed)?a=this._elapsed:isNumber(this.params.startTime)&&(a=b()-this.params.startTime);
return a};u.prototype.stop=function(){this._elapsed=b()-this.params.startTime;return this};u.prototype.emit=function(){var a=this.elapsed(),g=r(arguments),g=v(g,a);return h(g).fail(p)};u.prototype.emitNow=function(){var a=this.elapsed(),g=r(arguments),g=v(g,a);return k(g).fail(p)};return{modifyMetricsMethod:function(a,g){B[a]&&(B[a][q.FIELD_METHOD]=g)},startMetrics:function(a){var g={};g[q.FIELD_METHOD]=a;g[q.FIELD_TIMER_START]=b();t++;B[t]=g;return t},endMetrics:function(a){var g;(g=B[a])&&g[q.FIELD_TIMER_START]?
(g[q.FIELD_TIME]=b()-g[q.FIELD_TIMER_START],delete g[q.FIELD_TIMER_START],g=h([g]),delete B[a]):g=(new jQuery.Deferred).reject().promise();return g},cancelMetrics:function(a){delete B[a]},startSubTimer:function(a,g,d){var c=B[a];(a=c[q.FIELD_SUB_TIMERS])||(a=c[q.FIELD_SUB_TIMERS]={});c=a[g];c||(c=a[g]={},c[q.FIELD_NAME]=g,c[q.FIELD_COUNT]=0,c[q.FIELD_TIME]=0,d=n(d),d.length>0&&(c[q.FIELD_BREAK_DOWN]=d));c[q.FIELD_TIMER_START]||(c[q.FIELD_TIMER_START]=b())},endSubTimer:function(a,g){var d=B[a][q.FIELD_SUB_TIMERS][g];
d[q.FIELD_TIMER_START]!==void 0&&(d[q.FIELD_COUNT]+=1,d[q.FIELD_TIME]+=b()-d[q.FIELD_TIMER_START],delete d[q.FIELD_TIMER_START])},setSubCounter:function(a,g,d,c){a=l(a,g,c);isNumber(d)||(d=1);a[q.FIELD_COUNT]=d},increaseSubCounter:function(a,g,d,c){a=l(a,g,c);isNumber(d)||(d=1);a[q.FIELD_COUNT]+=d},initialize:function(a,g){G=a;w=$.extend(w,g);KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(a){z=a;e();setInterval(o,3E5)}).fail(function(){})},uploadMetrics:o,setBreakdown:function(a,
g){$.isArray(g)&&(g=g.join(":"));typeof g==="string"&&H.indexOf(a)>-1&&(w.breakdownDeclarations[a]=g)},createTimer:function(){return new u},emitNow:function(){var a=r(arguments);return k(a).fail(p)},emit:function(){var a=r(arguments);return h(a).fail(p)}}}(),KindleNetwork=function(){function b(){navigator.onLine===!1?e(!1):$.ajax(j)}function e(b){k&&(window.clearTimeout(k),k=0);o=Date.now();b!==l&&(l=b,h.callEventListeners(b?"online":"offline"));f()}function f(){h.hasEventListener(l?"offline":"online")?
k||(k=window.setTimeout(b,l?9E5:18E4)):k&&(window.clearTimeout(k),k=0)}var j="/service/web/reader/ping",h=new ListenerManager,l=!0,k,o=0;return{initialize:function(){$(document).ajaxComplete(function(b,y){e(!!y.status)});document.body.addEventListener("offline",b);document.body.addEventListener("online",b);e(navigator.onLine)},addEventListener:function(b,e){h.addEventListener(b,e);f()},removeEventListener:function(b,e){h.removeEventListener(b,e);f()},isOnline:function(b){b=Number(b);return Date.now()-
o<(b>=0?b:Infinity)?l:navigator.onLine===!1?!1:null}}}(),KindleRegistrationHandler=function(){function b(){var b=f(Kindle.URL.getLandingPageURL());KindleApp.gotoURL(b)}function e(b){var e=j.US;e+="?openid.assoc_handle=amzn_kweb";e+="&openid.return_to="+encodeURIComponent(b);e+="&openid.mode=checkid_setup";e+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";e+="&openid.identity=";e+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";e+="&openid.claimed_id=";e+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";
(b=Kindle.URL.getSiteState())&&(e+="&"+b);return e}function f(b){var e=j.US;e+="?openid.assoc_handle=amzn_kweb";e+="&openid.return_to="+encodeURIComponent(b);e+="&openid.mode=logout";e+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";return e}var j={US:"https://www.amazon.com/ap/signin"};return{register:function(){KindleApp.gotoURL(e(Kindle.URL.getBaseURL()))},deregister:function(e,j){function k(){var b=new jQuery.Deferred;KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).then(function(m){m.uploadJournal().then(b.resolve,
b.resolve)});return b.promise()}function o(){var b=new jQuery.Deferred;m.getAppDb().getPinnedSessionIds().done(function(m){KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).deregisterSessions(m).then(b.resolve,b.reject)});return b.promise()}function s(){function b(){v.uploadMetrics().then(n,n)}r.then(b,b)}function y(){u.reject()}function n(){function e(){var b=$(document.createElement("iframe")).attr("id","iframe_reauth").attr("src",f("")).attr("style","display:none");$("body").append(b)}
j?(KindleLocalStorage.localStorageObject.clear(),KindleApp.isEmbedded()||e(),m.clear(function(){KindleApp.isEmbedded()||b()},function(){KindleApp.isEmbedded()||b()})):(KindleLocalStorage.localStorageObject.removeItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE),KindleLocalStorage.localStorageObject.removeItem(Kindle.App.LIBRARY_FAIL_FLAG),m.getAppDb().clearDeviceToken().then(b,b));u.resolve()}var u=new jQuery.Deferred,v=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),r,p=v.createTimer();
r=j?p.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Intentional"}]):p.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Unintentional"}]);var m=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT);e?n():$.when(k(),o()).then(s,y);return u.promise()}}}(),KindleStreamingReaderClient=function(){function b(c){var b,c=c||{};b=(c.srsHostName||"")+("/"+(c.srsBasePath||"service")+"/")+"web/";q=b+"content/";c.useSignedServiceRequests&&(b+="device/");w=b+"reader/";H=b+"register/";
a=w+"setOfflineStatus/";g=w+"deregisterSessions/";d=w}function e(a){var c={prevState:T,newState:a};if(a===Kindle.Service.AuthOK&&(c.eid=I,K))c.deviceName=K;T=a;P.onServiceAuthState(c)}function f(a){if(!a)return"";a=encodeURIComponent(a);return"&guid="+a+"&refEmId="+a}function j(){var a=$.cookie("session-id"),c=k(),d=new jQuery.Deferred;m(c,a,function(a,c,g){a.deviceSessionToken?d.resolve(a):d.reject(g,"failed");A.emit("Service::GetDeviceTokenCall")},function(a,c,g){A.emitNow("Service::GetDeviceTokenCallFail");
d.reject(a,c,g)});return d.promise()}function h(a){a=a?"?lastSyncTime="+encodeURIComponent(a):"";return w+"getOwnedContent"+a}function l(a){var c=w+"startReading?asin="+a.asin;c+=a.basePath?"&basePath="+a.basePath:"";c+=a.useNewPath?"&useNewPath="+a.useNewPath:"";c+=a.useProdBucket?"&useProdBucket="+a.useProdBucket:"";c+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";c+=a.contentVersion?"&contentVersion="+a.contentVersion:"";c+=a.formatVersion?"&formatVersion="+a.formatVersion:"";c+=a.isSample!==
void 0?"&isSample="+(a.isSample?"true":"false"):"";KindleHostDeviceDetector.isMetro()||(c+="&clientVersion="+KindleVersion.getVersion());return encodeURI(c)}function k(){var a=H+"getDeviceToken",c=KindleHostDeviceDetector.getDeviceType();a+="?serialNumber="+(ha||c)+"&deviceType="+c;return encodeURI(a)}function o(a){var c=w+"getFileUrl?asin="+a.asin+"&contentVersion="+a.contentVersion+"&formatVersion="+a.formatVersion;c+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";c+=a.isSample?"&isSample="+
a.isSample:"";c+=a.skeletonIds?"&skeletonIds="+a.skeletonIds.join(","):"";c+=a.fragmentIds?"&fragmentIds="+a.fragmentIds.join(","):"";c+=a.glyphIds?"&glyphIds="+a.glyphIds.join(","):"";c+=a.resourceIds?"&resourceIds="+a.resourceIds.join(","):"";c+=a.locationMapIds?"&locationMapIds="+a.locationMapIds.join(","):"";c+=a.basePath?"&basePath="+a.basePath:"";c+=a.useNewPath?"&useNewPath="+a.useNewPath:"";c+=a.useProdBucket?"&useProdBucket="+a.useProdBucket:"";return encodeURI(c)}function s(a,c){var d=w+
a+"?asin="+c.asin+"&kindleSessionId="+c.kindleSessionId;return c.position&&c.position>0?(d+="&lastPageRead="+c.position+"&localTimeOffset="+c.localTimeOffset+"&countryCode="+c.countryCode,d+="&positionType="+c.positionType,d=encodeURI(d)+f(c.refEmId)):encodeURI(d)}function y(a){a=g+"?sessions="+a.join();return encodeURI(a)}function n(a,c,g){a=d+"getTodoListItems?maxNumItems="+a;c&&(a+="&reason="+c);g&&(a+="&softwareRev="+g);return encodeURI(a)}function u(a){var c=d+"removeTodoListItem";c+="?type="+
a.type+"&action="+a.action+"&key="+a.key+"&completeStatus="+(a.completeStatus||a.complete_status)+"&failureCode="+(a.failureCode||a.failure_code||"");return encodeURI(c)}function v(a){function d(){KindleDebug.error("Failed to sign SRS request.")}if(W){var g;(g=/\/web.*$/.exec(a.url))?(g=g[0],P.getRequestSigningHeaders({path:g,verb:a.type||"GET",data:a.data||""}).then(function(c){a.beforeSend=function(a){$.each(c,function(c,d){a.setRequestHeader(c,d)});return!0};$.ajax(a)},d)):d()}else KindleAssert(c,
"Device Token must be loaded in order to make an authenticated request"),a.beforeSend=function(a){c&&a.setRequestHeader("X-ADP-Session-Token",c);return!0},$.ajax(a)}function r(a,c,d){function g(){var m=[];m[G]=function(a,c,g){z();d(a,c,g)};v({url:a,dataType:"json",success:[c],error:function(a,c,m){KindleHostDeviceDetector.isiOSAppMode()&&a.status===0&&A.emit("KindleApp::iOSAppModeStatusCodeIsZero");a.status!==G&&(c!=="timeout"&&b-- >0?(setTimeout(g,C),C*=2):d(a,c,m))},statusCode:m})}var b=1,C=50;
g()}function p(a,c,d,g){var b=[];b[G]=function(a,c,d){z();g(a,c,d)};a={url:a,type:"POST",dataType:"json",processData:!1,contentType:"application/json",data:JSON.stringify(c),success:[d],error:function(a,c,d){a.status!==G&&g(a,c,d)},statusCode:b};v(a)}function m(a,c,d,g){var b=[];b[G]=z;$.ajax({url:a,dataType:"json",beforeSend:function(a){a.setRequestHeader("x-amzn-sessionid",c);return!0},success:d,error:function(a,c,d){a.status!==G&&g(a,c,d)},statusCode:b})}function z(){function a(){e(Kindle.Service.AuthError)}
c=null;L.clearDeviceToken().then(a,a)}function D(a,d){function g(a,b,C){function m(){e(Kindle.Service.AuthError);d(a,b,C)}c=null;L.clearDeviceToken().then(m,m)}function b(){T!==Kindle.Service.AuthOK&&e(Kindle.Service.AuthOK);a()}function m(a){if(C&&C!==a.clientHashId)e(Kindle.Service.AuthUserMismatch);else{c=a.deviceSessionToken;C=a.clientHashId;I=a.eid;if(a.deviceName)K=a.deviceName;jQuery.when(L.setDeviceToken(a.deviceSessionToken),L.setUserHashId(a.clientHashId),L.setEID(a.eid)).then(b,g)}}function n(){j().then(m,
g)}function p(a){C=a[Kindle.Service.UserHashIdKey];I=a[Kindle.Service.EidKey];a[Kindle.Service.DeviceTokenKey]?(c=a[Kindle.Service.DeviceTokenKey],b()):n()}c?b():L.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(p,n)}function t(){function a(){e(Kindle.Service.AuthTokenMismatch)}c&&L.getDeviceToken().done(function(d){d!==c&&A.emit("Service::CheckTokenConsistencyMismatch",{breakdown:["Browser"]}).then(a,a)}).fail(function(){A.emit("Service::CheckTokenConsistencyFail",
{breakdown:["Browser"]}).then(a,a)})}function B(a,c,d,g,b){c=JSON.stringify({Operation:"uploadMetricsExternal",Input:{devicePlatform:a,clientName:c,version:d,metricBreakdown:g,metrics:b}});KindleLocalStorage.localStorageObject&&(a=KindleLocalStorage.localStorageObject.getItem("QAMetricsURL"))&&$.ajax({url:a,type:"POST",dataType:"json",processData:!1,headers:{Source:window.location.href},contentType:"application/json",data:c}).fail(function(a,c){c.statusCode&&KindleDebug.warn("Failed to echo metrics to the QA ingester service; statusCode="+
c.statusCode)});a=encodeURI(q+"uploadMetrics");return $.ajax({url:a,type:"POST",dataType:"json",processData:!1,contentType:"application/json",data:c})}var G=403,w,q,H,a,g,d;b();var c,C,I,K,P,T,A,L,ha,W;$.ajaxSetup({headers:{"Cache-Control":"no-cache",Pragma:"no-cache"},timeout:6E4});var ia={getFileUrl:function(a){var a=o(a),c=new jQuery.Deferred;t();r(a,c.resolve,function(a,d,g){c.reject(a,d,g);A.emitNow("Service::GetFileUrlCallFail")});return c.promise()},stillReading:function(a){var a=s("stillReading",
a),c=new jQuery.Deferred;t();r(a,c.resolve,function(a,d,g){c.reject(a,d,g);A.emitNow("Service::StillReadingCallFail")});return c.promise()},setOfflineStatus:function(c){var c=encodeURI(a+"?asin="+c.asin+"&kindleSessionId="+c.kindleSessionId+"&offline="+(c.isOffline?"true":"false")),d=new jQuery.Deferred;r(c,function(a,c,g){d.resolve(a,c,g);A.emit("Service::SetOfflineStatusCall")},function(a,c,g){d.reject(a,c,g);A.emitNow("Service::SetOfflineStatusCallFail")});return d.promise()},deregisterSessions:function(a){var a=
y(a),c=new jQuery.Deferred;r(a,function(a,d,g){A.emit("Service::DeregisterSessionsCall");c.resolve(a,d,g)},function(a,d,g){A.emitNow("Service::DeregisterSessionsCallFail");c.reject(a,d,g)});return c.promise()},doneReading:function(a){var a=s("doneReading",a),c=new jQuery.Deferred;r(a,function(a,d,g){c.resolve(a,d,g);A.emit("Service::DoneReadingCall")},function(a,d,g){c.reject(a,d,g);A.emitNow("Service::DoneReadingCallFail")});return c.promise()},getOwnedContent:function(a){var a=h(a),c=new jQuery.Deferred;
t();r(a,function(a,d,g){c.resolve(a,d,g);A.emit("Service::GetOwnedContentCall")},function(a,d,g){c.reject(a,d,g);A.emitNow("Service::GetOwnedContentCallFail")});return c.promise()},startReading:function(a){var a=l(a),c=new jQuery.Deferred;t();r(a,function(a,d,g){c.resolve(a,d,g);A.emit("Service::StartReadingServiceCall")},function(a,d,g){c.reject(a,d,g);A.emitNow("Service::StartReadingServiceCallFail")});return c.promise()},getLPR:function(a,c){var d=w+"getLPR?asin="+encodeURIComponent(a)+f(c),g=
new jQuery.Deferred;r(d,function(a,c,d){g.resolve(a,c,d);A.emit("Service::GetLPRCall")},function(a,c,d){g.reject(a,c,d);A.emitNow("Service::GetLPRCallFail")});return g.promise()},resetLPR:function(a){var a=s("resetLPR",a),c=new jQuery.Deferred;r(a,function(a,d,g){c.resolve(a,d,g);A.emit("Service::ResetLPRCall")},function(a,d,g){c.reject(a,d,g);A.emitNow("Service::ResetLPRCallFail")});return c.promise()},getAnnotations:function(a,c){var d=w+"getAnnotations?asin="+encodeURIComponent(a)+f(c),g=new jQuery.Deferred;
r(d,function(a,c,d){g.resolve(a,c,d);A.emit("Service::GetAnnotationsCall")},function(a,c,d){g.reject(a,c,d);A.emitNow("Service::GetAnnotationsCallFail")});return g.promise()},updateAnnotations:function(a,c){var d=encodeURI(w+"updateAnnotations"),g={Operation:"updateAnnotations",Input:{annotations:a,localTimeOffset:c}},b=new jQuery.Deferred;t();p(d,g,function(a,c,d){b.resolve(a,c,d);A.emit("Service::UpdateAnnotationsCall")},function(a,c,d){b.reject(a,c,d);A.emitNow("Service::UpdateAnnotationsCallFail")});
return b.promise()},uploadMetrics:B,checkTokenConsistency:t,getEID:function(){var a=new jQuery.Deferred;if(I)return a.resolve(I).promise();L.getEID().then(a.resolve,function(){j().then(function(c){I=c.eid;L.setEID(c.eid).then(a.resolve(c.eid),a.reject(c.eid))},function(){A.emitNow("Service::GetEIDTokenCallFail");a.reject()})});return a.promise()},getOemAssociateId:function(a){var a=JSON.stringify({Operation:"getAssociateId",Input:{deviceType:a.deviceType,deviceParameters:{eid:a.eid,oemPartnerName:a.oemPartnerName,
oemDealGuid:a.oemDealGuid}}}),c=encodeURI(q+"getAssociateId"),d=new jQuery.Deferred;$.ajax({url:c,type:"POST",dataType:"json",contentType:"application/json",data:a}).then(function(a,c,g){d.resolve(a,c,g);A.emit("Service::OemAssociateIdSuccess")},function(a,c,g){d.reject(a,c,g);A.emit("Service::OemAssociateIdFailure")});return d.promise()},getTodoItems:function(a){var a=n(a.maxNumItems||a.count,a.reason,a.versionNumber),c=new jQuery.Deferred;r(a,function(a,d,g){c.resolve(a,d,g);A.emit("Service::GetTodoItemCall")},
function(a,d,g){c.reject(a,d,g);A.emitNow("Service::GetTodoItemCallFail")});return c.promise()},removeTodoItems:function(a){if(a.length!==1)return $.Deferred().reject("Must be one item").promise();var a=u(a[0]),c=new jQuery.Deferred;t();r(a,function(a,d,g){c.resolve(a,d,g);A.emit("Service::RemoveTodoItemsCall")},function(a,d,g){c.reject(a,d,g);A.emitNow("Service::RemoveTodoItemsCallFail")});return c.promise()},getWordDefinition:function(a){var c=jQuery.Deferred();r(w+"getWordDefinition?word="+a,function(a){c.resolve(a)},
function(a,d,g){c.reject(a,d,g)});return c.promise()},uploadSnapshot:function(a){var a=d+"uploadSnapshot?snapshot="+encodeURIComponent(a.response),c=new jQuery.Deferred;r(a,function(a,d,g){c.resolve(a,d,g);A.emit("Service::UploadSnapshotCall")},function(a,d,g){c.reject(a,d,g);A.emitNow("Service::UploadSnapshotCallFail")});return c.promise()},getPFM:function(){var a=encodeURI(w+"getPFM"),c=new jQuery.Deferred;r(a,function(a,d,g){A.emit("Service::GetPFMCall");c.resolve(a,d,g)},function(a,d,g){A.emit("Service::GetPFMCallFail");
c.reject(a,d,g)});return c.promise()},whenOnline:function(){var a=jQuery.Deferred();if(KindleNetwork.isOnline())a.resolve();else{var c=function(){KindleNetwork.removeEventListener("online",c);a.resolve()};KindleNetwork.addEventListener("online",c)}return a.promise()},setServiceHost:function(a){b({useSignedServiceRequests:W,srsHostName:a})}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.SERVICE_CLIENT,[Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,KindleModuleManager.METRICS_MANAGER,
Kindle.MODULE.DB_CLIENT],function(a,c,d){var g=new jQuery.Deferred;A=c;L=d.getAppDb();var C,m;P=a.hostApp;if(a.loginParams)ha=a.loginParams.dsn,W=!!a.loginParams.useSignedServiceRequests,C=a.loginParams.hostName,m=a.loginParams.srsBasePath;KindleNetwork.initialize();W?L.getUserHashId().always(function(c){c&&a.loginParams.clientHashId&&c!==a.loginParams.clientHashId?e(Kindle.Service.AuthUserMismatch):e(Kindle.Service.AuthOK);b({useSignedServiceRequests:!0,srsHostName:C});g.resolve(ia)}):(m&&b({srsBasePath:m}),
D(function(){g.resolve(ia)},g.reject));return g});KindleModuleManager.define(Kindle.MODULE.METRICS_UPLOADER,[],function(){return{uploadMetrics:B}})}}}(),KindleTOS=function(){function b(){var a="https://images-na.ssl-images-amazon.com/images/G/01/kindle/kindlefortheweb/store/"+G+"/BrowserHost-min.js",c=$.Deferred();if(typeof BrowserHostAPI!=="undefined")return c.resolve().promise();$.getScript(a,function(){typeof BrowserHostAPI!=="undefined"?c.resolve():c.reject()});return c.promise()}function e(){var a=
new jQuery.Deferred,c={w:$(window).width(),h:$(window).height(),dpi:null,osv:null,deviceType:KindleHostDeviceDetector.getDeviceType(),bhv:G};KindleModuleManager.getModule([KindleModuleManager.SERVICE_CLIENT]).then(function(g){g.getEID().then(function(g){c.eid=g;a.resolve("?"+$.param(c))},function(){KindleDebug.error("Couldn't fetch EID.");a.reject("?"+$.param(c))})},function(){KindleDebug.error("SRS not loaded");a.reject("?"+$.param(c))});return a.promise()}function f(){function a(c){var d=z?"&asin="+
encodeURIComponent(z):"",c=B+c+d+"&ref_="+(z?"kcr_store_sample":t?"kcr_store_emptylib_ipad":"kcr_store_libbutton_ipad");n&&$("#"+u.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();d=new Date;n=$(document.createElement("iframe")).attr("id",u.KINDLE_STORE_ID+d.getTime()).attr("src",c).addClass(v);$("#"+u.KINDLE_STORE_CONTAINER_ID).append(n)}e().then(a,a)}function j(){$("#"+u.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();H=n=null;a=!0;q&&q()}function h(){var a=$.Deferred();b().then(function(){var c=
{hostVersion:r,storeStartTime:D,deviceType:KindleHostDeviceDetector.getDeviceType()};BrowserHost=new K4WBrowserHost(c,{pageReady:l,closeStore:k,openBook:o,bookStatus:s,openInExternalBrowser:y});a.resolve()},a.reject);return a.promise()}function l(){clearTimeout(p);$("#"+u.KINDLE_STORE_CONTAINER_ID).removeClass("hidden");m.resolve(!1)}function k(){j()}function o(d){if(a){a=!1;var c=d.type,d=d.asin;if(w)switch(c){case g.EBOOK:w({asin:d,isSample:!1});j();break;case g.SAMPLE:w({asin:d,isSample:!0}),H=
d,$("#"+u.KINDLE_STORE_CONTAINER_ID).hide(),q&&q()}}}function s(a){return{id:a,status:1,percentDownloaded:1}}function y(a){clearTimeout(p);m.resolve(!0);var c=document.createElement("a");c.href=a;c.target="_blank";a=document.createEvent("MouseEvents");a.initEvent("click",!0,!0);c.dispatchEvent(a)}var n,u={KINDLE_STORE_ID:"store",KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},v="KindleIFrame",r=3,p,m,z,D,t,B="https://www.amazon.com/gp/kindle/kcp/tos.html",G="015",w,q,H,a=!0,g={EBOOK:"EBOK",SAMPLE:"EBSP"};
return{open:function(a){m=$.Deferred();z=a.asin;D=a.storeStartTime;t=a.isSourceEmptyLibBtn;if(z&&z===H&&n)return $("#"+u.KINDLE_STORE_CONTAINER_ID).show(),m.resolve(!1),m.promise();h().then(function(){p=setTimeout(function(){m.reject();j()},3E4);f()},m.reject);return m.promise()},setOpenBookCallback:function(a){w=a},setStoreClosedCallback:function(a){q=a},setOpenBookReady:function(){a=!0},setStoreURL:function(a){B=a}}}();
Kindle.URL=function(){function b(){return window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname}function e(b){for(var e={},b=b.split("&"),o=0;o<b.length;o++){var f;f=b[o].split("=");var s=f[0],p="";f.length>1&&(p=f[1]);f={key:s,value:p};f.key&&(e[f.key]=decodeURIComponent(f.value))}return e}function f(b){var e="";b.indexOf("?")===0&&b.length>1&&(e+=b.substring(1));return e}function j(b){var e="";b&&(e+="?"+b);return e}function h(b){var e={},f;for(f in b)s.indexOf(f)>
-1&&(e[f]=b[f]);return e}function l(b){var e=o();e[b]&&delete e[b];b=$.param(e);b=j(b);k(b)}function k(b){b=window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname+b+window.location.hash;if(window.history.replaceState)try{window.history.replaceState(document.title,document.title,b)}catch(e){}}function o(){var b={},n=window.location.search;n&&(b=f(n),b=e(b));return b=h(b)}var s=["basePath","srsBasePath","useNewPath","key","bucket","version","maxDBSize",
"useProdBucket","language","stringIDMode","region","host","hostVersion","clear","asin","lnd","ip"];return{normalizeQueryString:function(){var b=o(),n=b.siteState;if(n){var n=decodeURIComponent(n),n=f(n),n=e(n),s;for(s in n)b[s]=n[s]}b=$.param(b);b=j(b);k(b)},removeQueryParameter:l,removeASIN:function(){l("asin")},getQueryParameters:o,getFragIdParameters:function(){var b={};window.location.hash.length>0&&window.location.hash.substring(1).split("&").forEach(function(e){e=e.split("=");e.length===2&&
(b[e[0]]=decodeURIComponent(e[1]))});return b=h(b)},getBaseURL:b,getHostURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port},getBasePathURL:function(){return b().replace(/[^\/]*\.html$/,"")},getLandingPageURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port+"/about"},getSiteState:function(){var b="",e=window.location.search;e&&(e=encodeURIComponent(e),b+="siteState="+e);return b}}}();
var KindleUpgradeDeviceDetector=function(){function b(b,f,j){if((b=RegExp(/^metro@(\d+)\.(\d+)\.(\d+)\.(\d+)$/i).exec(b))&&b.length===5){for(var b=b.slice(1,5),h=0;h<f.length;h++)if(b[h]<f[h]||b[h]>j[h])return!1;return!0}}return{isMetroUpdateRequiredBecauseVersionNonSupported:function(){KindleHostDeviceDetector.isMetro();return!1},isMetroUpdateRequiredBecauseI18NSupported:function(e,f){if(!KindleHostDeviceDetector.isMetro())return!1;var j=[1,0,2,0],h=[1,0,2,9999],l=!!KindleHostDeviceDetector.isOnline();
return["de","es","it","fr","pt"].indexOf((f||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2))>-1&&e&&l?b(e,j,h):!1},isMetroUpdateRequiredBecauseCountryNotSupported:function(e,f,j){var h=jQuery.Deferred(),l=[1,0,2,0],k=[1,0,2,9999],o=!!KindleHostDeviceDetector.isOnline(),f=(f||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2);if(!KindleHostDeviceDetector.isMetro()||!o||!b(e,l,k))return h.resolve(!1).promise();e="/kcrservice/checkBLCountry?lang="+f;j&&(e+="&ip="+j);$.ajax({url:e,
dataType:"json"}).then(function(b){h.resolve(b?b.value:!1)},function(){h.resolve(!1)});return h.promise()}}}(),ResourceBundle=function(b,e){function f(b){if(k[b])return b;if(b.length===2)return u[b];var m=u[b.substr(0,2).toLowerCase()];if(m)return m;KindleDebug.error("No strings for lanuguage: "+b);return"en-US"}function j(b){b=b.toUpperCase();o[b]||KindleDebug.error("No formats for region: "+b);n=b}function h(b,m){function e(b,f){var p=m[f];delete m[f];return p}for(var f=/\$\{([A-Za-z0-9_]+)\}/g,
m=$.extend({},m),n;f.exec(b)&&n!==b;)n=b,b=b.replace(f,e);return b}function l(b){return b.substr(3,2).toUpperCase()}var k=b,o=e,s=!1,y="en-US",n="US",u={de:"de-DE",en:"en-US",es:"es-ES",fr:"fr-FR",it:"it-IT",pt:"pt-BR"},v=function(b,m){if(s)return b;if(k[m])return k[m][b]},r={en:["the ","a ","an "],de:["die ","der ","das ","des ","dem ","den ","ein ","eine ","einer ","einem ","einen "],es:["el ","la ","los ","las ","un ","una ","unos ","unas "],pt:["o ","a ","os ","as ","um ","uma ","uns ","umas "],
fr:["le ","la ","l'","les ","un ","une ","des "],it:["il ","lo ","la ","l'","i ","gli ","le ","un ","uno ","una ","un'"]};return{setLanguageCultureAndRegion:function(b,m){b&&(y=f(b));m?j(m):!m&&b&&b.length>=5&&j(l(b))},getFormatRegion:function(){return n},getLanguage:function(){return y},getLocalizedString:function(b,m,e){var n=y;e&&(n=f(e));e=v(b,n);typeof e!=="string"&&(n!=="en_US"&&(e=v(b,"en_US")),e||(e=b));m&&(e=h(e,m));return e},getLocalizedTime:function(b){return $.format.date(b,o[n].k_format_time)},
getLocalizedDate:function(b){return $.format.date(b,o[n].k_format_date)},getLocalizedDateTime:function(b){return $.format.date(b,o[n].k_format_date_time)},getLocalizedArticles:function(){var b;b=y.substr(0,2).toLowerCase();return r[b]},setStringIDMode:function(b){s=!!b},languageCultureNameToRegion:l}}(Kindle.strings,Kindle.formats);
function AppCacheEventProvider(b){function e(){o=!1;k=-1;s.done(function(){});KindleBuildInfo.getCurrentTotalAppcacheFileCount().then(s.resolve,s.reject)}function f(b,e,f){function k(){l.callEventListeners(b,e)}s.then(k,k);f&&(o=!0,s=jQuery.Deferred())}function j(b){o&&e();f("checking",b,!1)}function h(b){o&&e();k+=1;if(b.total!==void 0&&b.loaded!==void 0)s.resolve(b.total+1),l.callEventListeners("progress",b);else{var f=function(){b.loaded=k;return function(e){b.total=e===-1?-1:e-1;l.callEventListeners("progress",
b)}}();s.then(f,f)}}var l=ListenerManager(),k=-1,o=!0,s;s=jQuery.Deferred();(function(){typeof b.addEventListener==="function"&&(b.addEventListener("error",function(b){f("error",b,!0)}),b.addEventListener("cached",function(b){f("cached",b,!0)}),b.addEventListener("noupdate",function(b){f("noupdate",b,!0)}),b.addEventListener("updateready",function(b){f("updateready",b,!0)}),b.addEventListener("downloading",function(b){f("downloading",b,!1)}),b.addEventListener("checking",j,!1),b.addEventListener("progress",
h,!1))})();var y={status:0,abort:b.abort,update:b.update,swapCache:b.swapCache,addEventListener:l.addEventListener,removeEventListener:l.removeEventListener};$.extend(y,CreateAppCacheConstants());return y}function CreateAppCacheConstants(){var b={},e=window.applicationCache.constructor.prototype,f;for(f in e)["number","string"].indexOf(typeof e[f])>=0&&(b[f]=e[f]);return b}
var KindleAppCacheEventHandler=function(){function b(){u={timer:_metricsManager.createTimer(),loaded:0,total:0}}function e(){b()}function f(){KindleHostDeviceDetector.isNetworkAvailableSync()?(r.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserFailed",{breakdown:["Browser"]}):v.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RetryFailed",{breakdown:["Browser"]}):u.timer.emit("KindleApp:AppCacheError:FirstTime",{breakdown:["Browser"]}),u.timer.emit("KindleApp:AppCacheError",
{submetrics:[{name:"progress",value:u.total}],breakdown:["Browser"]}),KindleHostDeviceDetector.isiOS_4x()&&u.loaded===u.total&&v.getValue()>=1?(o(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART),r.increment(),_metricsManager.emit("KindleApp:AppCacheError:SafariRebootPrompt",{breakdown:["Browser"]})):(o(Kindle.APP_CACHE.CACHE_NEEDS_RETRY),v.increment(),_metricsManager.emit("KindleApp:AppCacheError:RetryPrompt",{breakdown:["Browser"]})),KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.isOnline()&&
n==="CHECKING"&&KindleLocalStorage.localStorageObject&&KindleLocalStorage.localStorageObject.getItem("cached")&&(_metricsManager.emit("KindleApp:AppCacheError:OnlineInstafail",{breakdown:["Browser"]}),KindleLocalStorage.localStorageObject.setItem("cached",0),KindleHostDeviceDetector.isiOSAppMode()&&(_metricsManager.emit("KindleApp::iOSAppModeAppCacheFix"),KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register())),n=""):o(Kindle.APP_CACHE.CACHE_DONE)}function j(e){u===null&&
b();o(Kindle.APP_CACHE.CACHE_PROGRESS,{progressRatio:e.total?e.loaded+1/e.total+1:0});n="";u.loaded=e.loaded+1;u.total=e.total+1}function h(){r.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserSucess",{breakdown:["Browser"]}):v.getValue()>0&&_metricsManager.emit("KindleApp:AppCacheError:RetrySucess",{breakdown:["Browser"]});v.reset();r.reset()}function l(){n="";o(Kindle.APP_CACHE.CACHE_DONE);h();u.timer.emit("KindleApp:AppCacheUpdate",{submetrics:[{name:"progress",value:u.loaded}],
breakdown:["Browser"]})}function k(){n="";o(Kindle.APP_CACHE.CACHE_CACHED);KindleLocalStorage.localStorageObject&&!KindleLocalStorage.localStorageObject.getItem("cached")&&KindleLocalStorage.localStorageObject.setItem("cached",1);h();u&&u.loaded&&u.timer.emit("KindleApp:AppCacheSuccess",{submetrics:[{name:"progress",value:u.loaded}],breakdown:["Browser"]})}function o(b,e){e||(e={});p=b;y.callEventListeners(b,e)}var s,y=ListenerManager(),n="",u=null,v,r,p;return{initialize:function(b,o,h){_metricsManager=
o;typeof Kindle==="undefined"&&(Kindle=h);v=LocalStorageCounter("AppCacheRetryCount");r=LocalStorageCounter("AppCacheBrowserRestartCount");s=b;n=["UNCACHED","IDLE","CHECKING","DOWNLOADING","UPDATE READY","OBSOLETE"][s.status];try{s.addEventListener("checking",e,!1),s.addEventListener("error",f,!1),s.addEventListener("progress",j,!1),s.addEventListener("cached",k,!1),s.addEventListener("noupdate",k,!1),s.addEventListener("updateready",l,!1)}catch(p){}},getCacheStatus:function(){return p},removeEventListener:function(b,
e){y.removeEventListener(b,e)},addEventListener:function(b,e,f){y.addEventListener(b,e,f)}}}(),KindleAppCacheManager=function(){function b(b){if(KindleHostDeviceDetector.isiOS_4x()||KindleHostDeviceDetector.isFirefox())b=AppCacheEventProvider(b);try{KindleAppCacheEventHandler.initialize(b,l,k),f.resolve(KindleAppCacheEventHandler)}catch(e){f.reject()}}function e(e,s){l=e;k=s;f=$.Deferred();h?j||(j=$(document.createElement("iframe")).attr("seamless",!0).css("display","none").css("visibility","hidden").attr("src",
KINDLE_APPCACHER_SRC)[0],$(document.body).append($(j)),KindleDebug.log("AppCacheIframe created")):b(window.applicationCache);return f.promise()}var f,j,h,l,k;return{initialize:function(b){var f=[KindleModuleManager.METRICS_MANAGER,KindleModuleManager.CONSTANTS];(h=KindleHostDeviceDetector.isFirefox())&&f.push(b);KindleModuleManager.define(Kindle.MODULE.APPCACHE_EVENTHANDLER,f,e)},connectIframeAppCache:b}}();
BexBrowserHostSerializer={postObjectToHost:function(b,e){window.parent.postMessage({method:b,param:e},"*")},postObjectToBookExtras:function(b,e){var f={method:b,param:e};$('iframe[id^="bex"]')[0].contentWindow.postMessage(f,"*")},receiveMessage:function(b){if(b.origin.match(/\.amazon\.com:?\d*$/)&&BexBrowserHost[b.data.method])BexBrowserHost[b.data.method](b.data.param)}};window.addEventListener("message",BexBrowserHostSerializer.receiveMessage,!1);
BexK4WBrowserHost=function(){return function(b,e){this.onBookExtrasReady=function(){e.onBookExtrasReady()};this.closeBookExtras=function(){e.closeBookExtras()};this.openStoreFromBex=function(b){e.openStoreFromBex(b)};this.logMetric=function(b){e.logMetric(b)};this.logBexStatus=function(b){e.logBexStatus(b)};this.onOrientationChanged=function(){setTimeout(function(){BexBrowserHostSerializer.postObjectToBookExtras("onOrientationChanged",{screenWidth:Kindle.top.innerWidth,screenHeight:Kindle.top.innerHeight})},
500)}}}();
BexBrowserHost=function(){return function(){this.pageReady=function(){BexBrowserHostSerializer.postObjectToHost("onBookExtrasReady")};this.closeBookExtras=function(){BexBrowserHostSerializer.postObjectToHost("closeBookExtras")};this.openStoreFromBex=function(b){BexBrowserHostSerializer.postObjectToHost("openStoreFromBex",b)};this.logMetric=function(b){BexBrowserHostSerializer.postObjectToHost("logMetric",b)};this.logBexStatus=function(b){BexBrowserHostSerializer.postObjectToHost("logBexStatus",b)};
this.onOrientationChanged=function(){}}}();function AssertionError(b){Error.call(this,b)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){return{multiColumnMode:function(){return!KindleHostDeviceDetector.isMetroArm()}}}(),KindleHostDeviceDetector=function(){function b(){return navigator.platform.indexOf("iPad")!==-1}function e(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function f(){return b()||e()||y()||j()}function j(){return navigator.userAgent.indexOf("Cloud9")!==
-1}function h(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function l(){return h()&&/arm/i.test(navigator.cpuClass)}function k(){return navigator.onLine}function o(){return"standalone"in navigator&&navigator.standalone}function s(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function y(){return navigator.userAgent.indexOf("PlayBook")!==-1}function n(){return!!window.navigator.msPointerEnabled}return{isiOS:f,isiPad:b,isiPhone:e,isiOS_4x:function(){return(b()||
e())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){var f;if(f=b()||e()){f=navigator.userAgent.indexOf("OS ");var o=0;if(f===-1)f=0;else{for(f+=3;/^\d$/.test(navigator.userAgent.charAt(f));)o=o*10+parseInt(navigator.userAgent.charAt(f),10),f++;f=o}f=f>=5}return f},isFirefox:function(){return navigator.userAgent.indexOf("Firefox")!==-1},isSafari:function(){return navigator.userAgent.indexOf("Safari")!==-1},isMetro:h,isMetroArm:l,isMetroSnappedView:function(){return h()&&$(window).width()===
320},isIE:function(){return navigator.userAgent.indexOf("MSIE")!==-1},isPlayBook:y,isCloud9:j,isTablet:function(){return b()||h()},isOnline:k,isNetworkAvailable:function(){if(!k())return(new jQuery.Deferred).reject().promise();var b=$.ajax({url:"/ping",error:function(){b.reject()},timeout:5E3});return b.promise()},isNetworkAvailableSync:function(){if(!k())return!1;var b=!0;$.ajax({url:"/ping",error:function(){b=!1},timeout:50,async:!1});return b},isChrome:function(){return window.chrome},isiOSAppMode:o,
isChromeApp:s,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return o()||s()},isCookieEnabled:function(){return navigator.cookieEnabled},isLocalStorageEnabled:function(){if(KindleLocalStorage.localStorageObject===null)return!1;try{KindleLocalStorage.localStorageObject.setItem("testLocalStorage","1"),KindleLocalStorage.localStorageObject.removeItem("testLocalStorage")}catch(b){return!1}return!0},isWebSQLSupported:function(){return!!window.openDatabase},
isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.webkitIndexedDB||!!window.msIndexedDB||!!window.indexedDB},isMSPointerEnabled:n,isTouchDevice:function(){return f()||n()||y()},getDevicePlatform:function(){return b()?"iPad":e()?"iPhone":y()?"playBook":j()?"otter":l()?"metroArm":h()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return b()&&KindleHostPadDetector.isPad1(o())||l()},getDeviceType:function(){return h()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return h()?
Kindle.ClientName.Metro:Kindle.ClientName.KCR},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(b){if(KindleLocalStorage.localStorageObject.getItem("definitelyNotPad1"))return!1;var e=0,f=1E3,j=0,h;for(i=0;i<3;i++)h=SunSpiderBenchmark.get3DSpeed(),h>e?e=h:h<f&&(f=h),j+=h;e=j/3;if(e>=200&&b)return!0;if(e>=100&&!b)return!0;KindleLocalStorage.localStorageObject.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function b(b,f){for(var j in f)if(f.hasOwnProperty(j)&&typeof b[j]!==typeof f[j])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},onBookExtrasOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},
removeBook:function(){}},IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openBookExtras:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},hideAppBar:function(){}},checkImplements:b,assertImplements:function(e,f){b(e,f)||
KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function b(b){var e=[],f;for(f in b){var k=b[f].entry;k.guid=k.guid||k.refEmId;delete k.refEmId;k&&e.push(k)}return e}function e(b){var e=[],f;for(f in b)e.push({entry:b[f]});return l.getAppDb().getTable(h).insertList(e)}function f(e){function f(){var v;j<e.length?(u=Math.min(j+100,e.length),v=Array.prototype.slice.call(e,j,u),j=u,k.updateAnnotations(b(v),KindleLocale.getLocalTimeOffset()).then(function(){l.getAppDb().deleteJournalEntries(v).then(f,
h.reject)},h.reject)):h.resolve()}var h=new jQuery.Deferred,j=0,u;f();return h.promise()}function j(){var b=new jQuery.Deferred;l.getAppDb().getTable(h).getRecord().then(function(e){e.length>0?f(e).then(b.resolve,b.reject):b.resolve()},b.reject);return b.promise()}var h="journal",l=null,k=null;return{initialize:function(){var b=new jQuery.Deferred,e=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT]).then(function(f){k=f[KindleModuleManager.SERVICE_CLIENT];
l=f[KindleModuleManager.DB_CLIENT];b.resolve(e)},b.reject);return b.promise()},saveToJournal:function(b){var f=new jQuery.Deferred;e(b).then(function(){j().then(f.resolve,f.resolve)},f.reject);return f.promise()},uploadJournal:j}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")},
setDeviceToken:function(b){KindleLocalStorage.localStorageObject.setItem("kindleDeviceToken",b)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.localStorageObject.removeItem("kindleDeviceToken")}}}(),KindleLocalStorage=function(){function b(){var b={getItem:function(b){return!b||!this.hasOwnProperty(b)?null:unescape(document.cookie.replace(RegExp("(?:^|.*;\\s*)"+escape(b).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"))},key:function(b){return unescape(document.cookie.replace(/\s*\=(?:.(?!;))*$/,
"").split(/\s*\=(?:[^;](?!;))*[^;]?;\s*/)[b])},setItem:function(b,e){if(b)document.cookie=escape(b)+"="+escape(e)+"; path=/",this.length=document.cookie.match(/\=/g).length},length:0,removeItem:function(b){if(b&&this.hasOwnProperty(b)){var e=new Date;e.setDate(e.getDate()-1);document.cookie=escape(b)+"=; expires="+e.toGMTString()+"; path=/";this.length--}},hasOwnProperty:function(b){return RegExp("(?:^|;\\s*)"+escape(b).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}};b.length=(document.cookie.match(/\=/g)||
b).length;return b}var e=null;try{if("localStorage"in window&&window.localStorage!==null&&window.localStorage)e=window.localStorage}catch(f){KindleDebug.error("Exception: Detecting local storage threw an exception."),KindleHostDeviceDetector.isIE()&&(KindleDebug.log("Using a 'localStorage' polyfill"),e=b())}return{localStorageObject:e}}(),KindleLocale=function(){var b=-(new Date).getTimezoneOffset();return{getLocalTimeOffset:function(){return b},getCountryCode:function(){return"US"}}}(),KindleMetricsProfiler=
function(b){function e(b){for(var e=0,f=0;f<b.length;f+=1)e+=b[f].end-b[f].start;return e}var f={};f.name=b;f.counters=null;f.subTimers=null;f.runs=[{start:(new Date).getTime(),end:null}];f.endTimer=function(){var b=this.runs[this.runs.length-1];if(b.end===null)b.end=(new Date).getTime()};f.addCount=function(b,e){if(this.counters===null)this.counters={};this.counters[b]===void 0?this.counters[b]=e:this.counters[b]+=e};f.createSubTimer=function(b){if(this.subTimers===null)this.subTimers={};this.subTimers[b]===
void 0?this.subTimers[b]=KindleMetricsProfiler(b):this.subTimers[b].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[b]};f.log=function(){this.logAsPercentageOfTime("",e(this.runs))};f.logAsPercentageOfTime=function(b,f){var l=b+":"+this.name,k;e(this.runs);for(k in this.counters);for(k in this.subTimers)this.subTimers[k].logAsPercentageOfTime(l,f)};return f};
function KindleModuleManagerFactory(){function b(b,e){if(r[b])throw"Duplicate registration of module "+b;if(!e)throw"Module is not initialized with an object "+b;r[b]=e;p[b].resolve(e)}function e(b){if(r.hasOwnProperty(b))throw"Duplicate registration of module "+b;r[b]=void 0}function f(e,f){p[e]||(p[e]=new jQuery.Deferred);b(e,f)}function j(f,k){e(f);p[f]||(p[f]=new jQuery.Deferred);k(p[f]);p[f].done(function(e){b(f,e)})}function h(b,e){j(b,function(b){e.done(b.resolve).fail(b.reject)})}function l(b){p[b]||
(p[b]=new jQuery.Deferred);return p[b].promise()}function k(b){if(!r[b])throw"Trying to get uninitialized module "+b;return r[b]}function o(b){return r.hasOwnProperty(b)}function s(b,e){r[b]=e}function y(b){var e=r[b];return{done:function(b){b(e)},fail:function(){},when:function(b){b(e)}}}function n(b){for(var e={},f=0;f<b.length;f++)e[name]=r[b];return{done:function(b){b(e)},fail:function(){},when:function(b){b(e)}}}function u(){r={}}var v={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",BOOKINFO:"bookinfo",NETWORK:"network"},r={},p={};return{CONSTANTS:v.CONSTANTS,DB_CLIENT:v.DB_CLIENT,RESOURCE_BUNDLE:v.RESOURCE_BUNDLE,METRICS_MANAGER:v.METRICS_MANAGER,SERVICE_CLIENT:v.SERVICE_CLIENT,APP_REGISTRATION:v.APP_REGISTRATION,JOURNAL_MANAGER:v.JOURNAL_MANAGER,BOOK_METADATA:v.BOOK_METADATA,BOOK_FRAGMAP:v.BOOK_FRAGMAP,
BOOKINFO:v.BOOKINFO,NETWORK:v.NETWORK,ERROR_CODE_CANCEL:"canceled",registerModule:f,registerModuleList:function(b){for(var e in b)f(e,b[e])},registerModuleWithInitializer:j,registerModuleWithDeferred:h,detachModule:function(b){var e=r[b],f=p[b];f&&!f.isResolved()&&f.reject("canceled");delete r[b];delete p[b];return e},getModule:l,getModuleList:function(b){var e=new jQuery.Deferred,f,k=[];for(f=0;f<b.length;f++)k.push(l(b[f]));$.when.apply($,k).done(function(){var f,k={};for(f=0;f<b.length;f++)k[b[f]]=
arguments[f];e.resolve(k)}).fail(e.reject);return e.promise()},getModuleSync:k,isModuleInitialized:function(b){return r[b]!==void 0},isModuleRegistered:o,switchToTestMode:function(){this.registerModuleTest=s;this.getModule=y;this.getModuleSync=k;this.getModuleList=n;this.clear=u;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},define:function(b,e,f){if(!o(b)){var k=[],p=$.Deferred();h(b,p);e&&e.length&&e.forEach(function(b){k.push(b&&$.isFunction(b.promise)?b:l(b))});
$.when.apply($,k).then(function(){var b;typeof f==="function"?(b=$.makeArray(arguments),b=f.apply(f,b)):b=f;b&&$.isFunction(b.promise)?b.then(p.resolve,function(){p.reject()}):p.resolve(b)},function(){p.reject()})}},require:function(b,e){$.isArray(b)||(b=[b]);var f,k,p=[];b.forEach(function(b){p.push(b&&$.isFunction(b.promise)?b:l(b))});e||(k=$.Deferred(),f=k.promise());$.when.apply($,p).done(function(){var b=$.makeArray(arguments);e?e.apply(e,b):k.resolve.apply(k,b)},function(){e&&k.reject()});return f}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{getStoreURL:function(){var b=new jQuery.Deferred;$.get("/remote/store").then(function(e){(e=e.url)?b.resolve(e):b.reject()},b.reject);return b.promise()},uploadFeedback:function(b){if(!b)return(new $.Deferred.reject).promise();var e={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth},e={version:KindleVersion.getVersionString(),
message:b.text,info:e};if(KindleHostDeviceDetector.isMetro()&&b.eid&&b.deviceType)e.eid=b.eid,e.deviceType=b.deviceType;b={url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(e)};return $.ajax(b)}}}(),KindleUserAgentMetricsInfo=function(){function b(b){if(b){var e=/^0*([0-9]+)/.exec(b);if(e&&e.length>=2)return parseInt(e[1],10);else KindleDebug.error("Bad regex on versionString: "+b)}}function e(){j=GoogleUserAgent.browserName.toLowerCase();h=GoogleUserAgent.browserVersionString.toLowerCase();
(function(){var b;["ipad","iphone"].indexOf(j)!==-1&&((b=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&b.length>=2&&(h=b[1]),osName=j="ios")})();(function(){var b=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);b&&(h=b[1]);osName="metro"})();l=b(h);s="undefined"===typeof l?o:y[j]?[j,l].join(k):o;f=!0}var f,j,h,l,k="@",o="other",s,y={chrome:14,firefox:7,safari:5,metro:1,ie:9,ios:4};return{browserWithVersionString:function(){f||e();return s}}}(),KindleVersion=function(){var b=null,e=null;return{getMetricsVersion:function(){e||
(e=parseInt("010405021".slice(0,2),10),e+=".",e+=parseInt("010405021".slice(2,4),10),e+=".",e+=parseInt("010405021".slice(4,6),10));return e},getVersionString:function(){b||(b=parseInt("010405021".slice(0,2),10),b+=".",b+=parseInt("010405021".slice(2,4),10),b+=".",b+=parseInt("010405021".slice(4,6),10),b+=".",b+=parseInt("010405021".slice(6),10));return b},getVersion:function(){return Number("010405021")}}}(),KindleAppDb=function(b){function e(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb()}
function f(b){var e=new jQuery.Deferred;l.getRecord("keyValue",{key:b}).then(function(b){b&&b.length>0&&e.resolve(b[0].value);e.reject()},e.reject);return e.promise()}function j(b,e){return l.upsertRecord("keyValue",{value:e},{key:b})}function h(b){return l.deleteRecord("keyValue",{key:b})}var l=b;b.updateBookData=function(b,f,h,j,n){function u(b){if(b.length<1||!e())return(new jQuery.Deferred).resolve().promise();var f=new jQuery.Deferred;e().deleteBooksData(b).then(f.resolve,f.resolve);return f.promise()}
var v,r,p=[],m=[];for(v in b)m.push(b[v].asin),p.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:b[v].asin}]});for(v in f)b=f[v],p.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"bookdata",params:[b,{asin:b.asin}]});r=p.length;p.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"keyValue",params:[{value:String(h)},{key:"synctime"}]});l.batchTransaction(p).done(function(){u(m).done(function(){j(r)})}).fail(n)};b.getAllBooks=function(b){l.getRecord("bookdata").done(b)};
b.getBook=function(b,e){l.getRecord("bookdata",{asin:b}).done(function(b){e(b.length>0?b[0]:{})})};b.getBookDataLastSyncTime=function(b){f("synctime").done(function(e){b(e?e:Kindle.DB.NEVER)}).fail(function(){b(Kindle.DB.NEVER)})};b.updateLastPositionRead=function(b,e,f,h){l.updateRecord("bookdata",{lastPositionRead:e,lastTimeRead:f},{asin:b}).fail(h)};b.updateLastFPRSyncTime=function(b,e,f){l.updateRecord("bookdata",{lastFPRSyncTime:e},{asin:b}).fail(f)};b.updateLastReadTime=function(b,e,f,h){l.upsertRecord("bookdata",
{lastTimeRead:e,lastFPRSyncTime:f},{asin:b}).fail(h)};b.updateMaxPosition=function(b,e,f){l.updateRecord("bookdata",{maxPosition:e},{asin:b}).fail(f)};b.getBookExtras=function(b,e){var f=KindleLocalStorage.localStorageObject.getItem(Kindle.BOOKEXTRAS.BEX_LOCAL_STORAGE+b),f=[{isAvailable:parseInt(f,10),asin:b}];e(f)};b.updateBookExtras=function(b,e){KindleLocalStorage.localStorageObject.setItem(Kindle.BOOKEXTRAS.BEX_LOCAL_STORAGE+b,e)};b.getDeviceToken=function(){return f(Kindle.Service.DeviceTokenKey)};
b.setDeviceToken=function(b){return j(Kindle.Service.DeviceTokenKey,b)};b.clearDeviceToken=function(){return h(Kindle.Service.DeviceTokenKey)};b.getUserHashId=function(){return f(Kindle.Service.UserHashIdKey)};b.setUserHashId=function(b){return j(Kindle.Service.UserHashIdKey,b)};b.clearUserHashId=function(){return h(Kindle.Service.UserHashIdKey)};b.getEID=function(){return f(Kindle.Service.EidKey)};b.setEID=function(b){return j(Kindle.Service.EidKey,b)};b.clearEID=function(){return h(Kindle.Service.EidKey)};
b.getValueForKey=f;b.setValueForKey=j;b.removeValueForKey=h;b.getValuesForKeys=function(b){for(var e=[],f=new jQuery.Deferred,h=0;h<b.length;h++)e.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"keyValue",params:[{key:b[h]}]});l.batchTransaction(e).then(function(b){for(var e,h={},k=0;k<b.length;k++)if(b[k]&&b[k].length)e=b[k][0],h[e.key]=e.value;f.resolve(h)},f.reject);return f.promise()};b.getCachedAsins=function(b){function f(e){var j,l=[];for(j=0;j<e.length;j++)b.indexOf(e[j].cacheState)>=
0&&l.push(e[j]);h.resolve(l)}var h=new jQuery.Deferred;e()?e().getRecord("bookinfo",null,{asin:!0,cacheState:!0,cachedSize:!0}).then(b?f:h.resolve,h.reject):h.resolve([]);return h.promise()};b.getCachedCovers=function(){function b(e){var h,k={};for(h=0;h<e.length;h++)k[e[h].asin]=e[h].coverData;f.resolve(k)}var f=new jQuery.Deferred;e()?e().getRecord("covers",null).then(b,f.reject):b([]);return f.promise()};b.getBookCachedState=function(b){return e()?e().getRecord("bookinfo",{asin:b},{cacheState:!0}):
(b=new jQuery.Deferred,b.resolve([]),b.promise())};b.getPinnedSessionIds=function(){function b(e){var f,j=[];if(e)for(f=0;f<e.length;f++)j.push(e[f].context.kindleSessionId);h.resolve(j)}function f(){h.resolve([])}var h=new jQuery.Deferred;e()?e().getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{context:!0}).then(b,f):h.resolve([]);return h.promise()};return b},KindleBookDb=function(b){function e(){switch(KindleHostDeviceDetector.getDevicePlatform()){case "iPad":case "iPhone":case "playBook":return 5E7;
case "desktop":return 5E8;default:return 5E8}}function f(b,a){var g={},d;for(d in b)b.hasOwnProperty(d)&&!a[d]&&(g[d]=b[d]);g=JSON.stringify(g);return g==="{}"?"":g}function j(b,a){if(a){var g=JSON.parse(a),d;for(d in g)g.hasOwnProperty(d)&&(b[d]=g[d])}return b}function h(b,a,g,d,c,e){var f=(new Date).getTime();w.getRecord(b,{asin:g,id:{operator:Kindle.DB.IN_ARRAY,values:d}}).then(function(b){a(b,f,c)},function(a){e(a)})}function l(b,a,g,d,c,e){(new Date).getTime();var f=0,K,P=[],T;for(T in d)K=a(g,
d[T]),f+=K.size,P.push(K);w.insertList(b,P).then(function(){(new Date).getTime();c(f)},function(a){e(a)})}function k(b,a,g,d){var c=KindleMetricsProfiler("getIds:"+b);w.getPieceIds(b,a).then(function(b){c.addCount(a,b.length);c.endTimer();c.log();g(b)},function(a){d(a)})}function o(b,a,g){(new Date).getTime();var a=[],d=0,c;for(c in b){var e=b[c],f=e.id;d+=e.piece.length+e.metadata.length;a[f]=j({fragmentData:e.piece,fragmentMetadata:JSON.parse(e.metadata)},e.other)}(new Date).getTime();g(a);(new Date).getTime()}
function s(b,a){var g=a.fragmentData,d=JSON.stringify(a.fragmentMetadata),c=f(a,{fragmentData:1,fragmentMetadata:1});return{asin:b,id:a.fragmentMetadata.id,size:g.length+d.length+c.length,piece:g,metadata:d,other:c}}function y(b,a,g){(new Date).getTime();var a=[],d;for(d in b){var c=b[d];a[c.id]=j({skeletonData:c.piece,skeletonMetadata:JSON.parse(c.metadata)},c.other)}(new Date).getTime();g(a)}function n(b,a){var g=a.skeletonData,d=JSON.stringify(a.skeletonMetadata),c=f(a,{skeletonData:1,skeletonMetadata:1});
return{asin:b,id:a.skeletonMetadata.id,size:g.length+d.length+c.length,piece:g,metadata:d,other:c}}function u(b,a,g){(new Date).getTime();var a=[],d=0,c;for(c in b){var e=b[c],f=e.id;d+=e.piece.length+e.metadata.length;a[f]=j({glyphData:JSON.parse(e.piece),glyphFragmentMetadata:JSON.parse(e.metadata)},e.other)}(new Date).getTime();g(a);(new Date).getTime()}function v(b,a){var g=JSON.stringify(a.glyphData),d=JSON.stringify(a.glyphFragmentMetadata),c=f(a,{glyphData:1,glyphFragmentMetadata:1});return{asin:b,
id:a.glyphFragmentMetadata.id,size:g.length+d.length+c.length,piece:g,metadata:d,other:c}}function r(b,a,g){(new Date).getTime();var a=[],d=0,c;for(c in b){var e=b[c],f=e.id;d+=e.piece.length+e.metadata.length;a[f]=j({data:JSON.parse(e.piece),metadata:JSON.parse(e.metadata)},e.other)}(new Date).getTime();g(a);(new Date).getTime()}function p(b,a){var g=JSON.stringify(a.data),d=JSON.stringify(a.metadata),c=f(a,{data:1,metadata:1});return{asin:b,id:a.metadata.id,size:g.length+d.length+c.length,piece:g,
metadata:d,other:c}}function m(b,a,g){(new Date).getTime();var a=[],d=0,c;for(c in b){var e=b[c],f=e.id;d+=e.piece.length+e.metadata.length;a[f]=j({locations:JSON.parse(e.piece),metadata:JSON.parse(e.metadata)},e.other)}(new Date).getTime();g(a);(new Date).getTime()}function z(b,a){var g=JSON.stringify(a.locations),d=JSON.stringify(a.metadata),c=f(a,{locations:1,metadata:1});return{asin:b,id:a.metadata.id,size:g.length+d.length+c.length,piece:g,metadata:d,other:c}}function D(b){return w.dbDeleteBooksData(b)}
function t(b){return w.dbGetBookStatistics(b)}function B(){var b=new jQuery.Deferred;w.getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{cachedSize:!0}).then(function(a){var g=0,d;for(d in a)g+=a[d].cachedSize;b.resolve(g)},function(){b.reject()});return b.promise()}function G(){var b=new jQuery.Deferred;B().then(function(a){a=e()-1E6-a*2.4;a=Math.round(a/2.4);b.resolve(a)},function(){b.resolve(0)});return b.promise()}var w=b,q=null;b.deleteBooksData=D;b.deleteOtherBooksData=function(b){for(var a=
new jQuery.Deferred,g=["fragments","glyphs","skeleton","bookinfo","annotationsCache","covers"],d=[],c=0;c<g.length;c++)d.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:g[c],params:[{asin:{operator:Kindle.DB.NOT_EQUAL,values:[b]}}]});w.batchTransaction(d).then(function(){a.resolve()},function(b){a.reject(b)});return a.promise()};b.deleteOldestBookData=function(b){function a(){q.resolve(arguments);q=null}function g(){q.reject(arguments);q=null}function d(b){if(!b||b.length===0)KindleDebug.warn("trying to delete oldest asin, but got no list of books"),
g();else{var d=b[0].asin,e=b[0].openTime,f;for(f=1;f<b.length;f++)if(b[f].openTime<e)e=b[f].openTime,d=b[f].asin;D([d]).then(a,g)}}q||(q=new jQuery.Deferred,w.getOldBookList(b).then(d,g));return q};b.getBookStatistics=t;b.BookInfoDB=function(b){function a(){var a=new jQuery.Deferred;G().then(function(b){d=b;a.resolve(b)},function(){d=0;a.resolve()});return a.promise()}var g=0,d=0;return{getFragments:function(a){var d=new jQuery.Deferred;h("fragments",o,b,a,d.resolve,d.reject);return d.promise()},
putFragments:function(a){var d=new jQuery.Deferred;l("fragments",s,b,a,function(a){g+=a;d.resolve(a)},d.reject);return d.promise()},getFragmentIds:function(){var a=new jQuery.Deferred;k("fragments",b,a.resolve,a.reject);return a.promise()},getSkeleton:function(a){var d=new jQuery.Deferred;h("skeleton",y,b,a,d.resolve,d.reject);return d.promise()},putSkeletons:function(a){var d=new jQuery.Deferred;l("skeleton",n,b,a,function(a){g+=a;d.resolve(a)},d.reject);return d.promise()},getSkeletonIds:function(){var a=
new jQuery.Deferred;k("skeleton",b,a.resolve,a.reject);return a.promise()},getGlyphs:function(a){var d=new jQuery.Deferred;h("glyphs",u,b,a,d.resolve,d.reject);return d.promise()},putGlyphs:function(a){var d=new jQuery.Deferred;l("glyphs",v,b,a,function(a){g+=a;d.resolve(a)},d.reject);return d.promise()},getGlyphIds:function(){var a=new jQuery.Deferred;k("glyphs",b,a.resolve,a.reject);return a.promise()},getResources:function(a){var d=new jQuery.Deferred;h("resources",r,b,a,d.resolve,d.reject);return d.promise()},
putResources:function(a){var d=new jQuery.Deferred;l("resources",p,b,a,function(a){g+=a;d.resolve(a)},d.reject);return d.promise()},getResourceIds:function(){var a=new jQuery.Deferred;k("resources",b,a.resolve,a.reject);return a.promise()},getLocations:function(a){var d=new jQuery.Deferred;h("locations",m,b,a,d.resolve,d.reject);return d.promise()},putLocations:function(a){var d=new jQuery.Deferred;l("locations",z,b,a,function(a){g+=a;d.resolve(a)},d.reject);return d.promise()},getLocationMapIds:function(){var a=
new jQuery.Deferred;k("locations",b,a.resolve,a.reject);return a.promise()},getBookInfo:function(){var a=new jQuery.Deferred;w.getRecord("bookinfo",{asin:b}).then(function(b){b.length===1?(g=b[0].cachedSize,a.resolve(b[0])):a.reject()},a.reject);return a.promise()},insertBookInfo:function(a){a=$.extend(!0,{},a,{asin:b,openTime:(new Date).getTime()});return w.insertRecord("bookinfo",a)},updateBookCacheState:function(a){return w.updateRecord("bookinfo",{cacheState:a},{asin:b})},savePinningFinishState:function(a,
d){return w.batchTransaction([{operation:Kindle.DB.UPDATE_RECORD_OPERATION,tableName:"bookinfo",params:[{cacheState:a},{asin:b}]},{operation:Kindle.DB.UPDATE_RECORD_OPERATION,tableName:"bookinfo",params:[{context:d,openTime:(new Date).getTime()},{asin:b}]}])},updateBookContext:function(a){return w.updateRecord("bookinfo",{context:a,openTime:(new Date).getTime()},{asin:b})},getBookStatistics:function(){var a=new jQuery.Deferred;t(b).then(function(d){d.totalSize!==d.cachedSize?(g=d.cachedSize=d.totalSize,
w.updateRecord("bookinfo",{cachedSize:g},{asin:b}).then(function(){a.resolve(d)},a.reject)):a.resolve(d)},a.reject);return a.promise()},getCacheQuota:function(){return{cachedSize:g,cacheQuota:d}},computeCacheQuota:function(){return a().promise()}}};return b},KindleDBClient=function(){function b(){if(!z)throw{name:"databaseInitializationError",message:"Please call initialize function first"};}function e(a){var b=new jQuery.Deferred;a.wrapper?a.wrapper.dropTables().then(b.resolve,b.reject):b.resolve();
return b.promise()}function f(b){if(D)return D.promise();D=new jQuery.Deferred;a.initDfd=new jQuery.Deferred;var d=KindleStubDBWrapper(w);n(!1);d.createTables(q,a.version).then(function(){h(d);KindleAppDb(d);a.wrapper=d;a.initDfd.resolve(d);G=t=d;z=!0;D.resolve(b)},function(a){D.reject(a)});return D.promise()}function j(){function a(){++f===e&&(G=null,KindleStubDBWrapper(w).dropTables(),d.resolve())}function b(g){return function(b){var e=[],f;for(f in b)e.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,
tableName:g,params:[b[f],b[f]]});t.batchTransaction(e).then(a,d.reject)}}var d=new jQuery.Deferred;if(!G)return d.resolve(),d.promise();var g=G.getTableNames(),e=g.length,f=0,A;for(A in g)G.getRecord(g[A]).then(b(g[A]),d.reject);return d.promise()}function h(a){function b(d){return{tableName:d,insertRecord:function(b){return a.insertRecord(d,b)},insertList:function(b){return a.insertList(d,b)},updateRecord:function(b,g){return a.updateRecord(d,b,g)},getRecord:function(b,g){return a.getRecord(d,b,
g)},deleteRecord:function(b){return a.deleteRecord(d,b)},batchTransaction:function(b){var g;for(g=0;g<b.length;g++)b[g].tableName=d;return a.batchTransaction(b)}}}var d=a.getTableNames(),g,e;for(e in d)g=d[e],H[g]=b(g);a.getTable=function(a){return H[a]}}function l(b){b.onversionchange=function(){a.handle&&a.handle.close();g.handle&&g.handle.close();setTimeout(function(){function a(){window.location.reload(!0)}_metricsManager.emitNow("App::DatabaseGoneOnVersionZero",{breakdown:["Browser"]}).then(a,
a)},500)}}function k(){function b(){h(d);KindleAppDb(d);a.wrapper=d;a.initDfd.resolve(d)}var d={};if(!a.initDfd)a.initDfd=new jQuery.Deferred,KindleHostDeviceDetector.isWebSQLSupported()?(d=KindleSqlWrapper(a),d.flavor="websql",d.openDatabase().then(function(d){a.handle=d;b();KindleLocalStorage.localStorageObject.setItem("haveDB","1")},a.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(d=KindleIDBWrapper(a),d.flavor="IndexedDB",d.openDatabase().done(function(d){l(d);a.handle=d;KindleLocalStorage.localStorageObject.setItem("haveDB",
"1");b()}).fail(a.initDfd.reject)):f(this);return a.initDfd.promise()}function o(){function a(){h(b);KindleBookDb(b);g.wrapper=b;g.initDfd.resolve(b)}var b={};if(!g.initDfd){g.initDfd=new jQuery.Deferred;try{KindleHostDeviceDetector.isWebSQLSupported()?(b=KindleSqlWrapper(g),b.openDatabase().then(function(d){g.handle=d;a(b)},g.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()&&(b=KindleIDBWrapper(g),b.openDatabase().done(function(b){l(b);g.handle=b;a()}).fail(g.initDfd.reject))}catch(d){g.initDfd.reject()}}return g.initDfd.promise()}
function s(){if(KindleHostDeviceDetector.isChromeApp())return!0;if(KindleHostDeviceDetector.isFirefox()&&KindleLocalStorage.localStorageObject.getItem("haveDB"))return!0;var a=KindleLocalStorage.localStorageObject.getItem("booksdb");if(a==="true")return!0;else if(a==="false")return!1}function y(){return!KindleHostDeviceDetector.isWebSQLSupported()&&!KindleHostDeviceDetector.isIndexedDBSupported()?!1:KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()?!1:!0}function n(a){KindleLocalStorage.localStorageObject.setItem("booksdb",
a?"true":"false")}function u(){var a;a=new jQuery.Deferred;if(B)return a.resolve(B),a.promise();if(!y())return a.reject(),a.promise();g.initDfd=null;o().then(function(b){B=b;n(!0);a.resolve(B)},function(){n(!1);a.reject()});return a.promise()}function v(){var b;b=new jQuery.Deferred;if(t&&t!==G)return b.resolve(t).promise();a.initDfd=null;k().then(function(a){t=a;b.resolve(t)},function(){b.reject()});return b.promise()}function r(a){function b(){t=G;KindleLocalStorage.localStorageObject.removeItem("haveDB");
g.reject()}function d(){u().then(function(){j().then(function(){G=null;KindleLocalStorage.localStorageObject.removeItem(w);g.resolve(a)},b)},b)}var g;return(KindleHostDeviceDetector.isFirefox()?KindleLocalStorage.localStorageObject.getItem("haveDB"):1)?u():(g=new jQuery.Deferred,v().then(d,b),g.promise())}function p(){function a(b,c){t=b;B=c;z=!0;m.resolve(d)}function b(a){KindleHostDeviceDetector.isFirefox()?(KindleLocalStorage.localStorageObject.removeItem("haveDB"),f(d).done(m.resolve)):m.reject(a)}
var g,e;m||(m=new jQuery.Deferred,(KindleHostDeviceDetector.isFirefox()?KindleLocalStorage.localStorageObject.getItem("haveDB"):1)?(g=k(),e=s()?o():(new jQuery.Deferred).resolve(null).promise(),$.when(g,e).then(a,b)):f(d).done(m.resolve));return m.promise()}var m=null,z=!1,D=null,t=null,B=null,G=null,w="app_db_storage",q={bookdata:{asin:17,title:9,authors:12,purchaseDate:10,maxPosition:10,lastTimeRead:10,lastPositionRead:10,lastFPRSyncTime:10},keyValue:{key:17,value:9},metrics:{method:1,time:2,timers:12,
counters:12,breakDown:12},journal:{id:32,entry:4}},H={},a={shortName:"K4W",version:1,displayName:"Kindle Cloud Reader",defaultSize:5E6,initDfd:null,wrapper:null,handle:null,tables:q},g={shortName:"K4Wbooks",version:4,displayName:"Kindle Cloud Reader Books",defaultSize:5E7,initDfd:null,wrapper:null,handle:null,tables:{bookinfo:{asin:17,cacheState:129,cachedSize:10,openTime:2,context:4,metadata:4,manifest:4,fragmap:4},skeleton:{asin:17,id:82,size:2,piece:1,metadata:1,other:1},fragments:{asin:17,id:82,
size:2,piece:1,metadata:1,other:1},glyphs:{asin:17,id:82,size:2,piece:1,metadata:1,other:1},resources:{asin:17,id:82,size:2,piece:1,metadata:1,other:1},locations:{asin:17,id:82,size:2,piece:1,metadata:1,other:1},annotationsCache:{asin:17,annotationsData:4},covers:{asin:17,coverData:1}},versionUpdate:[{version:4,tableName:"bookinfo",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["manifest"]}]},d={enableFullDb:function(){return r(this)},getAppDb:function(){b();return t},getBookDb:function(){b();
return B},bookDbPossible:y,bookDbEnabled:s,setBookDbDisabled:function(){n(!1)},persistDB:function(){t&&t.persist&&t.persist();B&&B.persist&&B.persist()},clear:function(b,d){function f(){a.wrapper=null;t=a.initDfd=null;g.wrapper=null;G=B=g.initDfd=null;z=!1;D=_initializeFullDeferred=null;K.resolve()}var K=new jQuery.Deferred;e(a).then(function(){e(g).then(f,K.reject)},K.reject);K.then(b,d);return K.promise()}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.DB_CLIENT,[Kindle.MODULE.APPLICATION_ARGS],
p)}}}();
function KindleIDBWrapper(b){function e(a){if(!d[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function f(){var a=[],b;for(b in d)a.push(b);return a}function j(a,b,c){if(d[a].info[b]&Kindle.DB.PIECE_ID_TYPE){for(a=""+c;a.length<q;)a="0"+a;return a}else return c}function h(a,b){if(a&&b){e(b);var c=d[b],g="";if(c.genKeyPath)for(var c=c.keyList,f=0;f<c.length;++f){if(a[c[f]]===void 0){g=void 0;break}g+=j(b,c[f],a[c[f]]);f<c.length-1&&(g+=w)}else g=a[c.keyPath];return g}}
function l(a,b,d){for(var c="",g,e,f=0;f<b.length;++f){g=b[f];e=d[g];if(!e)break;e=e.hasOwnProperty(Kindle.DB.OPERATOR)?e[Kindle.DB.VALUES][0]:e;c+=j(a,g,e);f<b.length-1&&(c+=w)}return c}function k(a,b,d){var c="",g,e,f;for(f=0;f<b.length;++f){e=b[f];g=d[e];if(!g)throw{name:"CreateUpperBoundException",message:"Need at least the root primary key to create an upper bound"};if(g.hasOwnProperty(Kindle.DB.OPERATOR)){var h=g[Kindle.DB.VALUES][g[Kindle.DB.VALUES].length-1];if(typeof h==="number")g=g[Kindle.DB.VALUES][g[Kindle.DB.VALUES].length-
1];else if(typeof h==="string")g=h;else throw{name:"InvalidKeyException",message:"Tried to generate a lowerbound key with invalid keys"};}c+=j(a,e,g);f<b.length-1&&(c+=w)}return c}function o(a,b,d){var c,e=new jQuery.Deferred,f=new jQuery.Deferred,h=$.makeArray(a);try{c=g.transaction(h,d)}catch(m){return e.reject().promise()}c.oncomplete=function(){f.then(e.resolve,e.reject)};c.onerror=e.reject;c.onabort=function(){e.reject({code:Kindle.DB.QUOTA_ERR,message:"Assumed QUOTA_ERR"})};b(c,a,f);return e.promise()}
function s(a,b,c){function g(){++e===f&&C.resolve(q)}for(var e=0,f=c.length,m=d[b].tableInfo,p=d[b].keyPath,j=d[b].genKeyPath,k=d[b].autoInc,C=new jQuery.Deferred,l,q=[],t=0;t<c.length;t++){for(var n in c[t])l=m[n],l&Kindle.DB.TEXT_TYPE?c[t][n]=typeof c[t][n]==="string"?c[t][n]:String(c[t][n]):l&Kindle.DB.NUMBER_TYPE&&(c[t][n]=typeof c[t][n]==="number"?c[t][n]:Number(c[t][n]));!k&&!c[t][p]?(l=j?h(c[t],b):p,l=a.put(c[t],l)):l=k?a.add(c[t]):a.put(c[t]);l.onsuccess=g;l.onerror=C.reject;q.push(c[t])}return C.promise()}
function y(a,b){if(!a||!b)throw{name:"databaseInsertError",message:"Tried to insert with an empty table name or empty object list"};e(a);return o(a,function(a,c,d){a=a.objectStore(c);s(a,c,b).then(d.resolve,d.reject)},C)}function n(a,b,c){function g(a,b){return a-b}e(b);var f=c?$.extend(!0,{},c):c,m,p=d[b].tableInfo,j=d[b].keyPath,c=d[b].keyList,t=d[b].autoInc,C=new jQuery.Deferred,q=!1,n;if(f)for(var z in f){var D=f[z];if(D){var o=p[z],D=D.hasOwnProperty(Kindle.DB.OPERATOR);if(o&Kindle.DB.TEXT_TYPE)if(D){for(var w in f[z][Kindle.DB.VALUES])o=
f[z][Kindle.DB.VALUES][w],f[z][Kindle.DB.VALUES][w]=typeof o==="string"?o:String(o);f[z][Kindle.DB.VALUES].sort()}else typeof f[z]!=="string"&&(f[z]=String(f[z]));else if(o&Kindle.DB.NUMBER_TYPE)if(D){for(var u in f[z][Kindle.DB.VALUES])o=f[z][Kindle.DB.VALUES][u],f[z][Kindle.DB.VALUES][u]=typeof o==="number"?o:Number(o);f[z][Kindle.DB.VALUES].sort(g)}else typeof f[z]!=="number"&&(f[z]=Number(f[z]));!q&&D&&(q=!0)}}!q&&f&&(f[j]?m=f[j]:t||(m=h(f,b)));if(m)n=a.get(m),n.onsuccess=function(a){(a=a.target.result)?
C.resolve([a]):C.resolve([])},n.onerror=C.reject;else{var B=[],r;if(f){m=!0;for(var s in c)if(!f[c[s]]){m=!1;break}if(m)m=l(b,c,f),b=k(b,c,f),b=IDBKeyRange.bound(m,b,!1,!1),n=a.openCursor(b);else{s={};for(var v in c)if(f[c[v]]){r=c[v];s[r]=f[r];break}if(!r){for(var I in f)if(f[I].hasOwnProperty(Kindle.DB.OPERATOR)){r=I;s[I]=f[I];break}r||(r=Object.keys(f)[0])}s[r]&&s[r].hasOwnProperty(Kindle.DB.OPERATOR)?(m=l(b,[r],s),b=k(b,[r],s),b=IDBKeyRange.bound(m,b,!1,!1)):b=IDBKeyRange.only(f[r]);try{n=a.index(r).openCursor(b)}catch(y){n=
a.openCursor()}}}else n=a.openCursor();n.onerror=C.reject;n.onsuccess=function(a){var a=a.target.result,b=!0;if(a){for(var c in f){var d=f[c];if(d){if(d.hasOwnProperty(Kindle.DB.OPERATOR))switch(b=$.inArray(a.value[c],d[Kindle.DB.VALUES])!==-1,d[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:b=!b}else d!==a.value[c]&&(b=!1);if(!b)break}}b&&B.push(a.value);a["continue"]()}else C.resolve(B)}}return C.promise()}function u(a,b,c){var d=c[0],c=c[1],g=new jQuery.Deferred;n(a,b,c).then(function(c){if(c.length>
0){for(var e in c)c[e]=$.extend(c[e],d);s(a,b,c).then(g.resolve,g.reject)}else g.resolve(c)},g.reject);return g.promise()}function v(a,b,c){return o(a,function(a,d,g){a=a.objectStore(d);u(a,d,[b,c]).then(g.resolve,g.reject)},C)}function r(a,b,c){var d=new jQuery.Deferred;u(a,b,c).then(function(g){g.length===0?(c[0]=$.extend(c[0],c[1]),s(a,b,[c[0]]).then(d.resolve,d.reject)):d.resolve(g)},d.reject);return d.promise()}function p(a,b,c){return n(a,b,c[0])}function m(a,b,c){function d(c){function f(){return function(){++m===
c.length&&g.resolve()}}var m=0;if(c.length===0)g.resolve();else for(var p in c){var j=h(c[p],b);e=a["delete"](j);e.onsuccess=f(j,c[p]);e.onerror=g.reject}}var c=c[0],g=new jQuery.Deferred,e;c?n(a,b,c).then(d,g.reject):(e=a.clear(),e.onsuccess=g.resolve,e.onerror=g.reject);return g.promise()}function z(a){for(var b=new jQuery.Deferred,c=g.transaction(a,C),d=0;d<a.length;d++)c.objectStore(a[d]).clear().onerror=b.reject;c.oncomplete=b.resolve;c.onabort=b.reject;c.onerror=b.reject;return b.promise()}
function D(){var a=new jQuery.Deferred;g.onversionchange=function(){g.close();g=void 0};g.close();var c=window.indexedDB.deleteDatabase(b.shortName);c.onsuccess=function(){a.resolve()};c.onerror=function(){a.reject()};return a.promise()}function t(){return B(function(a){return a.value})}function B(a){return o("bookinfo",function(b,c,d){var g=[],b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=a(b);c&&g.push(c);b["continue"]()}else d.resolve(g)};b.onerror=d.reject},
c)}function G(a){function b(a){k.reject(a)}function c(a){k.reject(a)}function e(a){if(a=a.target.result)a["delete"](),a["continue"]()}function m(){}var p=f(),j,k,t,l,n,z,q,o;k=new jQuery.Deferred;z=g.transaction(p,C);z.oncomplete=function(){k.resolve()};z.onerror=b;z.onabort=b;for(t=0;t<a.length;++t){l=a[t];n=h({asin:l,id:0},"skeleton");o=h({asin:l,id:H},"skeleton");o=IDBKeyRange.bound(n,o);for(n=0;n<p.length;n++)j=d[p[n]],q=z.objectStore(p[n]),j.genKeyPath?(j=q.openCursor(o),j.onsuccess=e):(j=q["delete"](l),
j.onsuccess=m),j.onerror=c}return k.promise()}var w=String.fromCharCode(31),q=8,H="99999999",a=b,g=null,d={},c=IDBTransaction.READ_ONLY||"readonly",C=IDBTransaction.READ_WRITE||"readwrite",I={};I[Kindle.DB.INSERT_LIST_OPERATION]=s;I[Kindle.DB.UPDATE_RECORD_OPERATION]=u;I[Kindle.DB.UPSERT_RECORD_OPERATION]=r;I[Kindle.DB.DELETE_RECORD_OPERATION]=m;I[Kindle.DB.GET_RECORD_OPERATION]=p;I[Kindle.DB.CREATE_TABLE_OPERATION]=function(){KindleDebug.error("Illegal function: doCreateTable")};if(!function(a){var b,
c;for(c in a){b=c;var g=!0,e=!1,f=void 0,m=[],p=[],h="",j=[],k=a[c],t=void 0;for(t in k){f=k[t];if(f&Kindle.DB.AUTO_INCREMENT||f&Kindle.DB.PRIMARY_KEY)e?g=!1:(e=!!(f&Kindle.DB.AUTO_INCREMENT))||m.push(t);f&(Kindle.DB.PRIMARY_KEY|Kindle.DB.SECONDARY_KEY)&&j.push({name:t,keyPath:t,unique:!1,multientry:!1})}if(g){for(var f=!1,n=0;n<m.length;++n)h+=m[n],p[n]=k[t],n<m.length-1&&(h+=w,f=!0);m.length===0&&(e=!0);d[b]={info:k,keyList:m,keyPath:h?h:void 0,genKeyPath:f,genKeyTypes:p,indexes:j,autoInc:e,tableInfo:k}}b=
g;if(b&Kindle.DB.CONSTRAINT_ERROR)return!1}return!0}(b.tables))throw Error("Invalid table description for "+b.shortName);return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},openDatabase:function(){function b(c){var g;a:{g=a.tables;var c=c.target.result,f,m,p;p=c.objectStoreNames;for(f=0;f<p.length;f++)m=p[f],g.hasOwnProperty(m)||c.deleteObjectStore(m);for(m in g)if($.inArray(m,p)===-1){var h=c;f=m;if(d[f]===void 0)f=Kindle.DB.CONSTRAINT_ERR;else{var j={autoIncrement:d[f].autoInc};
if(!j.autoIncrement&&!d[f].genKeyPath)j.keyPath=d[f].keyPath;var h=h.createObjectStore(f,j),k=j=void 0;for(k in d[f].indexes)j=d[f].indexes[k],h.createIndex(j.name,j.keyPath,{unique:j.unique});f=null}if(f&Kindle.DB.CONSTRAINT_ERROR){g=!1;break a}}g=!0}g||e.abort()}var c=new jQuery.Deferred,e;window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction;e=window.indexedDB.open(a.shortName,
a.version);e.onsuccess=function(b){function d(a){dbWrapper.createObjectStores(_dbInfo.tables)?(g=a.target.result,c.resolve(g)):f.abort()}if(e.onupgradeneeded===void 0&&Number(dbHandle.version)!==Number(a.version)){var f=dbHandle.setVersion(a.version||"1.0");f.onerror=c.reject;f.onsuccess=d}else g=b.target.result,c.resolve(g)};e.onerror=function(a){c.reject(a)};if(e.onupgradeneeded!==void 0)e.onupgradeneeded=b;return c.promise()},dropTables:function(){function a(){t().then(b,f)}function b(a){function g(){d(a).then(e,
f)}a.length===0?e():c(a).then(g,f)}function c(a){function b(){++g===a.length&&d.resolve()}for(var d=new jQuery.Deferred,g=0,e=0;e<a.length;e++)v("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PARTIAL},{asin:a[e].asin}).then(b,d.reject);return d.promise()}function d(a){function b(){++g===a.length&&c.resolve()}for(var c=new jQuery.Deferred,g=0,e=0;e<a.length;e++)G([a[e].asin]).then(b,c.reject);return c.promise()}function e(){z($.makeArray(g.objectStoreNames)).then(m.resolve,f)}function f(){KindleDebug.error("Error occured signing out");
m.reject()}var m;if(window.indexedDB.deleteDatabase)return D();m=new jQuery.Deferred;g.name==="K4Wbooks"?z(["annotationsCache"]).then(a,f):e();return m.promise()},getTableNames:f,insertRecord:function(a,b){return y(a,[b])},insertList:y,upsertRecord:function(a,b,c){return o(a,function(a,d,g){a=a.objectStore(d);r(a,d,[b,c]).then(g.resolve,g.reject)},C)},updateRecord:v,getRecord:function(a,b,d){return o(a,function(a,c,g){a=a.objectStore(c);p(a,c,[b]).then(function(a){if(d)for(var b in a)for(var c in a[b])c in
d||delete a[b][c];g.resolve(a)},g.reject)},c)},deleteRecord:function(a,b){return o(a,function(a,c,d){a=a.objectStore(c);m(a,c,[b]).then(d.resolve,d.reject)},C)},batchTransaction:function(a){if(!a||a.length===0){var b=new jQuery.Deferred;b.resolve([]);return b.promise()}var b=[],d=!0,g=[],f=0,m;for(m in a)$.inArray(a[m].tableName,b)===-1&&(e(a[m].tableName),b.push(a[m].tableName)),d&&a[m].operation!==Kindle.DB.GET_RECORD_OPERATION&&(d=!1);return o(b,function(b,c,d){function m(b){return function(c){g[b]=
c;++f===a.length?d.resolve(g):h()}}function p(){b.abort();d.reject()}function h(){(j=a[k])||d.reject();e(j.tableName);I[j.operation](b.objectStore(j.tableName),j.tableName,j.params).then(m(k),p);++k}var j,k=0;h();return d.promise()},d?c:C)},getPieceIds:function(a,b){e(a);return o(a,function(c,d,g){var e=[],f,c=c.objectStore(a),d=h({asin:b,id:0},a);f=h({asin:b,id:H},a);d=IDBKeyRange.bound(d,f);c=c.openCursor(d);c.onsuccess=function(a){var b;(a=a.target.result)?(b=a.key.split(w),b=parseInt(b[1],10),
e.push(b),a["continue"]()):g.resolve(e)};c.onerror=g.reject},c)},getOldBookList:function(a){return B(function(b){if(b.key!==a&&b.value.cacheState!==Kindle.BookInfo.CachedState.PINNED)return b.value})},dbGetBookStatistics:function(a){function b(a){j.reject(a)}function e(a){j.reject(a)}function m(a){t[a]={count:0,size:0};return function(b){(b=b.target.result)?(t[a].count++,t[a].size+=b.value.size,b["continue"]()):t.totalSize+=t[a].size}}var p=[];$.each(f(),function(a,b){d[b]&&d[b].info.size&&p.push(b)});
p.push("bookinfo");var j,k,t,n,l,C;j=new jQuery.Deferred;t={totalSize:0,cacheState:"",cachedSize:0};n=g.transaction(p,c);n.oncomplete=function(){j.resolve(t)};n.onerror=b;n.onabort=b;k=h({asin:a,id:0},p[0]);C=h({asin:a,id:H},p[0]);C=IDBKeyRange.bound(k,C);for(k=0;k<p.length-1;k++)t[p[k]]={count:0,size:0},l=n.objectStore(p[k]),l=l.openCursor(C),l.onsuccess=m(p[k]),l.onerror=e;l=n.objectStore("bookinfo");l=l.get(a);l.onsuccess=function(a){if(a=a.target.result)t.cacheState=a.cacheState,t.cachedSize=
a.cachedSize||0};l.onerror=e;return j.promise()},dbDeleteBooksData:G,deleteJournalEntries:function(a){return o("journal",function(b,c,d){b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=b.value,g;for(g in a)if(c.type===a[g].type&&(c.guid||c.refEmId)===(a[g].guid||a[g].refEmId)&&c.start===a[g].start&&c.end===a[g].end&&c.position===a[g].position&&c.modifiedTimestamp===a[g].modifiedTimestamp&&c.asin===a[g].asin){delete a[g];b["delete"]();break}b["continue"]()}else d.resolve()};
b.onerror=d.reject},C)}}}
function KindleSqlWrapper(b,e){function f(a){if(!q[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function j(a,b){var d=new jQuery.Deferred,c=[];w[b?"readTransaction":"transaction"](function(b){a(b,c)},function(a){d.reject(a)},function(){d.resolve(c)});return d.promise()}function h(){var a=[],b;for(b in q)a.push(b);return a}function l(a,b,d){var c=[],e,f;for(f in a)e=b[f],e!==void 0?a[f]&Kindle.DB.OBJECT_TYPE?c.push(JSON.stringify(e)):c.push(e):d&&!(a[f]&Kindle.DB.AUTO_INCREMENT)&&
c.push(null);return c}function k(a,b){var d="",c,e;for(e in a)if(c=b[e])if(d+=(d?" AND ":"")+e,c.hasOwnProperty(Kindle.DB.OPERATOR))switch(c[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:d+=" != ?";break;case Kindle.DB.IN_ARRAY:d+=" IN (?";for(var f=1;f<c[Kindle.DB.VALUES].length;f++)d+=", ?";d+=")"}else d+=" = ?";return d}function o(a){var b="";a&Kindle.DB.TEXT_TYPE||a&Kindle.DB.OBJECT_TYPE?b+="TEXT ":a&Kindle.DB.AUTO_INCREMENT?b+="INTEGER PRIMARY KEY AUTOINCREMENT ":a&Kindle.DB.NUMBER_TYPE&&(b+=
"INTEGER ");!(a&Kindle.DB.PRIMARY_KEY)&&!(a&Kindle.DB.ALLOW_NULL)&&(b+="NOT NULL ");return b}function s(a,b){var d="DELETE FROM "+a;b&&(d+=" WHERE "+k(q[a],b));return d+";"}function y(a,b,d){if(d===void 0)d="*";else{var c=q[a],e="",f;for(f in c)d[f]&&(e+=(e?", ":"")+f);d=e}d="SELECT "+d+" FROM "+a;b&&(d+=" WHERE "+k(q[a],b));return d+";"}function n(a,b){f(a);if($.isArray(b)){if(b.length===0)return(new jQuery.Deferred).resolve().promise()}else return(new jQuery.Deferred).reject().promise();return j(function(d){u(d,
a,[b])},!1)}function u(a,b,d,c,e){var d=d[0],f,c=q[b],e="INSERT OR "+(e?"IGNORE":"REPLACE")+" INTO "+b+" (",m="",p="";for(f in c)c[f]&Kindle.DB.AUTO_INCREMENT||(m+=(m?", ":"")+f,p+=(p?", ":"")+"?");e+=m+") VALUES ("+p+");";f=e;b=q[b];for(e=0;e<d.length;e++)c=l(b,d[e],!0),a.executeSql(f,c)}function v(a,b,d,c,e){var c=d[0],d=d[1],f=q[b],m=q[b],p="",h;for(h in m)c[h]!==void 0&&(p+=(p?", ":"")+h+" = ?");b="UPDATE "+(e?"OR IGNORE ":"")+b+" SET "+(p+" WHERE "+k(m,d));b+=";";c=l(f,c).concat(l(f,d));a.executeSql(b,
c)}function r(a,b,d){v(a,b,d,[],!0);u(a,b,[[$.extend({},d[0],d[1])]],[],!0)}function p(a,b){var d={},c,e,f;for(f in a)c=b[f],c!==void 0&&c!==null&&(e=a[f],d[f]=e&Kindle.DB.OBJECT_TYPE?JSON.parse(c):c);return d}function m(a,b,d){f(a);return j(function(c,e){D(c,a,[b,d],e)},!0)}function z(a){var b=[],d;if(a)for(var c in a)d=a[c],d.hasOwnProperty(Kindle.DB.VALUES)?b=b.concat(d[Kindle.DB.VALUES]):b.push(d);return b}function D(a,b,d,c){var e=d[0],f=q[b];a.executeSql(y(b,e,d[1]),z(e),function(a,b){if(b.rows.length>
0)for(var d=0;d<b.rows.length;d++)c.push(p(f,b.rows.item(d)))})}function t(a,b,d){d=d[0];a.executeSql(s(b,d),z(d))}function B(a){return j(function(b,d){for(var c,e=0;e<a.length;e++)if(c=H[a[e].operation])d[e]=[],c(b,a[e].tableName,a[e].params,d[e])},!1)}function G(a){var b,d=[];for(b in a)d.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:b,params:[a[b]]});return B(d)}var w=null,q={},H={};H[Kindle.DB.INSERT_LIST_OPERATION]=u;H[Kindle.DB.UPDATE_RECORD_OPERATION]=v;H[Kindle.DB.UPSERT_RECORD_OPERATION]=
r;H[Kindle.DB.DELETE_RECORD_OPERATION]=t;H[Kindle.DB.GET_RECORD_OPERATION]=D;H[Kindle.DB.CREATE_TABLE_OPERATION]=function(a,b,d){var d=d[0],c="CREATE TABLE IF NOT EXISTS "+b+"(",e="",f,m=!0,p;for(p in d)m?m=!1:c+=", ",c+=p+" ",f=d[p],c+=o(f),f&Kindle.DB.PRIMARY_KEY&&(e+=e?", ":" PRIMARY KEY (",e+=p);e&&(c+=", "+e+")");c+=");";q[b]=d;a.executeSql(c,[])};H[Kindle.DB.ALTER_TABLE_OPERATION]=function(a,b,d){for(var c=d[0],d=d[1],e="",f=0;f<d.length;f++)fieldName=d[f],fieldInfo=c[fieldName]|Kindle.DB.ALLOW_NULL,
e="ALTER TABLE "+b+" ADD COLUMN "+fieldName+" ",e+=o(fieldInfo),e+=";",a.executeSql(e,[])};return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},openDatabase:function(){var a=new jQuery.Deferred,g=b.defaultSize;e!==void 0&&g>e*1E6&&(g=_maxDbSize*1E6);w=openDatabase(b.shortName,"",b.displayName,g);var d=w.version;KindleHostDeviceDetector.isiOS_4x()||w.changeVersion(d,b.version);G(b.tables).done(function(){var c=b.tables,e=b.versionUpdate,g=[];if(e&&e.length)for(var f=
0;f<e.length;f++)e[f].version>d&&g.push({operation:e[f].operation,tableName:e[f].tableName,params:[c[e[f].tableName],e[f].params]});B(g).then(a.resolve(w),a.resolve(w))}).fail(a.reject);return a.promise()},dropTables:function(){return j(function(a){for(var b in q)a.executeSql("DROP TABLE IF EXISTS "+b+";")},!1)},getTableNames:h,insertRecord:function(a,b){return n(a,[b])},insertList:n,upsertRecord:function(a,b,d){f(a);return j(function(c){r(c,a,[b,d])},!1)},updateRecord:function(a,b,d){f(a);return j(function(c){v(c,
a,[b,d])},!1)},getRecord:m,deleteRecord:function(a,b){f(a);return j(function(d){t(d,a,[b])},!1)},batchTransaction:B,getPieceIds:function(a,b){var d=new jQuery.Deferred;m(a,{asin:b},{id:!0}).then(function(a){var b=[],e;for(e in a)b.push(a[e].id);d.resolve(b)},d.reject);return d.promise()},getOldBookList:function(a){var b=new jQuery.Deferred;m("bookinfo",{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]},cacheState:{operator:Kindle.DB.NOT_EQUAL,values:[Kindle.BookInfo.CachedState.PINNED]}},{asin:!0,openTime:!0}).then(function(a){a.length===
0?b.reject():b.resolve(a)},b.reject);return b.promise()},dbGetBookStatistics:function(a){var b=new jQuery.Deferred,d=[];$.each(h(),function(a,b){q[b]&&q[b].size&&d.push(b)});for(var c={totalSize:0,cacheState:"",cachedSize:0},e,f=[],m=0;m<d.length;m++)f.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:d[m],params:[{asin:a},{size:!0}]});f.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"bookinfo",params:[{asin:a},{cacheState:!0,cachedSize:!0}]});B(f).then(function(a){for(var f=0;f<
d.length;f++){var m=a[f],p=0,h=void 0;for(h in m)p+=m[h].size;e={count:m.length,size:p};c[d[f]]=e;c.totalSize+=e.size}c.cacheState=a[a.length-1][0].cacheState;c.cachedSize=a[a.length-1][0].cachedSize||0;b.resolve(c)},function(){b.resolve(c)});return b.promise()},dbDeleteBooksData:function(a){var b,d,c,e=[];c=h();for(d=0;d<a.length;++d)for(b=0;b<c.length;++b)e.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:c[b],params:[{asin:a[d]}]});return B(e)},deleteJournalEntries:function(a){var b=
[],d;for(d in a)b.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[d].id}]});return B(b)}}}
function KindleStubDBWrapper(b){function e(b){if(!n[b])throw{name:"databaseAccessError",message:"Trying to access undefined table "+b};}function f(b,f){var h=f[0],j,k,l,o;for(o in h){j={};l=b;k=j;var r;r=l;var q=h[o];e(r);var s=n[r],a=!0,g=void 0,d=void 0;for(d in s.info)if(g=s.info[d],q[d]===void 0)if(g&Kindle.DB.AUTO_INCREMENT)v[r]++,q[d]=v[r];else{if(!(g&Kindle.DB.ALLOW_NULL)||g&Kindle.DB.PRIMARY_KEY)a=!1}else if(g&Kindle.DB.AUTO_INCREMENT)a=!1;else{switch(typeof q[d]){case "number":a=g&Kindle.DB.NUMBER_TYPE;
break;case "string":a=g&Kindle.DB.TEXT_TYPE;break;case "object":a=g&Kindle.DB.OBJECT_TYPE}if(!a)break}r=a?null:Kindle.DB.CONSTRAINT_ERR;a=s=q=void 0;if(r===null){a=n[l].keyList;s=u[l];for(l=0;l<a.length-1;l++)q=a[l],s[q]||(s[q]={}),s=s[k];k.container=s;k.key=a[a.length-1]}k=r;if(k===null)l=h[o][j.key],j.container[l]===void 0?j.container[l]=h[o]:k=Kindle.DB.CONSTRAINT_ERR;else{k=Kindle.DB.CONSTRAINT_ERR;break}}return k}function j(b,e){var h=new jQuery.Deferred,j=f(b,[e]);j?h.reject(j):h.resolve();
return h.promise()}function h(b,f){e(b);var h=n[b].keyList,j=u[b],k,l,o={};for(k=0;k<h.length;k++)if(l=h[k],f[l])if(k===h.length-1){o.key=f[l];break}else j[f[l]]||(u[f[l]]={}),j=u[f[l]],delete f[l];else break;if(k<h.length-1)throw"unsupported use case for in-memory DB!!";o.container=j;o.selection=f;return o}function l(b,e){var f=e[0],j=null,k=h(b,e[1]);k.container&&k.key&&k.container[k.key]?$.extend(k.container[k.key],f):j=Kindle.DB.CONSTRAINT_ERR;return j}function k(b,e){$.extend(e[0],e[1]);var h=
f(b,[[e[0]]]);h===Kindle.DB.CONSTRAINT_ERR&&(h=l(b,e));return h}function o(b,e,f){var e=e[0],j=n[b],k=u[b],l,o;if(e){if(b=h(b,e),k=b.container)if(b.key)k[b.key]&&f.push(k[b.key]);else for(l in b=b.selection,j=!0,k){for(o in b)if(k[l][o]!==e[o]){j=!1;break}j&&f.push(k[l])}}else if(j.keyList.length!==1)throw"unsupported use case for in-memory DB!!";else for(l in k)f.push(k[l]);return null}function s(b,e){var f=e[0],j,k=u[b],l,n,o;if(f){if(j=h(b,f),k=j.container)if(j.key)delete k[j.key];else for(l in j=
j.selection,o=!0,k){for(n in j)if(k[l][n]!==f[n]){o=!1;break}o&&delete k[l]}}else u[b]={};return null}function y(b){var e=new jQuery.Deferred,f,j=[],h;for(h in b)if(f=b[h],j[h]=[],f=r[f.operation](f.tableName,f.params,j[h]))break;f===null?e.resolve(j):e.reject(f);return e.promise()}var n={},u={},v={},r={};r[Kindle.DB.INSERT_LIST_OPERATION]=f;r[Kindle.DB.UPDATE_RECORD_OPERATION]=l;r[Kindle.DB.UPSERT_RECORD_OPERATION]=k;r[Kindle.DB.DELETE_RECORD_OPERATION]=s;r[Kindle.DB.GET_RECORD_OPERATION]=o;r[Kindle.DB.CREATE_TABLE_OPERATION]=
function(b,e){var f=!0,j=!1,h,k=[],l=0,o=e[0],q;for(q in o)if(h=o[q],h&Kindle.DB.AUTO_INCREMENT||h&Kindle.DB.PRIMARY_KEY)j?f=!1:(j=h&Kindle.DB.AUTO_INCREMENT,k.push(q));if(f){if(k.length===0)k.push("id"),o.id=Kindle.DB.AUTO_INCREMENT,j=!0;n[b]={info:o,keyList:k};(h=u[b])||(u[b]={});if(j){for(var r in h)l=Math.max(l,parseInt(r,10));v[b]=l}}return f?null:Kindle.DB.CONSTRAINT_ERR};(function(){var e;try{e=JSON.parse(KindleLocalStorage.localStorageObject.getItem(b))}catch(f){}e&&typeof e==="object"&&(u=
e)})();return{persist:function(){var e=null;try{KindleLocalStorage.localStorageObject.setItem(b,JSON.stringify(u))}catch(f){e=Kindle.DB.QUOTA_ERR}return e},createTables:function(b){var e,f,h;e=new jQuery.Deferred;h=[];for(f in b)h.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:f,params:[b[f]]});y(h).then(e.resolve,e.reject);return e.promise()},dropTables:function(){u={};n={};v={};KindleLocalStorage.localStorageObject.setItem(b,null);return(new $.Deferred).resolve().promise()},getTableNames:function(){var b=
[],e;for(e in n)b.push(e);return b},insertRecord:function(b,e){return j(b,[e])},insertList:j,upsertRecord:function(b,e,f){var h=new jQuery.Deferred;(b=k(b,[e,f]))?h.reject(b):h.resolve();return h.promise()},updateRecord:function(b,e,f){var h=new jQuery.Deferred;(b=l(b,[e,f]))?h.reject(b):h.resolve();return h.promise()},getRecord:function(b,e){var f=new jQuery.Deferred,h=[],j=o(b,[e],h);j?f.reject(j):f.resolve(h);return f.promise()},deleteRecord:function(b,e){var f=new jQuery.Deferred,h=s(b,[e]);h?
f.reject(h):f.resolve();return f.promise()},batchTransaction:y,deleteJournalEntries:function(b){var e=[],f;for(f in b)e.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:b[f].id}]});return y(e)}}}
EmbeddedReaderAPI={setLoginParameters:function(){},setFocusToReader:function(){},showAppbar:function(){},hideAppbar:function(){},sendMetrics:function(){},sendMetricsNow:function(){},deregister:function(){},clearDatabases:function(){},clearLocalStorage:function(){},openBook:function(){},downloadBook:function(){},requestDownloadedBookList:function(){},cancelBookDownload:function(){},removeBook:function(){},requestOemAssociateId:function(){},getTodoItems:function(){},removeTodoItems:function(){},uploadSnapshot:function(){},
getDownloadedBookInfo:function(){},requestDeviceName:function(){},getSelectedText:function(){},hideContextMenu:function(){},setStoreCookies:function(){},setServiceHost:function(){},uploadJournal:function(){},getTOSParams:function(){},updateAppCache:function(){}};
ReaderHostAPI={onReaderLoaded:function(){},onAppCacheStatus:function(){},onAppCacheUpdateReady:function(){},onBookOpenStatus:function(){},onBookClose:function(){},onOpenStore:function(){},onServiceAuthState:function(){},pinBookToStart:function(){},onRequestDownloadedBookList:function(){},onBookDownloadComplete:function(){},onBookDownloadFailed:function(){},onBookDownloadProgress:function(){},onDeregister:function(){},onReaderTapped:function(){},hideAppBar:function(){},showWebPage:function(){},getRequestSigningHeaders:$.rpc.fn()};
function ReaderHostInterfaceFactory(b,e){KindleInterfaces.assertImplements(b,EmbeddedReaderAPI);return $.rpc({iRemote:ReaderHostAPI,local:b,channelId:"reader",target:window.parent,remoteDomain:e})}
var KindleChromeInstaller=function(){function b(){function b(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,function(){KindleDebug.log("install success");setTimeout(b,250)},function(b){KindleDebug.error(b)})}function e(){return window.chrome&&Kindle.top.chrome.webstore&&Kindle.top.chrome.webstore.install}return{install:function(){e()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},initialize:function(){if(KindleHostDeviceDetector.isChrome()&&
e()){var f=document.createElement("button");f.id="inlineInstallProxy";f.style.display="none";$(f).click(b);$("body").append(f)}}}}(),KindleFirefoxInstaller=function(){function b(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();var b=$.Deferred(),f=navigator.mozApps.getSelf();f.onsuccess=function(){b.resolve(f.result)};f.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);b.reject()};return b.promise()}return{install:function(){var e=
$.Deferred();b().done(function(b){b?e.reject():(navigator.mozApps.install(Kindle.URL.getHostURL()+"/offline/kcr_ff.webapp").onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");e.resolve()},request.onerror=function(){KindleDebug.error("Firefox App failed to install.");e.reject()})}).fail(e.reject);return e.promise()}}}();
