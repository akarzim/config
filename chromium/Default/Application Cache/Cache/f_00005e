var KindleGlyphRenderer=function(){function d(a,b,e,c,g,f,h,m){b=b[c.imgSrc];if(e.getContext&&b!==void 0){var n=new Image,l=c.o;l||(l=[0,0]);n.onload=function(){if(a===o){var b=l,c=e,n=c.getContext("2d"),q=b[0]*g/1440,b=b[1]*g/1440,A={x:q,y:b,w:this.width*f,h:this.height*f};h[c.id]||(h[c.id]=[]);c=h[c.id];c[c.length]=A;n.translate(q,b);n.scale(f,f);n.drawImage(this,0,0);n.scale(1/f,1/f);n.translate(-q,-b);e=null}setTimeout(m,25)};n.src=b;c=b=b=null}else setTimeout(m,10)}function k(a,b,e,c){if(b.getContext){var g=
e.o;g||(g=[0,0]);var f=b.getContext("2d");f.translate(g[0]*c/1440,g[1]*c/1440);f.fillStyle=j(b);for(var h,m,n,l,o,p=e.l.length,d=0;d<p;d++){a:{h=e.l[d][0];n=void 0;for(o=0;o<a.length;o+=1)if(n=a[o].glyphFragmentMetadata,h>=n.startingGlyph&&h<=n.endingGlyph){n=h-n.startingGlyph;h=a[o].glyphData[n];break a}h=null}if(h!==null){n=e.l[d][1]+e.p[0];l=e.l[d][2]+e.p[1];o=c/h.dpi;n=(n-e.p[0])*c/1440;l=(l-e.p[1])*c/1440;f.translate(n,l);f.scale(o,o);f.beginPath();for(var v=h.c.length,k=0;k<v;k++){var B=h.c[k];
f.moveTo(B[0],B[1]);m=B.length-6;for(var H=2;H<m;H+=6)f.bezierCurveTo(B[H],B[H+1],B[H+2],B[H+3],B[H+4],B[H+5]);m=B.length;f.bezierCurveTo(B[m-4],B[m-3],B[m-2],B[m-1],B[0],B[1])}f.closePath();f.fill();f.scale(1/o,1/o);f.translate(-n,-l)}}f.translate(-(g[0]*c/1440),-(g[1]*c/1440));if(b.parentNode.tagName==="A")f.strokeStyle=j(b),f.lineWidth=q.lineWidth,f.beginPath(),f.moveTo(0,b.height-1),f.lineTo(b.width,b.height-1),f.stroke(),f.closePath()}}function j(a){a=a.parentNode;return a.tagName==="A"?q.linkColor:
(a=a.getAttribute("class"))&&a.indexOf("fixedOverlap")>=0?p:q.textColor}function b(a){for(var a=a.getElementsByTagName("CANVAS"),b={},e=0;e<a.length;e+=1)b[a[e].id]=a[e];return b}function a(a,b,e,c,g,f){for(var h={},m=0;m<a.length;m+=1){var n=b[a[m].id];if(n)for(var l=0;l<n.length;l++){var q=g[n[l].id];if(q){var o=c,p=q.parentNode.getAttribute("class");if(p&&p.indexOf("fixed")>=0){var o=e,p=q,d=f;if(d[p.id])o=d[p.id];else{var j=p.getAttribute("height"),v=p.getAttribute("width"),H=0,k=0,J=1;if(j&&
!(j<=0||!v||v<=0))j>o.height&&(H=o.height/j),v>o.width&&(k=o.width/v),H>0&&k>0?J=H<k?H:k:H>0?J=H:k>0&&(J=k),d[p.id]=J;o=J}}if(o!==1&&!h[q.id])h[q.id]=1,q.width=Math.round(o*q.width),q.height=Math.round(o*q.height)}}}}function c(a,b,e,g,f,h,m,n,l,q,p){function j(){a===o?c(a,b,e+1,g,f,h,m,n,l,q,p):setTimeout(p,10)}for(var k=g.length;b<k;){var F=f[g[b].id];if(F)for(var E=F.length;e<E;){var B=F[e];if(B.imgSrc!==void 0){var H=n[B.id];if(H){k=l[H.id];k=k!==void 0?k:h;d(a,m,H,B,k*v,k,q,j);return}}e+=1}b+=
1;e=0}setTimeout(p,10)}function f(a,b,e,g,f,h,m,n,l){c(a,0,0,b,e,g,f,h,m,n,l)}function e(a,b,c,g,f,h,m,n,l,q,p){function d(){a===o?e(a,b,c+1,g,f,h,m,n,l,q,p):setTimeout(p,q.time)}var j=0,F=g.length;for(KindleRendererProcessTuning.startingOperation("GlyphRenderering");b<F;){var E=f[g[b].id];if(E)for(var B=E.length;c<B;){var H=E[c];if(H.l!==void 0&&H.l.length>0){var K=n[H.id];if(K){var J=l[K.id];k(m,K,H,(J!==void 0?J:h)*v);j+=1;if(j>=q.frequency){KindleRendererProcessTuning.endingOperation("GlyphRenderering",
j);setTimeout(d,q.time);return}}}c+=1}b+=1;c=0}KindleRendererProcessTuning.endingOperation("GlyphRenderering",j);setTimeout(p,q.time)}function g(a,b,c,g,f,h,m,n,l){e(a,0,0,b,c,g,f,h,m,n,l)}function h(e,c,h,m,l,p){var d={height:$(e).parent().height()*0.85,width:$(e).parent().width()*0.85},j=b(e.contentDocument),v=[],k=e.contentDocument.getElementsByTagName("html")[0],D=e.contentDocument.getElementsByTagName("body")[0],D=k.removeChild(D),C=$(D).find("p"),I={},F=l.createSubTimer("resizing-canvases");
a(C,h.paraData,d,q.glyphScale,j,I);F.endTimer();F=l.createSubTimer("rendering-all-images");f(c.requestId,C,h.paraData,q.glyphScale,h.imageData,j,I,v,function(){F.endTimer();if(!(o!==c.requestId||e.processingRequestId!==c.requestId)){F=l.createSubTimer("rendering-all-glyphs");var a={frequency:KindleRendererProcessTuning.drawYieldFrequency("GlyphRenderering"),time:KindleRendererProcessTuning.drawYieldUpdateTime("GlyphRenderering")};g(c.requestId,C,h.paraData,q.glyphScale,m,j,I,a,function(){F.endTimer();
o!==c.requestId||e.processingRequestId!==c.requestId||(k.appendChild(D),n[e.id]=v,j=I=null,setTimeout(p,a.time))})}})}function l(a,b,e,c){var g=new jQuery.Deferred;if(o===null||b.requestId>=o){o=b.requestId;var f=b.metrics.createSubTimer("glyph-rendering");h(a,b,e,c,f,function(){o===b.requestId&&a.processingRequestId===b.requestId&&(o=null,f.endTimer(),g.resolve())})}return g.promise()}function m(a){var b={r:parseInt(q.textColor.substring(1,3),16),g:parseInt(q.textColor.substring(3,5),16),b:parseInt(q.textColor.substring(5,
7),16)},e=n[a.id];$(a.contentDocument).find("canvas").each(function(){var a=this.parentNode;if(a.tagName!=="A"&&(a=a.getAttribute("class"),!a||a.indexOf("fixedOverlap")<0)){a=this.getContext("2d");try{var c=a.getImageData(0,0,this.width,this.height),g=this.width*this.height*4,f=e[this.id];if(f){for(var h=this.width,m=0,n=f.length,l=[];m<n;m+=1)for(var q=Math.floor(f[m].x),o=Math.floor(f[m].y),p=Math.ceil(f[m].w),d=Math.ceil(f[m].h),t=0;t<d;t+=1)for(var j=(h*(o+t)+q)*4,v=j+p*4;j<=v;j+=4)l[j]=1;for(var k=
c.data,L=b.r,M=b.g,N=b.b,f=0;f<g;f+=4)k[f+3]>0&&!l[f]&&(k[f]=L,k[f+1]=M,k[f+2]=N)}else{l=c.data;m=b.r;t=b.g;j=b.b;for(k=0;k<g;k+=4)l[k+3]>0&&(l[k]=m,l[k+1]=t,l[k+2]=j)}a.putImageData(c,0,0)}catch(O){}}})}var p="#000000",o=null,v=100,n=[],q={glyphScale:1,textColor:p,linkColor:"#0000ff",lineWidth:1};return{renderAllContent:function(a,b,e,c){return l(a,b,e,c)},updateTextColor:function(a){m(a)},updateSettings:function(a){if(a.glyphScale!==void 0&&(q.glyphScale=a.glyphScale,q.glyphScale<0.75||q.glyphScale>
3))q.glyphScale=Math.max(0.75,Math.min(3,q.glyphScale));if(a.fontColor!==void 0)q.textColor=a.fontColor},clearIframeData:function(a){n[a.id]=void 0},cleanup:function(){n=null}}}(),KindlePaginator=function(){function d(b,a){if(a!==null)b.currentTopOfScreen=a.topOfScreen,b.currentBottomOfScreen=a.bottomOfScreen,j(b)}function k(b,a){if(a!==null)b.currentTopOfScreen=a.topOfScreen,b.currentBottomOfScreen=a.bottomOfScreen,j(b)}function j(b){var a=KindleRendererDeviceSpecific.animatePageFlip(),c=$(b);a&&
(c.removeClass("pageTurnEnd"),c.addClass("pageTurnStart"));b.writingMode.scrollTop(b,b.currentTopOfScreen);b.writingMode.fitToBottomOfFrame(b,b.pageOverflowDiv,b.currentBottomOfScreen-b.currentTopOfScreen);a&&(c.removeClass("pageTurnStart"),c.addClass("pageTurnEnd"))}return{scrollToTop:function(b){var a=b.screenManager.findNextScreen(b.screenManager.minDocTop);d(b,a)},scrollToBottom:function(b){var a=b.screenManager.findPreviousScreen(b.screenManager.docBottom);k(b,a)},scrollToPosition:function(b,
a){var c=b.screenManager.getTopOfNodeAtPosition(b.contentDocument,a),c=b.screenManager.getFirstEmptySpaceBeforeHeight(c),c=b.screenManager.findNextScreen(c);d(b,c)},matchFrames:function(b,a){var c=b.screenManager.getFirstReadingPositionAtHeight(b.currentTopOfScreen),f=b.screenManager.getTopOfNodeAtPosition(b.contentDocument,c)-b.currentTopOfScreen,e=b.currentBottomOfScreen-b.currentTopOfScreen,c=a.screenManager.getTopOfNodeAtPosition(a.contentDocument,c);a.currentTopOfScreen=c-f;a.currentBottomOfScreen=
a.currentTopOfScreen+e;j(a)},getApproximateNumPreviousScreens:function(b){var a=b.writingMode.height($(b).parent());return(b.currentTopOfScreen-b.screenManager.minDocTop)/a},getApproximateNumNextScreens:function(b){var a=b.writingMode.height($(b).parent());return(b.screenManager.maxDocTop-b.currentBottomOfScreen)/a},getCurrentPagePositionRange:function(b){var a=b.screenManager.getFirstReadingPositionAtHeight(b.currentTopOfScreen),b=b.screenManager.getFirstReadingPositionAtHeight(b.currentBottomOfScreen)-
1;return{currentTopOfPage:a,currentBottomOfPage:b}},hasPreviousScreen:function(b){return b.screenManager.hasPreviousScreen(b.currentTopOfScreen)},hasNextScreen:function(b){return b.screenManager.hasNextScreen(b.currentBottomOfScreen)},isPreviousFullScreen:function(b){var a=b.screenManager.findPreviousScreen(b.currentTopOfScreen);return a!==null?b.screenManager.hasPreviousScreen(a.topOfScreen):!1},isNextFullScreen:function(b){var a=b.screenManager.findNextScreen(b.currentBottomOfScreen);return a!==
null?b.screenManager.hasNextScreen(a.bottomOfScreen):!1},nextScreen:function(b,a){var c=b.screenManager.findNextScreen(b.currentBottomOfScreen);return c!==null&&(a||b.screenManager.hasNextScreen(c.bottomOfScreen))?(d(b,c),!0):!1},previousScreen:function(b,a){var c=b.screenManager.findPreviousScreen(b.currentTopOfScreen);return c!==null&&(a||b.screenManager.hasPreviousScreen(c.topOfScreen))?(k(b,c),!0):!1},getWordMap:function(b){return b.screenManager.wordMap},copyIframe:function(b,a){a.screenManager=
b.screenManager;a.writingMode=b.writingMode;a.currentTopOfScreen=b.currentTopOfScreen;a.currentBottomOfScreen=b.currentBottomOfScreen;a.writingMode.resetIframeDimensions(a)},getSelectableItemBoundariesForCurrentScreen:function(b){for(var a=KindlePaginator.getCurrentPagePositionRange(b),c=b.screenManager.wordMap,f=a.currentBottomOfPage,e={},a=a.currentTopOfPage;a<=f;++a){var g=c[a]&&c[a].rects;if(g!==void 0){var h=c[a].selectableRects;h!==void 0&&(g=h);e[a]=b.writingMode.getRectBoundariesForScreen(g,
b.currentTopOfScreen)}}return e},isPointOnVisiblePage:function(b,a,c){var f=b.writingMode.height(b),e=b.writingMode.height(b.pageOverflowDiv);return b.writingMode.isPointOnVisiblePage(f,e,a,c)},showEndOfDocument:function(b){b.currentTopOfScreen=b.currentBottomOfScreen;j(b)},isIframePaginationValid:function(b){var a=b.screenManager.validationData;if(a){var c=b.contentDocument.body,f=a.bodyDimensions,b=$(b).parent();if(c.offsetHeight===f.height&&c.offsetWidth===f.width||c.offsetHeight<=b.height()&&
c.offsetWidth<=b.width())return!0;c=c.lastElementChild;return(a=a.lastElementPos)&&c?(b=$(c),c=b.offset(),f=b.width(),b=b.height(),c.top===a.top&&c.left===a.left&&f===a.width&&b===a.height):!1}return!0},clearIframePaginationValidation:function(b){b.screenManager.validationData=null},cleanupIframe:function(b){b.screenManager=null}}}(),KindlePaginatorDefaultParser=function(){function d(a,b,c,h,l,m){c<0&&(c=0);h<0&&(h=0);if(b.previousTop===c&&b.previousBottom===h&&b.previousFontSize===m)return!1;b.previousTop=
c;b.previousBottom=h;b.previousFontSize=m;if(c<a.minDocTop)a.minDocTop=c;if(c>a.maxDocTop)a.maxDocTop=c;b=h;if(b>a.docBottom)a.docBottom=b;h-=c;m===void 0&&(m=h);h=c+Math.floor((h-m)/2);m=h+m;a=a.nodeHeightRanges;for(c+=1;c<h;)a[c]>=0||(a[c]=-l),++c;for(;c<m;)a[c]>=0||(a[c]=l),++c;for(;c<b;)a[c]===void 0&&(a[c]=-l),++c;return!0}function k(a){for(var a=a.nodeHeightRanges,b=a.length,c=0,h,l,m,p,o;c<b;){for(;a[c]<0;)a[c]=-a[c],++c;if(a[c]>=0){for(++c;a[c]>=0;)++c;if(a[c]<0){h=c;p=a[h-1];for(++c;a[c]<
0;)++c;l=c-1;o=a[c];if(o>=0){m=Math.floor((h+l)/2);for(delete a[m];h<m;++h)a[h]=p;for(h=m+1;h<=l;++h)a[h]=o}else for(;h<=l;++h)a[h]=p}}++c}}function j(a,b,c,h,l,m,p,o){function v(){j(a+1,b,c,h,l,m,p,o)}var n=0;for(KindleRendererProcessTuning.startingOperation("HeightMap");a<b.length;){for(var q=b[a],t=c[q],A=t.rects,z=A.length,u=0;u<z;u++){var w=A[u],x=l.clientRectTop(w),w=l.clientRectBottom(w);if(x>0||w>0){var s=Math.round(x);d(h,m,s,s+Math.round(w-x+1),q,t.fontSize)&&n++}}if(n>o.count){KindleRendererProcessTuning.endingOperation("HeightMap",
n);setTimeout(v,o.interval);return}a++}KindleRendererProcessTuning.endingOperation("HeightMap",n);k(h);setTimeout(p.resolve,o.interval)}function b(a){var b=[],c;for(c in a){var h=parseInt(c,10);b.push(h)}b.sort(function(a,b){return a-b});return b}function a(a){var b={},a=a.body;b.bodyDimensions={height:a.offsetHeight,width:a.offsetWidth};if(a=a.lastElementChild){var c=$(a),a=c.offset(),h=c.width(),c=c.height();b.lastElementPos={top:a.top,left:a.left,width:h,height:c}}return b}function c(a,c,g,h,l,
m,p){if(h){var o=new jQuery.Deferred,d={count:KindleRendererProcessTuning.drawYieldFrequency("HeightMap"),interval:KindleRendererProcessTuning.drawYieldUpdateTime("HeightMap")},n=b(h);j(0,n,h,g,c,{},o,d);if(n.length>0)g.minPosition=n[0],g.maxPosition=n[n.length-1];o.promise().then(function(){var b=Array.prototype.slice.call(a.getElementsByTagName("hr")),g,h=[];for(g=0;g<b.length;++g)h.push(b[g].getBoundingClientRect());h=c.getTransformedClientRects(h);for(g=0;g<h.length;++g)m.push(h[g]);b=[];b=b.concat(Array.prototype.slice.call(a.getElementsByClassName("page-break")));
b=b.concat(Array.prototype.slice.call(a.getElementsByClassName("pagebreak")));g=[];for(h=0;h<b.length;++h)g.push(b[h].getBoundingClientRect());g=c.getTransformedClientRects(g);for(h=0;h<g.length;++h)l.push(Math.round(c.clientRectTop(g[h])));p()},function(){})}}return{createHeightMap:function(b,e,g,h){var l={nodeHeightRanges:[],minDocTop:Infinity,maxDocTop:-Infinity,minPosition:Infinity,maxPosition:0,minDocTop:Infinity,maxDocTop:0,docBottom:0};l.creationTimer=KindleMetricsProfiler("creation-timer");
l.validationData=a(b);l.wordMap=g;var m=[],p=[];c(b,e,l,l.wordMap,m,p,function(){for(var a=m,b=0;b<a.length;b++){var c=a[b],g=l.nodeHeightRanges[c];if(g===void 0)l.nodeHeightRanges[c]="page-break";else if(g!=="page-break")for(var f=1;f<20;f++){if(l.nodeHeightRanges[c-f]!==g){l.nodeHeightRanges[c-f]="page-break";break}if(l.nodeHeightRanges[c+f]!==g){l.nodeHeightRanges[c+f]="page-break";break}}}for(a=0;a<p.length;a++){c=Math.round(e.clientRectTop(p[a]));b=Math.round(e.clientRectBottom(p[a]));if(c<l.minDocTop)l.minDocTop=
c;if(c>l.maxDocTop)l.maxDocTop=c;if(b>l.docBottom)l.docBottom=b;for(;c<b;c++)l.nodeHeightRanges[c]===void 0&&(l.nodeHeightRanges[c]="horizontal-rule")}m=null;l.creationTimer.endTimer();l.creationTimer.log();h(l)})}}}(),KindlePaginatorFixedContent=function(d,k,j,b){d={minDocTop:0,maxDocTop:0,docBottom:j,wordMap:k};(function(a){a.minPosition=Infinity;a.maxPosition=-Infinity;for(var b in k){var f=parseInt(b,10);if(f>a.maxPosition)a.maxPosition=f;if(f<a.minPosition)a.minPosition=f}})(d);(function(a){a.hasNextScreen=
function(a){return a===0};a.hasPreviousScreen=function(a){return a===j};a.getFirstReadingPositionAtHeight=function(){return null};a.getFirstEmptySpaceBeforeHeight=function(){return 0};a.getTopOfNodeAtPosition=function(){return 0};a.findNextScreen=function(b){return!a.hasNextScreen(b)?null:{topOfScreen:0,bottomOfScreen:j}};a.findPreviousScreen=function(a){return!this.hasPreviousScreen(a)?null:{topOfScreen:0,bottomOfScreen:j}}})(d);b(d)},KindlePaginatorScreenFragmentation=function(d,k,j,b,a){function c(a){a.hasNextScreen=
function(a){return this.maxDocTop>=a};a.hasPreviousScreen=function(a){return a>this.minDocTop};a.getFirstReadingPositionAtHeight=function(a){if(this.nodeHeightRanges.length===0)return null;a:{for(var c=this.nodeHeightRanges,g=a;g<c.length;g+=1)if(a=c[g],a!==void 0&&a!==f&&a!==e){a=Math.abs(a);break a}a=this.maxPosition+1}if(this.wordMap[a]===void 0)return a;c=b.unionRect(this.wordMap[a].rects);for(g=a;g>=this.minPosition;g--)if(this.wordMap[g]!==void 0)if(b.unionRect(this.wordMap[g].rects).bottom<
c.top)break;else a=g;return a};a.getFirstEmptySpaceBeforeHeight=function(a){for(var b,c=a;c>=0;c-=1)if(b=this.nodeHeightRanges[c],b===void 0||b===f)return c;return a};a.getTopOfNodeAtPosition=function(a,c){if(c<this.minPosition)return 0;if(c>this.maxPosition)return this.maxDocTop;for(;c<=this.maxPosition;){var e=this.wordMap[c];if(e){for(var e=e.rects,g=Infinity,f=0;f<e.length;f++){var d=b.clientRectTop(e[f]);d<g&&(g=d)}return Math.round(g)}c+=1}return 0};a.findBestPaginationNearBottom=function(a,
c){var e=this.nodeHeightRanges[c];return e!==void 0&&(e=this.wordMap[e]&&this.wordMap[e].rects,e!==void 0&&(e=Math.floor(b.clientRectTop(e[0])+1),a<=e&&e<c))?e:c-1};a.findBestPaginationNearTop=function(a,c){var e=this.nodeHeightRanges[a];return e!==void 0&&(e<0&&(e=-e),e=this.wordMap[e]&&this.wordMap[e].rects,e!==void 0&&(e=Math.floor(b.clientRectBottom(e[e.length-1])),a<e&&e<=c))?e:a+1};a.findNextScreen=function(a){if(this.nodeHeightRanges.length===0||!this.hasNextScreen(a))return null;for(var b=
a,c=0,e=0,g=!1,d=!1,n=this.nodeHeightRanges.length,q,e=a;e<=n;e+=1)if(c+=1,q=this.nodeHeightRanges[e],q===void 0?(b=e,d=g):q!==f&&(g=!0),q===f&&e>a){c=e-a;d=g;break}else if(c>=j){b===a&&(b=this.findBestPaginationNearBottom(a+1,a+j-1),d=g);c=b-a;break}b={topOfScreen:a,bottomOfScreen:0};e<n?b.bottomOfScreen=a+c:(b.bottomOfScreen=e,d=g);return!d&&e<n?this.findNextScreen(b.bottomOfScreen):b};a.findPreviousScreen=function(a){if(this.nodeHeightRanges.length===0||!this.hasPreviousScreen(a))return null;for(var b=
a,c=0,e=0,g,d=!1,n=!1,e=a;e>=0;e-=1)if(c+=1,g=this.nodeHeightRanges[e],g===void 0?(b=e,n=d):g!==f&&(d=!0),g===f&&e<a){if(d)return this.findNextScreen(e);c=0;a=e}else if(c>=j){b===a&&(b=this.findBestPaginationNearTop(a-j,a-1),n=d);c=a-b;break}if(e<0)return this.findNextScreen(0);result={topOfScreen:b,bottomOfScreen:b+c};return!n&&e>0?this.findPreviousScreen(result.topOfScreen):result}}var f="page-break",e="horizontal-rule";KindlePaginatorDefaultParser.createHeightMap(d,b,k,function(b){c(b);a(b)})},
KindleRenderer=function(){function d(a,b,c){a={status:a};if(b!==void 0)a.errorCode=b;if(c!==void 0)a.errorMsg=c;y!==void 0&&y(a)}function k(a,b){d(p,a,b?b:"no msg")}function j(){s=!1;d(v)}function b(){r!==null&&(r.endTimer(),r.log(),r=null);s=!0;d(n)}function a(a){s=!1;k(A,a)}function c(a){KindleRendererSettings.updateSettings(a);KindleGlyphRenderer.updateSettings(a);KindleRendererContentDisplay.updateSettings(a)}function f(a){a=parseInt(a,10);isNaN(a)&&(a=0);KindleRendererContentDisplay.gotoPosition(a,
!0)}function e(){return setTimeout(function(){x||(w=!0,k(q,"Init timed out"))},u)}function g(a){clearTimeout(a);return e()}function h(h,m,n,l){r===null&&(r=KindleMetricsProfiler("Renderer-Load"));y=n.statusCallback;w=!1;if(h)if(h.bookInfo&&h.containerId)if(G=$(document.getElementById(h.containerId)),G.length===0)k(t,"Container not found");else{d(o);KindleRendererWordIteratorFactory.initialize(G.get(0));KindleRendererDeviceSpecific.initialize();u=KindleRendererDeviceSpecific.rendererInitializationTimeout();
var p=e();KindleRendererFragmentLoader.initialize(h.bookInfo).then(function(){w||(p=g(p),KindleRendererSettings.initialize(h.bookInfo).then(function(){if(!w){p=g(p);KindleRendererPositionLoadingCalculator.updateScreenDimensions(G.width(),G.height());var e={waitNotification:j,readyNotification:b,errorNotification:a,annotationTriggered:n.annotationEventCallback};KindleRendererContentDisplay.initialize(G.get(0),e,h.bookInfo,l).then(function(){w||(p=g(p),c(m),h.startingPositionDfd.done(function(a){w||
(x=!0,f(a))}))},function(a){w||k(q,"Load Failure: "+a)})}},function(){w||k(q,"Load Failure: Metadata")}))},function(a){w||k(q,"Load Failure: "+a)})}else throw{name:"initializationError",message:"required parameters not present"};}function l(){if(!x)throw{name:"initializationError",message:"Please call KindleRenderer.initialize function first"};}var m=0,p=m++,o=m++,v=m++,n=m++,q=m++,t=m++,A=m++,z=m++,m=m++,u=12E4,w=!1,x=!1,s=!1,y=void 0,r=null,G=null;return{STATUS_ERROR:p,STATUS_LOADING:o,STATUS_PAGINATING:v,
STATUS_DONE:n,ERROR_LOAD_FAILURE:q,ERROR_CONTAINER_NOT_FOUND:t,ERROR_UNABLE_TO_GET_BOOK_CONTENT:A,ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT:z,ERROR_UNKNOWN:m,PAGE_LOAD_INCOMPLETE_FLAG_NAME:"PageLoadIncomplete",initialize:function(a,b,c,e){try{h(a,b,c,e)}catch(g){}},shutdown:function(){try{x&&(x=!1,KindleRendererContentDisplay.cleanup(),KindleGlyphRenderer.cleanup(),KindleRendererCanvasInsertion.cleanup())}catch(a){}},getMinimumPosition:function(){l();return KindleRendererFragmentLoader.getMinimumPosition()},
getMaximumPosition:function(){l();return KindleRendererFragmentLoader.getMaximumPosition()},createWordIterator:function(){l();try{return KindleRendererWordIteratorFactory.build()}catch(a){}return null},updateSettings:function(a){try{c(a)}catch(b){return!1}},gotoPosition:function(a){l();try{f(a)}catch(b){}},nextScreen:function(){l();try{if(s)return KindleRendererContentDisplay.nextScreen()}catch(a){}return!1},previousScreen:function(){l();try{if(s)return KindleRendererContentDisplay.previousScreen()}catch(a){}return!1},
hasNextScreen:function(){l();try{if(s)return KindleRendererContentDisplay.hasNextScreen()}catch(a){}return!1},hasPreviousScreen:function(){l();try{if(s)return KindleRendererContentDisplay.hasPreviousScreen()}catch(a){}return!1},getPagePositionRange:function(){l();try{if(s)return KindleRendererContentDisplay.getPagePositionRange()}catch(a){}return{currentTopOfPage:0,currentBottomOfPage:0}},getPageSelectableItemBoundaries:function(){l();try{if(s)return KindleRendererContentDisplay.getSelectableItemBoundaries()}catch(a){}return null},
onWindowResize:function(){if(x)try{KindleRendererPositionLoadingCalculator.updateScreenDimensions(G.width(),G.height()),KindleRendererContentDisplay.onWindowResize()}catch(a){}},handleClick:function(a,b){try{if(s)return KindleRendererContentDisplay.handleClick(a,b)}catch(c){}return null},reloadAnnotations:function(){try{s&&KindleRendererContentDisplay.reloadAnnotations()}catch(a){}},getContentRects:function(){l();try{if(s)return KindleRendererContentDisplay.getContentRects()}catch(a){}return null},
getZoomableAt:function(a,b){l();try{if(s)return KindleRendererContentDisplay.getZoomableAt(a,b)}catch(c){}return null},getZoomableList:function(){l();try{if(s)return KindleRendererContentDisplay.getZoomableList()}catch(a){}return null}}}(),KindleRendererAnnotationRenderer=function(){function d(){var a={};return function(b,c){if(a[b]!==void 0)return a[b];var e=c[b];if(!e)return a[b]=!1;if(e.tagName==="IMG")return a[b]=!0;for(;e.tagName!=="BODY";){var g=$(e);if(g){var f=g.css("background-color"),g=
g.css("background-image");if(f&&f!=="rgba(0, 0, 0, 0)"&&f!=="transparent"||g&&g!=="none")return a[b]=!0;e=e.parentNode}}return a[b]=!1}}function k(a){var b={};$(a).find("[data-nid]").each(function(a,c){b[c.getAttribute("data-nid")]=c});return b}function j(a,b,c,g){a.style.top=b.top+e;a.style.height=b.height+e;a.style.left=b.left+e;a.style.width=b.width+e;a.className=c?g+" "+f:g}function b(a,b){var c=a.tagName==="IMG",e=!1,e=b!==void 0?b.tagName==="IMG":!1;return c!==e}function a(a,c,e,g,f,h){var q=
a.contentDocument,d=q.createElement("DIV"),A=!1,z={isNewLine:!0,isImageBound:!1,lineBounds:{top:0,height:0,left:0,right:0,width:0}},u=!1,w=!0;e.sort(function(b,c){return a.writingMode.clientRectCompare(b.rect,c.rect)});for(var x=e.length,k=0;k<x;k+=1){var y=e[k].dataNid;A||typeof y==="string"&&h(y,f)&&(A=!0);var w=e[k].rect,r=void 0,y=f[y],G=void 0,D=!1;if(k<x-1)r=e[k+1].rect,G=f[e[k+1].dataNid];y&&G&&(D=y.tagName==="IMG",u=b(y,G));if(w=a.writingMode.updateDivIfNewLineOrImageBound(z,w,r,D,u,q.width))j(d,
z.lineBounds,A,g),c.appendChild(d),d=q.createElement("DIV"),w=A=!1}}function c(a,b){b!==void 0&&(b.clickable!==void 0&&a.setAttribute(g,b.clickable),b.feedbackAnimation!==void 0&&a.setAttribute(h,b.feedbackAnimation))}var f="semiTransparentOverlay",e="px",g="data-annotationClickable",h="data-annotationClickFeedback";return{DRAW_AFTER:"after",DRAW_OVER:"over",ANNOTATION_CLICK_ATTRIBUTE:g,ANNOTATION_CLICK_FEEDBACK_ATTRIBUTE:h,createAnnotationElements:function(b,g,f,h){var j=[];if(f!==null)for(var n=
KindleRendererSettings.getSettings().annotationStyles,q=KindleRendererSettings.getSettings().annotationClick,t,A=t=null,z=k(b.contentDocument),u=d(),w=0;w<f.length;w+=1)if(t=f[w].type,n[t]){A=q?q[f[w].type]:void 0;if(n[t].drawingType==="over"){t=b;var x=h,s=g,y=f[w],r=n[f[w].type].className,G=A,A=z,D=u,C=t.contentDocument.createElement("DIV");C.setAttribute("annotationType",y.type);C.setAttribute("annotationStart",y.start);c(C,G);for(var G=[],I=y.start;I<=y.end;I+=1){var F=s[I]&&s[I].rects;if(F!==
void 0){var E=s[I].selectableRects;E!==void 0&&(F=E);for(var E=F.length,B=0;B<E;B++)G.push({rect:F[B],dataNid:s[I].dataNid})}}a(t,C,G,r,A,D);x.appendChild(C);t=C}else if(n[t].drawingType==="after"){r=b;t=h;D=f[w];s=n[f[w].type].className;y=g[D.start];C=-1;for(x=void 0;y===void 0&&C<100;)y=g[D.start+C],C+=1;if(y!==void 0)x=r.contentDocument.createElement("DIV"),x.setAttribute("annotationType",D.type),x.setAttribute("annotationStart",D.start),c(x,A),A=x,y=y.rects[y.rects.length-1],D=r.contentDocument,
C=D.createElement("DIV"),r.writingMode.positionDivAfterWord(C,y,e,D.width),C.className="note-annotation "+s,A.appendChild(C),t.appendChild(x);t=x}else t=null;t&&j.push(t)}return j},removeAnnotationElements:function(a,b){$(a).children('[annotationtype="'+b.type+'"][annotationstart="'+b.start+'"]').remove()}}}(),KindleRendererCanvasInsertion=function(){function d(a,b){for(var c=a;c<b.length;c++){b[c].innerHTML="";b[c].width=0;for(var h=b[c].attributes.length;--h>=0;)b[c].removeAttribute(b[c].attributes[h].nodeName)}}
function k(a,e,g,h){var l=e.getElementsByTagName("html")[0],m=e.getElementsByTagName("body")[0],p=Array.prototype.slice.call(m.getElementsByClassName("k4wc"));if(p.length>0){l.removeChild(m);var o=p.length,v=KindleRendererDeviceSpecific.maximumCanvases();b[a]=0;var n=null;j[a]||(j[a]=[]);var q=function(g){g=p[g];if(b[a]>=v)if(g.parentNode.removeChild(g),g=parseInt(g.id,10),h){if(n===null||g>n)n=g}else{if(n===null||g<n)n=g}else{var m=c(a,e);m.id=g.id;m.setAttribute("height",g.getAttribute("height"));
m.setAttribute("width",g.getAttribute("width"));m.setAttribute("data-nid",m.id);m.innerHTML=g.innerHTML;g.parentNode.replaceChild(m,g)}},t;if(h)for(t=o-1;t>=0;t--)q(t);else for(t=0;t<o;t++)q(t);if(n!==null){o=KindleMetricsProfiler("remove-extra-canvases");if(h){if($(m).find("*").filter(function(){return parseInt(this.getAttribute("id"),10)<n}).remove(),g.startPosition<=n)g.startPosition=n+1}else if($(m).find("*").filter(function(){return parseInt(this.getAttribute("id"),10)>n}).remove(),g.endPosition>=
n)g.endPosition=n-1;o.endTimer();o.log()}d(b[a],j[a]);l.appendChild(m)}}var j=[],b=[],a=0,c=function(){return window.ActiveXObject&&window.XMLHttpRequest?function(a,b){return b.createElement("CANVAS")}:function(c,e){b[c]++;var g=b[c],h=j[c],l=null;g>h.length?(l=e.createElement("CANVAS"),a+=1,h[g-1]=l):l=h[g-1];return l}}();return{changeSpanToCanvas:function(a,b,c,h){k(a,b,c,h)},cleanup:function(){for(var a in j)for(var b=j[a],c=b.length,h=0;h<c;h+=1){var l=b[h],m=l.parentNode;m!==null&&m!==void 0&&
m.removeChild(l)}j=null}}}(),KindleRendererColorHelper=function(){function d(a){if(a.charAt(0)==="#")return a.length===4?[parseInt(a.charAt(1)+a.charAt(1),16),parseInt(a.charAt(2)+a.charAt(2),16),parseInt(a.charAt(3)+a.charAt(3),16)]:a.length===7?[parseInt(a.charAt(1)+a.charAt(2),16),parseInt(a.charAt(3)+a.charAt(4),16),parseInt(a.charAt(5)+a.charAt(6),16)]:null;var a=a.toUpperCase(),f=b[a];if(f)return f;a=j.exec(a);return a!==null&&a.length===4?[parseInt(a[1],10),parseInt(a[2],10),parseInt(a[3],
10)]:null}function k(b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}var j=/RGB\s*\(\s*(\d*)\s*,\s*(\d*)\s*,\s*(\d*)\s*\)/,b={ALICEBLUE:[240,248,255],ANTIQUEWHITE:[250,235,215],AQUA:[0,255,255],AQUAMARINE:[127,255,212],AZURE:[240,255,255],BEIGE:[245,245,220],BISQUE:[255,228,196],BLACK:[0,0,0],BLANCHEDALMOND:[255,235,205],BLUE:[0,0,255],BLUEVIOLET:[138,43,226],BROWN:[165,42,42],BURLYWOOD:[222,184,135],CADETBLUE:[95,158,160],CHARTREUSE:[127,255,0],CHOCOLATE:[210,105,30],CORAL:[255,127,80],CORNFLOWERBLUE:[100,
149,237],CORNSILK:[255,248,220],CRIMSON:[220,20,60],CYAN:[0,255,255],DARKBLUE:[0,0,139],DARKCYAN:[0,139,139],DARKGOLDENROD:[184,134,11],DARKGRAY:[169,169,169],DARKGREY:[169,169,169],DARKGREEN:[0,100,0],DARKKHAKI:[189,183,107],DARKMAGENTA:[139,0,139],DARKOLIVEGREEN:[85,107,47],DARKORANGE:[255,140,0],DARKORCHID:[153,50,204],DARKRED:[139,0,0],DARKSALMON:[233,150,122],DARKSEAGREEN:[143,188,143],DARKSLATEBLUE:[72,61,139],DARKSLATEGRAY:[47,79,79],DARKSLATEGREY:[47,79,79],DARKTURQUOISE:[0,206,209],DARKVIOLET:[148,
0,211],DEEPPINK:[255,20,147],DEEPSKYBLUE:[0,191,255],DIMGRAY:[105,105,105],DIMGREY:[105,105,105],DODGERBLUE:[30,144,255],FIREBRICK:[178,34,34],FLORALWHITE:[255,250,240],FORESTGREEN:[34,139,34],FUCHSIA:[255,0,255],GAINSBORO:[220,220,220],GHOSTWHITE:[248,248,255],GOLD:[255,215,0],GOLDENROD:[218,165,32],GRAY:[128,128,128],GREY:[128,128,128],GREEN:[0,128,0],GREENYELLOW:[173,255,47],HONEYDEW:[240,255,240],HOTPINK:[255,105,180],INDIANRED:[205,92,92],INDIGO:[75,0,130],IVORY:[255,255,240],KHAKI:[240,230,
140],LAVENDER:[230,230,250],LAVENDERBLUSH:[255,240,245],LAWNGREEN:[124,252,0],LEMONCHIFFON:[255,250,205],LIGHTBLUE:[173,216,230],LIGHTCORAL:[240,128,128],LIGHTCYAN:[224,255,255],LIGHTGOLDENRODYELLOW:[250,250,210],LIGHTGRAY:[211,211,211],LIGHTGREY:[211,211,211],LIGHTGREEN:[144,238,144],LIGHTPINK:[255,182,193],LIGHTSALMON:[255,160,122],LIGHTSEAGREEN:[32,178,170],LIGHTSKYBLUE:[135,206,250],LIGHTSLATEGRAY:[119,136,153],LIGHTSLATEGREY:[119,136,153],LIGHTSTEELBLUE:[176,196,222],LIGHTYELLOW:[255,255,224],
LIME:[0,255,0],LIMEGREEN:[50,205,50],LINEN:[250,240,230],MAGENTA:[255,0,255],MAROON:[128,0,0],MEDIUMAQUAMARINE:[102,205,170],MEDIUMBLUE:[0,0,205],MEDIUMORCHID:[186,85,211],MEDIUMPURPLE:[147,112,216],MEDIUMSEAGREEN:[60,179,113],MEDIUMSLATEBLUE:[123,104,238],MEDIUMSPRINGGREEN:[0,250,154],MEDIUMTURQUOISE:[72,209,204],MEDIUMVIOLETRED:[199,21,133],MIDNIGHTBLUE:[25,25,112],MINTCREAM:[245,255,250],MISTYROSE:[255,228,225],MOCCASIN:[255,228,181],NAVAJOWHITE:[255,222,173],NAVY:[0,0,128],OLDLACE:[253,245,230],
OLIVE:[128,128,0],OLIVEDRAB:[107,142,35],ORANGE:[255,165,0],ORANGERED:[255,69,0],ORCHID:[218,112,214],PALEGOLDENROD:[238,232,170],PALEGREEN:[152,251,152],PALETURQUOISE:[175,238,238],PALEVIOLETRED:[216,112,147],PAPAYAWHIP:[255,239,213],PEACHPUFF:[255,218,185],PERU:[205,133,63],PINK:[255,192,203],PLUM:[221,160,221],POWDERBLUE:[176,224,230],PURPLE:[128,0,128],RED:[255,0,0],ROSYBROWN:[188,143,143],ROYALBLUE:[65,105,225],SADDLEBROWN:[139,69,19],SALMON:[250,128,114],SANDYBROWN:[244,164,96],SEAGREEN:[46,
139,87],SEASHELL:[255,245,238],SIENNA:[160,82,45],SILVER:[192,192,192],SKYBLUE:[135,206,235],SLATEBLUE:[106,90,205],SLATEGRAY:[112,128,144],SLATEGREY:[112,128,144],SNOW:[255,250,250],SPRINGGREEN:[0,255,127],STEELBLUE:[70,130,180],TAN:[210,180,140],TEAL:[0,128,128],THISTLE:[216,191,216],TOMATO:[255,99,71],TURQUOISE:[64,224,208],VIOLET:[238,130,238],WHEAT:[245,222,179],WHITE:[255,255,255],WHITESMOKE:[245,245,245],YELLOW:[255,255,0],YELLOWGREEN:[154,205,50]},a=[0.2126/255,0.7152/255,0.0722/255];return{toRgbArray:function(a){return d(a)},
calculateTextColorForBackground:function(a,b){var e=Math.abs(k(b)-k(a));if(e<0.3)var g=k(b),h=k(a),g=g<0.5?h<g?160:80:h>g?-160:-80,g=[Math.max(0,Math.min(255,a[0]+g)),Math.max(0,Math.min(255,a[1]+g)),Math.max(0,Math.min(255,a[2]+g))],e=Math.abs(k(g)-k(b))>e?g:null;else e=null;return e}}}(),KindleRendererColumnManager=function(){function d(){for(var a=0;a<s;a++)r[a].hide()}function k(a){if(C||I){if(a<=z)throw{name:"pagingError",message:"Repeating wait request"};z=a;A<0&&(t.waitNotification&&t.waitNotification(),
s>=KindleRendererDeviceSpecific.minColumnsToHide()&&(I=!0,d()));A=a}}function j(a){if((C||I)&&A>=0&&A<=a){E=0;A=-1;if(I||s>=KindleRendererDeviceSpecific.minColumnsToHide()){for(a=0;a<s;a++)r[a].show();C=!0;I=!1}t.readyNotification&&t.readyNotification()}}function b(a){return a>s*B?(t.errorNotification&&t.errorNotification("Irrecoverable Error"),!0):!1}function a(a,b,c){A<=a&&(b!==KindleRendererIframeManagerFactory.DATA_LOAD_ERROR&&E<F?(++E,n(),p(c)):(t.errorNotification&&t.errorNotification(b),A=
-1))}function c(e,g){try{if(b(g))return!1;if(r[e].copyIframeData(r[e===0?s-1:e-1])){var f=r[e].nextScreen(),h=e+1;if(f)return h<s?c(h,g+1):!0}var n=r[e].getCurrentProcessId();k(n);r[e].getCurrentProcessDfd().then(function(){c(e,g+1)&&j(n)},function(b){a(n,b,g)})}catch(m){p(g)}return!1}function f(g,h){try{if(b(h))return!1;var n=r[g===s-1?0:g+1];if(!n.hasPreviousScreen())return e(0,h),!1;if(r[g].copyIframeData(n)){var m=r[g].previousScreen(),n=g-1;if(m)return n>=0?f(n,h+1):c(1,h)}var q=r[g].getCurrentProcessId();
k(q);r[g].getCurrentProcessDfd().then(function(){f(g,h+1)&&j(q)},function(b){a(q,b,h)})}catch(l){p(h)}return!1}function e(b,e,g){var f;r[0].gotoPosition(b,g)?(f=KindleRendererRequestId.getUniqueRequestId(),k(f),j(f)):(f=r[0].getCurrentProcessId(),k(f),b=r[0].getCurrentProcessDfd(),s===1?b.then(function(){j(f)},function(b){a(f,b,e)}):b.then(function(){c(1)&&j(f)},function(b){a(f,b,e)}))}function g(){try{if(s===1){var b=r[0].nextScreen();if(!b){var e=r[0].getCurrentProcessId();k(e);r[0].getCurrentProcessDfd().then(function(){g();
j(e)},function(b){a(e,b,0)})}return b}else return c(0,0)}catch(f){return p(0),!1}}function h(){try{if(s===1){var b=r[0].previousScreen();if(!b){var c=r[0].getCurrentProcessId();k(c);r[0].getCurrentProcessDfd().then(function(){h();j(c)},function(b){a(c,b,0)})}return b}else return f(s-1,0)}catch(e){return p(0),!1}}function l(a){for(;a<s;a++)r[a].reloadNotification()}function m(){var a=r[0].getCurrentPosition();a!==null&&(G=a)}function p(a){m();l(0);e(G,a)}function o(a){if(u&&a&&a.length>0){var b=document.getElementById("renderer_translation_div");
if(!b)b=document.createElement("div"),b.id="renderer_translation_div",$(b).css({visibility:"hidden","z-index":-1E3}),u.appendChild(b);$(b).css({margin:a});a=window.getComputedStyle(b);return{top:parseFloat(a.marginTop),bottom:parseFloat(a.marginBottom),left:parseFloat(a.marginLeft),right:parseFloat(a.marginRight)}}return{top:0,bottom:0,left:0,right:0}}function v(){var a=KindleRendererSettings.getSettings().inlineBaseDirection,b=a&&a.value===a.VERTICAL,a=o(w),c,e;b?(a={top:a.left,right:a.bottom,bottom:a.right,
left:a.top},c=$(u).height(),e=$(u).width()):(c=$(u).width(),e=$(u).height());return{margins:a,parentWidth:c,parentHeight:e,getStyle:function(a){return b?{top:a.left,left:a.top,width:a.height,height:a.width}:a}}}function n(){s=Math.max(s,1);for(var a=v(),b=a.parentHeight,c=a.margins,e=x-(c.left+c.right),g=parseInt((a.parentWidth-e*(s-1))/s,10),f=c.top,b=b-c.top-c.bottom,c=0;c<s;c++){if(y[c]===void 0)y[c]=document.createElement("div"),y[c].name="column_"+c,$(y[c]).css("position","absolute"),u.appendChild(y[c]);
var h=a.getStyle({top:f,left:c*(g+e),height:b,width:g});h.display="";$(y[c]).css(h);r[c]===void 0&&(r[c]=KindleRendererIframeManagerFactory.build(y[c]),r[c].setAnnotationEventCallback(t.annotationTriggered),r[c].setOverlayManager(D));r[c].setCanPreloadPrevious(c===0);r[c].setCanPreloadNext(c===s-1)}for(c=s;c<y.length;c++)$(y[c]).hide();C||d()}function q(a){a=$(y[a]);return{x:parseInt(a.css("left"),10),y:parseInt(a.css("top"),10)}}var t={},A=-1,z=-1,u=null,w=0,x=20,s=0,y=[],r=[],G=0,D,C=!0,I=!1,F=
3,E=0,B=20;return{initialize:function(a,b,c){u=a;t=b;D=c;n()},cleanup:function(){for(var a=0;a<r.length;a++)r[a].cleanup()},hide:function(){d();I=C=!1},show:function(){I=!0},updateSettings:function(a){if(a.columns!==void 0)if(KindleRendererSettings.getSettings().fixedContent)s=1,x=0;else{if(a.columns.num!==void 0)s=a.columns.num;a.columns.gap!==void 0&&(x=parseInt(a.columns.gap,10))}if(a.margin!==void 0)w=a.margin;if(u!==null){n();for(var b=a.fontSizes!==void 0||a.fontSizeUnits!==void 0||a.fontFamily!==
void 0||a.lineHeight!==void 0||a.margin!==void 0||a.columns!==void 0||a.textAlign!==void 0,c=0;c<s;c++)r[c].updateSettings(a),!b&&a.fontColor!==void 0&&r[0].updateGlyphColor();b&&(C?p(0):l(0))}},gotoPosition:function(a,b){e(a,0,b)},nextScreen:function(){return g()},previousScreen:function(){return h()},hasNextScreen:function(){return r[s-1].hasNextScreen()},hasPreviousScreen:function(){return r[0].hasPreviousScreen()},getPagePositionRange:function(){var a;a=r[0].getPagePositionRange();if(s!==1){var b=
r[s-1].getPagePositionRange();a={currentTopOfPage:a.currentTopOfPage,currentBottomOfPage:b.currentBottomOfPage}}return a},getSelectableItemBoundaries:function(){for(var a={},b=0;b<s;b++){var c=$(y[b]),e=parseFloat(c.css("top")),c=parseFloat(c.css("left")),g=r[b].getSelectableItemBoundaries(),f;for(f in g){a[f]=[];for(var h=g[f],n=0;n<h.length;n++)a[f].push({top:h[n].top+e,bottom:h[n].bottom+e,left:h[n].left+c,right:h[n].right+c})}}return a},onWindowResize:function(){n();m();r[0].resizeNotification();
l(1);e(G,0)},handleClick:function(a,b){for(var c=0;c<s;c++){var e=$(y[c]),g=a-parseInt(e.css("left"),10),e=b-parseInt(e.css("top"),10);if(r[c].handleClick(g,e))return!0}return!1},reloadAnnotations:function(){for(var a=0;a<s;a++)r[a].reloadAnnotations()},getContentRects:function(){for(var a=[],b=0;b<s;b++){for(var c=r[b].getContentRects(),e=q(b),g=0;g<c.length;g++)c[g].left+=e.x,c[g].right+=e.x,c[g].top+=e.y,c[g].bottom+=e.y;a=a.concat(c)}return a},getZoomableAt:function(a,b){for(var c=0;c<s;c++){var e=
q(c);if(e=r[c].getZoomableAt(e,a,b))return e}return null},getZoomableList:function(){for(var a=[],b=0;b<s;b++)var c=q(b),c=r[b].getZoomableList(c),a=a.concat(c);return a}}}(),KindleRendererContentCorrection=function(){function d(a,b,c){if(c.getWritingMode()==="vertical"){a=$(b.body).find(".azn-ECJK");for(b=0;b<a.length;b++){var c=a[b].firstChild.nodeValue.charCodeAt(0),e;e=c>=65307&&c<=65308?!0:c===65310?!0:c===65293?!0:!1;e&&(c="rotate(90deg) translateX("+(c===65293?n:"0.5")+"em)",$(a[b]).css({display:"inline-block",
"-webkit-transform":c,width:"1em",height:"1em","text-indent":"0px","vertical-align":"text-top"}))}}}function k(a,b){var c=a.getComputedStyle(b.body).fontFamily,c=KindleRendererFontHelper.sanitizeJPFontFamily(c);b.body.style.fontFamily=c}function j(a,b){for(var c=$(b.body).find(".azn-UNB"),e=0;e<c.length;++e){var g=c[e].firstChild.nodeValue.charCodeAt(0);if(g===8213||g===8212||g===9472){if(g!==9472)g=String.fromCharCode(9472),c[e].innerHTML=g+g;$(c[e]).css("-webkit-transform","scaleY(.9)")}}}function b(a,
b,c){if(c.getWritingMode()==="vertical"){a=$("img",b.body).filter(function(){return $(this).css("float")!=="none"&&$(this).parent().css("display")!=="block"});for(b=0;b<a.length;b++)$(a[b]).parent().css("display","block")}}function a(a,b,c){if(c.getWritingMode()==="horizontal"){a=$('img[data-isGaiji="true"]',b.body);for(b=0;b<a.length;b++)$(a[b]).css("vertical-align","text-top")}}function c(a,b,c){var e={position:"absolute",height:a.height,width:a.width};b?$.extend(e,{top:a.top,left:a.left+1,borderLeft:"1px solid "+
c}):$.extend(e,{top:a.top-1,left:a.left,borderBottom:"1px solid "+c});return e}function f(a,b,c){var e={position:"absolute",height:a.height,width:a.width};b?$.extend(e,{top:a.top,left:a.left-1,borderRight:"1px solid "+c}):$.extend(e,{top:a.top+1,left:a.left,borderTop:"1px solid "+c});return e}function e(a,b,c){var e={position:"absolute",top:a.top,left:a.left};b?$.extend(e,{height:a.height,width:Math.floor(a.width/2),borderRight:"1px solid "+c}):$.extend(e,{height:Math.floor(a.height/2),width:a.width,
borderBottom:"1px solid "+c});return e}function g(a,b){for(var c,e=$("span",b.body),g=0;g<e.length;++g)if(currNode=e[g],c=a.getComputedStyle(currNode),c.webkitTextCombine==="horizontal"&&c.webkitWritingMode==="vertical-rl"&&currNode.textContent.length>1&&currNode.textContent.length<5){currNode.setAttribute("data-isTextCombineBlock","true");var f=currNode;c=parseInt(c.fontSize,10);$(f).css("-webkit-text-combine","none");var h=f.getClientRects();if(h.length>0){var n=h[0].height,h=-Math.floor((n-c)/
2)+"px";c=n>c?" scaleY("+c/n+")":"";$(f).css({"-webkit-transform":"rotate(270deg)"+c,margin:h+" 0px"})}}}function h(a,b){for(var c=$("rt",b.body),e=0;e<c.length;e++)$(c[e]).css("font-size","")}function l(a,b,g,h,n,m){if(a.nodeType===Node.TEXT_NODE)a=a.parentNode;if(b.webkitWritingMode.match(m.getWritingMode())!==null){var q=n.document,l=q.getElementById(o),d;a:{d=a;for(var t=b,A=0;A<=2;++A){if(!d)break;t=d.getAttribute(v)||t.textDecoration;if(!t||t==="none")d=d.parentElement,t=n.getComputedStyle(d);
else{d={node:d,decoration:t};break a}}d=void 0}n={underline:c,overline:f,"line-through":e};if(!d||!n[d.decoration])l&&l.lastChild&&$(l.lastChild).removeData(v);else{n=n[d.decoration];d.node.setAttribute(v,d.decoration);if(!l){A=q.getElementById(p);if(!A)return;l=q.createElement("DIV");l.id=o;l.style.position="relative";l.style.zIndex="-8";A.appendChild(l)}if(a.tagName==="IMG")g=h[g.start].rects;else{a=[];for(A=g.start;A<=g.end;A+=1)if(t=h[A]&&h[A].rects,t!==void 0){var j=h[A].selectableRects;j!==
void 0&&(t=j);for(var j=t.length,k=0;k<j;k++)a.push(t[k])}g=a.sort(m.clientRectCompare)}h=g;g=q.createDocumentFragment();k=l.lastChild;d=d.node;var a=b.webkitWritingMode==="vertical-rl",A=q.createElement("DIV"),t=!0,B=j=null;if(k&&h.length>0){var H=$(k).data(v);if(H){var K=d===H.node,J=m.checkIfNewLine(H.line,h[0]),K=K&&!J;$(k).removeData(v);if(K)t=!1,j=H.line,A=k}}for(k=0;k<h.length;k+=1)if(B=h[k],t&&(j={top:B.top,height:B.height,left:B.left,right:B.right,width:B.width}),B=$.extend({},j),t=m.checkIfNewLine(j,
h[k+1]))m.updateLineBounds(j,!0,h[k],h[k+1],q.width),$(A).css(n(j,a,b.color)),g.appendChild(A),A=q.createElement("DIV");b={line:B,word:h[k-1],node:d};$(g.lastChild).data(v,b);l.appendChild(g)}}}function m(a){for(var a=a.querySelectorAll("["+v+"]"),b=0;b<a.length;++b);}var p="content-overlays",o="text-decoration-correction",v="data-cjktextdecoration",n=".425",q=[],t=[],A=[];return{initialize:function(){KindleRendererSettings.getLanguageOptions().language==="ja"&&(q.push(k),q.push(j),q.push(b),q.push(a),
q.push(d),q.push(g),q.push(h),t.push(l),A.push(m))},applyDocumentWideCorrections:function(a,b,c){for(var e=0;e<q.length;++e)q[e](a,b,c)},applyNodeLocalCorrections:function(a,b,c,e,g){if(t.length!==0&&b){var f=e.getComputedStyle(a);f||(f=e.getComputedStyle(a.parentNode));for(var h=0;h<t.length;++h)t[h](a,f,b,c,e,g)}},cleanup:function(a){for(var b=0;b<A.length;++b)A[b](a)}}}(),KindleRendererContentDisplay=function(){function d(b){a=document.createElement("DIV");$(a).css({position:"absolute",top:0,left:0});
b.appendChild(a);c=document.createElement("DIV");$(c).css({position:"absolute",top:0,left:0});b.appendChild(c);k()}function k(){a&&$(a).css({width:$(a.parentNode).width(),height:$(a.parentNode).height()});c&&$(c).css({width:$(c.parentNode).width(),height:$(c.parentNode).height()})}function j(a){b!==a&&(b.hide(),b=a,b.show())}var b=KindleRendererColumnManager,a=null,c=null,f=!1;return{initialize:function(b,g,h,l){var m=new jQuery.Deferred;d(b);KindleRendererCover.initialize(a,g,h);KindleRendererColumnManager.initialize(c,
g,l);KindleRendererContentReflow.initialize();h.hasCover(function(a){f=a;m.resolve()},m.resolve);return m.promise()},cleanup:function(){KindleRendererCover.cleanup();KindleRendererColumnManager.cleanup();c=a=b=null},updateSettings:function(a){k();KindleRendererColumnManager.updateSettings(a)},gotoPosition:function(a,b){a=parseInt(a,10);a=Math.max(a,0);f&&a===0?(j(KindleRendererCover),KindleRendererCover.showCover()):(j(KindleRendererColumnManager),a=Math.min(a,KindleRendererFragmentLoader.getMaximumPosition()));
KindleRendererColumnManager.gotoPosition(a,b)},nextScreen:function(){if(b===KindleRendererCover)j(KindleRendererColumnManager),KindleRendererColumnManager.gotoPosition(0);else if(b.hasNextScreen())return b.nextScreen();return!0},previousScreen:function(){if(b===KindleRendererColumnManager)if(b.hasPreviousScreen())return b.previousScreen();else f&&(j(KindleRendererCover),KindleRendererCover.showCover());return!0},hasNextScreen:function(){return b.hasNextScreen()},hasPreviousScreen:function(){return f?
b!==KindleRendererCover:b.hasPreviousScreen()},getPagePositionRange:function(){return b.getPagePositionRange()},getSelectableItemBoundaries:function(){return b.getSelectableItemBoundaries()},onWindowResize:function(){k();KindleRendererCover.onWindowResize();KindleRendererColumnManager.onWindowResize()},handleClick:function(a,c){return b.handleClick(a,c)},reloadAnnotations:function(){b.reloadAnnotations()},getContentRects:function(){return b.getContentRects()},getZoomableAt:function(a,c){return b.getZoomableAt(a,
c)},getZoomableList:function(){return b.getZoomableList()}}}(),KindleRendererContentFragmentation=function(){function d(a){a=$.extend(!0,{},a);if(!isFinite(a.startPosition)||!isFinite(a.endPosition))a.startPosition=0,a.endPosition=1E4;if(a.startPosition<0)a.startPosition=0;if(a.endPosition<0)a.endPosition=1E4;return a}function k(a){return!a||!a.requestData||a.requestData.cancelled===!0}function j(a,b){for(var c=Math.max(l[0].cPos,b.startPosition),e=Math.min(l[l.length-1].ePos,b.endPosition),g=[],
f=Infinity,h=-Infinity,m=0;m<l.length;m+=1)if(l[m].sId===a){var d=m===0?l[m].cPos:Math.min(l[m].cPos,l[m-1].ePos+1),o=l[m].ePos;if(!(o<c)){if(d>e)break;d<f&&(f=d);o>h&&(h=o);g.push(m)}}g[0]===1&&l[0].cPos===l[0].ePos&&l[0].cPos===l[1].cPos&&g.push(0);return{fragmentList:g,startPosition:f,endPosition:h}}function b(a,b){if(b!==null)b.skeletonData=a.skeletonData,b.resourceInfo=a.resourceInfo,c(a),m.getBookFragments(function(a){k(b)&&(b=null);var c=b;if(c===null||c.loadedFragments===null)a.fragmentData=
null,a.fragmentMetadata=null,a.paraData=null;else if(c.numFragmentsLoaded+=1,c.loadedFragments[a.fragmentMetadata.id]=a,!(c.numFragmentsLoaded<c.fragmentsToLoad.length)&&(c.fragmentLoadMetrics.addCount("Success",1),c.fragmentLoadMetrics.endTimer(),c!==null)){var g=c.loadedFragments,a={},h;for(h in g){var m=g[h].imageRefs;if(m)for(var n in m)a[m[n]]=!0}h=[];for(var l in a)h.push(l);h.length>0?e(h,c):f(c)}},function(){if(b!==null){var a=b.requestData;b.fragmentLoadMetrics.addCount("Failure",1);b.fragmentLoadMetrics.endTimer();
var c=b.deferredResult;b.loadedFragments=null;b=b.glyphData=null;c.reject("Error trying to download file fragments.",a)}},b.fragmentsToLoad)}function a(a){if(a!==void 0&&a!==null&&a.length>0&&o>0){var b=[],c,e,g,f;p=[];e=Math.min(a.length,o);c=o-e;for(g=0;g<a.length&&g<e;++g)f=a[g].glyphFragmentMetadata.id,b[f]=a[g],delete p[f];if(c>0)for(g in p)if(b[g]=p[g],--c===0)break;p=b}}function c(a){if(a.skeletonMetadata){var b=a.skeletonMetadata.id;v[b]===void 0&&(v={},v[b]=a)}}function f(a){function b(c){k(a)&&
(a=null);var e=a;e===null||e.glyphData===null?(c.glyphData=null,c.glyphFragmentMetadata=null):(e.glyphChunkLoadCnt+=1,e.glyphData.push(c),e.glyphChunkLoadCnt<e.glyphChunksToDownload.length||(e.glyphLoadMetrics.addCount("Success",1),e.glyphLoadMetrics.endTimer(),g(e)))}function c(){if(a!==null&&a.glyphData!==null){var b=a.requestData,e=a.deferredResult;a.glyphLoadMetrics.addCount("Failure",1);a.glyphLoadMetrics.endTimer();a=a.glyphData=null;e.reject("Error trying to download glyph chunks.",b)}}if(a!==
null){var e,f=[],l=[],d;for(d in a.loadedFragments)if(e=h(parseInt(d,10)),e.gCks)for(var o=0;o<e.gCks.length;o+=1)$.inArray(e.gCks[o],l)===-1&&l.push(e.gCks[o]);e=[];for(d=0;d<l.length;d+=1)o=l[d],p[o]===void 0?e.push(o):f.push(p[o]);a.glyphData=f;e.length>0?(f=a.overallLoadMetrics.createSubTimer("glyph-loading"),f.addCount("NumGlyphCunks",e.length),a.glyphChunkLoadCnt=0,a.glyphChunksToDownload=e,a.glyphLoadMetrics=f,m.getGlyphFragments(b,c,e,a)):g(a)}}function e(a,b){var c=b.overallLoadMetrics.createSubTimer("fragment-resource-loading");
c.addCount("NumResources",a.length);b.fragmentResources={};b.fragmentResourceLoadCnt=0;b.fragmentResourceToDownload=a;b.fragmentResourceLoadMetrics=c;m.getResourceUrls(function(a){k(b)&&(b=null);var c=b;c!==null&&(c.fragmentResourceLoadCnt+=1,jQuery.extend(c.fragmentResources,a),c.fragmentResourceLoadCnt<c.fragmentResourceToDownload.length||(c.fragmentResourceLoadMetrics.addCount("Success",1),c.fragmentResourceLoadMetrics.endTimer(),f(c)))},function(){if(b!==null){var a=b.requestData,c=b.deferredResult;
b.fragmentResourceLoadMetrics.addCount("Failure",1);b.fragmentResourceLoadMetrics.endTimer();b=null;c.reject("Error trying to download fragment resources.",a)}},a)}function g(b){if(!(b===null||b.loadedFragments===null)){a(b.glyphData);var c,e;for(e in b.loadedFragments)if(b.loadedFragments[e].fragmentMetadata.lId===void 0)c=h(parseInt(e,10)),b.loadedFragments[e].fragmentMetadata.lId=c.lId,b.loadedFragments[e].fragmentMetadata.lt=c.lt,b.loadedFragments[e].fragmentMetadata.nOff=c.off;c=null;var g=b.deferredResult,
f=b.requestData,m={};m.skeletonData=b.skeletonData;m.resourceInfo=b.resourceInfo;m.glyphData=b.glyphData;m.fragmentResources=b.fragmentResources;m.contentRange={skeletonId:b.skeletonId,startPosition:b.fragmentsStartPosition,endPosition:b.fragmentsEndPosition};m.fragmentData=b.loadedFragments;b.overallLoadMetrics.endTimer();b.glyphData=null;b.fragmentResources=null;var b=b.loadedFragments=null,l=f.metrics.createSubTimer("waiting-to-callback");setTimeout(function(){l.endTimer();g.resolve(f,m);m=f=null},
KindleRendererDeviceSpecific.drawYieldUpdateTime())}}function h(a){for(var b=0;b<l.length;b++)if(l[b].fId===a)return l[b];return null}var l=null,m=null,p=[],o,v={};return{initialize:function(a){p=[];o=KindleRendererDeviceSpecific.glyphCacheMaxSize();v={};m=a;var b=new jQuery.Deferred;m.getFragmentMap(function(a){l=a.fragmentArray;b.resolve(a)},function(){b.reject()});return b.promise()},cleanup:function(){m=l=null;p=[];v={}},loadNextFragmentGroup:function(a,c,e){function g(a){k(r)?r=null:b(a,r)}function h(){if(r!==
null){var a=r.requestData;r.fragmentLoadMetrics.addCount("Failure",1);r.fragmentLoadMetrics.endTimer();r=null;o.reject("Error trying to download skeleton.",a)}}function l(){G.endTimer();k(r)?r=null:v[a]!==void 0?g(v[a]):m.getBookSkeleton(g,h,a)}var o=new jQuery.Deferred,c=d(c),p=e.metrics.createSubTimer("fragment-glyph-loading"),s=p.createSubTimer("fragment-loading"),c=j(a,c),c=d(c),y=c.fragmentList.slice();s.addCount("NumFragments",c.fragmentList.length);var r={deferredResult:o,skeletonId:a,fragmentsStartPosition:c.startPosition,
fragmentsEndPosition:c.endPosition,overallLoadMetrics:p,fragmentLoadMetrics:s,loadedFragments:{},fragmentsToLoad:y,numFragmentsLoaded:0,requestData:e},G=s.createSubTimer("waiting-to-begin");y.length===0?f(r):setTimeout(l,KindleRendererDeviceSpecific.drawYieldUpdateTime());return o.promise()},isContentRangeLoaded:function(a,b,c,e){if(a===null||a===void 0||!b||c===null||c===void 0||!e)return!1;if(a!==c)return!1;b=d(b);e=d(e);a=j(a,b);c=j(c,e);if(c.fragmentList.length>a.fragmentList.length)return!1;
for(e=0;e<c.fragmentList.length;++e)if(a.fragmentList.indexOf(c.fragmentList[e])===-1)return!1;return!0}}}(),KindleRendererContentReflow=function(){function d(a){a=a.contentDocument.getElementsByTagName("body")[0];return $(a).css("position")==="absolute"}function k(a,b){KindleRendererSettings.getLanguageOptions().needsPageRefresh&&!d(a)?(a.contentDocument.body.style.display="none",setTimeout(function(){a.contentDocument.body.style.display="block";b()},1)):b()}function j(a,b,c,f){g===null&&(g=KindleRendererWordMapGeneratorFactory.buildWordMapGeneratorForWordBounds());
KindleRendererContentCorrection.applyDocumentWideCorrections(a.contentWindow,a.contentDocument,a.writingMode);k(a,function(){a.writingMode.prepareForPagination(a);var o=a.contentDocument.getElementById(e);a.writingMode.floatToTopOfIframe(a.contentWindow,o);g.createWordMap(a.contentDocument,a.contentWindow,b,a.writingMode).then(function(b){KindleRendererContentCorrection.cleanup(a.contentDocument.body);d(a)?KindlePaginatorFixedContent(a.contentDocument,b,$(a).parent().height(),f):KindlePaginatorScreenFragmentation(a.contentDocument,
b,a.writingMode.height($(a).parent()),a.writingMode,f);k(a,function(){})},c.reject)})}function b(b,c,e,g){if(b.processingRequestId===c.requestId){b.writingMode.scrollToTopOfDocument(b);b.writingMode.resetHeight(b);var f={height:$(b).parent().height(),width:$(b).parent().width()},d=b.contentDocument.getElementsByTagName("body")[0];if(KindleRendererSettings.getSettings().initialExpandedBodyHeight!==void 0){var n=parseInt($(d).css("margin-top"),10),q=parseInt($(d).css("margin-bottom"),10);d.style.height=
parseInt(f.height,10)-n-q+"px"}n=d.getElementsByClassName("k4w-margin");for(q=0;q<n.length;q+=1){var j=parseInt(n[q].getAttribute("vertical"),10);if(j>0)n[q].style.marginTop=Math.round(j*0.01*f.height)+"px"}var A=c.reflowMetrics.createSubTimer("image-reflow");KindleRendererElementFitting.fitToViewport(c.requestId,d,b.writingMode,f).then(function(){b.processingRequestId!==c.requestId?(c.reflowMetrics.addCount("Cancelled",1),c.reflowMetrics.endTimer()):(A.endTimer(),a(b,c,e,g))},g.reject)}}function a(a,
b,c,e){var g=b.reflowMetrics.createSubTimer("screen-splitting");j(a,c,e,function(c){g.endTimer();g.log();a.processingRequestId!==b.requestId?(b.reflowMetrics.addCount("Cancelled",1),b.reflowMetrics.endTimer()):(a.screenManager=c,b.reflowMetrics.addCount("Success",1),b.reflowMetrics.endTimer(),e.resolve(b))})}function c(a,b){var c=KindleRendererDeviceSpecific.reflowTimeout();c>0&&setTimeout(function(){!b.isRejected()&&!b.isResolved()&&(a.reflowMetrics.addCount("Timeout",1),a.reflowMetrics.endTimer(),
b.reject())},c)}function f(a,e,g){var f=new jQuery.Deferred;c(e,f);e.reflowMetrics=e.metrics.createSubTimer("frame-reflow");var d=e.reflowMetrics.createSubTimer("waiting-to-begin");setTimeout(function(){d.endTimer();b(a,e,g,f)},KindleRendererDeviceSpecific.drawYieldUpdateTime());return f.promise()}var e="content-overlays",g=null;return{initialize:function(){KindleRendererContentCorrection.initialize()},reflow:function(a,b,c){return f(a,b,c)}}}(),KindleRendererContentScripts=function(){return{addInterfaceScripts:function(d){var k=
document.createElement("script");k.language="Javascript";k.type="text/javascript";k.id="kindleContentInterface";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{d.appendChild(k),d="var KindleContentInterface = function() { return { ",d+=" gotoPosition : function(frm, pos) {parent.KindleReaderUI.gotoPosition(pos); return false;}, ",d+=" buyNow : function() {parent.KindleReaderUI.openStoreDP();return false;}, ",d+=" showDetails : function() {parent.KindleReaderUI.openStoreDP();  return false;} ",
d+=" };}();",k.text=d}catch(j){}}}}(),KindleRendererContentStyleSanitization=function(){function d(a,b){var c=a[b];if(c===void 0){var g=e.exec(b);g!==null&&g.length>=3&&(b=g[1]+g[2].substring(0,1).toUpperCase()+g[2].substring(1),c=a[b])}return c}function k(a,b,c,e,f){if(b==="float")return f.hasFloat=!0;if(b==="position")return a=d(a,b),!(a==="inherit"||a==="static")?f.isPositioned=!0:!1;if(b==="width"){a=d(a,b);if(a!==void 0){if(!f.widths)f.widths={percent:[],fixed:[]};a.indexOf("%")>=0?f.widths.percent.push(a):
f.widths.fixed.push(a);return!0}return!1}if(b==="height"){a=d(a,b);if(a!==void 0){if(!f.heights)f.heights={percent:[],fixed:[]};a.indexOf("%")>=0?f.heights.percent.push(a):f.heights.fixed.push(a);return!0}return!1}if(b==="max-width"||b==="max-height"){a=d(a,b);if(a!==void 0&&a.indexOf("%")>=0){if(!f.prcntMaxDimension)f.prcntMaxDimension=[];f.prcntMaxDimension.push(a);return!0}return!1}if(b==="font-size")return a=d(a,b),a!==void 0&&!g.test(a)?(h.test(a)?f.remFontValue=a.trim():f.absFontValue=a.trim(),
!0):!1;if(b==="line-height")return a=d(a,b),a!==void 0?(f.lineHeight=a,!0):!1;if(b==="background-color")return a=d(a,b),a!==void 0?(f.backgroundColorRgb=KindleRendererColorHelper.toRgbArray(a.trim()),!0):!1;if(b==="text-indent")return!c.allowsNegativeTextIndent&&(a=d(a,b),a!==void 0)?(f.textIndent=a,!0):!1;if(b==="color")return f.hasTextColor=!0;if(b==="clear")return!c.allowsClearStyle?f.hasClearStyle=!0:!1;if(b==="-webkit-text-combine"&&e.getWritingMode()==="vertical")return f.textCombine=d(a,b),
!0;if(b==="font-family"&&c.language==="ja")return f.fontFamilyJP=d(a,b),!0;if(b==="display")f.display=d(a,b);return!1}function j(a,b,c){try{for(var e={},g=a.style.length,f=!1,h=0;h<g;h++)f|=k(a.style,a.style[h],b,c,e);if(f)return e}catch(d){}return null}function b(a,b){var c=KindleRendererScaleHelper.convertLength(a,"px");return c?(c=parseFloat(c),c=Math.floor(c),c=Math.min(c,b),c+"px"):a}function a(a,c,e,g,f,h,d){var j="",k=0;if(a.widths){for(var u=a.widths.percent,w=a.widths.fixed,x=0.95*d.width,
k=0;k<u.length;k++)j+="width: auto; ",a.display==="inline-block"&&parseInt(u[k],10)>95&&(j+="display: block; ");for(k=0;k<w.length;k++)u=b(w[k],x),j+=parseInt(u,10)<1?"width: auto; ":"width: "+u+"; "}if(a.heights){u=a.heights.percent;w=a.heights.fixed;x=0.95*d.height;for(k=0;k<u.length;k++)j+="height: auto; ",a.display==="inline-block"&&parseInt(u[k],10)>95&&(j+="display: block; ");for(k=0;k<w.length;k++)u=b(w[k],x),j+=parseInt(u,10)<1?"height: auto; ":"height: "+u+"; "}a.lineHeight&&(k=parseFloat(a.lineHeight),
a.lineHeight.indexOf("%")>0&&k>=f*100||/^\d*(\.\d+)?$/.test(a.lineHeight.trim())&&k>=f||(j+="line-height : "+f+"; "));if(a.prcntMaxDimension)for(k=0;k<a.prcntMaxDimension.length;k++)j+=a.prcntMaxDimension[k]+": none; ";a.hasFloat&&(j+="line-height : "+(f+l)+"; ");a.isPositioned&&(j+="position: inherit; ");a.backgroundColorRgb&&!a.hasTextColor&&c&&(c=KindleRendererColorHelper.calculateTextColorForBackground(c,a.backgroundColorRgb))&&(j+="color : rgb("+c[0]+", "+c[1]+", "+c[2]+"); ");a.absFontValue&&
(c=KindleRendererScaleHelper.scaleFont(a.absFontValue,e,g)||a.absFontValue,j+="font-size: "+c+"; ");a.remFontValue&&(h=Math.round(parseFloat(a.remFontValue)*parseInt(h,10))+"px",e=KindleRendererScaleHelper.scaleFont(h,e,g)||a.absFontValue,j+="font-size: "+e+"; ");a.textIndent&&parseInt(a.textIndent,10)<0&&(d=0.9*d.width,e=a.textIndent.replace(/-/g,""),e.indexOf("%")>0?(e=parseFloat(e,10)/100,e*=d,e=Math.min(e,d),e=Math.floor(e),e=Math.max(e,1),d=e+"px"):d=b(e,d),e=d,j+="text-indent: -"+e+"; padding-left: "+
e+"; ");a.hasClearStyle&&(j+="clear:none");a.textCombine&&(j+="-webkit-text-combine: "+a.textCombine+"; display: inline-block; text-indent: 0px; height: auto;");a.fontFamilyJP&&(sanitizedFontFamily=KindleRendererFontHelper.sanitizeJPFontFamily(a.fontFamilyJP),j+="font-family: "+sanitizedFontFamily+";");return j}function c(a){function b(){var a,d,l=0;f++;for(KindleRendererProcessTuning.startingOperation("SanitizeNodes");g.length&&l<h;)if(a=g.pop(),l++,a&&a.nodeType===Node.ELEMENT_NODE){(d=a.getAttribute("style"))&&
d.length>0&&a.tagName!=="IMG"&&e.push(a);a=a.childNodes;for(d=0;d<a.length;d++)g.push(a[d])}KindleRendererProcessTuning.endingOperation("SanitizeNodes",l);g.length?setTimeout(b,processTimeout):c.resolve(e,f)}var c=$.Deferred(),e=[],g=[],f=0,h=KindleRendererProcessTuning.drawYieldFrequency("SanitizeNodes");processTimeout=KindleRendererProcessTuning.drawYieldUpdateTime("SanitizeNodes");g.push(a);b();return c.promise()}function f(a){var b=[];try{if(window.ActiveXObject&&window.XMLHttpRequest)return c(a.body);
else for(var e=(new XPathEvaluator).evaluate("/html/body//*[@style]",a,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),g=e.iterateNext();g;)g.style.length>0&&g.tagName!=="IMG"&&b.push(g),g=e.iterateNext()}catch(f){return c(a.body)}return $.Deferred().resolve(b)}var e=/^(\w*)-(\w*)(-value)?$/,g=/%|[^r]em|smaller|larger/,h=/rem/,l=0.2;return{sanitizeCSS:function(b,c,e,g,f){for(var h=$('link[type="text/css"][title]',b.head),d=0;d<h.length;++d)h[d].removeAttribute("title");if(!c.fixedContent){d=!1;
h=b.getElementById("kindleReaderSanitizationStylesheet");if(!h){h=b.createElement("style");h.id="kindleReaderSanitizationStylesheet";h.type="text/css";for(var d=h,l=KindleMetricsProfiler("finding-interesting-rules"),k=b.styleSheets,u=[],w=k.length,x=0;x<w;x++)for(var s=k[x],y=u,r=e,G=g,D=(s=s.rules?s.rules:s.cssRules)&&s.length||0,C=0;C<D;C++){var I=j(s[C],r,G);if(I)I.selectorText=s[C].selectorText,y.push(I)}l.endTimer();l.log();d.sanitizationRules=u;d=!0}if(h.sanitizationRules.length>0){e=h.sanitizationRules;
g=c.fontColor?KindleRendererColorHelper.toRgbArray(c.fontColor):null;l=c.fontSizes;k=c.fontSizeUnits;c=c.lineHeight;u=getComputedStyle(b.documentElement).fontSize;w="";x=e.length;for(y=0;y<x;y++)w+=e[y].selectorText+" { ",w+=a(e[y],g,l,k,c,u,f),w+=" } ";h.innerHTML=w}d&&b.head.appendChild(h)}},sanitizeContent:function(b,c,e,g,h){var d=$.Deferred();if(c.fixedContent)return d.resolve();f(b).done(function(f){for(var l=c.fontColor?KindleRendererColorHelper.toRgbArray(c.fontColor):null,k=c.fontSizes,u=
c.fontSizeUnits,w=c.lineHeight,x=getComputedStyle(b.documentElement).fontSize,s=f.length,y=0;y<s;y++){var r=f[y],G=r,D=G.getAttribute("data-origStyle");D?G.setAttribute("style",D):G.setAttribute("data-origStyle",G.getAttribute("style"));if(G=j(f[y],e,g))D=r.getAttribute("style")||"",D+="; ",D+=a(G,l,k,u,w,x,h,e),r.setAttribute("style",D)}d.resolve()});return d.promise()},copySanitizationData:function(a,b){var c=a.getElementById("kindleReaderSanitizationStylesheet"),e=b.getElementById("kindleReaderSanitizationStylesheet");
if(c&&e)e.sanitizationRules=c.sanitizationRules}}}(),KindleRendererCover=function(){function d(g){a=b.ownerDocument.createElement("IMG");a.src=g;$(a).css("visibility","hidden");a.onload=function(){k(this);e=!0;c.readyNotification&&c.readyNotification()};b.appendChild(a)}function k(a){if(!(a===null||a===void 0)){var b=$(a),c=$(b.parent()),e=c.width(),c=c.height();b.css("visiblity","hidden");var f=1,d=a.offsetWidth,j=a.offsetHeight;d>0&&j>0?(b.attr("nativeWidth")===void 0&&b.attr("nativeWidth",d),b.attr("nativeHeight")===
void 0&&b.attr("nativeHeight",j)):(d=b.attr("nativeWidth")||e,j=b.attr("nativeHeight")||c);f=Math.min(e/d,c/j);d*=f;f*=j;b.css({height:f+"px",width:d+"px"});b.css({position:"absolute",left:Math.round((e-d)*0.5)+"px",top:Math.round((c-f)*0.5)+"px"});$(a).css("visibility","visible")}}function j(a){c.errorNotification&&c.errorNotification(a)}var b=null,a=null,c=null,f=null,e=!1;return{initialize:function(a,e,d){b=a;c=e;f=d},cleanup:function(){f=c=a=b=null;e=!1},hide:function(){$(b).hide()},show:function(){$(b).show()},
showCover:function(){e?c.readyNotification&&c.readyNotification():(c.waitNotification&&c.waitNotification(),f.getCoverUrl(d,j))},nextScreen:function(){return!0},previousScreen:function(){return!0},hasNextScreen:function(){return!0},hasPreviousScreen:function(){return!1},getPagePositionRange:function(){return{currentTopOfPage:0,currentBottomOfPage:0}},getSelectableItemBoundaries:function(){var b={};if(a&&a.getBoundingClientRect){var c=a.getBoundingClientRect();c&&(b[0]=[{left:c.left,top:c.top,right:c.right,
bottom:c.bottom}])}return b},onWindowResize:function(){k(a)},handleClick:function(){return!1},reloadAnnotations:function(){},getContentRects:function(){var b=$(a),b={left:parseInt(b.css("left"),10),top:parseInt(b.css("top"),10),width:b.width(),height:b.height()};b.right=b.left+b.width;b.bottom=b.top+b.height;return[b]},getZoomableAt:function(){return a?KindleRendererZoomableReflowableContentFactory.buildFromElement(a,{x:0,y:0}):null},getZoomableList:function(){return[]}}}(),KindleRendererDefaults=
function(){function d(d,j,b){d.styleSheet&&d.styleSheet.addRule?d.styleSheet.addRule(j,b):d.sheet&&d.sheet.insertRule&&d.sheet.insertRule(j+"{"+b+"}",d.sheet.cssRules?d.sheet.cssRules.length:d.sheet.rules.length)}return{addCSSRules:function(k,j){if(j==="mobi8"){var b=document.createElement("style");b.type="text/css";b.id="kindleReaderStylesheetDefaults";try{k.insertBefore(b,k.firstChild);d(b,"html","font-size: 15px;");d(b,"table","color: inherit; font-size: inherit; line-height: inherit; font-weight: inherit; font-variant:inherit; font-style:inherit; white-space: inherit; word-wrap: inherit;");
var a=KindleRendererSettings.getLanguageOptions();a&&(a.fontFamily&&d(b,"body","font-family: "+a.fontFamily+";"),a.lineHeight&&d(b,"body","line-height: "+a.lineHeight+";"));var c=KindleRendererSettings.getSettings().initialExpandedBodyHeight;c!==void 0&&d(stylesheet,"body","height: "+c+";")}catch(f){}}b=document.createElement("style");b.type="text/css";b.id="kindleReaderStylesheetOverrides";try{k.appendChild(b),j==="mobi7"&&(d(b,"body","font-family: Georgia, serif; word-wrap: break-word;"),d(b,"p",
"margin-top: 0px; margin-bottom: 0px; text-indent:2em"),d(b,".was-a-p","margin-top: 0px; margin-bottom: 0px; text-indent:2em;"),d(b,"hr","margin-top: 15px; margin-bottom: 15px;"),d(b,"center,dd,div,dl,dt,li,ol,pre,table,ul,hr,h1,h2,h3,h4,h5,h6","margin-top: 0px; margin-bottom: 0px;"),d(b,"blockquote","text-indent: 0px; margin-top: 0px; margin-bottom: 0px;"),d(b,"ul","list-style-type: disc;"),d(b,"ol, ul, li .was-a-p","text-indent: 0;"),d(b,"table.amazon-table-style-0","border-collapse:collapse; font-size: inherit;"),
d(b,"table.amazon-table-style-0 tr td","border:none; padding:1px;"),d(b,"table.amazon-table-style-0 tr th","border:none; padding:1px; text-align:justify"),d(b,"table.amazon-table-style-1","border-collapse:collapse; font-size: inherit;"),d(b,"table.amazon-table-style-1 tr td","border:1px solid black; padding:1px;"),d(b,"table.amazon-table-style-1 tr th","border:1px solid black; padding:1px; text-align:justify")),j==="mobi8"&&(d(b,"body","word-wrap: break-word; padding: 0px !important;"),d(b,".azn-FWURG",
"-webkit-text-orientation: upright;"),d(b,".azn-NTE","-webkit-text-emphasis: none !important"),d(b,".azn-UNB","letter-spacing: 0em !important; display: inline-block; text-indent: 0px !important; -webkit-text-orientation: vertical-right !important;"),d(b,".azn-JPLB","display:inline-block; text-indent: 0px !important;")),d(b,".semiTransparentOverlay","z-index: 10 !important; opacity: 0.5"),d(b,"svg img","display: none;"),d(b,".page-break","display:block; padding:1px"),d(b,".pagebreak","display:block; padding:1px"),
d(b,".defaultHighlight","background-color:#ffff9b"),d(b,".noDisplay","display:none"),d(b,"body","-webkit-user-select:none; -moz-user-select:none; unselectable: on; cursor: default; position: relative;"),KindleRendererSettings.getSettings().fixedContent||(d(b,"body","background: none !important; background-color: transparent !important;"),d(b,"html, body","width: auto; height: auto;")),d(b,".kindle-annotation-wrapper, .kindle-annotation-wrapper *","margin: auto; padding: 0"),d(b,"div#content-overlays",
"margin: 0px; padding: 0px;")}catch(e){}}}}(),KindleRendererDeviceSpecific=function(){var d={};return{initialize:function(){var k=KindleHostDeviceDetector.getDevicePlatform();if(k==="desktop"){if(d.fragmentBufferCapacityForGoTo=2,d.fragmentBufferCapacityForPageFlip=10,d.fragmentBufferCapacityForPageFlipGlyphs=3,d.drawYieldUpdateTime=25,d.drawYieldScreenManagerFrequency=5E3,d.drawYieldGlyphRendereringFrequency=1E3,d.drawYieldWordMapGenFrequency=5E3,d.drawYieldWordMapGenUpdateTime=25,d.drawYieldHeightMapFrequency=
5E3,d.drawYieldHeightMapUpdateTime=25,d.drawYieldSanitizeNodesFrequency=2500,d.drawYieldSanitizeNodesTime=0,d.reflowTimeout=-1,d.minColumnsToHide=2,d.maximumCanvases=4900,d.clientRectsExpire=KindleHostDeviceDetector.isIE(),d.rendererInitializationTimeout=6E4,d.glyphCacheMaxSize=15,KindleHostDeviceDetector.hasCanvasPerformanceProblem())d.maximumCanvases=1750,d.drawYieldGlyphRendereringFrequency=200}else k==="lassen"?(d.fragmentBufferCapacityForGoTo=1.2,d.fragmentBufferCapacityForPageFlip=7,d.fragmentBufferCapacityForPageFlipGlyphs=
2,d.drawYieldGlyphRendereringFrequency=200,d.reflowTimeout=2E4,d.maximumCanvases=1750,d.minColumnsToHide=1,d.rendererInitializationTimeout=2E4,d.drawYieldSanitizeNodesFrequency=2500,d.drawYieldSanitizeNodesTime=0,KindleHostDeviceDetector.isiPhone()?(d.drawYieldWordMapGenFrequency=20,d.drawYieldWordMapGenUpdateTime=10,d.drawYieldHeightMapFrequency=500,d.drawYieldHeightMapUpdateTime=10,d.drawYieldScreenManagerFrequency=250,d.drawYieldUpdateTime=50):(d.drawYieldWordMapGenFrequency=300,d.drawYieldWordMapGenUpdateTime=
50,d.drawYieldHeightMapFrequency=500,d.drawYieldHeightMapUpdateTime=20,d.drawYieldScreenManagerFrequency=250,d.drawYieldUpdateTime=10)):k==="metro"?(d.fragmentBufferCapacityForGoTo=2,d.fragmentBufferCapacityForPageFlip=10,d.fragmentBufferCapacityForPageFlipGlyphs=3,d.drawYieldUpdateTime=0,d.drawYieldScreenManagerFrequency=500,d.drawYieldGlyphRendereringFrequency=200,d.drawYieldWordMapGenFrequency=500,d.drawYieldWordMapGenUpdateTime=0,d.drawYieldHeightMapFrequency=500,d.drawYieldHeightMapUpdateTime=
0,d.reflowTimeout=-1,d.minColumnsToHide=2,d.maximumCanvases=1750,d.clientRectsExpire=!0,d.rendererInitializationTimeout=6E4,d.drawYieldSanitizeNodesFrequency=2500,d.drawYieldSanitizeNodesTime=0,d.glyphCacheMaxSize=15,d.clientRectsExpire=!0):k==="metroArm"?(d.fragmentBufferCapacityForGoTo=1.2,d.fragmentBufferCapacityForPageFlip=7,d.fragmentBufferCapacityForPageFlipGlyphs=2,d.drawYieldUpdateTime=0,d.drawYieldScreenManagerFrequency=500,d.drawYieldGlyphRendereringFrequency=200,d.drawYieldWordMapGenFrequency=
500,d.drawYieldWordMapGenUpdateTime=0,d.drawYieldHeightMapFrequency=500,d.drawYieldHeightMapUpdateTime=0,d.reflowTimeout=-1,d.minColumnsToHide=2,d.maximumCanvases=1750,d.clientRectsExpire=!0,d.rendererInitializationTimeout=9E4,d.drawYieldSanitizeNodesFrequency=2500,d.drawYieldSanitizeNodesTime=0,d.glyphCacheMaxSize=15,d.clientRectsExpire=!0,d.animatePageFlip=!1):(d.fragmentBufferCapacityForGoTo=1.2,d.fragmentBufferCapacityForPageFlip=7,d.fragmentBufferCapacityForPageFlipGlyphs=2,d.drawYieldUpdateTime=
50,d.drawYieldScreenManagerFrequency=250,d.drawYieldGlyphRendereringFrequency=200,d.drawYieldWordMapGenFrequency=300,d.drawYieldWordMapGenUpdateTime=50,d.drawYieldHeightMapFrequency=5E3,d.drawYieldHeightMapUpdateTime=50,d.drawYieldSanitizeNodesFrequency=2500,d.drawYieldSanitizeNodesTime=0,d.reflowTimeout=1E4,d.minColumnsToHide=2,d.maximumCanvases=1750,d.rendererInitializationTimeout=9E4,d.animatePageFlip=KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isiOS_4x());if(k==="metro")d.minColumnsToHide=
1,d.clientRectsExpire=!0;d.needsReflowOnPageFlip=KindleHostDeviceDetector.isiOS_4x()||KindleHostDeviceDetector.isChrome&&KindleHostDeviceDetector.isChrome()&&navigator.userAgent.indexOf("Chrome/18.")>=0;d.usesDocRelativeVerticalCoordinates=KindleHostDeviceDetector.isiOS();d.verticalParagraphsScaleSeparately=KindleHostDeviceDetector.isiPhone()},fragmentBufferCapacityForGoTo:function(){return d.fragmentBufferCapacityForGoTo},fragmentBufferCapacityForPageFlip:function(k){return k?d.fragmentBufferCapacityForPageFlipGlyphs:
d.fragmentBufferCapacityForPageFlip},drawYieldUpdateTime:function(){return d.drawYieldUpdateTime},glyphCacheMaxSize:function(){return d.glyphCacheMaxSize||0},drawYieldWordMapGenUpdateTime:function(){return d.drawYieldWordMapGenUpdateTime},drawYieldHeightMapUpdateTime:function(){return d.drawYieldHeightMapUpdateTime},drawYieldScreenManagerFrequency:function(){return d.drawYieldScreenManagerFrequency},drawYieldGlyphRendereringFrequency:function(){return d.drawYieldGlyphRendereringFrequency},drawYieldWordMapGenFrequency:function(){return d.drawYieldWordMapGenFrequency},
drawYieldHeightMapFrequency:function(){return d.drawYieldHeightMapFrequency},drawYieldSanitizeNodesFrequency:function(){return d.drawYieldSanitizeNodesFrequency},needsReflowOnPageFlip:function(){return d.needsReflowOnPageFlip},usesDocRelativeVerticalCoordinates:function(){return d.usesDocRelativeVerticalCoordinates},verticalParagraphsScaleSeparately:function(){return d.verticalParagraphsScaleSeparately},reflowTimeout:function(){return d.reflowTimeout},maximumCanvases:function(){return d.maximumCanvases},
animatePageFlip:function(){return d.animatePageFlip},clientRectsExpire:function(){return d.clientRectsExpire},minColumnsToHide:function(){return d.minColumnsToHide},rendererInitializationTimeout:function(){return d.rendererInitializationTimeout},drawYieldSanitizeNodesTime:function(){return d.drawYieldSanitizeNodesTime||0}}}(),KindleRendererElementFitting=function(){function d(a){return(a.getAttribute("style")||"")+";"}function k(a,b,c,e){var g=0,f=g=0;a>c&&(g=c/a);b>e&&(f=e/b);g=g>0&&f>0?g<f?g:f:
g>0?g:f;g!==0&&(a=g*parseInt(a,10),b=g*parseInt(b,10),b=Math.max(1,b),a=Math.max(1,a));return{height:a,width:b,scale:g}}function j(a){var b=a.getAttribute("data-isGaiji");if(b)return b==="true";var b=parseInt($(a).css("width"),10),c=parseInt($(a).css("height"),10),e=parseInt($(a).css("font-size"),10);if(Math.abs(b-e)<=1&&Math.abs(c-e)<=1)return a.setAttribute("data-isGaiji","true"),!0;a.setAttribute("data-isGaiji","false");return!1}function b(a,b){for(var c={neededCount:0,downloadedCount:0},e=function(){c.downloadedCount+=
1;c.downloadedCount===c.neededCount&&setTimeout(b,KindleRendererDeviceSpecific.drawYieldUpdateTime())},g=0;g<a.length;g+=1)if(a[g].src!==""&&(a[g].complete!==void 0&&a[g].complete===!1||a[g].height===0))c.neededCount+=1,a[g].onerror=e,a[g].onload=e,a[g].onabort=e;c.neededCount===0&&setTimeout(b,KindleRendererDeviceSpecific.drawYieldUpdateTime())}function a(a,b){if(b.width>0&&b.height>0){var c=a.offsetWidth>0&&a.offsetHeight>0?Math.min(b.width/a.offsetWidth,b.height/a.offsetHeight):1,e="scale("+c+
")";$(a).css({"-moz-transform":e,"-moz-transform-origin":"left top","-webkit-transform":e,"-webkit-transform-origin":"left top","-o-transform":e,"-o-transform-origin":"left top","ms-transform":e,"ms-transform-origin":"left top","-ms-transform":e,"-ms-transform-origin":"left top",transform:e,"transform-origin":"left top"});return{width:$(a).width()*c,height:$(a).height()*c}}}function c(a,c){var e=a.getElementsByTagName("IMG");e.length>0?b(e,c):c()}function f(b,f,o,v){var n=new jQuery.Deferred,b=function(){if($(f).css("position")===
"absolute")a(f,v),n.resolve();else{var b=f.getElementsByTagName("IMG");if(b.length>0){var c;for(c=0;c<b.length;c+=1){var m=b[c],z=m,u=$(z),w=u.css("max-height"),u=u.css("max-width"),w=w!=="auto"&&w!=="none",u=u!=="auto"&&u!=="none";if(w||u){var x=d(z);w&&(x+="max-height: none; ");u&&(x+="max-width: none; ");z.setAttribute("style",x)}z=m;z.getAttribute("data-nativeHeight")||z.setAttribute("data-nativeHeight",z.height);z.getAttribute("data-nativeWidth")||z.setAttribute("data-nativeWidth",z.width);z.getAttribute("data-nativeLeftOffset")||
z.setAttribute("data-nativeLeftOffset",z.offsetLeft);z.getAttribute("data-nativeTopOffset")||z.setAttribute("data-nativeTopOffset",z.offsetTop);z=m;if(z.className.indexOf("unsupsvg")>=0&&(z.src=h,z.height=z.getAttribute("data-nativeHeight"),z.width=z.getAttribute("data-nativeWidth"),z.height===0||z.width===0))z.height=l,z.width=l,z.setAttribute("data-nativeHeight",z.height),z.setAttribute("data-nativeWidth",z.width);var z=m,x=o.getAvailableSizeForImage(z,v,e),w=parseInt(z.getAttribute("data-nativeHeight"),
10),u=parseInt(z.getAttribute("data-nativeWidth"),10),u=k(w,u,x.height,x.width),w=u.height,u=u.width,s=z,y=w,r=u,G=x.height,D=x.width,x={},C=0,I=parseInt($(s).css("padding-top"),10),F=parseInt($(s).css("padding-bottom"),10),E=I+F;if(E+y>G)C=y+E-G,y=Math.ceil(I/E*C),C-=y,x.top=I-y,x.bottom=F-C;I=parseInt($(s).css("padding-left"),10);s=parseInt($(s).css("padding-right"),10);F=I+s;if(F+r>D)C=r+F-D,r=Math.ceil(I/F*C),D=C-r,x.left=I-r,x.right=s-D;r=d(z);r+="height: "+w+"px; width: "+u+"px; ";r+=(x.top!==
void 0?"padding-top: "+x.top+"px; ":"")+(x.bottom!==void 0?"padding-bottom: "+x.bottom+"px; ":"")+(x.left!==void 0?"padding-left: "+x.left+"px; ":"")+(x.right!==void 0?"padding-right: "+x.right+"px; ":"");z.setAttribute("style",r);j(m)||o.padImageIfNeeded(m)}m=o.calculateOverlappingImageSets(b,j);for(z=g;z>0&&m.length>0;){for(c=0;c<m.length;c+=1)if(u=m[c],w=u.imgs,u=k(u.height,u.width,v.height*e,v.width*e).scale,u!==0){D=r=x=void 0;for(C=0;C<w.length;C+=1)x=w[C],r=x.height*u,D=x.width*u,r<1||D<1||
(s=d(x),s+="height: "+r+"px; width: "+D+"px;",x.setAttribute("style",s))}--z;m=o.calculateOverlappingImageSets(b,j)}}if(o.getWritingMode()!=="vertical"){b=f.getElementsByTagName("TABLE");for(c=0;c<b.length;c++){m=b[c];z=v;u=w=0;x=m.getAttribute("data-nativeWidth");x||(x=$(m).width(),m.setAttribute("data-nativeWidth",x));r=Math.min(m.getAttribute("data-nativeLeftOffset"),m.offsetLeft);if(!r)r=m.offsetLeft,m.setAttribute("data-nativeLeftOffset",r);D=$(m.offsetParent).width()||z.width;D=Math.min(D-r,
z.width*e);x>D&&(u=D/x);u>0&&(w=u);w!==0&&(w="scale("+w+")",z=d(m),z+=" -moz-transform: "+w+"; -webkit-transform:"+w+"; -o-transform:"+w+"; -ms-transform:"+w+"; ms-transform:"+w+"; transform:"+w+"; ",w=$(m).css("float"),u="top ",u+=w==="right"?"right":"left",z+=" -moz-transform-origin: "+u+"; -webkit-transform-origin: "+u+"; -o-transform-origin: "+u+"; -ms-transform-origin "+u+"; ms-transform-origin "+u+"; transform-origin "+u+"; ",m.setAttribute("style",z))}}setTimeout(n.resolve,10)}};window.ActiveXObject&&
window.XMLHttpRequest?$(f.ownerDocument).ready(b):c(f,b);return n.promise()}var e=0.95,g=3,h="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' viewBox='0 0 100 100'><g><rect x='1%' y='1%' rx='20' ry='20' width='98%' height='98%' style='fill:white; stroke:gray;stroke-width:2;'></rect><text x='50%' y='50%' fill='black' font-size='8px' style='text-anchor: middle; dominant-baseline: central;'>Image Not Supported</text></g></svg>",l=200;return{fitToViewport:function(a,b,c,
e){return f(a,b,c,e)},resize:function(b,c){var e;$(b).css("position")==="absolute"&&(e=a(b,c));return e}}}(),KindleRendererEventHandler=function(){function d(d){var b=KindleRendererSettings.getSettings().clickableElementFeedbackStyles;if(b!==void 0){var a=b.className,d=$(d),b=function(){var b=$(this);b.unbind("animationend");b.unbind("webkitAnimationEnd");b.removeClass(a)};d.bind("animationend",b);d.bind("webkitAnimationEnd",b);d.addClass(a)}}function k(d){var b=document.createEvent("MouseEvents");
b.initEvent("click",!0,!0);d.dispatchEvent(b)}return{handleClick:function(j,b,a){var c;var f;if(f=b)b:{for(f=b;f!==null;){if(f.getAttribute!==void 0){var e=f.getAttribute("onclick")||f.getAttribute("href");if(e!==null&&e.length>0){f=!0;break b}}f=f.parentNode}f=!1}f&&(d(b),k(b),c=!0);if(!(b=c)){j=j.getElementById("annotation-section");j=$(j).find("["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']").children();b=null;c=-Infinity;f=j.length;for(e=0;e<f;e+=1){var g=j[e],h=$(g).offset();
h.top-10<a.y&&a.y<h.top+$(g).height()+10&&h.left-10<a.x&&a.x<h.left+$(g).width()+10&&(h=parseInt($(g).css("z-index"),10),isNaN(h)&&(h=0),h>c&&(c=h,b=g))}if(a=b){if((j=a.parentNode)&&j.getAttribute(KindleRendererAnnotationRenderer.ANNOTATION_CLICK_FEEDBACK_ATTRIBUTE)!=="false"){j=j.childNodes;for(b=0;b<j.length;b++)d(j[b])}k(a);b=!0}else b=!1}return b}}}(),KindleRendererFontHelper=function(){var d=/(sans)|(gothic)/i,k=/(Hiragino)|(HiraKaku)/;return{sanitizeJPFontFamily:function(j){var b=j.split(",");
if(!j.match(k)){for(var j="",a=0;a<b.length;++a){var c=b[a];j+=c.match(d)?"HiraKakuProN-W3, "+c:c.match(/serif/i)?"'Hiragino Mincho ProN', "+c:c;a<b.length-1&&(j+=",")}j.match(k)||(j+=",'Hiragino Mincho ProN'")}return j}}}(),KindleRendererFragmentLoader=function(){function d(b){for(var c=0;c<a.length;c++){var f=a[c];if(f.start<=b&&b<=f.end)return c}return 0}function k(e){f=e;var g=new jQuery.Deferred;KindleRendererContentFragmentation.initialize(f).then(function(e){var f=[],d,j=e.fragmentArray;for(d=
0;d<j.length;d+=1){var o=j[d].sId,k=d===0?j[d].cPos:Math.min(j[d].cPos,j[d-1].ePos+1),n=j[d].ePos,q=f[o];if(q===void 0)f[o]={start:k,end:n};else{if(k<q.start)q.start=k;if(n>q.end)q.end=n}}if(e.skeletonMap!==void 0)for(d=0;d<e.skeletonMap.length;++d)if(f[d])f[d].properties=e.skeletonMap[d].properties;a=f;b=e.fragmentArray;c=e.fragmentMetadata.bookType;g.resolve()},g.reject);return g.promise()}function j(a,c,h){f.getBookFragments(function(a){var e=a.fragmentMetadata.id,f;a:{for(f=0;f<b.length;f++)if(b[f].fId===
e){f=b[f];break a}f=null}var d,j;d=a.fragmentMetadata.lId===void 0||a.fragmentMetadata.lId===null?f.lId:a.fragmentMetadata.lId;j=a.fragmentMetadata.nOff===void 0||a.fragmentMetadata.nOff===null?f.off:a.fragmentMetadata.nOff;var n=document.createElement("DIV");n.id=d;n.setAttribute("data-nid",d);n.innerHTML=a.fragmentData;d=n.childNodes;for(var q=d.length,k=0;k<q;k+=1)d[k].ownChildIndex=j+k;h.resolve(c,{id:e,contentRange:{startPosition:f.cPos,endPosition:f.ePos},fragmentRoot:n,positionMap:a.posMap})},
function(){h.reject("Error trying to download file fragments ID : ",a)},[a])}var b=null,a=null,c=!1,f=null;return{initialize:function(a){return k(a)},cleanup:function(){KindleRendererContentFragmentation.cleanup();a=b=null;c=!1},loadFragments:function(a,b){var c=d(a.focus);return KindleRendererContentFragmentation.loadNextFragmentGroup(c,a,b)},getFragmentAtId:function(a,b){var c=new jQuery.Deferred;f?j(a,b,c):c.reject();return c.promise()},getFragmentIdForPosition:function(a){a:{var c=0;if(b[c].cPos<=
a&&a<=b[c].ePos)a=c;else{for(c=1;c<b.length;c+=1)if(b[c-1].ePos<a&&a<=b[c].ePos){a=c;break a}a=0}}return a},needToLoadFragments:function(a,b){var c;if(!a||!b)c=!0;else{c=d(a.startPosition);var f=d(b.focus);c=!KindleRendererContentFragmentation.isContentRangeLoaded(c,a,f,b)}return c},getMaximumPosition:function(){return b[b.length-1].ePos},getMinimumPosition:function(){return b[0].cPos},isPositionAtBeginningOfSkeletonOrDocument:function(c,f){return f<=b[0].cPos||f===a[c].start},isPositionAtEndOfSkeletonOrDocument:function(c,
f){return f>=b[b.length-1].ePos||f===a[c].end},getBookContentType:function(){return c},getSkeletonForPosition:function(a){return d(a)},getSkeletonRange:function(b){return{start:a[b].start,end:a[b].end}},getGroupInfo:function(b){if(a[b].properties&&a[b].properties.group)return a[b].properties.group;var c=b%2===0?b+1:b-1;return c<0||c>=this.getNumSkeletons()||a[c].properties&&a[c].properties.group?{start:b,length:1,spine:!0}:{start:Math.min(b,c),length:2,spine:!0}},isBlankPage:function(b){return!a[b].properties?
!1:a[b].properties.blank===!0},getNumSkeletons:function(){return a.length},getFragmentMap:function(){}}}(),KindleRendererIframeLoading=function(){function d(){window.focus()}function k(a){switch(a.which){case 219:case 221:a.shiftKey||a.preventDefault();break;case 37:case 38:case 33:case 39:case 40:case 34:case 32:case 8:a.preventDefault()}}function j(a,b){var c=window.document.createEvent("KeyboardEvent");c.initKeyEvent(a,b.bubbles,b.cancelable,window,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.keyCode,
b.charCode);window.document.dispatchEvent(c)}function b(a){var b=a.contentDocument.getElementsByTagName("head")[0];KindleRendererDefaults.addCSSRules(b,KindleRendererFragmentLoader.getBookContentType());KindleRendererSettings.addCSSRules(b);KindleRendererContentScripts.addInterfaceScripts(b);document.onmousewheel=function(){return!1};a.contentDocument.getElementsByTagName("body")[0].onselectstart=function(){return!1};a.contentWindow.onkeydown=function(a){k(a);j("keydown",a)};a.contentWindow.onkeyup=
function(a){k(a);j("keyup",a)};a.contentWindow.onkeypress=function(a){k(a);j("keypress",a)};a.contentWindow.onfocus=d;a.contentWindow.onclick=d}function a(a){if(a=a.getElementsByTagName("body")[0])for(;a.hasChildNodes();)a.removeChild(a.lastChild)}function c(a,b){if(a&&a.nodeType===Node.ELEMENT_NODE){var e=a.getAttribute("data-nid");e!==null&&(b[e]={linkNode:a,typeArray:[a.firstChild,a.nextSibling]});for(var e=a.childNodes,f=e.length,g=0;g<f;g+=1)c(e[g])}}function f(a){var b={};try{if(window.ActiveXObject&&
window.XMLHttpRequest)c(a.contentDocument.body,b);else for(var e=(new XPathEvaluator).evaluate("//*[@data-nid]",a.contentDocument,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),f=e.iterateNext();f;){var g=f.getAttribute("data-nid");b[g]={linkNode:f,typeArray:[f.firstChild,f.nextSibling]};f=e.iterateNext()}}catch(h){c(a.contentDocument.body,b)}return b}function e(a,b,c){a=a.contentDocument.getElementById(c);b[c]={linkNode:a,typeArray:[a.firstChild,a.nextSibling]}}function g(a,b,c){if(b||c)for(var a=
$(a).find("img"),e=0,f=0;f<a.length;f+=1){e=a[f].getAttribute("dataUrl");if(e===void 0||e===null)e=a[f].getAttribute("src");if(b&&b[e])a[f].src=b[e];else if(c&&c[e])a[f].src=c[e]}}function h(a){var b=[],c;for(c in a)b.push(parseInt(c,10));b.sort(function(a,b){return a-b});return b}function l(a,b,c){function f(){if(C!==null)D.insertBefore(C,I),C=null,r.lId=null,r.lt=-1}for(var d,l,j={},m=!1,k={},p={},s=!1,y=null,r={lId:null,lt:-1},G=null,D=null,C=null,I=null,F=h(c.fragmentData),E=0;E<F.length;E++){d=
c.fragmentData[F[E]];l=d.fragmentMetadata;if(r.lId!==l.lId||r.lt!==l.lt)f(),r.lId=l.lId,r.lt=l.lt,G=b[l.lId],G===void 0&&(e(a,b,l.lId),G=b[l.lId]),C=l.lt===0?G.linkNode:G.linkNode.parentNode,D=C.parentNode,I=C.nextSibling,C=D.removeChild(C);y=a.contentDocument.createElement(C.tagName);y.innerHTML=d.fragmentData;g(y,c.fragmentResources,d.resList===void 0?d.imageData:d.resList);for(var B=l.nOff;y.hasChildNodes();){var H=y.removeChild(y.firstChild);if(H.nodeType===Node.TEXT_NODE)H.ownChildIndex=B;C.insertBefore(H,
G.typeArray[l.lt]);B+=1}if(d.posMap!==void 0){var m=!0,K;for(K in d.posMap)j[K]=d.posMap[K]}if(d.paraIds!==void 0&&d.paraIds!==null){s=!0;for(l=0;l<d.paraIds.length;l+=1)k[d.paraIds[l]]=d.paraData[l];for(var J in d.imageData)p[J]=d.imageData[J]}d.fragmentData=null;d.imageData=null;d.paraData=null}f();I=C=D=d=null;a={};if(m)a.positionData=j;if(s)a.glyphData={paraData:k,imageData:p};return a}function m(c,e,f,g){if(c.processingRequestId===e.requestId){var d=c.contentDocument;c.screenManager=null;a(d);
KindleGlyphRenderer.clearIframeData(c);c.onload=function(){if(c.processingRequestId===e.requestId){c.onload=null;c.writingMode=KindleRendererWritingModeFactory.buildIFrameWritingMode(c);c.writingMode.resetIframeDimensions(c);var a=KindleRendererSettings.getSettings(),d=KindleRendererSettings.getLanguageOptions(),h=$(c).parent(),h={height:h.height(),width:h.width()};KindleRendererContentStyleSanitization.sanitizeCSS(c.contentDocument,a,d,c.writingMode,h);b(c);p(c,e,f,g)}};var h=f.skeletonData;d.open();
d.write(h);d.close()}}function p(a,b,c,e){var g=f(a);try{var d=l(a,g,c),h=KindleRendererSettings.getSettings(),j=KindleRendererSettings.getLanguageOptions(),m=$(a).parent(),k={height:m.height(),width:m.width()};KindleRendererContentStyleSanitization.sanitizeContent(a.contentDocument,h,j,a.writingMode,k).done(function(){e.resolve(b,d)})}catch(p){e.reject(b,p)}}return{loadIframe:function(a,b,c){var e=new jQuery.Deferred;a.processingRequestId===b.requestId?m(a,b,c,e):e.reject();return e.promise()},copyIframeContents:function(c,
e,f){function g(){if(f.processingRequestId===c.requestId)b(f),KindleRendererContentStyleSanitization.copySanitizationData(e.contentDocument,f.contentDocument),KindlePaginator.copyIframe(e,f),f.onload=null,f.writingMode.prepareForPagination(f),d.resolve(c)}var d=new jQuery.Deferred;if(f.processingRequestId===c.requestId){var h=e.contentDocument.getElementsByTagName("html")[0];a(f.contentDocument);f.writingMode.resetHeight(f);f.onload=g;var l=h.outerHTML;l===void 0&&(l="<html>"+h.innerHTML+"</html>");
f.contentDocument.open();f.contentDocument.write(l);f.contentDocument.close()}else d.reject();return d.promise()},cleanupIframe:function(b){a(b.contentDocument)},updateSettingsInIframe:function(a){if(a&&a.contentDocument){var b=a.contentDocument.getElementsByTagName("head")[0];if(b){KindleRendererSettings.addCSSRules(b);var b=KindleRendererSettings.getSettings(),c=KindleRendererSettings.getLanguageOptions(),e={height:$(a).parent().height(),width:$(a).parent().width()};KindleRendererContentStyleSanitization.sanitizeCSS(a.contentDocument,
b,c,a.writingMode,e);KindleRendererContentStyleSanitization.sanitizeContent(a.contentDocument,b,c,a.writingMode,e)}}}}}(),KindleRendererIframeManagerFactory=function(){function d(g){g.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest.cancelled=!0,this.currentRequest=null};g.createNewRequest=function(a,b){this.cancelCurrentRequest();this.currentRequest={type:a,requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("renderer-iframe-load"),retryCount:0,
initialPosition:b};this.currentRequestDfd=new jQuery.Deferred};g.willRetryCurrentRequest=function(){this.currentRequest&&this.currentRequest.retryCount++};g.canRetryCurrentRequest=function(){return this.currentRequest?this.currentRequest.retryCount<f:!0};g.getCurrentProcessDfd=function(){return this.currentRequestDfd.promise()};g.getCurrentProcessId=function(){return this.currentRequest.requestId};g.createIframe=function(a,b,c){var e=document.createElement("iframe");e.writingMode=KindleRendererWritingModeFactory.buildIFrameWritingMode(e);
e.index=c;e.setAttribute("frameBorder","0");e.setAttribute("id",b+"_frame_"+c);e.setAttribute("name","book_iframe_"+c);e.setAttribute("scrolling","no");e.setAttribute("tabindex",-1);$(e).css({height:"100%",width:a+"px",position:"absolute",top:"0px",left:"0px",visibility:"hidden"});return e};g.setIframeVisibility=function(a,b){if(this.showContent||!b)b?($(a).css({visibility:"visible","z-index":0}),$(a.pageOverflowDiv).css({visibility:"visible","z-index":0})):($(a).css({visibility:"hidden","z-index":e}),
$(a.pageOverflowDiv).css({visibility:"hidden","z-index":e}))};g.calculateIframePaginationData=function(a,b,e){var f=this,g=KindleRendererFragmentLoader.getBookContentType()==="topaz"?f.currentRequest.type===f.loadedType.PREVIOUS?KindleRendererIframePreparation.CANVAS_INSERTION_PREVIOUS:KindleRendererIframePreparation.CANVAS_INSERTION_NEXT:KindleRendererIframePreparation.CANVAS_INSERTION_NONE;KindleRendererIframePreparation.prepareIframe(a,f.currentRequest,b,e,g).then(function(b){if(a.processingRequestId===
b.requestId&&f.currentRequest&&f.currentRequest.requestId===b.requestId)a.processingRequestId=null,f.frameIsLoadedAndReady(a);f=null},function(a){f.currentRequest&&f.currentRequest.requestId===a.requestId&&f.currentRequestDfd.reject(c);f=null})};g.loadContentDataIntoIframe=function(b){var c=this,e=c.getIframeToLoad();if(e)c.contentRange[e.index]=b.contentRange,e.processingRequestId=c.currentRequest.requestId,KindleRendererIframeLoading.loadIframe(e,c.currentRequest,b).then(function(a,f){if(e.processingRequestId===
a.requestId&&c.currentRequest&&c.currentRequest.requestId===a.requestId)c.positionData[e.index]=f.positionData,c.calculateIframePaginationData(e,b,f);c=null},function(b){c.currentRequest&&c.currentRequest.requestId===b.requestId&&c.currentRequestDfd.reject(a);c=null})};g.loadFragmentsForRange=function(a){var c=this;KindleRendererFragmentLoader.loadFragments(a,c.currentRequest).then(function(a,b){c.currentRequest&&c.currentRequest.requestId===a.requestId&&c.loadContentDataIntoIframe(b);c=null},function(a,
e){c.currentRequest&&c.currentRequest.requestId===e.requestId&&c.currentRequestDfd.reject(b);c=null})};g.resizeWithoutReload=function(a){var b=this,e=this.iframes[a];e.processingRequestId=this.currentRequest.requestId;b.setIframeVisibility(e,!1);KindleRendererContentReflow.reflow(e,this.currentRequest,this.positionData[a]).then(function(){b.currentRequest&&b.currentRequest.requestId===e.processingRequestId&&(b.frameIsLoadedAndReady(e),b.setIframeVisibility(e,e.index===b.visibleIframeIndex));b=null},
function(){b.currentRequest&&b.currentRequest.requestId===e.processingRequestId&&(b.setIframeVisibility(e,e.index===b.visibleIframeIndex),b.currentRequestDfd.reject(c));b=null})};g.setCanPreloadNext=function(a){this.canPreloadNext=a};g.setCanPreloadPrevious=function(a){this.canPreloadPrevious=a};g.getIframeOrigin=function(a){a=$(this.iframes[a]);return{x:parseInt(a.css("left"),10),y:parseInt(a.css("top"),10)}};g.getBoundsWithOffset=function(a,b){if(a.getBoundingClientRect){var c=a.getBoundingClientRect();
if(c)return{top:c.top+b.y,right:c.right+b.x,bottom:c.bottom+b.y,left:c.left+b.x,width:c.width,height:c.height}}return null}}function k(a,b){a.gotoPosition=function(a,c){return b.gotoPosition(a,c)};a.nextScreen=function(){return b.nextScreen()};a.previousScreen=function(){return b.previousScreen()};a.copyIframeData=function(a){return b.copyIframeData(a.internal)};a.hasNextScreen=function(){return b.hasNextScreen()};a.hasPreviousScreen=function(){return b.hasPreviousScreen()};a.getPagePositionRange=
function(){return b.getPagePositionRange()};a.getCurrentPosition=function(){return b.getCurrentPosition()};a.getSelectableItemBoundaries=function(){return b.getSelectableItemBoundaries()};a.reloadAnnotations=function(){b.reloadAnnotations()};a.updateGlyphColor=function(){b.updateGlyphColor()};a.handleClick=function(a,c){return b.handleClick(a,c)};a.cleanup=function(){b.cleanup()};a.updateSettings=function(a){b.updateSettings(a)};a.reloadNotification=function(){b.reloadNotification()};a.resizeNotification=
function(){b.resizeNotification()};a.setAnnotationEventCallback=function(a){b.setAnnotationEventCallback(a)};a.getCurrentProcessDfd=function(){return b.getCurrentProcessDfd()};a.getCurrentProcessId=function(){return b.getCurrentProcessId()};a.show=function(){b.show()};a.hide=function(){b.hide()};a.getContentRects=function(){return b.getContentRects()};a.getZoomableAt=function(a,c,e){return b.getZoomableAt(a,c,e)};a.getZoomableList=function(a){return b.getZoomableList(a)};a.setOverlayManager=function(a){b.setOverlayManager(a)};
a.setCanPreloadPrevious=function(a){b.setCanPreloadPrevious(a)};a.setCanPreloadNext=function(a){b.setCanPreloadNext(a)};a.drawWordMap=function(){b.drawWordMap()};a.drawHeightMaps=function(){b.drawHeightMaps()}}var j=0,b=j++,a=j++,c=j++,f=5,e=-1E3;return{DATA_LOAD_ERROR:b,IFRAME_ERROR_LOADING:a,IFRAME_ERROR_PAGINATING:c,build:function(a){if(KindleRendererSettings.getSettings().fixedContent){var b={showContent:!0,canPreloadNext:!0,canPreloadPrevious:!0};d(b);KindleRendererIframeManagerFixedFactory.build(b,
a);a={}}else b={showContent:!0,canPreloadNext:!0,canPreloadPrevious:!0},d(b),KindleRendererIframeManagerReflowFactory.build(b,a),a={internal:b};k(a,b);return a}}}(),KindleRendererIframeManagerFixedFactory=function(){function d(d){d.findNextNonBlankPage=function(b,a){var c=this.findNextNonBlankPageInDirection(b,a);c===null&&(c=this.findNextNonBlankPageInDirection(b,!a));return c};d.findNextNonBlankPageInDirection=function(b,a){for(var c=b,f=KindleRendererFragmentLoader.getNumSkeletons();c>=0&&c<f;){if(KindleRendererFragmentLoader.isBlankPage(c)===
!1)return c;a?c+=1:c-=1}return null};d.getNeededSkeletonsFrom=function(b,a){for(var c=this.getSkeletonsToShowWith(b,a),f=0;f<c.length;f++)if(KindleRendererFragmentLoader.isBlankPage(c[f])===!1)return c;f=this.findNextNonBlankPage(a?Math.max.apply(Math,c)+1:Math.min.apply(Math,c)-1,a);return f===null?c:this.getSkeletonsToShowWith(f,a)};d.addSkeletonRangeToList=function(b,a,c){for(var f=0;f<c;f+=1)b.push(a+f)};d.getSkeletonsToShowWith=function(b,a){var c=KindleRendererFragmentLoader.getGroupInfo(b);
if(c.length>this.numberOfColumns){var f=[];this.addSkeletonRangeToList(f,b,Math.min(this.numberOfColumns,c.length-(b-c.start)));return f}return this.getGroupsToFillScreen(c,a)};d.getGroupsToFillScreen=function(b,a){var c=[];this.addSkeletonRangeToList(c,b.start,b.length);var f;f=a?b.start+b.length:b.start-1;for(var e=KindleRendererFragmentLoader.getNumSkeletons();c.length<this.numberOfColumns&&f>=0&&f<e;){var g=KindleRendererFragmentLoader.getGroupInfo(f);if(c.length+g.length<=this.numberOfColumns)this.addSkeletonRangeToList(c,
f,g.length);else break;a?f+=g.length:f-=g.length}return c};d.getNeededSkeletonsForGoTo=function(b){return this.getNeededSkeletonsFrom(KindleRendererFragmentLoader.getSkeletonForPosition(b),!0)};d.getNeededSkeletonsForPageFlip=function(b){var a=this.getCurrentlyVisibleSkeletons();return b>0?(b=Math.max.apply(Math,a),b=Math.min(b+1,KindleRendererFragmentLoader.getNumSkeletons()),this.getNeededSkeletonsFrom(b,!0)):(b=Math.min.apply(Math,a),b=Math.max(b-1,0),this.getNeededSkeletonsFrom(b,!1))};d.clearCacheReservations=
function(){for(var b=this.iframeStatus.length,a=0;a<b;a++)if(this.iframeStatus[a]===this.statusType.RESERVED)this.iframeStatus[a]=this.statusType.AVAILABLE};d.getLoadedSkeletons=function(){for(var b={},a=this.contentRange.length,c=0;c<a;c++)this.contentRange[c]&&this.iframes[c].processingRequestId===null&&(b[this.contentRange[c].skeletonId]=c);return b};d.reserveSkeletonsInCache=function(b){this.clearCacheReservations();for(var a=this.getLoadedSkeletons(),c=[],f=0;f<b.length;f++){var e=b[f],g=a[e];
if(g===void 0)c.push(e);else if(this.iframeStatus[g]===this.statusType.AVAILABLE)this.iframeStatus[g]=this.statusType.RESERVED}return c};d.getIndicesToShow=function(b){for(var a=this.getLoadedSkeletons(),c=[],f=0;f<b.length;f++)c.push(a[b[f]]);return c};d.shouldShowSpineAfterSkeleton=function(b){var b=this.contentRange[b].skeletonId,a=KindleRendererFragmentLoader.getGroupInfo(b),c=a.start+a.length-1;return a.spine||b===c?!0:!1};d.getSpineCountForIndicies=function(b){var a=0;for(i=0;i<b.length-1;i++)this.shouldShowSpineAfterSkeleton(b[i])&&
a++;return a};d.prepareSpine=function(){var b={position:"absolute",visibility:"visible","background-color":this.spineColor,"z-index":k},a=this.getAvailableSpine();$(a).css(b);return a};d.getAvailableSpine=function(){for(i=0;i<this.spines.length;i++)if(this.spines[i].status===this.statusType.AVAILABLE)return this.spines[i];var b=document.createElement("div");this.parent.appendChild(b);b.status=this.statusType.RESERVED;this.spines.push(b);return b};d.removeAllSpines=function(){for(i=0;i<this.spines.length;i++)$(this.spines[i]).css("visibility",
"hidden"),this.spines[i].status=this.statusType.AVAILABLE};d.isRTLProgression=function(){var b=KindleRendererSettings.getSettings().pageProgressionDirection;return b?b.value===b.RTL:!1};d.prepareDisplayElements=function(b,a,c){for(var f,e=[],g=0;g<b.length;g++){f=this.iframes[b[g]];var d=KindleRendererElementFitting.resize(f.contentDocument.body,a),l=Math.round((a.height-d.height)*0.5)+"px";$(f).css({top:l,height:d.height+"px",width:d.width+"px"});e.push(f);if(g!==b.length-1&&this.shouldShowSpineAfterSkeleton(b[g])){var j=
this.prepareSpine();$(j).css({top:l,height:d.height+"px",width:this.columnGap+"px"});e.push(j)}this.iframeStatus[f.index]=this.statusType.VISIBLE;this.setIframeVisibility(f,!0);c[f.index]=!1}return e};d.placeElementsHorizontally=function(b,a){var c=0,f;for(f=0;f<b.length;f++)c+=$(b[f]).width();var e,g=Math.floor((a-c)*0.5);for(f=0;f<b.length;f++)c=b[f],e=$(c).width(),$(c).css({left:this.isRTLProgression()?a-(g+e):g}),g+=e};d.showSkeletons=function(b){var b=this.getIndicesToShow(b.sort(function(a,
b){return a-b})),a=this.getCurrentlyVisibleIndices(),c={},f;for(f=0;f<a.length;f++)c[a[f]]=!0;if(b.length>0){var e=$(this.parent).height(),a=$(this.parent).width(),e={width:Math.round((a-this.columnGap*this.getSpineCountForIndicies(b))/b.length),height:e};this.removeAllSpines();this.placeElementsHorizontally(this.prepareDisplayElements(b,e,c),a)}for(f in c)if(c[f])this.iframeStatus[f]=this.statusType.AVAILABLE,this.setIframeVisibility(this.iframes[f],!1)};d.getCurrentlyVisibleIndices=function(){for(var b=
[],a=this.iframeStatus.length,c=0;c<a;c++)this.iframeStatus[c]===this.statusType.VISIBLE&&b.push(c);return b};d.getSkeletonsFromIndices=function(b){for(var a=[],c=0;c<b.length;c++){var f=this.contentRange[b[c]];f&&a.push(f.skeletonId)}return a};d.getCurrentlyVisibleSkeletons=function(){return this.getSkeletonsFromIndices(this.getCurrentlyVisibleIndices())};d.getPrioritizedPreloadList=function(b){var a=b.slice(0);if(b.length>0)for(var c=KindleRendererFragmentLoader.getNumSkeletons(),f=this.iframes.length,
e=Math.min.apply(Math,b),b=Math.max.apply(Math,b);a.length<f&&(e>0||b<c-1);){var g;for(g=0;g<this.numberOfColumns&&b<c-1&&a.length<f;g++)b++,a.push(b);for(g=0;g<this.numberOfColumns&&e>0&&a.length<f;g++)e--,a.push(e)}return a};d.getLowestPriority=function(b){for(var a=this.iframes.length,c=0,f=-1,e=0;e<a;e++){var g=this.contentRange[e];if(!g)return{iframeIndex:e,priorityRating:-Infinity};if(this.iframeStatus[e]===this.statusType.AVAILABLE)if(g=$.inArray(g.skeletonId,b),g===-1)return{iframeIndex:e,
priorityRating:-Infinity};else g>f&&(f=g,c=e)}return{iframeIndex:c,priorityRating:a-f}};d.pickSkeletonToPreload=function(b){for(var a=this.getLoadedSkeletons(),c=0;c<b.length;c++)if(a[b[c]]===void 0)return{skeletonId:b[c],priorityRating:b.length-c};return null};d.considerLoadingMoreSkeletons=function(){if(!this.currentRequest){var b=this.getPrioritizedPreloadList(this.getCurrentlyVisibleSkeletons()),a=this.pickSkeletonToPreload(b);if(a!==null&&this.getLowestPriority(b).priorityRating<a.priorityRating)this.createNewRequest(this.loadedType.PRELOAD,
null),this.currentRequest.skeletons=[a.skeletonId],this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(a.skeletonId))}};d.updateSettings=function(b){if(b.columns!==void 0){if(b.columns.num!==void 0)this.numberOfColumns=b.columns.num;if(b.columns.gap!==void 0)this.columnGap=b.columns.gap;if(b.columns.spineColor!==void 0)this.spineColor=b.columns.spineColor}};d.getIframeToLoad=function(){return this.currentRequest?this.iframes[this.getLowestPriority(this.getPrioritizedPreloadList(this.currentRequest.type===
this.loadedType.PRELOAD?this.getCurrentlyVisibleSkeletons():this.currentRequest.skeletons)).iframeIndex]:null};d.getDesiredRangeForSkeleton=function(b){b=KindleRendererFragmentLoader.getSkeletonRange(b);return{focus:b.start,startPosition:b.start,endPosition:b.end}};d.frameIsLoadedAndReady=function(){var b=this.currentRequest,a=this.reserveSkeletonsInCache(b.skeletons);a.length>0?this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(a[0])):(b.type===this.loadedType.PRELOAD&&this.clearCacheReservations(),
b.initialPosition!==null&&this.showSkeletons(b.skeletons),b.metrics.addCount("Success",1),b.metrics.endTimer(),b.metrics.log(),this.currentRequest=null,setTimeout(this.currentRequestDfd.resolve,10),b.type!==this.loadedType.PAGE_FLIP&&this.considerLoadingMoreSkeletons())};d.pageFlip=function(b){var b=this.getNeededSkeletonsForPageFlip(b),a=this.reserveSkeletonsInCache(b),c=Math.max.apply(Math,b);this.currentPosition=KindleRendererFragmentLoader.getSkeletonRange(c).start;if(a.length>0)return this.createNewRequest(this.loadedType.PAGE_FLIP,
null),this.currentRequest.skeletons=b,this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(a[0])),!1;this.showSkeletons(b);this.considerLoadingMoreSkeletons();return!0};d.nextScreen=function(){return this.pageFlip(1)};d.previousScreen=function(){return this.pageFlip(-1)};d.gotoPosition=function(b,a){var c=this.getNeededSkeletonsForGoTo(b),f=this.reserveSkeletonsInCache(c);if(a){var e=Math.max.apply(Math,c);this.currentPosition=KindleRendererFragmentLoader.getSkeletonRange(e).start}if(f.length>
0)return this.createNewRequest(this.loadedType.GOTO,b),this.currentRequest.skeletons=c,this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(f[0])),!1;this.clearCacheReservations();this.showSkeletons(c);return!0};d.getPagePositionRange=function(){var b=this.getCurrentlyVisibleIndices();if(b.length===0)return null;for(var a=Infinity,c=-Infinity,f=0;f<b.length;f++)var e=this.contentRange[b[f]],a=Math.min(a,e.startPosition),c=Math.max(c,e.endPosition);return{currentTopOfPage:a,currentBottomOfPage:c}};
d.getCurrentPosition=function(){return this.currentPosition};d.cleanup=function(){this.cancelCurrentRequest();for(var b=0;b<this.iframes.length;b++)KindleRendererIframeLoading.cleanupIframe(this.iframes[b]),KindlePaginator.cleanupIframe(this.iframes[b]),this.contentRange[b]=null,this.positionData[b]=null;this.iframes=null};d.hasNextScreen=function(){for(var b=this.getCurrentlyVisibleSkeletons(),a=KindleRendererFragmentLoader.getNumSkeletons()-1,c=0;c<b.length;c++)if(b[c]===a)return!1;return!0};d.hasPreviousScreen=
function(){for(var b=this.getCurrentlyVisibleSkeletons(),a=0;a<b.length;a++)if(b[a]===0)return!1;return!0};d.getSortedVisibleIndicies=function(){for(var b,a=[],c=this.getCurrentlyVisibleIndices(),f=0;f<c.length;f++){b=c[f];var e=this.contentRange[b].skeletonId;KindleRendererFragmentLoader.isBlankPage(e)||a.push([e,b])}a.sort(function(a,b){return a[0]-b[0]});b=[];for(f=0;f<a.length;f++)b.push(a[f][1]);return b};d.getContentRects=function(){for(var b=this.getSortedVisibleIndicies(),a=[],c=0;c<b.length;c++){var f=
b[c],e=this.iframes[f],f=this.getIframeOrigin(f);a.push(this.getBoundsWithOffset(e.contentDocument.body,f))}return a};d.getZoomableAt=function(b,a,c){for(var f=this.getCurrentlyVisibleIndices(),e=0;e<f.length;e++){var g=f[e],d=$(this.iframes[g]),d={x:b.x+parseInt(d.css("left"),10),y:b.y+parseInt(d.css("top"),10)};if(g=KindleRendererZoomablesFactory.buildFromCoord(this.iframes[g].contentDocument,d,a,c))return g}return null};d.getZoomableList=function(b){for(var a=[],c=this.getSortedVisibleIndicies(),
f=0;f<c.length;f++)var e=c[f],g=$(this.iframes[e]),g={x:b.x+parseInt(g.css("left"),10),y:b.y+parseInt(g.css("top"),10)},a=a.concat(KindleRendererZoomablesFactory.buildList(this.iframes[e].contentDocument,g));return a};d.getSelectableItemBoundaries=function(){return{}};d.show=function(){this.showContent=!0;for(var b=this.getCurrentlyVisibleIndices(),a=0;a<b.length;a++)this.setIframeVisibility(this.iframes[b[a]],!0)};d.hide=function(){this.showContent=!1;for(var b=this.getCurrentlyVisibleIndices(),
a=0;a<b.length;a++)this.setIframeVisibility(this.iframes[b[a]],!1)};d.handleClick=function(b,a){for(var c=this.getCurrentlyVisibleIndices(),f,e=0;e<c.length;e++){var g=this.iframes[c[e]],d=g.offsetLeft,l=g.offsetTop,j=g.offsetHeight,k=g.offsetWidth;if(b>=d&&b<=d+k&&a>=l&&a<=l+j){f=g;break}}return f?(b-=parseInt(f.offsetLeft,10),a-=parseInt(f.offsetTop,10),c=f.contentDocument.elementFromPoint(b,a),KindleRendererEventHandler.handleClick(f.contentDocument,c,{x:b,y:a})):!1};d.resizeNotification=function(){this.reloadNotification()};
d.reloadNotification=function(){this.showSkeletons(this.getCurrentlyVisibleSkeletons())};d.reloadAnnotations=function(){};d.updateGlyphColor=function(){};d.setAnnotationEventCallback=function(){};d.setOverlayManager=function(){};d.copyIframeData=function(){}}var k=-1;return{build:function(j,b){j.loadedType={PRELOAD:0,GOTO:1,PAGE_FLIP:2};j.statusType={AVAILABLE:0,RESERVED:1,VISIBLE:2};j.iframes=[];j.iframeStatus=[];j.contentRange=[];j.positionData=[];j.parent=b;for(var a=0;a<6;a+=1)j.iframes[a]=j.createIframe($(b).width(),
b.name,a),j.iframeStatus[a]=j.statusType.AVAILABLE,j.contentRange[a]=null,j.positionData[a]=null,b.appendChild(j.iframes[a]);j.currentPosition=0;j.showContent=!0;j.numberOfColumns=1;j.columnGap=20;j.spineColor="transparent";j.spines=[];d(j)}}}(),KindleRendererIframeManagerReflowFactory=function(){function d(b){b.getIframeToLoad=function(){return this.iframes[this.hiddenIframeIndex]};b.annotationClickedHandler=function(a){if(this.annotationEventCallback!==void 0){var b=a.currentTarget.parentNode,a=
b.getAttribute("annotationType"),b=b.getAttribute("annotationStart");this.annotationEventCallback(a,b)}};b.renderAnnotations=function(a,b){var f=a.contentDocument.getElementById(j);f!==null&&f.parentNode.removeChild(f);if(this.overlayManager&&(f=this.overlayManager.getOverlaysInRange(b.startPosition,b.endPosition))&&f.length>0)this.createAnnotationElements(a,f),a.writingMode.forceRepaint(a)};b.frameIsLoadedAndReady=function(a){var b=this,f=b.currentRequest;b.iframeLoadStatus[a.index]=f.type;var e=
b.contentRange[a.index];b.renderAnnotations(a,e);f.initialPosition!==null?KindlePaginator.scrollToPosition(a,f.initialPosition):KindlePaginator.scrollToTop(a);if(!KindlePaginator.isIframePaginationValid(a)){if(b.canRetryCurrentRequest()){b.willRetryCurrentRequest();b.resizeWithoutReload(a.index);return}KindlePaginator.clearIframePaginationValidation(a)}if(!KindlePaginator.hasNextScreen(a)&&!KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(e.skeletonId,e.endPosition))if(e=e.endPosition-
e.startPosition,e<0)b.currentRequestDfd.reject(DATA_LOAD_ERROR);else{KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(e+1);var g=f.initialPosition;if(g===null)g=KindlePaginator.getCurrentPagePositionRange(a).currentTopOfPage;setTimeout(function(){b.reloadHiddenFrame(g)},0)}else f.initialPosition!==null&&a===b.iframes[b.hiddenIframeIndex]&&(b.swapIframes(),this.updateDisplayedPositionsInPage()),f.metrics.addCount("Success",1),f.metrics.endTimer(),f.metrics.log(),b.currentRequest=
null,setTimeout(b.currentRequestDfd.resolve,10),f.type===this.loadedType.GOTO_POSITION&&this.considerLoadingMoreFragments()};b.reloadHiddenFrame=function(a){this.loadFragmentsForRange(KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(a))};b.gotoPosition=function(a){$(this.iframes[this.visibleIframeIndex].contentDocument.body).find("#"+k).empty();this.createNewRequest(this.loadedType.GOTO_POSITION,a);a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(a);
KindleRendererFragmentLoader.needToLoadFragments(this.contentRange[this.visibleIframeIndex],a)?this.loadFragmentsForRange(a):this.resizeWithoutReload(this.visibleIframeIndex);return!1};b.swapIframes=function(){this.iframeLoadStatus[this.visibleIframeIndex]=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT?this.loadedType.PREVIOUS:this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS?this.loadedType.NEXT:this.loadedType.EMPTY;this.iframeLoadStatus[this.hiddenIframeIndex]=
this.loadedType.EMPTY;var a=this.visibleIframeIndex;this.visibleIframeIndex=this.hiddenIframeIndex;this.hiddenIframeIndex=a;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0);this.setIframeVisibility(this.iframes[this.hiddenIframeIndex],!1);this.iframes[this.hiddenIframeIndex].writingMode.resetHeight(this.iframes[this.hiddenIframeIndex])};b.getPagePositionRange=function(){var a=this.contentRange[this.visibleIframeIndex];if(a===null)return null;var b=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.visibleIframeIndex]);
if(b.currentTopOfPage===null||b.currentBottomOfPage===null)b.currentTopOfPage=a.startPosition,b.currentBottomOfPage=a.endPosition;return b};b.getCurrentPosition=function(){var a=this.getPagePositionRange();return a?a.currentTopOfPage:null};b.getSelectableItemBoundaries=function(){return KindlePaginator.getSelectableItemBoundariesForCurrentScreen(this.iframes[this.visibleIframeIndex])};b.causeReflowEventInBrowser=function(){var a=this.iframes[this.visibleIframeIndex].contentDocument.getElementsByTagName("html")[0],
b=this.iframes[this.visibleIframeIndex].contentDocument.getElementsByTagName("body")[0];a.removeChild(b);a.appendChild(b)};b.causeReflowEventInBrowserIfNeeded=function(){if(KindleRendererDeviceSpecific.needsReflowOnPageFlip()){var a=this;setTimeout(function(){a.causeReflowEventInBrowser()},KindleRendererDeviceSpecific.drawYieldUpdateTime())}};b.reloadAnnotations=function(){this.renderAnnotations(this.iframes[this.visibleIframeIndex],this.contentRange[this.visibleIframeIndex]);this.iframes[this.hiddenIframeIndex]!==
null&&this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.EMPTY&&this.renderAnnotations(this.iframes[this.hiddenIframeIndex],this.contentRange[this.hiddenIframeIndex])};b.loadNextPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.NEXT&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.NEXT)){var a=this.contentRange[this.visibleIframeIndex].endPosition+1,b=this.getPagePositionRange(),a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(a,
b);this.createNewRequest(this.loadedType.NEXT,null);this.loadFragmentsForRange(a)}};b.loadPreviousPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.PREVIOUS&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.PREVIOUS)){var a=this.contentRange[this.visibleIframeIndex].startPosition-1,b=this.getPagePositionRange(),a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(a,b);this.createNewRequest(this.loadedType.PREVIOUS,
null);this.loadFragmentsForRange(a)}};b.considerLoadingMoreFragments=function(a){if(this.canPreloadNext){var b=a!==this.direction.PREVIOUS?4:2;if(KindlePaginator.getApproximateNumNextScreens(this.iframes[this.visibleIframeIndex])<b&&this.hasMoreNextFragments()){this.loadNextPages();return}}this.canPreloadPrevious&&(a=a===this.direction.PREVIOUS?4:2,KindlePaginator.getApproximateNumPreviousScreens(this.iframes[this.visibleIframeIndex])<a&&this.hasMorePreviousFragments()&&this.loadPreviousPages())};
b.handleClick=function(a,b){var f=this.iframes[this.visibleIframeIndex].contentDocument.elementFromPoint(a,b);return KindleRendererEventHandler.handleClick(this.iframes[this.visibleIframeIndex].contentDocument,f,{x:a,y:b})};b.crossSkeletonBoundary=function(){var a=this.contentRange[this.visibleIframeIndex],b=this.contentRange[this.hiddenIframeIndex];if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT)if(a.skeletonId+1===b.skeletonId)return KindlePaginator.scrollToTop(this.iframes[this.hiddenIframeIndex]),
this.swapIframes(),!0;else if(a.skeletonId!==b.skeletonId)return this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY,!1;if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS)if(a.skeletonId-1===b.skeletonId)return KindlePaginator.scrollToBottom(this.iframes[this.hiddenIframeIndex]),this.swapIframes(),!0;else if(a.skeletonId!==b.skeletonId)this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;return!1};b.cleanup=function(){this.cancelCurrentRequest();
KindleRendererIframeLoading.cleanupIframe(this.iframes[this.visibleIframeIndex]);KindleRendererIframeLoading.cleanupIframe(this.iframes[this.hiddenIframeIndex]);KindlePaginator.cleanupIframe(this.iframes[this.visibleIframeIndex]);KindlePaginator.cleanupIframe(this.iframes[this.hiddenIframeIndex]);this.setOverlayManager(null);this.contentRange=[null,null];this.positionData=[null,null];this.iframes=null};b.hasMoreNextFragments=function(){return this.contentRange[this.visibleIframeIndex].endPosition!==
KindleRendererFragmentLoader.getMaximumPosition()};b.hasMorePreviousFragments=function(){return this.contentRange[this.visibleIframeIndex].startPosition!==KindleRendererFragmentLoader.getMinimumPosition()};b.isAtEndOfDocumentOrSkeleton=function(){var a=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(a.skeletonId,a.endPosition)};b.isAtBeginningOfDocumentOrSkeleton=function(){var a=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(a.skeletonId,
a.startPosition)};b.needToWaitForLoadToShowNextPage=function(){return!KindlePaginator.isNextFullScreen(this.iframes[this.visibleIframeIndex])&&this.hasMoreNextFragments()};b.needToWaitForLoadToShowPreviousPage=function(){return!KindlePaginator.isPreviousFullScreen(this.iframes[this.visibleIframeIndex])&&this.hasMorePreviousFragments()};b.hasNextScreen=function(){return KindlePaginator.hasNextScreen(this.iframes[this.visibleIframeIndex])||this.hasMoreNextFragments()};b.hasPreviousScreen=function(){return KindlePaginator.hasPreviousScreen(this.iframes[this.visibleIframeIndex])||
this.hasMorePreviousFragments()};b.updateDisplayedPositionsInPage=function(){var a=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.visibleIframeIndex]);KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a.currentBottomOfPage-a.currentTopOfPage)};b.considerFlippingFrames=function(){var a=this.iframeLoadStatus[this.hiddenIframeIndex],b=this.currentRequest!==null&&this.currentRequest.type===a;if(a!==this.loadedType.EMPTY&&!b){var b=this.getPagePositionRange(),f=this.contentRange[this.hiddenIframeIndex],
e=0,g=0;a===this.loadedType.NEXT?g=1:e=1;if(b.currentTopOfPage>=f.startPosition+e&&b.currentBottomOfPage<=f.endPosition-g)if(KindlePaginator.matchFrames(this.iframes[this.visibleIframeIndex],this.iframes[this.hiddenIframeIndex]),a=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.hiddenIframeIndex]),a.currentTopOfPage===b.currentTopOfPage&&a.currentBottomOfPage===b.currentBottomOfPage)return this.swapIframes(),!0;else if(this.needToWaitForLoadToShowNextPage()||this.needToWaitForLoadToShowPreviousPage())throw"Pagination Error";
}return!1};b.nextScreen=function(){if(!KindlePaginator.isIframePaginationValid(this.iframes[this.visibleIframeIndex]))return this.gotoPosition(this.getPagePositionRange().currentTopOfPage);var a=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT;if(a&&this.considerFlippingFrames()===void 0)return!0;var b=this.isAtEndOfDocumentOrSkeleton(),f=KindlePaginator.nextScreen(this.iframes[this.visibleIframeIndex],b);if(!f)if(this.hasMoreNextFragments())if(a&&b&&this.crossSkeletonBoundary())f=
!0;else return a=this.getPagePositionRange(),KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(this.contentRange[this.visibleIframeIndex].endPosition-a.currentBottomOfPage),this.loadNextPages(),!1;else KindlePaginator.showEndOfDocument(this.iframes[this.visibleIframeIndex]),f=!0;this.considerLoadingMoreFragments(this.direction.NEXT);this.causeReflowEventInBrowserIfNeeded();this.updateDisplayedPositionsInPage();return f};b.previousScreen=function(){if(!KindlePaginator.isIframePaginationValid(this.iframes[this.visibleIframeIndex]))return this.gotoPosition(this.getPagePositionRange().currentTopOfPage);
var a=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS;if(a&&this.considerFlippingFrames()===void 0)return!0;var b=this.isAtBeginningOfDocumentOrSkeleton(),f=KindlePaginator.previousScreen(this.iframes[this.visibleIframeIndex],b);if(!f&&this.hasMorePreviousFragments())if(a&&b&&this.crossSkeletonBoundary())f=!0;else return a=this.getPagePositionRange(),KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a.currentTopOfPage-this.contentRange[this.visibleIframeIndex].startPosition),
this.loadPreviousPages(),!1;this.considerLoadingMoreFragments(this.direction.PREVIOUS);this.causeReflowEventInBrowserIfNeeded();this.updateDisplayedPositionsInPage();return f};b.cancelHiddenIframeLoading=function(){var a=this.iframes[this.hiddenIframeIndex];if(a.processingRequestId!==null)a.processingRequestId=null,this.cancelCurrentRequest()};b.doGuardedAsyncCopyOf=function(a,b,f){var e=this;b.processingRequestId=e.currentRequest.requestId;KindleRendererIframeLoading.copyIframeContents(e.currentRequest,
a,b).done(function(a){if(b.processingRequestId===a.requestId&&e.currentRequest&&e.currentRequest.requestId===a.requestId)e.addClickHandlers(b),b.processingRequestId=null,f()})};b.copyIframeDataOf=function(a){var b=this;b.cancelHiddenIframeLoading();b.createNewRequest(b.loadedType.GOTO_POSITION,null);b.doGuardedAsyncCopyOf(a.iframes[a.visibleIframeIndex],b.iframes[b.visibleIframeIndex],function(){b.contentRange[b.visibleIframeIndex]=jQuery.extend({},a.contentRange[a.visibleIframeIndex]);b.positionData[b.visibleIframeIndex]=
jQuery.extend({},a.positionData[a.visibleIframeIndex]);var f=b.iframes[b.hiddenIframeIndex],e=a.iframes[a.hiddenIframeIndex];a.iframeLoadStatus[a.hiddenIframeIndex]!==a.loadedType.EMPTY&&e.processingRequestId===null?b.doGuardedAsyncCopyOf(e,f,function(){b.contentRange[b.hiddenIframeIndex]=jQuery.extend({},a.contentRange[a.hiddenIframeIndex]);b.positionData[b.hiddenIframeIndex]=jQuery.extend({},a.positionData[a.hiddenIframeIndex]);b.iframeLoadStatus[b.visibleIframeIndex]=a.iframeLoadStatus[a.visibleIframeIndex];
b.iframeLoadStatus[b.hiddenIframeIndex]=a.iframeLoadStatus[a.hiddenIframeIndex];b.currentRequestDfd.resolve()}):(b.iframeLoadStatus=[b.loadedType.EMPTY,b.loadedType.EMPTY],b.currentRequestDfd.resolve())});return b.currentRequestDfd.isResolved()};b.recreateFrame=function(a){var b=this.iframes[a],f=b.writingMode.width(b),e=b.parentNode,g=b.pageOverflowDiv;e.removeChild(b);b=this.createIframe(f,this.parentName,b.index);b.pageOverflowDiv=g;e.appendChild(b);e.appendChild(g);this.iframes[a]=b};b.copyIframeData=
function(a){if(!(this.contentRange[this.visibleIframeIndex]===null||a.contentRange[a.visibleIframeIndex]===null?this.contentRange[this.visibleIframeIndex]===a.contentRange[a.visibleIframeIndex]:this.contentRange[this.visibleIframeIndex].startPosition===a.contentRange[a.visibleIframeIndex].startPosition&&this.contentRange[this.visibleIframeIndex].endPosition===a.contentRange[a.visibleIframeIndex].endPosition))return KindleRendererDeviceSpecific.needsReflowOnPageFlip()&&(this.recreateFrame(0),this.recreateFrame(1),
this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0)),this.copyIframeDataOf(a);var b=this.iframes[this.visibleIframeIndex],a=a.iframes[a.visibleIframeIndex];b.currentTopOfScreen=a.currentTopOfScreen;b.currentBottomOfScreen=a.currentBottomOfScreen;return!0};b.updateSettingsInIframe=function(a){if(a&&a.contentDocument){var b=a.contentDocument.getElementById(k);b&&a.contentDocument.body.removeChild(b);KindleRendererIframeLoading.updateSettingsInIframe(a);b&&a.contentDocument.body.appendChild(b)}};
b.updateSettings=function(){var a=KindleRendererSettings.getSettings().backgroundColor;$(this.iframes[this.visibleIframeIndex].pageOverflowDiv).css({"background-color":a});$(this.iframes[this.hiddenIframeIndex].pageOverflowDiv).css({"background-color":a});this.updateSettingsInIframe(this.iframes[this.visibleIframeIndex]);this.updateSettingsInIframe(this.iframes[this.hiddenIframeIndex])};b.reloadNotification=function(){this.contentRange=[null,null];this.positionData=[null,null];this.resizeNotification()};
b.resizeNotification=function(){this.cancelHiddenIframeLoading();this.iframeLoadStatus=[this.loadedType.EMPTY,this.loadedType.EMPTY];var a=this.iframes[this.visibleIframeIndex];a.writingMode.resetIframeDimensions(a);a=this.iframes[this.hiddenIframeIndex];a.writingMode.resetIframeDimensions(a)};b.updateGlyphColorForFrameIndex=function(a){this.iframes[a].hasGlyphs&&this.iframes[a].contentDocument&&KindleGlyphRenderer.updateTextColor(this.iframes[a])};b.updateGlyphColor=function(){this.updateGlyphColorForFrameIndex(this.visibleIframeIndex);
this.updateGlyphColorForFrameIndex(this.hiddenIframeIndex)};b.setAnnotationEventCallback=function(a){this.annotationEventCallback=a};b.getContentRects=function(){var a=this.iframes[this.visibleIframeIndex],b=this.getIframeOrigin(this.visibleIframeIndex),a={left:b.x,top:b.y,width:$(a).width(),height:$(a).height()};a.right=a.left+a.width;a.bottom=a.top+a.height;return[a]};b.getZoomableAt=function(a,b,f){var e=this.iframes[this.visibleIframeIndex];return!KindlePaginator.isPointOnVisiblePage(e,b-a.x,
f-a.y)?null:KindleRendererZoomablesFactory.buildFromCoord(e.contentDocument,a,b,f)};b.getZoomableList=function(a){return KindleRendererZoomablesFactory.buildList(this.iframes[this.visibleIframeIndex].contentDocument,a)};b.addClickHandlers=function(a){var b=this,a=a.contentDocument.getElementById(j),a=$(a).find("["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']").children();$(a).unbind("click");$(a).click(function(a){b.annotationClickedHandler(a)})};b.createAnnotationElements=
function(a,b){if(a.contentDocument.getElementsByTagName("body")[0]){var f=KindlePaginator.getWordMap(a),e=a.contentDocument.createDocumentFragment();KindleRendererAnnotationRenderer.createAnnotationElements(a,f,b,e);f=a.contentDocument.getElementById(j);if(!f){var g=a.contentDocument.getElementById(k),f=a.contentDocument.createElement("DIV");f.id=j;f.setAttribute("class","kindle-annotation-wrapper");g.appendChild(f)}f.appendChild(e);this.addClickHandlers(a)}};b.addAnnotation=function(a,b,f){a&&b&&
f&&b.startPosition<=f.end&&f.start<=b.endPosition&&(this.createAnnotationElements(a,[f]),a.writingMode.forceRepaint(a))};b.removeAnnotation=function(a,b){if(a&&b){var f=a.contentDocument.getElementById(j);f&&(KindleRendererAnnotationRenderer.removeAnnotationElements(f,b),a.writingMode.forceRepaint(a))}};b.onOverlayAdded=function(a){b.addAnnotation(b.iframes[0],b.contentRange[0],a.overlay);b.addAnnotation(b.iframes[1],b.contentRange[1],a.overlay)};b.onOverlayRemoved=function(a){b.removeAnnotation(b.iframes[0],
a.overlay);b.removeAnnotation(b.iframes[1],a.overlay)};b.setOverlayManager=function(a){this.overlayManager&&(this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved));if(this.overlayManager=a)this.overlayManager.addEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.addEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,
this.onOverlayRemoved)};b.show=function(){this.showContent=!0;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0)};b.hide=function(){this.showContent=!1;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!1)};b.drawWordMap=function(){var a=this.iframes[this.visibleIframeIndex];drawWordMap(a,a.screenManager,a.contentDocument.body)};b.drawHeightMaps=function(){drawHeightMaps(this.iframes[this.visibleIframeIndex],this.iframes[this.hiddenIframeIndex])}}var k="content-overlays",
j="annotation-section";return{build:function(b,a){for(var c=[],f=0;f<2;f+=1){c[f]=b.createIframe($(a).width(),a.name,f);a.appendChild(c[f]);var e=c[f],g=a,h=f,l=document.createElement("div");l.setAttribute("id",g.name+"_page_overflow_"+h);$(l).css({position:"absolute",visibility:"hidden","z-index":1});g.appendChild(l);e.pageOverflowDiv=l}b.loadedType={EMPTY:0,GOTO_POSITION:1,NEXT:2,PREVIOUS:3};b.direction={NEXT:2,PREVIOUS:3};b.iframes=c;b.parentName=a.name;b.iframeLoadStatus=[b.loadedType.EMPTY,b.loadedType.EMPTY];
b.contentRange=[null,null];b.positionData=[null,null];b.visibleIframeIndex=0;b.hiddenIframeIndex=1;b.overlayManager=null;d(b)}}}(),KindleRendererIframePreparation=function(){function d(a,b,f,e){KindleRendererContentReflow.reflow(a,b,f).then(function(){e.resolve(b)},function(){e.reject(b,"reflow took too long")})}function k(a,c,f,e,g,h){g!==b&&KindleRendererCanvasInsertion.changeSpanToCanvas(a.id,a.contentDocument,f.contentRange,g===j);a.hasGlyphs=e.glyphData!==void 0&&f.glyphData!==void 0;a.hasGlyphs?
KindleGlyphRenderer.renderAllContent(a,c,e.glyphData,f.glyphData).then(function(){d(a,c,e.positionData,h)},function(){h.reject(c,"glyph rendering took too long")}):(e.glyphData=null,d(a,c,e.positionData,h))}var j=-1,b=0;return{CANVAS_INSERTION_PREVIOUS:j,CANVAS_INSERTION_NONE:b,CANVAS_INSERTION_NEXT:1,prepareIframe:function(a,b,f,e,g){var d=new jQuery.Deferred;if(a.processingRequestId===b.requestId){var l=a.contentDocument.getElementById("content-overlays");if(!l)l=a.contentDocument.createElement("DIV"),
l.id="content-overlays",a.contentDocument.body.appendChild(l);k(a,b,f,e,g,d)}else d.reject();return d.promise()}}}(),KindleRendererPositionLoadingCalculator=function(){function d(){if(c>0)return c;var a,b;b=KindleRendererSettings.getSettings();if(KindleRendererFragmentLoader.getBookContentType()==="topaz")a=j.width/(25*b.glyphScale),b=j.height/(25*b.glyphScale);else{var g=b.fontSizes[k];a=j.width/(g*0.4);b=j.height/(g*b.lineHeight)}return Math.round(a*b)}var k=2,j={height:1,width:1},b=0,a=[],c=0;
return{updateScreenDimensions:function(a,b){j.width=a;j.height=b;c=_displayedScreenCount=_logSumPositionsDisplayed=0},updateDisplayedPositionRange:function(f){f>0&&(a[b]=f,b=(b+1)%10,c=0,c=Math.max.apply(Math,a))},calculateDesiredFragmentRangeForPageFlip:function(a,b){var c=KindleRendererFragmentLoader.getBookContentType()==="topaz",h=KindleRendererDeviceSpecific.fragmentBufferCapacityForPageFlip(c),l=d();h*=l;var j=Math.ceil(h*0.25),k=Math.ceil(h*0.75),h=KindleRendererFragmentLoader.getMinimumPosition(),
o=KindleRendererFragmentLoader.getMaximumPosition(),j=Math.max(h,a-j),k=Math.min(o,a+k),v=b.currentTopOfPage,n=b.currentBottomOfPage;c?(j=Math.min(j,Math.max(h,v-1)),k=Math.max(k,Math.min(o,n+1))):a<v&&v-a<3*l?k=Math.min(o,n+1):a>n&&a-n<3*l&&(j=Math.max(h,v-1));return{focus:a,startPosition:j,endPosition:k}},calculateDesiredFragmentRangeForGoTo:function(a){var b=d()*KindleRendererDeviceSpecific.fragmentBufferCapacityForGoTo(),c=Math.ceil(b*0.1),b=Math.ceil(b),h=KindleRendererFragmentLoader.getMinimumPosition(),
l=KindleRendererFragmentLoader.getMaximumPosition();return{focus:a,startPosition:Math.max(h,a-c),endPosition:Math.min(l,Math.max(h+b,a+b))}}}}(),KindleRendererProcessTuning=function(){function d(d){var b,a=k[d];if(a){if(!a.unitTime)return a.frequency;d=a.frequency*a.unitTime;if(d>100){if(b=Math.floor(Math.max(100/a.unitTime,a.minimumFrequency)),b<a.frequency)a.frequency=b}else if(d<50){if(b=Math.ceil(Math.max(50/a.unitTime,a.minimumFrequency)),b>a.frequency)a.frequency=b}else b=a.frequency}else b=
KindleRendererDeviceSpecific["drawYield"+d+"Frequency"]?KindleRendererDeviceSpecific["drawYield"+d+"Frequency"]():100,a=KindleRendererDeviceSpecific["drawYield"+d+"UpdateTime"]?KindleRendererDeviceSpecific["drawYield"+d+"UpdateTime"]():KindleRendererDeviceSpecific.drawYieldUpdateTime(),k[d]={frequency:b,minimumFrequency:b/4,yieldTime:a};return b}var k={};return{startingOperation:function(j){var b=k[j];b||(d(j),b=k[j]);b.startTime=Date.now()},endingOperation:function(j,b){var a;var c=k[j];c||(d(j),
c=k[j]);if(c.startTime){var f=Date.now()-c.startTime;if(!(b<1)){var e=k[j];f/=b;if(e.unitTime){var g=0.1*b/e.frequency;e.unitTime=g*f+(1-g)*e.unitTime}else e.unitTime=f}c.startTime=0}else a=void 0;return a},drawYieldFrequency:function(j){return d(j)},drawYieldUpdateTime:function(j){var b=k[j];b||(d(time),b=k[j]);return b.yieldTime}}}(),KindleRendererRequestId=function(){var d=0;return{getUniqueRequestId:function(){d+=1;return d}}}(),KindleRendererScaleHelper=function(){function d(a,e){if(!c[e])return null;
var g=a.match(b);return g?(g=c[g[1]],parseFloat(a,10)*g/c[e]):null}function k(b,c,g){if((b=b.match(j))&&c.length>0){var b=a[b[1]],d=Math.floor((c.length-1)/2),l=parseFloat(c[0],10),d=parseFloat(c[d],10),c=parseFloat(c[c.length-1],10);return Math.min(c,Math.max(l,b*d))+g}return null}var j=/(xx-small|x-small|small|medium|large|x-large|xx-large)/,b=/(mm|cm|in|pt|pc|px)/,a={"xx-small":0.6,"x-small":0.75,small:0.889,medium:1,large:1.2,"x-large":1.5,"xx-large":2},c={mm:2.835,cm:28.346,"in":72,pt:1,pc:6,
px:1.25};return{scaleFont:function(c,e,g){if(g=g.match(b)){var g=g[1],h;if(!(h=k(c,e,g)))h=(c=d(c,"pt"))?k(c<=a["xx-small"]*25?"xx-small":c<=a["x-small"]*25?"x-small":c<=a.small*25?"small":c<=a.medium*25?"medium":c<=a.large*25?"large":c<=a["x-large"]*25?"x-large":"xx-large",e,g):null;e=h}else e=c;return e},convertLength:function(a,b){var c=d(a,b);return c?c+b:null}}}(),KindleRendererSettings=function(){function d(a,b,c){try{a.styleSheet&&a.styleSheet.addRule?a.styleSheet.addRule(b,c):a.sheet&&a.sheet.insertRule&&
a.sheet.insertRule(b+"{"+c+"}",0)}catch(d){}}function k(b){b=b&&b.split("-")[0]||"en";a=b==="ja"?{characterSelection:!0,language:b,lineHeight:"1.75",allowsVerticalLayout:!0,allowsNegativeTextIndent:!0,allowsClearStyle:!1,needsPageRefresh:!0,fontFamily:"'Hiragino Mincho ProN'"}:{characterSelection:!1,language:b,lineHeight:"1.4",allowsVerticalLayout:!1,allowsNegativeTextIndent:!1,allowsClearStyle:!0,needsPageRefresh:!1,fontFamily:"Georgia, serif"}}function j(f){var e=new jQuery.Deferred;f.getMetadata(function(f){if(f.hasFixedContent!==
void 0)b.fixedContent=f.hasFixedContent;if(f.publisherMetadata!==void 0){var d=f.publisherMetadata;if(d[0]==="metadata"&&(d=d[2],d!==void 0))for(var l=d.length,j=0;j<l;++j){var p=d[j][1];if(p!==void 0)if(p.name==="fixed-layout")b.fixedContent=p.content==="true";else if(p.name==="original-resolution"&&(p=p.content.match(/(\d+)[Xx](\d+)/)))b.originalResolution={width:parseInt(p[1],10),height:parseInt(p[2],10)}}}if(f.headerMetadata!==void 0){d=f.headerMetadata;if(d.fixedLayout)b.fixedContent=d.fixedLayout===
"true";if(d.originalResolution&&(l=d.originalResolution.match(/(\d+)[Xx](\d+)/)))b.originalResolution={width:parseInt(l[1],10),height:parseInt(l[2],10)};b.pageProgressionDirection={RTL:0,LTR:1};b.inlineBaseDirection={VERTICAL:0,HORIZONTAL:1};if(d.app_PrimaryWritingMode)b.pageProgressionDirection.value=d.app_PrimaryWritingMode==="vertical-rl"||d.app_PrimaryWritingMode==="horizontal-rl"?b.pageProgressionDirection.RTL:b.pageProgressionDirection.LTR,b.inlineBaseDirection.value=d.app_PrimaryWritingMode.match(/^vertical/)!==
null?b.inlineBaseDirection.VERTICAL:b.inlineBaseDirection.HORIZONTAL;k(f.headerMetadata.app_contentLanguageTag)}else k("en");b.lineHeight=a.lineHeight;if(KindleRendererDeviceSpecific.verticalParagraphsScaleSeparately()&&a.allowsVerticalLayout&&!b.fixedContent)b.initialExpandedBodyHeight=c;e.resolve()},function(){e.reject()});return e.promise()}var b={},a={},c="500%";return{initialize:function(a){return j(a)},cleanup:function(){b={}},getSettings:function(){return b},getLanguageOptions:function(){return a},
updateSettings:function(a){for(var c in a)b[c]=a[c]},addCSSRules:function(a){var c=b,g=document.getElementById("kindleRendererOptionsStylesheet");g!==void 0&&g!==null&&g.parentNode.removeChild(g);g=document.createElement("style");g.type="text/css";g.id="kindleRendererOptionsStylesheet";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{if(a.appendChild(g),c.fixedContent)d(g,"body","position : absolute; margin: 0;"),c.originalResolution&&d(g,"body","background-size: contain; width: "+
c.originalResolution.width+"px; height: "+c.originalResolution.height+"px");else{var h;if(c.fontSizes!==void 0){d(g,"body","font-size : "+c.fontSizes[2]+c.fontSizeUnits+" !important");d(g,"font","font-size : "+c.fontSizes[2]+c.fontSizeUnits+" !important");for(h=0;h<c.fontSizes.length;h+=1)d(g,".font-size-"+(h+1),"font-size : "+c.fontSizes[h]+c.fontSizeUnits+" !important")}c.fontColor!==void 0&&d(g,"body","color : "+c.fontColor);c.fontFamily!==void 0&&d(g,"body","font-family : "+c.fontFamily);c.lineHeight!==
void 0&&d(g,"body","line-height : "+c.lineHeight);c.backgroundColor!==void 0&&d(g,"body","background-color : "+c.backgroundColor);c.textAlign!==void 0&&d(g,"body","text-align : "+c.textAlign);c.margin!==void 0&&d(g,"body","margin : "+c.margin+" !important");c.selectionColor!==void 0&&d(g,"div.amazon-selection","background-color : "+c.selectionColor);c.selectionColor!==void 0&&d(g,"div.amazon-selection","background-color : "+c.selectionColor);c.insertBgColor!==void 0&&d(g,".insert","background-color : "+
c.insertBgColor);if(c.annotationStyles!==void 0)for(var l in c.annotationStyles)d(g,"div."+c.annotationStyles[l].className,c.annotationStyles[l].style);c.clickableElementFeedbackStyles!==void 0&&d(g,"."+c.clickableElementFeedbackStyles.className,c.clickableElementFeedbackStyles.classStyle);if(c.keyframes!==void 0){var j=c.keyframes,k;for(k in j)d(g,k,j[k])}if(c.additionalRules!==void 0&&c.additionalRules.length!==void 0)for(h=0;h<c.additionalRules.length;h+=1)d(g,c.additionalRules[h].selector,c.additionalRules[h].style)}}catch(o){}}}}(),
KindleRendererWordIteratorFactory=function(){function d(a,b,e,g){for(var h=!0;h;){h=a.getItem();if(h.pos>b){g.resolve(e);return}e+=h.text;h=a.next()}a.getLoadingDfd().then(function(h){h?d(a,b,e,g):g.resolve(e)},g.reject)}function k(c){c.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest=null};c.newRequest=function(a,b,c){this.cancelCurrentRequest();this.currentRequest={requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("word-iterator-load"),
position:a,stopPosition:b,direction:c}};c.newRequestDfd=function(){this.currentRequestDfd=new jQuery.Deferred;this.currentRequestReachedTerminal=!1};c.fragmentLoadedCallback=function(a){var b=this;b.loadedRange=a.contentRange;b.wordMapGenerator.createWordMap(a.fragmentRoot,a.positionMap).then(function(a){b.createPositionInfo(a)},function(){b.currentRequestDfd.reject()})};c.calculateContinuePosition=function(b){return b===a?this.loadedRange.endPosition+1:this.loadedRange.startPosition-1};c.hasReachedStopPosition=
function(){if(this.currentRequest&&this.currentRequest.stopPosition!==void 0){var c=this.currentRequest.direction,e=this.currentRequest.stopPosition,g;g=this.currPositionIndex<this.positions.length?this.positions[this.currPositionIndex]:this.calculateContinuePosition(c);return c===a&&g>e||c===b&&g<e}return!1};c.createPositionInfo=function(c){this.wordMap=c;c=this.currentRequest.direction;this.positions=[];for(var e in this.wordMap)this.positions.push(parseInt(e,10));this.positions.sort(function(a,
b){return a-b});this.findPosition(this.currentRequest.position,c);if(this.hasReachedStopPosition())this.currentRequestDfd.reject();else if(this.currPositionIndex<this.positions.length)this.currentRequest=null,this.currentRequestDfd.resolve(!this.currentRequestReachedTerminal);else{if(c===b&&this.startPositionIsLoaded()||c===a&&this.endPositionIsLoaded()){if(this.currentRequestReachedTerminal){this.currentRequestDfd.reject();return}this.currentRequestReachedTerminal=!0;c=c===a?b:a}this.beginLoad(this.calculateContinuePosition(c),
this.currentRequest.stopPosition,c)}};c.findPosition=function(b,c){this.currPositionIndex=KindleListUtilities.binarySearch(this.positions,b);c===a&&this.positions[this.currPositionIndex]<b&&this.currPositionIndex++};c.beginLoad=function(a,b,c){var d=this;d.newRequest(a,b,c);a=KindleRendererFragmentLoader.getFragmentIdForPosition(a);KindleRendererFragmentLoader.getFragmentAtId(a,d.currentRequest).then(function(a,b){d.currentRequest&&d.currentRequest.requestId===a.requestId&&d.fragmentLoadedCallback(b)},
function(){d.currentRequestDfd.reject()})};c.gotoPosition=function(b,c){this.newRequestDfd();if(this.currentRequest===null&&this.loadedRange!==null&&b>=this.loadedRange.startPosition&&b<this.loadedRange.endPosition&&(this.findPosition(b,a),this.currPositionIndex<this.positions.length))return this.currentRequestDfd.resolve(!0),this.currentRequestDfd.promise();this.beginLoad(b,c,a);return this.currentRequestDfd.promise()};c.getItem=function(){if(this.currentRequest===null){var a=this.positions[this.currPositionIndex];
return{pos:a,text:this.wordMap[a].text}}return null};c.previous=function(){if(this.currPositionIndex===null||this.currentRequest!==null)return!1;this.currPositionIndex--;return this.currPositionIndex<0?(this.startPositionIsLoaded()?(this.currPositionIndex=0,this.newRequestDfd(),this.currentRequestDfd.resolve(!1)):(this.newRequestDfd(),this.beginLoad(this.loadedRange.startPosition-1,void 0,b)),!1):!0};c.next=function(){if(this.currPositionIndex===null||this.currentRequest!==null)return!1;this.currPositionIndex++;
return this.currPositionIndex>=this.positions.length?(this.endPositionIsLoaded()?(this.currPositionIndex=this.positions.length-1,this.newRequestDfd(),this.currentRequestDfd.resolve(!1)):(this.newRequestDfd(),this.beginLoad(this.loadedRange.endPosition+1,void 0,a)),!1):!0};c.getLoadingDfd=function(){return this.currentRequestDfd.promise()};c.startPositionIsLoaded=function(){return this.loadedRange.startPosition<=KindleRendererFragmentLoader.getMinimumPosition()};c.endPositionIsLoaded=function(){return this.loadedRange.endPosition>=
KindleRendererFragmentLoader.getMaximumPosition()}}function j(a,b){a.getItem=function(){return b.getItem()};a.previous=function(){return b.previous()};a.next=function(){return b.next()};a.getLoadingDfd=function(){return b.getLoadingDfd()};a.gotoPosition=function(a,c){var d=Math.max(a,KindleRendererFragmentLoader.getMinimumPosition()),d=Math.min(d,KindleRendererFragmentLoader.getMaximumPosition());return b.gotoPosition(d,c)};a.getText=function(a,b){var c=this,f=new jQuery.Deferred;c.gotoPosition(a).then(function(){d(c,
b,"",f)},f.reject);return f.promise()}}var b="prev",a="next";return{initialize:function(){},build:function(){var a={};a.wordMapGenerator=KindleRendererWordMapGeneratorFactory.buildWordMapGeneratorForWordText();a.currentRequest=null;a.currentRequestDfd=null;a.currentRequestReachedTerminal=null;a.loadedRange=null;a.wordMap=null;a.positions=null;a.currPositionIndex=null;k(a);var b={};j(b,a);return b}}}(),KindleRendererWordMapGeneratorFactory=function(){function d(a,b){if(a&&a.getComputedStyle)return a.getComputedStyle(b)}
function k(a){if(a<128)return 1;else if(a<2048)return 2;else if(a>=55296&&a<=57343)return 2;return 3}function j(a,b){if(a.nodeType===Node.TEXT_NODE||a.tagName==="IMG")b.push(a);else for(var c=a.childNodes,e=c.length,f=0;f<e;f+=1)j(c[f],b)}function b(a){var b=[];j(a,b);return b}function a(a){if(window.ActiveXObject&&window.XMLHttpRequest)return b(a.body);else try{var c=(new XPathEvaluator).evaluate("/html/body//text()[not(ancestor::ruby)] | //img[not(ancestor::ruby)] | //ruby",a,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,
null),e;if(c.invalidIteratorState)e=b(a.body);else{for(var f=[],d=c.iterateNext();d;)f.push(d),d=c.iterateNext();e=f}return e}catch(g){return b(a.body)}}function c(a){a=a.body;return{bodyDimensions:{height:a.offsetHeight,width:a.offsetWidth}}}function f(a,b){var c=a.body,e=b.bodyDimensions;return e.width===c.offsetWidth&&e.height===c.offsetHeight}function e(a){a.addElementsToWordMap=function(a,b,c,e,f,d,g){function h(){l.addElementsToWordMap(a,b,c+1,e,f,d,g)}var l=this;KindleRendererProcessTuning.startingOperation("ScreenManager");
for(var j=0;c<b.length;){var k=b[c],m=k.id,k=l.getValueForNode(a,k,d);k!==null&&(f[m]=k);j+=1;if(j>=e.interval){KindleRendererProcessTuning.endingOperation("ScreenManager",j);setTimeout(h,e.time);return}c+=1}KindleRendererProcessTuning.endingOperation("ScreenManager",j);setTimeout(function(){g.resolve(f)},e.time)};a.getPositionDataForNode=function(a,b,c){a=a[b+"_"+c];return a===void 0||a.length===0?null:a};a.getNodeId=function(a){var b=a.parentNode,c=b.getAttribute(v),e=0;if(a.ownChildIndex===void 0)for(;b.childNodes[e]!==
a;)e+=1;else e=a.ownChildIndex;return{parentId:c,index:e}};a.getAllBaseNodesInRuby=function(a){a=(new XPathEvaluator).evaluate(".//text()[not(ancestor::rt or ancestor::rp)] | .//img[not(ancestor::rt or ancestor::rp)]",a,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(!a.invalidIteratorState){for(var b=[],c=a.iterateNext();c;)c.nodeType===Node.TEXT_NODE&&c.nodeValue.trim().length===0||b.push(c),c=a.iterateNext();return b}};a.addRubyNodeToWordMap=function(a,b,c,e,f,d){for(var g=this.getAllBaseNodesInRuby(a),
h=Infinity,l=-Infinity,j,k=0;k<g.length;++k)if(node=g[k],node.deltaX=a.deltaX,node.isRuby=!0,j=node.nodeType===Node.TEXT_NODE?this.addTextNodeToWordMap(this.getNodeId(node),node,b,c,e,f,d):this.addImageNodeToWordMap(node,c,e,f,d))h=Math.min(j.start,h),l=Math.max(j.end,l);return{start:h,end:l}}}function g(a){a.addTextNodeToWordMap=function(a,b,c,e,f,g,h){var l=b.nodeValue;if(l&&l.trim().length>0&&(a=this.getPositionDataForNode(f,a.parentId,a.index))){var f=a.length-1,j=d(e,b.parentNode),k=b.parentNode.getAttribute(v),
m,n=0,p;a:{p=b;for(var o=0;o<2;o++)if(p.parentNode)if(p.parentNode.getAttribute("data-isTextCombineBlock"))break a;else p=p.parentNode;p=null}if(p){if(p.deltaX===void 0)p.deltaX=h.getDeltaX(p,c);p.parentNode.deltaX=p.deltaX;if(m=this.getValueForNode(e,p.parentNode,h))return n=a[0][1],g[n]=m,{start:n,end:n+1}}e=0;p=e<f?a[e+1][0]:Infinity;for(var F=o=0,E=0,B=l.length,H=0;H<=B;H++)if(m=l.charCodeAt(H),m<128?o+=1:m<2048?o+=2:m>=55296&&m<=57343?(E+=1,o+=2):o+=3,m=m<=32||m===45,H<B){if(!m){if(E===0)m=this.getValueForWord(c,
b,H,H+1,m,j,k,h);else if(E===1)continue;else E=0,m=this.getValueForWord(c,b,H-1,H+1,m,j,k,h);if(m!==null){for(;F>=p;)e++,p=e<f?a[e+1][0]:Infinity;n=a[e][1]+(F-a[e][0]);g[n]=m}}F=o}return{start:a[0][1],end:n}}}}function h(a){a.addTextNodeToWordMap=function(a,b,c,e,f,g,h){var l=b.nodeValue;if(l&&l.trim().length>0&&(a=this.getPositionDataForNode(f,a.parentId,a.index)))for(var f=a.length-1,e=d(e,b.parentNode),j=b.parentNode.getAttribute(v),k=0,m=k<f?a[k+1][0]:Infinity,n=0,p=0,o=0,n=0,F=l.length,E=0;E<=
F;E++){var B=l.charCodeAt(E);p+=B<128?1:B<2048?2:B>=55296&&B<=57343?2:3;B=B<=32||B===45||B===8212;if(E===F||B){o=this.getValueForWord(c,b,o,E,B,e,j,h);if(o!==null){for(;n>=m;)k++,m=k<f?a[k+1][0]:Infinity;n=a[k][1]+(n-a[k][0]);g[n]=o}o=E+1;n=p}}}}function l(b){b.getValueForWord=function(a,b,c,e,f,d,g,h){return e>c&&(a=a.createRange(),a.setStart(b,c),a.setEnd(b,e),a.getClientRects&&(c=a.getClientRects())&&c.length>0)?(b=this.getBoundingAndSelectableRects(b,c,d,h),{selectableRects:b.selectableRects,
rects:b.boundingRects,fontSize:d?parseInt(d.fontSize,10):0,dataNid:g}):null};b.getValueForNode=function(a,b,c){var e=b.getClientRects();if(KindleRendererDeviceSpecific.clientRectsExpire()){for(var f=[],g=0;g<e.length;++g)f.push({top:e[g].top,left:e[g].left,bottom:e[g].bottom,right:e[g].right,width:e[g].width,height:e[g].height});e=f}if(e&&e.length>0){c={rects:c.getTransformedClientRects(e,b)};if(b.tagName==="span")a=d(a,b),c.fontSize=a?parseInt(a.fontSize,10):void 0;c.dataNid=b.getAttribute(v);return c}return null};
b.getValueForImage=function(a,b,c){if(a.getClientRects){var e=a.getClientRects();if(e&&e.length>0)return b=this.getBoundingAndSelectableRects(a,e,d(b,a),c),{selectableRects:b.selectableRects,rects:b.boundingRects,dataNid:a.getAttribute(v)}}return null};b.getValueForWhitespace=function(a,b,c,e){b=b.createRange();b.setStart(a,0);b.setEnd(a,a.length);return b.getClientRects?(b=b.getClientRects(),this.getBoundingAndSelectableRects(a,b,d(c,a.parentNode),e).boundingRects):null};b.getBoundingAndSelectableRects=
function(a,b,c,e){var f=c?parseInt(c.fontSize,10):0,g=c?c.webkitTextEmphasisStyle!=="none":!1,d=a.isRuby,h=void 0,a=e.getTransformedClientRects(b,a,c),h=d||g?e.getRectsAdjustedForAnnotationMarks(a,f):a;return{boundingRects:h,selectableRects:a}};b.createBoundsWordMap=function(b,e,f,g){var d=new jQuery.Deferred,h={};if(f===void 0||$.isEmptyObject(f))this.createWordMapFromElements(b,e,h,g,d);else if(f!==null){var l={interval:KindleRendererProcessTuning.drawYieldFrequency("WordMapGen"),time:KindleRendererProcessTuning.drawYieldUpdateTime("WordMapGen")},
j=c(b);this.createWordMapFromNodeList(0,a(b),b,e,f,h,g,l,j,d)}else d.resolve(h);return d.promise()};b.addImageNodeToWordMap=function(a,b,c,e,f){b=this.getValueForImage(a,b,f);if(b!==null)return a=a.getAttribute(v),c=c[a],e[c[0][1]]=b,{start:c[0][1],end:c[0][1]+1}};b.createWordMapFromElements=function(a,b,c,e,f){var g=[],g=g.concat(Array.prototype.slice.call(a.getElementsByTagName("IMG"))),g=g.concat(Array.prototype.slice.call(a.getElementsByTagName("CANVAS"))),g=g.concat(Array.prototype.slice.call(a.getElementsByClassName("k4w"))),
g=g.concat(Array.prototype.slice.call(a.getElementsByClassName("k4wc"))),a={interval:KindleRendererProcessTuning.drawYieldFrequency("ScreenManager"),time:KindleRendererProcessTuning.drawYieldUpdateTime("ScreenManager")};this.addElementsToWordMap(b,g,0,a,c,e,f)};b.createWordMapFromNodeList=function(a,b,e,g,d,h,l,j,k,m){function n(){f(e,k)?p.createWordMapFromNodeList(a+1,b,e,g,d,h,l,j,k,m):(k=c(e),p.createWordMapFromNodeList(0,b,e,g,d,h,l,j,k,m))}var p=this;KindleRendererProcessTuning.startingOperation("WordMapGen");
for(var o=0,v=b.length,F=null;a<v;){var E=b[a],B=h;E.deltaX=l.getDeltaX(E,e);E.nodeType===Node.TEXT_NODE?(F=p.getNodeId(E),F=p.addTextNodeToWordMap(F,E,e,g,d,h,l),F===void 0&&(F={start:0,end:0},B=[{rects:p.getValueForWhitespace(E,e,g,l)}])):F=E.tagName==="IMG"?p.addImageNodeToWordMap(E,g,d,h,l):p.addRubyNodeToWordMap(E,e,g,d,h,l);KindleRendererContentCorrection.applyNodeLocalCorrections(E,F,B,g,l);++o;if(o>=j.interval){KindleRendererProcessTuning.endingOperation("WordMapGen",o);setTimeout(n,j.time);
return}++a}KindleRendererProcessTuning.endingOperation("WordMapGen",o);f(e,k)?m.resolve(h):(k=c(e),p.createWordMapFromNodeList(0,b,e,g,d,h,l,j,k,m))}}function m(a){a.getValueForWord=function(a,b,c,e,f){return e>c?(a=b.nodeValue,c={text:a.substr(c,f?e-c+1:e-c)},e===a.length&&(c.text+=" "),c):null};a.findSibling=function(a){return a&&a.nodeType!==Node.DOCUMENT_NODE?a.nextSibling?a.nextSibling:this.findSibling(a.parentNode):null};a.getValueForNode=function(a,b){if(b.tagName!=="IMG"){var c=b.textContent;
if(!/\s/.test(c[c.length-1])){var e=this.findSibling(b);e&&e.className!=="k4w"&&(c+=" ")}return{text:c}}return null};a.getValueForImage=function(){return null};a.createTextWordMap=function(a,c){var e=new jQuery.Deferred,f={},g,d,h,l,j;if(c===void 0){l=$(a).find("CANVAS,.k4w,.k4wc");l=$.makeArray(l);j=l.length;for(g=0;g<j;g++)h=l[g],d=h.id,h=this.getValueForNode(null,h),h!==null&&(f[d]=h)}else if(c!==null){l=b(a);j=l.length;for(g=0;g<j;g++)h=l[g],h.nodeType===Node.TEXT_NODE&&(d=this.getNodeId(h),this.addTextNodeToWordMap(d,
h,null,null,c,f))}e.resolve(f);return e.promise()}}function p(a,b){a.createWordMap=function(a,c,e,f){return b.createBoundsWordMap(a,c,e,f)}}function o(a,b){a.createWordMap=function(a,c){return b.createTextWordMap(a,c)}}var v="data-nid";return{buildWordMapGeneratorForWordBounds:function(){var a={};e(a);l(a);KindleRendererSettings.getLanguageOptions().characterSelection?g(a):h(a);var b={};p(b,a);return b},buildWordMapGeneratorForWordText:function(){var a={};e(a);m(a);KindleRendererSettings.getLanguageOptions().characterSelection?
g(a):h(a);var b={};o(b,a);return b},countUTF8Bytes:function(a){return k(a)}}}(),KindleRendererWritingModeFactory=function(){function d(a,c,f,e){return(a<c?a+f-c:c+e-a)>b*Math.min(f,e)}function k(){var a=KindleRendererDeviceSpecific.usesDocRelativeVerticalCoordinates(),b=0,f=!1;return{getWritingMode:function(){return"vertical"},resetHeight:function(a){$(a).css("width",$(a.parentNode).width()+"px")},resetWidth:function(a){$(a).css("height",$(a.parentNode).height()+"px")},resetIframeDimensions:function(a){$(a).css({width:$(a.parentNode).width()+
"px",height:$(a.parentNode).height()+"px"})},padImageIfNeeded:function(a){var b=$(a).css("margin-left");parseInt(b,10)<=1&&$(a).css("margin-left","2px")},getAvailableSizeForImage:function(a,b,c){var f=Math.min(a.getAttribute("data-nativeTopOffset"),a.offsetTop),d=$(a.offsetParent).height()||b.height,j=$(a.offsetParent).width()||b.width,d=Math.min(d-f,b.height*c),j=Math.min(j,b.width*c);$(a).css("float")!=="none"&&(c=$(a).parent(),a=parseInt($(c).css("line-height"),10),c=parseInt($(c).css("font-size"),
10),j=Math.min(j,b.width-(a+c)));return{width:j,height:d}},calculateOverlappingImageSets:function(a,b){function c(a,b){return a.offsetLeft-b.offsetLeft}var f=[];if(a.length>1){for(var a=Array.prototype.slice.call(a).sort(c),d=null,j=a[0],k=j.offsetLeft+j.width,v,n,q=1;q<a.length;++q)if(v=a[q],!b(v)){n=v.offsetLeft+v.width;if(v.offsetLeft<=k){d||(d={left:j.offsetLeft,right:k,imgs:[j]});if(n>d.right)d.right=n;d.imgs.push(v)}else d&&(f.push({height:0,width:d.right-d.left,imgs:d.imgs}),d=null);j=v;k=
d?d.right:n}d&&f.push({height:0,width:d.right-d.left,imgs:d.imgs})}return f},forceRepaint:function(a){if(a.contentDocument)a.contentDocument.body.style.top=0,setTimeout(function(){a.contentDocument.body.style.top=""},1)},setHeight:function(a,b){$(a).css("width",b)},setWidth:function(a,b){$(a).css("height",b)},fitToBottomOfFrame:function(a,b,c){$(b).css({height:"100%",width:$(a).width()-c+1,top:0,left:$(a).position().left-1})},height:function(a){return $(a).width()},width:function(a){return $(a).height()},
prepareForPagination:function(a){b=$(a).width();this.scrollToTopOfDocument(a);f=$(a.contentDocument).find("table").length>0},getTransformedClientRects:function(a,d,h){var l=a.length,j=[],k=0,h=h?parseInt(h.fontSize,10):void 0;if(d&&d.deltaX)k=d.deltaX;var o=0;for(a.length>1&&a[0].height<=1&&(o=1);o<l;o++){var v=a[o],n=v.right+k,q=h&&d.tagName!=="IMG"?h:v.width,v={top:v.top,bottom:v.bottom,height:v.height,left:b-(n-q),right:b-n,width:q},q=d,n=v;if(f){var t=$(q).closest("TBODY")[0];if(t){var A=0,A=
$(t).parent(),z=$(A).width(),A=z,u=$(q).closest("TD")[0];u&&(A-=$(u).width());t=z-$(t).width();A+=t;n.left+=A;n.right+=A}}q&&q.getAttribute&&q.getAttribute("data-isTextCombineBlock")&&(t=parseInt($(q).css("font-size"),10),q=n.height-t,t=n.width-t,q>0&&(A=Math.ceil(q/2),n.top+=A,n.bottom-=A,n.height-=q),t<0&&(q=Math.ceil(t/2),n.left-=q,n.right+=q,n.width-=t));j.push(v)}return j},getRectsAdjustedForAnnotationMarks:function(a,b){for(var c=a.length,f=[],d=Math.ceil(b/2)+1,j=0;j<c;j++){var k=a[j];f.push({top:k.top,
bottom:k.bottom,height:k.height,left:k.left,right:k.right-d,width:k.width+d})}return f},unionRect:function(a){for(var b=a[0],b={left:b.top,right:b.bottom,bottom:b.left,top:b.right},c=1;c<a.length;++c)b.top=Math.min(b.top,a[c].right),b.bottom=Math.max(b.bottom,a[c].left),b.right=Math.max(b.right,a[c].bottom),b.left=Math.min(b.left,a[c].top);return b},clientRectTop:function(a){return a.right},clientRectBottom:function(a){return a.left},clientRectLeft:function(a){return a.top},clientRectRight:function(a){return a.bottom},
clientRectCompare:function(a,b){return d(a.right,b.right,a.width,b.width)?a.top-b.top:a.right<b.right},scrollToTopOfDocument:function(e){var f=0;a&&(f=e.contentDocument.width-b);$(e.contentWindow).scrollLeft(f);e.contentDocument.body.style.top=0;e.contentDocument.body.style.left=0},scrollTop:function(a,b){a.contentDocument.body.style.left=b},getRectBoundariesForScreen:function(a,f){for(var d=[],j=a.length,k=0;k<j;k++)d.push({left:b-(a[k].left-f),top:a[k].top,right:b-(a[k].right-f),bottom:a[k].bottom});
return d},isPointOnVisiblePage:function(a,b,c){return c>b},checkIfNewLine:function(a,b){return b===void 0||!d(a.right,b.right,a.width,b.width)},updateLineBounds:function(a,b,c,f,d){a.left=d-a.left;a.right=d-a.right;a.height=b&&f?f.top-a.top:c.bottom-a.top},updateDivIfNewLineOrImageBound:function(a,b,c,f,d,j){var k=!1;if(a.isNewLine||a.isImageBound)a.lineBounds={top:a.isNewLine?b.top:a.lineBounds.top+a.lineBounds.height,height:b.height,left:b.left,right:b.right,width:b.width};a.isImageBound=d;a.isNewLine=
this.checkIfNewLine(a.lineBounds,c);(k=a.isNewLine||a.isImageBound)&&this.updateLineBounds(a.lineBounds,!a.isNewLine&&!(f||c===void 0),b,c,j);return k},positionDivAfterWord:function(a,b,c,f){a.style.top=b.top+c;a.style.left=f-b.left+b.width+c},getDeltaX:function(a,b){var e;var c=0;if(!(KindleHostDeviceDetector.isiOS()&&navigator.userAgent.indexOf("OS 6")!==-1)){if(a.tagName==="RUBY"){var f=b.createRange();f.selectNodeContents(a);var f=f.getClientRects(),d=a.getClientRects();d&&f&&d.length&&f.length&&
(c=d[0].left-f[0].left)}if(a.parentNode&&a.parentNode.parentNode){var f=a.nodeType===Node.TEXT_NODE?a.parentNode:a,d=a.nodeType!==Node.TEXT_NODE&&a.tagName!=="RUBY"&&$(f).css("display")==="inline",j=$(f).css("display")==="inline-block",k=$(f.parentNode).css("display")==="inline";if((d||j)&&k){c+=-f.getBoundingClientRect().right;j=d=f;do j=d,d=d.parentNode;while(d&&$(d).css("display")!=="block");j={containingBlock:d,furthestNonBlockParent:j};if(d=j.containingBlock){e=k=j.furthestNonBlockParent,j=e;
do j=j.nextElementSibling;while(j&&$(j).css("display")!=="block");do k=k.previousElementSibling;while(k&&$(k).css("display")!=="block");k=k?k.getBoundingClientRect().left-parseInt($(k).css("margin-left"),10):d.getBoundingClientRect().right;d=j?j.getBoundingClientRect().right+parseInt($(j).css("margin-right"),10):d.getBoundingClientRect().left;f=k-(f.getBoundingClientRect().left-d)}else f=f.getBoundingClientRect().right;c+=f}}}return c},floatToTopOfIframe:function(a,f){var d=a.document.body,j=d.getBoundingClientRect(),
d=a.getComputedStyle(d);$(f).css({position:"absolute",top:parseInt(d.top,10)-j.top,left:parseInt(d.left,10)-(j.left+a.document.width-b)})}}}function j(){return{getWritingMode:function(){return"horizontal"},resetHeight:function(a){$(a).css("height",$(a.parentNode).height()+"px")},resetWidth:function(a){$(a).css("width",$(a.parentNode).width()+"px")},resetIframeDimensions:function(a){$(a).css({height:$(a.parentNode).height()+"px",width:$(a.parentNode).width()+"px"})},padImageIfNeeded:function(a){var b=
$(a).css("margin-bottom");parseInt(b,10)<=1&&$(a).css("margin-bottom","2px")},getAvailableSizeForImage:function(a,b,f){var e=Math.min(a.getAttribute("data-nativeLeftOffset"),a.offsetLeft),d=$(a.offsetParent).height()||b.height,h=$(a.offsetParent).width()||b.width,d=Math.min(d,b.height*f),h=Math.min(h-e,b.width*f);$(a).css("float")!=="none"&&(f=$(a).parent(),a=parseInt($(f).css("line-height"),10),f=parseInt($(f).css("font-size"),10),d=Math.min(d,b.height-(a+f)));return{width:h,height:d}},calculateOverlappingImageSets:function(a,
b){function f(a,b){return a.offsetTop-b.offsetTop}var e=[];if(a.length>1){for(var a=Array.prototype.slice.call(a).sort(f),d=null,h=a[0],j=h.offsetTop+h.height,k,p,o=1;o<a.length;++o)if(k=a[o],!b(k)){p=k.offsetTop+k.height;if(k.offsetTop<=j){d||(d={top:h.offsetTop,bottom:j,imgs:[h]});if(p>d.bottom)d.bottom=p;d.imgs.push(k)}else d&&(e.push({height:d.bottom-d.top,width:0,imgs:d.imgs}),d=null);h=k;j=d?d.bottom:p}d&&e.push({height:d.bottom-d.top,width:0,imgs:d.imgs})}return e},forceRepaint:function(){},
setHeight:function(a,b){$(a).css("height",b)},setWidth:function(a,b){$(a).css("width",b)},fitToBottomOfFrame:function(a,b,f){f=$(a).height()-f+1;a=$(a).position().top+$(a).height()-f+1;$(b).css({height:f,width:"100%",top:a,left:0})},height:function(a){return $(a).height()},width:function(a){return $(a).width()},prepareForPagination:function(a){this.scrollToTopOfDocument(a)},getTransformedClientRects:function(a){return a.length>1&&a[0].width<=1?Array.prototype.slice.call(a,1):a},getRectsAdjustedForAnnotationMarks:function(a,
b){for(var f=a.length,e=[],d=Math.ceil(b/2)+1,h=0;h<f;h++){var j=a[h];e.push({top:j.top-d,bottom:j.bottom,height:j.height+d,left:j.left,right:j.right,width:j.width})}return e},unionRect:function(a){for(var b=a[0],b={top:b.top,bottom:b.bottom,left:b.left,right:b.right},f=1;f<a.length;++f)b.top=Math.min(b.top,a[f].top),b.right=Math.max(b.right,a[f].right),b.bottom=Math.max(b.bottom,a[f].bottom),b.left=Math.min(b.left,a[f].left);return b},clientRectTop:function(a){return a.top},clientRectBottom:function(a){return a.bottom},
clientRectLeft:function(a){return a.left},clientRectRight:function(a){return a.right},clientRectCompare:function(a,b){return d(a.top,b.top,a.height,b.height)?a.left-b.left:a.top-b.top},scrollToTopOfDocument:function(a){$(a.contentWindow).scrollTop(0);a.contentDocument.body.style.top=0;a.contentDocument.body.style.left=0},scrollTop:function(a,b){a.contentDocument.body.style.top=-b},getRectBoundariesForScreen:function(a,b){for(var f=[],e=a.length,d=0;d<e;d++)f.push({left:a[d].left,top:a[d].top-b,right:a[d].right,
bottom:a[d].bottom-b});return f},isPointOnVisiblePage:function(a,b,f,e){return e<a-b},checkIfNewLine:function(a,b){return b===void 0||!d(a.top,b.top,a.height,b.height)},updateLineBounds:function(a,b,f,e){a.width=b&&e?e.left-a.left:f.right-a.left},updateDivIfNewLineOrImageBound:function(a,b,f,e,d){var h=!1;if(a.isNewLine||a.isImageBound)a.lineBounds={top:b.top,height:b.height,left:a.isNewLine?b.left:a.lineBounds.left+a.lineBounds.width,right:b.right,width:b.width};a.isImageBound=d;a.isNewLine=this.checkIfNewLine(a.lineBounds,
f);(h=a.isNewLine||a.isImageBound)&&this.updateLineBounds(a.lineBounds,!a.isNewLine&&!(e||f===void 0),b,f);return h},positionDivAfterWord:function(a,b,d){a.style.top=b.top+d;a.style.left=b.left+b.width+d},getDeltaX:function(){return 0},floatToTopOfIframe:function(a,b){var d=a.document.body,e=d.getBoundingClientRect(),d=a.getComputedStyle(d);$(b).css({position:"absolute",top:parseInt(d.top,10)-e.top,left:parseInt(d.left,10)-e.left})}}}var b=0.15;return{buildIFrameWritingMode:function(a){return!a.contentDocument?
j():(a=$(a.contentDocument.body).css("-webkit-writing-mode"))&&a.match(/^vertical/)!==null?k():j()}}}(),KindleRendererZoomableFixedContentFactory=function(){function d(a,b){return a.data&&b.data?a.data.ordinal!==void 0&&b.data.ordinal!==void 0?a.data.ordinal-b.data.ordinal:a.data.ordinal===void 0&&b.data.ordinal===void 0?0:a.data.ordinal!==void 0?-1:1:!a.data&&!b.data?0:a.data?-1:1}function k(a,b){if(a.getBoundingClientRect){var c=a.getBoundingClientRect();if(c)return{top:c.top+b.y,right:c.right+
b.x,bottom:c.bottom+b.y,left:c.left+b.x,width:c.width,height:c.height}}return null}function j(a){a.setActive=function(a){if(this.sourceElement){var b=this.sourceElement.ownerDocument;if(b&&this.data.targetId){var c=$(b).find("#"+this.data.targetId),d=null;a?(this.data.sourceId&&(d=$(b).find("#"+this.data.sourceId),c.html().trim().length===0&&(a=d.clone(),a.css({visibility:"visible",color:"black"}),$(c).append(a)),d.hide()),c.show()):(c.hide(),this.data.sourceId&&(d=$(b).find("#"+this.data.sourceId),
d.show()))}}};a.isSame=function(a){return a.internalComparison(this.sourceElement)};a.internalComparison=function(a){return this.sourceElement===a};a.getBounds=function(){if(this.sourceElement){var a=this.sourceElement.ownerDocument;if(a&&this.data.targetId&&(a=$(a).find("#"+this.data.targetId),a.is(":visible"))){var b=a.children(".target-mag"),a=b.length===1?b:a;return k(a.get(0),this.origin)}return k(this.sourceElement,this.origin)}return null}}function b(a,b){a.activate=function(){return b.setActive(!0)};
a.deactivate=function(){return b.setActive(!1)};a.isSame=function(a){return b.isSame(a)};a.getBounds=function(){return b.getBounds()};a.internalComparison=function(a){return b.internalComparison(a)}}function a(a,b,d){a.origin=b;a.sourceElement=d;b=d.getAttribute(c);a.data=jQuery.parseJSON(b)}var c="data-app-amzn-magnify";return{buildList:function(c,e){for(var g=[],h=$(c).find(".app-amzn-magnify").get(),k=0;k<h.length;k++)try{var m={};a(m,e,h[k]);j(m);g.push(m)}catch(p){}g.sort(d);h=[];for(k=0;k<g.length;k++)m=
{},b(m,g[k]),h.push(m);return h},buildFromCoord:function(c,d,g,h){a:{for(c=c.elementFromPoint(g-d.x,h-d.y);c;){if($(c).hasClass("app-amzn-magnify")){g=c;break a}c=c.parentNode}g=null}if(g)try{return c={},a(c,d,g),j(c),d={},b(d,c),d}catch(k){}return null}}}(),KindleRendererZoomableReflowableContentFactory=function(){function d(b){for(;b;){if(b.tagName==="IMG")return b;b=b.parentNode}return null}function k(b){b.clone=function(){if(this.sourceElement)return $(this.sourceElement).clone().get(0)};b.getBounds=
function(){var a;if(this.sourceElement)a:{var b=this.sourceElement;a=this.origin;if(b.getBoundingClientRect&&(b=b.getBoundingClientRect())){a={top:b.top+a.y,right:b.right+a.x,bottom:b.bottom+a.y,left:b.left+a.x,width:b.width,height:b.height};break a}a=null}else a=null;return a}}function j(b,a){b.clone=function(){return a.clone()};b.getBounds=function(){return a.getBounds()}}return{buildFromCoord:function(b,a,c,f){b=b.elementFromPoint(c-a.x,f-a.y);if(c=d(b))try{return b={},b.origin=a,b.sourceElement=
c,k(b),a={},j(a,b),a}catch(e){}return null},buildFromElement:function(b,a){var c=d(b);if(c)try{var f={};f.origin=a;f.sourceElement=c;k(f);c={};j(c,f);return c}catch(e){}return null}}}(),KindleRendererZoomablesFactory=function(){return{buildList:function(d,k){return $(d.body).css("position")==="absolute"?KindleRendererZoomableFixedContentFactory.buildList(d,k):[]},buildFromCoord:function(d,k,j,b){return $(d.body).css("position")==="absolute"?KindleRendererZoomableFixedContentFactory.buildFromCoord(d,
k,j,b):KindleRendererZoomableReflowableContentFactory.buildFromCoord(d,k,j,b)}}}(),KindleListUtilities=function(){return{binarySearch:function(d,k,j){if(!d.length)return 0;for(var b=d.length-1,a=0,c=0,f=null,e=0;a<=b;)if(c=Math.floor((a+b)/2),f=d[c],e=0,j===void 0?f>k?e=1:f<k&&(e=-1):e=j(k,f),e>0)b=c-1;else if(e<0)a=c+1;else return c;return c===0||e<0?c:c-1},first:function(d){return d[0]},last:function(d){return d[d.length-1]}}}();
